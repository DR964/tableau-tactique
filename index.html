<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau Tactique v0.6.32 - ES Marbres & Granits</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè≠</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* Modern Dark Theme */
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-elevated: #22222e;
            
            /* Accent Colors */
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-tertiary: #a78bfa;
            
            /* Semantic Colors */
            --success: #22c55e;
            --success-muted: #16a34a;
            --warning: #f59e0b;
            --warning-muted: #d97706;
            --danger: #ef4444;
            --danger-muted: #dc2626;
            --info: #06b6d4;
            --info-muted: #0891b2;
            
            /* Text Colors */
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            /* Borders */
            --border-subtle: rgba(255,255,255,0.06);
            --border-default: rgba(255,255,255,0.1);
            --border-strong: rgba(255,255,255,0.15);
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
            --gradient-success: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f43f5e 100%);
            --gradient-info: linear-gradient(135deg, #06b6d4 0%, #0ea5e9 100%);
            
            /* Legacy compatibility */
            --purple: #8b5cf6; --pink: #f472b6; --blue: #3b82f6;
            --cyan: #06b6d4; --green: #22c55e; --yellow: #f59e0b;
            --orange: #f97316; --red: #ef4444;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.5;
        }
        
        /* Support tactile global pour iOS/Android */
        button, .btn, [onclick], .nav-tab, .card, .tooltip-term {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(6, 182, 212, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container { max-width: 1900px; margin: 0 auto; padding: 20px; }
        
        /* Header */
        .game-header {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px 28px;
            margin-bottom: 24px;
            border: 1px solid var(--border-default);
            box-shadow: 0 4px 24px rgba(0,0,0,0.3);
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .logo-section h1 {
            font-size: 1.6em;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }
        .logo-section p { color: var(--text-muted); font-size: 0.85em; margin-top: 4px; }
        .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-label { font-size: 0.7em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
        select {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        select:hover { border-color: var(--accent-primary); }
        select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        select option { background: var(--bg-card); color: var(--text-primary); }
        
        .manche-badge {
            background: var(--gradient-warning);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.95em;
            color: #000;
            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.3);
        }
        .player-badge {
            background: var(--gradient-info);
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.95em;
            color: #000;
            box-shadow: 0 2px 12px rgba(6, 182, 212, 0.3);
        }
        .kpi-badge {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1em;
            color: #000;
            box-shadow: 0 2px 12px rgba(34, 197, 94, 0.3);
            transition: all 0.3s ease;
        }
        
        /* Navigation */
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .nav-tab {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .nav-tab:hover { 
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-strong);
        }
        .nav-tab.active {
            background: var(--gradient-primary);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
        }
        .nav-tab.locked { 
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        .nav-tab:not(.locked) {
            pointer-events: auto;
        }
        .nav-tab.locked:hover { background: var(--bg-card); color: var(--text-secondary); }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Stats Row */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 20px;
            border: 1px solid var(--border-default);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .stat-card:hover { 
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border-color: var(--border-strong);
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 3px;
            background: var(--gradient-info);
        }
        .stat-card.warning::before { background: var(--gradient-warning); }
        .stat-card.good::before { background: var(--gradient-success); }
        .stat-icon { font-size: 1.6em; margin-bottom: 8px; }
        .stat-label { font-size: 0.7em; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1.6em; font-weight: 700; color: var(--text-primary); }
        .stat-subtext { font-size: 0.75em; color: var(--text-muted); margin-top: 4px; }
        .stat-change { font-size: 0.8em; margin-top: 6px; font-weight: 600; }
        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }
        
        /* Main Grid */
        .main-grid { display: grid; grid-template-columns: 1fr 1.6fr; gap: 24px; margin-bottom: 24px; }
        @media (max-width: 1200px) { .main-grid { grid-template-columns: 1fr; } }
        
        /* Layout pleine largeur pour Manche 2 et 3 */
        .main-grid.full-width-cards { 
            grid-template-columns: 1fr; 
        }
        .main-grid.full-width-cards .board-section:first-child {
            display: none; /* Cacher la section processus/ranking */
        }
        .main-grid.full-width-cards .cards-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            max-height: none;
            overflow: visible;
        }
        .main-grid.full-width-cards .card {
            flex: 1 1 280px;
            max-width: 350px;
        }
        
        /* Boutique par secteur en Manche 2/3 */
        .shop-sector {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .shop-sector-title {
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid;
        }
        .shop-sector-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .shop-sector-cards .card {
            flex: 1 1 260px;
            max-width: 320px;
            min-width: 240px;
        }
        
        .board-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-default);
            box-shadow: 0 4px 24px rgba(0,0,0,0.2);
        }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title { font-size: 1.1em; font-weight: 700; display: flex; align-items: center; gap: 12px; color: var(--text-primary); }
        .title-icon {
            width: 40px; height: 40px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1em;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        /* Poste du joueur */
        .poste-section {
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        .poste-section::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        .poste-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .poste-title { font-size: 1.4em; font-weight: 800; color: var(--text-primary); }
        .poste-trg {
            background: var(--gradient-success);
            padding: 12px 24px;
            border-radius: 12px;
            color: #000;
            font-weight: 800;
            font-size: 1.2em;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
        }
        .poste-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; }
        .poste-stat {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all 0.2s ease;
        }
        .poste-stat:hover { border-color: var(--border-default); }
        .poste-stat-label { font-size: 0.7em; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.05em; }
        .poste-stat-value { font-size: 1.4em; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        
        /* Tableau Excel Style */
        .excel-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            background: var(--bg-elevated);
            border-radius: 12px;
            overflow: hidden;
        }
        .excel-table th, .excel-table td {
            padding: 8px 10px;
            text-align: center;
            border: 1px solid var(--border-subtle);
        }
        .excel-table th {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            font-weight: 600;
            font-size: 0.75em;
            text-transform: uppercase;
        }
        .excel-table th.section-header {
            background: linear-gradient(135deg, #0f766e, #14b8a6);
            font-size: 0.8em;
        }
        .excel-table th.section-header-yellow {
            background: linear-gradient(135deg, #b45309, #f59e0b);
            color: #000;
        }
        .excel-table th.section-header-green {
            background: linear-gradient(135deg, #15803d, #22c55e);
        }
        .excel-table th.section-header-blue {
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
        }
        .excel-table .mf-row { background: var(--bg-card); }
        .excel-table .mf-row:hover { background: rgba(99, 102, 241, 0.1); }
        .excel-table .mf-name { 
            text-align: left; 
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .excel-table .total-row {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            font-weight: 700;
        }
        .excel-table .value-positive { color: var(--success); }
        .excel-table .value-negative { color: var(--danger); }
        .excel-table .value-warning { color: var(--warning); }
        .excel-table .capacity-cell {
            position: relative;
        }
        .excel-table .capacity-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .excel-table .capacity-bar.ok { background: var(--success); }
        .excel-table .capacity-bar.warning { background: var(--warning); }
        .excel-table .capacity-bar.danger { background: var(--danger); }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .summary-card {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
        }
        .summary-card.highlight {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            border-color: var(--accent-primary);
        }
        .summary-card.positive {
            background: rgba(34, 197, 94, 0.15);
            border-color: var(--success);
        }
        .summary-card.negative {
            background: rgba(239, 68, 68, 0.15);
            border-color: var(--danger);
        }
        .summary-card-label {
            font-size: 0.7em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }
        .summary-card-value {
            font-size: 1.5em;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        .summary-card-value.positive { color: var(--success); }
        .summary-card-value.negative { color: var(--danger); }
        
        /* Tooltips pour les acronymes */
        .tooltip-term {
            position: relative;
            cursor: help;
            border-bottom: 1px dashed var(--text-muted);
            display: inline-block;
        }
        .tooltip-term:hover {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        .tooltip-term::after {
            content: attr(data-tooltip);
            position: fixed;
            left: var(--tooltip-left, 50%);
            top: var(--tooltip-top, auto);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 400;
            white-space: normal;
            width: max-content;
            max-width: min(280px, calc(100vw - 20px));
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            border: 1px solid var(--accent-primary);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease;
            z-index: 99999;
            text-align: left;
            line-height: 1.4;
            pointer-events: none;
        }
        .tooltip-term:hover::after {
            opacity: 1;
            visibility: visible;
        }
        /* Support tactile (tablettes/mobiles) */
        .tooltip-term.tooltip-active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
        }
        .tooltip-term.tooltip-active::after {
            opacity: 1;
            visibility: visible;
        }
        .excel-table .tooltip-term {
            border-bottom: none;
            font-weight: 600;
        }
        .excel-table .tooltip-term::after {
            font-weight: 400;
            max-width: min(220px, calc(100vw - 20px));
        }
        /* Tooltips dans les cartes de vente */
        .sales-card .tooltip-term::after {
            max-width: min(220px, calc(100vw - 20px));
            font-size: 0.75em;
        }
        /* Tooltips dans sales-card-info */
        .sales-card-info .tooltip-term::after {
            max-width: min(200px, calc(100vw - 20px));
        }
        
        /* Indicateurs de contraintes */
        .constraint-ok {
            color: var(--success) !important;
            background: rgba(34, 197, 94, 0.1);
        }
        .constraint-warning {
            color: var(--warning) !important;
            background: rgba(245, 158, 11, 0.2);
            animation: pulse-warning 2s infinite;
        }
        .constraint-danger {
            color: var(--danger) !important;
            background: rgba(239, 68, 68, 0.25);
            animation: pulse-danger 1s infinite;
        }
        @keyframes pulse-warning {
            0%, 100% { background: rgba(245, 158, 11, 0.15); }
            50% { background: rgba(245, 158, 11, 0.3); }
        }
        @keyframes pulse-danger {
            0%, 100% { background: rgba(239, 68, 68, 0.2); }
            50% { background: rgba(239, 68, 68, 0.4); }
        }
        @keyframes pulse-success {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); }
            50% { transform: scale(1.02); box-shadow: 0 6px 25px rgba(34, 197, 94, 0.5); }
        }
        .constraint-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
        }
        .constraint-bar-container {
            width: 100%;
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            margin-top: 4px;
            overflow: hidden;
        }
        .constraint-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease, background 0.3s ease;
        }
        .constraint-bar-fill.ok { background: var(--success); }
        .constraint-bar-fill.warning { background: var(--warning); }
        .constraint-bar-fill.danger { background: var(--danger); }
        
        /* Cards Grid */
        .cards-grid { display: flex; flex-direction: column; gap: 12px; max-height: 520px; overflow-y: auto; padding-right: 8px; }
        .cards-grid::-webkit-scrollbar { width: 6px; }
        .cards-grid::-webkit-scrollbar-track { background: var(--bg-elevated); border-radius: 10px; }
        .cards-grid::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 10px; }
        
        .card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 14px;
            padding: 18px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .card:hover { 
            transform: translateY(-2px);
            border-color: var(--success);
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.2);
        }
        .card.purchased { 
            opacity: 0.4;
            border-color: var(--border-subtle);
            cursor: not-allowed;
        }
        .card.purchased:hover { transform: none; box-shadow: none; border-color: var(--border-subtle); }
        
        .card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .card-title { font-weight: 700; font-size: 0.95em; display: flex; align-items: center; gap: 10px; color: var(--text-primary); }
        .card-emoji { font-size: 1.3em; }
        .card-price {
            background: var(--gradient-warning);
            color: #000;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8em;
        }
        .card-description { font-size: 0.85em; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; }
        .card-effect {
            background: rgba(34, 197, 94, 0.15);
            border-left: 3px solid var(--success);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--success);
        }
        .card-effect.repair {
            background: rgba(6, 182, 212, 0.15);
            border-left-color: var(--info);
            color: var(--info);
        }
        .btn-buy {
            width: 100%;
            background: var(--gradient-success);
            border: none;
            padding: 12px;
            border-radius: 10px;
            color: #000;
            font-weight: 700;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-buy:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
        }
        .btn-buy:disabled { 
            background: var(--bg-elevated);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        
        /* Classement TRG */
        .ranking-mini {
            background: var(--bg-elevated);
            border-radius: 14px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--border-subtle);
        }
        .ranking-mini h4 { margin-bottom: 16px; font-size: 0.95em; color: var(--text-primary); }
        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            transition: all 0.2s ease;
        }
        .ranking-item:hover { border-color: var(--border-default); }
        .ranking-item.current { 
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent-primary);
        }
        .ranking-item.leader { 
            background: rgba(245, 158, 11, 0.15);
            border-color: var(--warning);
        }
        .ranking-position { font-weight: 800; font-size: 1.1em; width: 32px; color: var(--text-primary); }
        .ranking-name { flex: 1; font-weight: 600; color: var(--text-secondary); }
        .ranking-trg { font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--info); }
        
        /* Hidden Indicators Panel (Manche 2+) */
        .hidden-panel {
            background: var(--bg-card);
            border: 1px solid var(--danger);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
        }
        .hidden-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--gradient-danger);
            border-radius: 16px 16px 0 0;
        }
        .hidden-panel h3 { color: var(--danger); margin-bottom: 16px; display: flex; align-items: center; gap: 10px; font-size: 1.1em; }
        .hidden-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
        .hidden-item { 
            text-align: center;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
        }
        .hidden-label { font-size: 0.75em; color: var(--text-muted); margin-bottom: 6px; }
        .hidden-value { font-size: 1.4em; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
        .hidden-value.critical { color: var(--danger); }
        .hidden-value.warning { color: var(--warning); }
        .hidden-value.good { color: var(--success); }
        
        /* Ready Button */
        .ready-section {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            text-align: center;
        }
        .ready-status { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .player-ready {
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85em;
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .player-ready.ready { 
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }
        .player-ready.current { 
            border-color: var(--accent-primary);
            box-shadow: 0 0 16px rgba(99, 102, 241, 0.4);
        }
        .btn-ready {
            background: var(--gradient-primary);
            border: none;
            padding: 16px 48px;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }
        .btn-ready:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.5);
        }
        .btn-ready:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-ready.is-ready { 
            background: var(--gradient-success);
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
        }
        
        /* Alert Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            backdrop-filter: blur(12px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { 
            display: flex; 
            animation: modalFadeIn 0.5s ease-out;
        }
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 48px;
            max-width: 850px;
            width: 95%;
            border: 3px solid var(--danger);
            text-align: center;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 0 80px rgba(239, 68, 68, 0.4), 0 24px 64px rgba(0,0,0,0.5);
            animation: modalSlideIn 0.5s ease-out;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.9) translateY(-30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-content h2 { 
            color: var(--danger); 
            font-size: 2em; 
            margin-bottom: 24px; 
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            animation: alertPulse 2s ease-in-out infinite;
        }
        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Alert Sp√©cifique Manche 1->2 */
        .modal-content.alert-manche1 {
            border-color: var(--danger);
            box-shadow: 0 0 100px rgba(239, 68, 68, 0.5), 0 0 200px rgba(239, 68, 68, 0.2);
        }
        .modal-content.alert-manche1::before {
            content: '‚ö†Ô∏è ALERTE CRITIQUE ‚ö†Ô∏è';
            display: block;
            background: linear-gradient(90deg, var(--danger), #ff6b6b, var(--danger));
            background-size: 200% 100%;
            animation: alertGradient 2s linear infinite;
            color: white;
            font-weight: 800;
            font-size: 1.2em;
            padding: 16px;
            margin: -48px -48px 32px -48px;
            border-radius: 21px 21px 0 0;
        }
        @keyframes alertGradient {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        /* Alert Sp√©cifique Manche 2->3 */
        .modal-content.alert-manche2 {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 100px rgba(139, 92, 246, 0.5), 0 0 200px rgba(139, 92, 246, 0.2);
        }
        .modal-content.alert-manche2::before {
            content: 'üìä BILAN COLLABORATION üìä';
            display: block;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-primary));
            background-size: 200% 100%;
            animation: alertGradient 2s linear infinite;
            color: white;
            font-weight: 800;
            font-size: 1.2em;
            padding: 16px;
            margin: -48px -48px 32px -48px;
            border-radius: 21px 21px 0 0;
        }
        .modal-content.alert-manche2 h2 {
            color: var(--accent-tertiary);
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }
        .modal-content p { font-size: 0.95em; line-height: 1.7; margin-bottom: 16px; color: var(--text-secondary); }
        .modal-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 24px 0; }
        .modal-stat { 
            background: var(--bg-elevated);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
        }
        .modal-stat-label { font-size: 0.75em; color: var(--text-muted); margin-bottom: 4px; }
        .modal-stat-value { font-size: 1.2em; font-weight: 800; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; }
        .modal-stat-value.improved { color: var(--success); }
        .modal-stat-value.negative { color: var(--danger); }
        .modal-stat-value.positive { color: var(--success); }
        
        .modal-comment {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            line-height: 1.5;
            font-weight: 500;
        }
        .modal-comment.critical {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border-left: 3px solid var(--danger);
        }
        .modal-comment.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border-left: 3px solid var(--warning);
        }
        .modal-comment.good {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
            border-left: 3px solid var(--success);
        }
        
        .btn-modal {
            background: var(--gradient-success);
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            color: #000;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            margin-top: 24px;
            transition: all 0.3s ease;
        }
        .btn-modal:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
        }
        .btn-modal.secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
        }
        .btn-modal.secondary:hover {
            background: var(--bg-card);
            border-color: var(--accent-primary);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2);
        }
        
        /* Target Selection Modal */
        .modal-content.target-selection {
            max-width: 700px;
            border-color: var(--accent-primary);
        }
        .modal-content.target-selection h2 {
            color: var(--accent-tertiary) !important;
        }
        .target-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }
        .target-card {
            background: var(--bg-elevated);
            border: 2px solid var(--border-default);
            border-radius: 14px;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .target-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }
        .target-card.bottleneck {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }
        .target-card.bottleneck::after {
            content: '‚ö†Ô∏è GOULET';
            display: block;
            font-size: 0.7em;
            color: var(--danger);
            margin-top: 8px;
            font-weight: 700;
        }
        .target-card-emoji {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .target-card-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        .target-card-stats {
            font-size: 0.8em;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        .target-card-stats div {
            margin: 4px 0;
        }
        .target-card-bar {
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .target-card-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .target-card-bar-fill.low { background: var(--success); }
        .target-card-bar-fill.medium { background: var(--warning); }
        .target-card-bar-fill.high { background: var(--danger); }
        .target-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        /* Player Selection Modal */
        .player-select-btn:hover {
            border-color: var(--accent-primary) !important;
            background: var(--bg-card) !important;
            transform: translateX(8px);
        }
        .player-select-btn:active {
            transform: translateX(4px);
        }
        
        /* VSM Micro-flux section */
        .vsm-microflux-section {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px dashed var(--border-default);
        }
        .vsm-microflux-section h3 {
            color: var(--accent-tertiary);
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        .vsm-microflux-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .vsm-microflux-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 16px;
        }
        .vsm-microflux-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .vsm-microflux-name {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .vsm-microflux-name span {
            font-size: 1.3em;
        }
        .vsm-microflux-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.8em;
        }
        .vsm-microflux-metric {
            background: var(--bg-card);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        .vsm-microflux-metric-label {
            color: var(--text-muted);
            font-size: 0.75em;
        }
        .vsm-microflux-metric-value {
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }
        
        /* VSM Constraints section */
        .vsm-constraints {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        .vsm-constraint {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-subtle);
        }
        .vsm-constraint-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .vsm-constraint-label {
            font-weight: 600;
            color: var(--text-secondary);
        }
        .vsm-constraint-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
        }
        .vsm-constraint-bar {
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            overflow: hidden;
        }
        .vsm-constraint-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .vsm-constraint-bar-fill.low { background: var(--success); }
        .vsm-constraint-bar-fill.medium { background: var(--warning); }
        .vsm-constraint-bar-fill.high { background: var(--danger); }
        .vsm-constraint.bottleneck {
            border: 2px solid var(--danger);
            background: rgba(239, 68, 68, 0.1);
            animation: pulse-danger 2s infinite;
        }
        @keyframes pulse-danger {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(239, 68, 68, 0.2); }
        }
        
        /* Final Results Modal */
        .modal-content.final-results {
            max-width: 900px;
            border-color: var(--success);
            text-align: left;
        }
        .final-header {
            text-align: center;
            margin-bottom: 32px;
        }
        .final-header .trophy {
            font-size: 4em;
            margin-bottom: 16px;
            animation: bounce 1s ease infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .final-header h2 {
            color: var(--success) !important;
            font-size: 1.8em;
            margin-bottom: 8px;
        }
        .final-header p {
            color: var(--text-secondary);
            font-size: 1em;
        }
        .final-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 28px;
        }
        .final-comparison-card {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-default);
        }
        .final-comparison-card.before {
            border-color: var(--danger);
        }
        .final-comparison-card.after {
            border-color: var(--success);
        }
        .final-comparison-card h4 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            font-size: 1.1em;
        }
        .final-comparison-card.before h4 { color: var(--danger); }
        .final-comparison-card.after h4 { color: var(--success); }
        .final-stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9em;
        }
        .final-stat-row:last-child { border-bottom: none; }
        .final-stat-label { color: var(--text-secondary); }
        .final-stat-value { font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        
        .final-evolution {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--accent-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 28px;
            text-align: center;
        }
        .final-evolution h3 {
            color: var(--accent-tertiary);
            margin-bottom: 20px;
        }
        .evolution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }
        .evolution-item {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
        }
        .evolution-label { font-size: 0.75em; color: var(--text-muted); margin-bottom: 6px; }
        .evolution-change { font-size: 1.4em; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
        .evolution-change.positive { color: var(--success); }
        .evolution-change.negative { color: var(--danger); }
        .evolution-change.neutral { color: var(--text-muted); }
        
        .final-lessons {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 28px;
        }
        .final-lessons h3 {
            color: var(--warning);
            margin-bottom: 16px;
        }
        .lesson-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.95em;
            color: var(--text-secondary);
        }
        .lesson-item:last-child { border-bottom: none; }
        .lesson-icon { font-size: 1.2em; }
        
        .final-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        .final-credits a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: all 0.2s ease;
            border-bottom: 1px solid transparent;
        }
        .final-credits a:hover {
            opacity: 0.8;
            border-bottom: 1px solid var(--accent-primary);
        }
        
        /* VSM Page */
        .vsm-locked {
            text-align: center;
            padding: 80px 40px;
            color: var(--text-muted);
        }
        .vsm-locked-icon { font-size: 4em; margin-bottom: 24px; opacity: 0.6; }
        .vsm-locked h2 { color: var(--text-primary); margin-bottom: 12px; }
        .vsm-locked p { color: var(--text-secondary); }
        .vsm-container { overflow-x: auto; padding: 24px 0; }
        .vsm-container::-webkit-scrollbar { height: 8px; }
        .vsm-container::-webkit-scrollbar-track { background: var(--bg-elevated); border-radius: 10px; }
        .vsm-container::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 10px; }
        .vsm-flow { display: flex; align-items: center; gap: 16px; min-width: 1100px; }
        .vsm-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 14px;
            padding: 20px;
            min-width: 150px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .vsm-box:hover { 
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
        }
        .vsm-icon { font-size: 2em; margin-bottom: 10px; }
        .vsm-name { font-weight: 700; font-size: 0.9em; margin-bottom: 12px; color: var(--text-primary); }
        .vsm-metrics { font-size: 0.8em; }
        .vsm-metric { 
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
        .vsm-metric:last-child { border-bottom: none; }
        .vsm-arrow { font-size: 1.5em; color: var(--text-muted); }
        .vsm-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-top: 28px; }
        .vsm-summary-card { 
            background: var(--bg-elevated);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-subtle);
        }
        .vsm-summary-label { font-size: 0.7em; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
        .vsm-summary-value { font-size: 1.5em; font-weight: 800; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        .vsm-summary-value.good { color: var(--success); }
        .vsm-summary-value.bad { color: var(--danger); }
        
        /* Toast */
        .toast-container { position: fixed; top: 24px; right: 24px; z-index: 1001; }
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            max-width: 380px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            color: var(--text-primary);
        }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.error { border-left: 4px solid var(--danger); }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Manche 2 Collaborative */
        .collab-notice {
            background: var(--bg-card);
            border: 1px solid var(--success);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
            position: relative;
        }
        .collab-notice::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--gradient-success);
            border-radius: 16px 16px 0 0;
        }
        .collab-notice h3 { color: var(--success); margin-bottom: 12px; }
        .collab-notice p { color: var(--text-secondary); }
        
        /* Sales Management Section (Manche 2) */
        .sales-section {
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        .sales-section::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 16px 16px 0 0;
        }
        .sales-summary {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        @media (min-width: 600px) {
            .sales-summary {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        .sales-summary-item {
            text-align: center;
            padding: 8px;
        }
        .sales-summary-label {
            font-size: 0.7em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .sales-summary-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1.1em;
            word-break: break-all;
        }
        .sales-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        @media (min-width: 700px) {
            .sales-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .sales-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .sales-card:hover {
            border-color: var(--accent-primary);
        }
        .sales-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .sales-card-name {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1em;
        }
        .sales-card-name span {
            font-size: 1.4em;
        }
        .sales-card-vag {
            font-family: 'JetBrains Mono', monospace;
            color: var(--success);
            font-weight: 700;
            font-size: 0.85em;
            background: rgba(16, 185, 129, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
        }
        .sales-card-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .sales-card-controls button {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85em;
            transition: all 0.2s ease;
            min-width: 44px;
        }
        .sales-card-controls button:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        .sales-card-controls input {
            width: 70px;
            text-align: center;
            padding: 8px 4px;
            border: 2px solid var(--accent-primary);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1em;
            font-weight: 700;
        }
        .sales-card-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.75em;
            color: var(--text-muted);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }
        .sales-card-info span {
            white-space: nowrap;
        }
        .sales-minmax-bar {
            margin-top: 10px;
            padding: 8px 0;
        }
        .sales-minmax-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .sales-minmax-track {
            height: 8px;
            background: var(--bg-card);
            border-radius: 4px;
            position: relative;
            overflow: visible;
            border: 1px solid var(--border-subtle);
        }
        .sales-minmax-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--accent-primary));
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .sales-minmax-fill.warning {
            background: linear-gradient(90deg, var(--warning), var(--danger));
        }
        .sales-minmax-fill.danger {
            background: linear-gradient(90deg, var(--danger), #dc2626);
        }
        .sales-card.goulet-warning {
            border: 2px solid var(--danger);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
        }
        .sales-goulet-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            text-align: center;
            display: none;
        }
        .sales-goulet-warning.active {
            display: block;
        }
        
        /* Full Ranking Page */
        .full-ranking { max-width: 800px; margin: 0 auto; }
        .ranking-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 24px;
            transition: all 0.3s ease;
        }
        .ranking-card:hover {
            transform: translateX(4px);
            border-color: var(--border-strong);
        }
        .ranking-card.gold { 
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }
        .ranking-card.silver { 
            background: rgba(148, 163, 184, 0.1);
            border-color: #64748b;
        }
        .ranking-card.bronze { 
            background: rgba(180, 83, 9, 0.1);
            border-color: #b45309;
        }
        .ranking-card .position { font-size: 2.2em; font-weight: 800; width: 60px; text-align: center; }
        .ranking-card .info { flex: 1; }
        .ranking-card .name { font-size: 1.2em; font-weight: 700; color: var(--text-primary); }
        .ranking-card .details { font-size: 0.85em; color: var(--text-muted); margin-top: 6px; }
        .ranking-card .trg-value { font-size: 1.8em; font-weight: 800; font-family: 'JetBrains Mono', monospace; color: var(--info); }
        
        /* History Page */
        .history-container { max-width: 1200px; margin: 0 auto; }
        .history-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            background: var(--bg-elevated);
            padding: 20px;
            border-radius: 14px;
            border: 1px solid var(--border-subtle);
        }
        .filter-group { display: flex; flex-direction: column; gap: 6px; }
        .filter-label { font-size: 0.7em; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; }
        .filter-select {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            min-width: 160px;
            transition: all 0.2s ease;
        }
        .filter-select:hover { border-color: var(--accent-primary); }
        .filter-select:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .filter-select option { background: var(--bg-card); color: var(--text-primary); }
        
        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .history-stat-card {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-default);
            transition: all 0.3s ease;
        }
        .history-stat-card:hover { transform: translateY(-2px); }
        .history-stat-card.negative { 
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.08);
        }
        .history-stat-card.positive { 
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.08);
        }
        .history-stat-icon { font-size: 2em; margin-bottom: 10px; }
        .history-stat-label { font-size: 0.8em; color: var(--text-muted); margin-bottom: 6px; }
        .history-stat-value { font-size: 1.8em; font-weight: 800; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        
        .history-timeline { display: flex; flex-direction: column; gap: 12px; }
        .history-entry {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 20px;
            border: 1px solid var(--border-default);
            border-left: 4px solid var(--accent-primary);
            transition: all 0.3s ease;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 20px;
            align-items: center;
        }
        .history-entry:hover { 
            background: var(--bg-elevated);
            transform: translateX(4px);
            border-color: var(--border-strong);
        }
        .history-entry.manche-1 { border-left-color: var(--warning); }
        .history-entry.manche-2 { border-left-color: var(--info); }
        .history-entry.manche-3 { border-left-color: var(--success); }
        
        .history-entry-meta {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 85px;
        }
        .history-manche-badge {
            background: var(--accent-primary);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 700;
            color: white;
        }
        .history-entry.manche-1 .history-manche-badge { background: var(--warning); color: #000; }
        .history-entry.manche-2 .history-manche-badge { background: var(--info); color: #000; }
        .history-entry.manche-3 .history-manche-badge { background: var(--success); color: #000; }
        .history-player-badge {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 600;
        }
        .history-time { font-size: 0.7em; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        
        .history-entry-content { flex: 1; }
        .history-card-name { font-size: 1.05em; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; color: var(--text-primary); }
        .history-card-emoji { font-size: 1.3em; }
        .history-card-desc { font-size: 0.85em; color: var(--text-secondary); margin-bottom: 12px; }
        .history-effects { display: flex; gap: 8px; flex-wrap: wrap; }
        .history-effect {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .history-effect.visible { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .history-effect.hidden { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .history-effect.positive { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        
        .history-entry-cost {
            text-align: right;
            min-width: 110px;
        }
        .history-cost-value {
            font-size: 1.2em;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            color: var(--warning);
        }
        .history-cost-label { font-size: 0.7em; color: var(--text-muted); margin-top: 4px; }
        
        .history-empty {
            text-align: center;
            padding: 80px 40px;
            color: var(--text-muted);
        }
        .history-empty-icon { font-size: 4em; margin-bottom: 24px; opacity: 0.5; }
        .history-empty h3 { color: var(--text-primary); margin-bottom: 8px; }
        .history-empty p { color: var(--text-secondary); }
        
        .history-export-btn {
            background: var(--gradient-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .history-export-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }
        
        .impact-summary {
            background: var(--bg-elevated);
            border-radius: 14px;
            padding: 24px;
            margin-top: 24px;
            border: 1px solid var(--border-subtle);
        }
        .impact-summary h4 { 
            margin-bottom: 16px;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }
        .impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        .impact-item {
            background: var(--bg-card);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-subtle);
        }
        .impact-item-label { font-size: 0.75em; color: var(--text-muted); margin-bottom: 6px; }
        .impact-item-value { font-size: 1.3em; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .impact-item-value.negative { color: var(--danger); }
        .impact-item-value.positive { color: var(--success); }
        
        /* Debriefing Section */
        .debriefing-section {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(249, 115, 22, 0.1));
            border: 2px solid var(--danger);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            text-align: center;
        }
        .debriefing-header h3 {
            color: var(--danger);
            margin-bottom: 12px;
            font-size: 1.2em;
        }
        .debriefing-header p {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin-bottom: 20px;
        }
        .debriefing-status {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .debriefing-player {
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.85em;
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .debriefing-player.compris {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }
        .debriefing-player.current {
            border-color: var(--accent-primary);
            box-shadow: 0 0 16px rgba(99, 102, 241, 0.4);
        }
        .btn-compris {
            background: var(--gradient-success);
            border: none;
            padding: 16px 48px;
            border-radius: 12px;
            color: #000;
            font-weight: 700;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.3);
        }
        .btn-compris:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.5);
        }
        .btn-compris.is-compris {
            background: var(--bg-elevated);
            color: var(--success);
            border: 2px solid var(--success);
        }
        
        /* Intro Modal */
        .intro-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            z-index: 2000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 20px;
            overflow-y: auto;
        }
        .intro-overlay.hidden {
            display: none;
        }
        .intro-container {
            max-width: 900px;
            width: 100%;
            animation: introFadeIn 0.8s ease-out;
        }
        @keyframes introFadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .intro-header {
            text-align: center;
            margin-bottom: 32px;
        }
        .intro-logo {
            font-size: 4em;
            margin-bottom: 16px;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .intro-title {
            font-size: 2.5em;
            font-weight: 800;
            background: linear-gradient(135deg, #f8f8f8, #a0a0a0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        .intro-subtitle {
            font-size: 1.2em;
            color: var(--text-muted);
            font-style: italic;
        }
        .intro-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
        }
        .intro-card h2 {
            color: var(--accent-primary);
            font-size: 1.3em;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .intro-card p {
            color: var(--text-secondary);
            line-height: 1.7;
            margin-bottom: 16px;
        }
        .intro-card p:last-child {
            margin-bottom: 0;
        }
        .intro-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }
        .intro-stat {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .intro-stat-value {
            font-size: 1.8em;
            font-weight: 800;
            color: var(--danger);
            font-family: 'JetBrains Mono', monospace;
        }
        .intro-stat-value.warning { color: var(--warning); }
        .intro-stat-value.info { color: var(--accent-primary); }
        .intro-stat-value.highlight { color: var(--success); }
        .intro-stat-label {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .intro-products {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-top: 16px;
        }
        .intro-product {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .intro-product:hover {
            border-color: var(--accent-primary);
            transform: translateY(-4px);
        }
        .intro-product-icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }
        .intro-product-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .intro-product-desc {
            font-size: 0.8em;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .intro-product-price {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        .intro-product-margin {
            font-size: 0.9em;
            color: var(--text-primary);
            margin-top: 4px;
            padding: 6px 10px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 8px;
            margin-top: 8px;
        }
        .intro-roles {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }
        .intro-role {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px 18px;
            transition: all 0.3s ease;
        }
        .intro-role:hover {
            border-color: var(--accent-primary);
            transform: translateX(8px);
        }
        .intro-role-icon {
            font-size: 1.8em;
            width: 50px;
            text-align: center;
        }
        .intro-role strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 2px;
        }
        .intro-role-desc {
            font-size: 0.85em;
            color: var(--text-muted);
        }
        .intro-process {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
        }
        .intro-process-step {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .intro-process-step::after {
            content: '‚Üí';
            color: var(--text-muted);
            margin-left: 8px;
        }
        .intro-process-step:last-child::after {
            content: '';
        }
        .btn-start {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 32px auto 0;
            padding: 20px 40px;
            font-size: 1.3em;
            font-weight: 700;
            color: #000;
            background: var(--gradient-primary);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .btn-start:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 48px rgba(99, 102, 241, 0.6);
        }
        
        /* ==================== V0.6.32 - AM√âLIRATIONS UX ==================== */
        
        /* Quick Stats Bar - Barre de stats rapides toujours visible */
        .quick-stats-bar {
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-elevated) 100%);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .quick-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quick-stat-icon {
            font-size: 1.2em;
        }
        .quick-stat-label {
            font-size: 0.75em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .quick-stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1em;
        }
        .quick-stat-value.positive { color: var(--success); }
        .quick-stat-value.negative { color: var(--danger); }
        .quick-stat-value.warning { color: var(--warning); }
        .quick-stat-value.neutral { color: var(--text-primary); }
        
        /* Decision Assistant Panel */
        .decision-assistant {
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        .decision-assistant::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--gradient-primary);
        }
        .decision-assistant-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .decision-assistant-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: var(--accent-tertiary);
        }
        .decision-assistant-title .icon {
            font-size: 1.4em;
        }
        .decision-assistant-toggle {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 6px 12px;
            color: var(--text-secondary);
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .decision-assistant-toggle:hover {
            background: var(--accent-primary);
            color: white;
        }
        .decision-tips {
            display: grid;
            gap: 12px;
        }
        .decision-tip {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 14px 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            border-left: 3px solid var(--accent-primary);
            font-size: 0.9em;
            line-height: 1.5;
        }
        .decision-tip.warning {
            border-left-color: var(--warning);
            background: rgba(245, 158, 11, 0.08);
        }
        .decision-tip.danger {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.08);
        }
        .decision-tip.success {
            border-left-color: var(--success);
            background: rgba(34, 197, 94, 0.08);
        }
        .decision-tip-icon {
            font-size: 1.3em;
            flex-shrink: 0;
        }
        .decision-tip-content {
            flex: 1;
        }
        .decision-tip-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .decision-tip-text {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        /* Card Filters */
        .card-filters {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-label {
            font-size: 0.8em;
            color: var(--text-muted);
            font-weight: 600;
        }
        .filter-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 8px 14px;
            color: var(--text-secondary);
            font-size: 0.85em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }
        .filter-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }
        .filter-select {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 0.85em;
            cursor: pointer;
        }
        .filter-search {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 8px 14px;
            color: var(--text-primary);
            font-size: 0.85em;
            min-width: 180px;
        }
        .filter-search::placeholder {
            color: var(--text-muted);
        }
        
        /* Card Impact Preview */
        .card-impact-preview {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            padding: 16px;
            min-width: 280px;
            z-index: 100;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }
        .action-card:hover .card-impact-preview {
            opacity: 1;
            visibility: visible;
        }
        .impact-preview-title {
            font-weight: 700;
            color: var(--accent-tertiary);
            margin-bottom: 12px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .impact-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .impact-preview-item {
            background: var(--bg-elevated);
            border-radius: 6px;
            padding: 8px 10px;
            text-align: center;
        }
        .impact-preview-label {
            font-size: 0.7em;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .impact-preview-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.9em;
        }
        .impact-preview-value.positive { color: var(--success); }
        .impact-preview-value.negative { color: var(--danger); }
        .impact-preview-value.neutral { color: var(--text-secondary); }
        
        /* Card Risk Badge */
        .card-risk-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 5;
        }
        .card-risk-badge.high-risk {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        .card-risk-badge.medium-risk {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid var(--warning);
        }
        .card-risk-badge.low-risk {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        .card-risk-badge.best-choice {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3));
            color: var(--accent-tertiary);
            border: 1px solid var(--accent-primary);
            animation: pulse-best 2s infinite;
        }
        @keyframes pulse-best {
            0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 0 12px 4px rgba(99, 102, 241, 0.2); }
        }
        
        /* Card Comparison Mode */
        .comparison-mode-active .action-card {
            cursor: pointer;
        }
        .action-card.selected-for-compare {
            border: 2px solid var(--info) !important;
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3) !important;
        }
        .action-card.selected-for-compare::after {
            content: '‚úì';
            position: absolute;
            top: -8px;
            left: -8px;
            width: 24px;
            height: 24px;
            background: var(--info);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: 700;
        }
        
        /* Comparison Panel */
        .comparison-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 2px solid var(--info);
            padding: 20px;
            z-index: 500;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 -8px 32px rgba(0,0,0,0.4);
        }
        .comparison-panel.active {
            transform: translateY(0);
        }
        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .comparison-title {
            font-weight: 700;
            color: var(--info);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .comparison-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .comparison-card {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-default);
        }
        .comparison-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .comparison-card-emoji {
            font-size: 1.5em;
        }
        .comparison-card-name {
            font-weight: 700;
            flex: 1;
        }
        .comparison-card-cost {
            font-family: 'JetBrains Mono', monospace;
            color: var(--warning);
            font-weight: 700;
        }
        .comparison-metrics {
            display: grid;
            gap: 8px;
        }
        .comparison-metric {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
        }
        .comparison-metric-label {
            color: var(--text-muted);
        }
        .comparison-metric-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        /* Simulation Mode Button */
        .btn-simulate {
            background: linear-gradient(135deg, var(--info), #0ea5e9);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            font-weight: 600;
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn-simulate:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(6, 182, 212, 0.4);
        }
        
        /* Simulation Modal */
        .simulation-results {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
        }
        .simulation-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: start;
        }
        .simulation-before, .simulation-after {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 16px;
        }
        .simulation-before {
            border: 1px solid var(--text-muted);
        }
        .simulation-after {
            border: 1px solid var(--success);
        }
        .simulation-title {
            font-weight: 700;
            margin-bottom: 12px;
            text-align: center;
        }
        .simulation-before .simulation-title {
            color: var(--text-muted);
        }
        .simulation-after .simulation-title {
            color: var(--success);
        }
        .simulation-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            color: var(--accent-primary);
        }
        .simulation-metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9em;
        }
        .simulation-metric-row:last-child {
            border-bottom: none;
        }
        .simulation-change {
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-family: 'JetBrains Mono', monospace;
        }
        .simulation-change.positive {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }
        .simulation-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        /* Strategy Summary Panel */
        .strategy-summary {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .strategy-title {
            font-weight: 700;
            color: var(--accent-tertiary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .strategy-objectives {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        .strategy-objective {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .strategy-objective-label {
            font-size: 0.75em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .strategy-objective-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 1.1em;
        }
        .strategy-objective-status {
            font-size: 0.75em;
            margin-top: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        .strategy-objective-status.on-track {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }
        .strategy-objective-status.at-risk {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }
        .strategy-objective-status.off-track {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        /* Card Recommendation Badge */
        .card-recommendation {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.9);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 0.75em;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.2s;
        }
        .action-card:hover .card-recommendation {
            opacity: 1;
            transform: translateY(0);
        }
        .card-recommendation.recommended {
            border: 1px solid var(--success);
        }
        .card-recommendation.caution {
            border: 1px solid var(--warning);
        }
        
        /* Decision Score */
        .decision-score {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-elevated);
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 10px;
        }
        .decision-score-label {
            font-size: 0.75em;
            color: var(--text-muted);
        }
        .decision-score-bar {
            flex: 1;
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            overflow: hidden;
        }
        .decision-score-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .decision-score-fill.excellent { background: var(--success); }
        .decision-score-fill.good { background: var(--info); }
        .decision-score-fill.medium { background: var(--warning); }
        .decision-score-fill.poor { background: var(--danger); }
        .decision-score-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 0.85em;
        }
        
        /* Impact Timeline in History */
        .impact-timeline {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-default);
        }
        .impact-timeline-title {
            font-weight: 700;
            color: var(--accent-tertiary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .impact-chart {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .quick-stats-bar {
                padding: 10px 14px;
                gap: 12px;
            }
            .quick-stat {
                flex: 1;
                min-width: 100px;
            }
            .card-filters {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-group {
                flex-wrap: wrap;
            }
            .comparison-panel {
                padding: 12px;
            }
            .simulation-comparison {
                grid-template-columns: 1fr;
            }
            .simulation-arrow {
                transform: rotate(90deg);
                padding: 10px 0;
            }
        }
    </style>
</head>
<body>
    <!-- √âcran d'Introduction -->
    <div class="intro-overlay" id="introOverlay">
        <div class="intro-container">
            <div class="intro-header">
                <div class="intro-logo">üèõÔ∏è</div>
                <h1 class="intro-title">Tableau Tactique</h1>
                <p class="intro-subtitle">Serious Game de Management Industriel</p>
            </div>
            
            <!-- CADRE 1 : PR√âSENTATION DE L'ENTREPRISE -->
            <div class="intro-card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15)); border-color: var(--accent-primary);">
                <h2>üèõÔ∏è Bienvenue chez ES Marbres & Granits</h2>
                <p>
                    Vous √™tes <strong>manager de d√©partement</strong> dans une entreprise fran√ßaise leader de la transformation 
                    de pierres naturelles haut de gamme. Depuis 35 ans, ES Marbres & Granits accompagne architectes et 
                    d√©corateurs dans leurs projets les plus prestigieux.
                </p>
                <p style="margin-top: 12px; color: var(--text-secondary);">
                    <strong style="color: var(--accent-primary);">Chaque joueur se voit attribuer un poste</strong> parmi les 5 d√©partements de l'entreprise :
                </p>
                <div class="intro-roles">
                    <div class="intro-role">
                        <span class="intro-role-icon">üíº</span>
                        <div><strong>J1 - Commercial</strong><div class="intro-role-desc">Ventes, prix, mix produits</div></div>
                    </div>
                    <div class="intro-role">
                        <span class="intro-role-icon">üõí</span>
                        <div><strong>J2 - Approvisionnement</strong><div class="intro-role-desc">Fournisseurs, achats, d√©lais</div></div>
                    </div>
                    <div class="intro-role">
                        <span class="intro-role-icon">üöõ</span>
                        <div><strong>J3 - Logistique</strong><div class="intro-role-desc">Transport, stocks, exp√©dition</div></div>
                    </div>
                    <div class="intro-role">
                        <span class="intro-role-icon">üè≠</span>
                        <div><strong>J4 - Production</strong><div class="intro-role-desc">Machines, capacit√©, temps de cycle</div></div>
                    </div>
                    <div class="intro-role">
                        <span class="intro-role-icon">‚úÖ</span>
                        <div><strong>J5 - Qualit√©</strong><div class="intro-role-desc">Inspections, contr√¥les, d√©fauts</div></div>
                    </div>
                </div>
            </div>
            
            <!-- CADRE 2 : LES PRODUITS (MICRO-FLUX) -->
            <div class="intro-card">
                <h2>üíé Nos 2 Produits</h2>
                <p style="margin-bottom: 15px; color: var(--text-secondary);">Chaque produit g√©n√®re une <strong style="color: var(--success);">marge brute</strong> (Prix de Vente - Co√ªt d'Achat)</p>
                <div class="intro-products" style="justify-content: center; gap: 40px;">
                    <div class="intro-product">
                        <div class="intro-product-icon">‚¨ú</div>
                        <div class="intro-product-name">Marbre Standard</div>
                        <div class="intro-product-price">PV: 2.500‚Ç¨</div>
                        <div class="intro-product-margin">Marge: <span style="color: var(--success); font-weight: 700;">1.100‚Ç¨</span></div>
                    </div>
                    <div class="intro-product" style="border-color: var(--accent-primary); background: rgba(99, 102, 241, 0.1);">
                        <div class="intro-product-icon">üíé</div>
                        <div class="intro-product-name">Marbre Premium</div>
                        <div class="intro-product-price">PV: 5.000‚Ç¨ ‚≠ê</div>
                        <div class="intro-product-margin">Marge: <span style="color: var(--success); font-weight: 700;">2.800‚Ç¨</span></div>
                    </div>
                </div>
            </div>
            
            <!-- CADRE 3 : OBJECTIF MANCHE 1 - SILOS -->
            <div class="intro-card" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-color: var(--accent-primary);">
                <h2>üéØ Votre Mission - Manche 1 : Maximiser vos Indicateurs</h2>
                <p style="background: rgba(99, 102, 241, 0.15); padding: 16px; border-radius: 12px; border-left: 4px solid var(--accent-primary); margin-bottom: 16px;">
                    <strong>üìä Indicateurs :</strong> Marge (MRG), Co√ªt de Revient (CR), Budget, Charges Globales d'Exploitation (CGE), Taux de Rendement Global (TRG), Lead Time (LT), Taux de Rebut (TR)
                </p>
                <p>
                    <strong>üíº J1 - Commercial :</strong> Maximisez la <em>Marge</em> en param√©trant le Mix des Ventes (ajustez les QV dans le tableau)
                </p>
                <p>
                    <strong>üõí J2 - Approvisionnement :</strong> Minimisez le <em>Co√ªt de Revient (CR)</em> en optimisant les D√©penses d'Achat (DA) et votre Budget
                </p>
                <p>
                    <strong>üöõ J3 - Logistique :</strong> Minimisez les <em>CGE</em> (Charges Globales d'Exploitation)
                </p>
                <p>
                    <strong>üè≠ J4 - Production :</strong> Pilotez par le <em>GOULET</em> ! La machine √† 100% donne le rythme. N'augmentez pas les autres b√™tement.
                </p>
                <p>
                    <strong>‚úÖ J5 - Qualit√© :</strong> Maximisez la <em>Conformit√© (1-TR)</em> en r√©duisant le Taux de Rebut et le Lead Time
                </p>
                <p style="margin-top: 12px; padding: 12px; background: var(--bg-elevated); border-radius: 10px;">
                    <strong>üéÆ Budget : 300 points PARTAG√âS par l'√©quipe</strong> - Chaque carte a un co√ªt. D√©pensez judicieusement !
                </p>
                <p style="text-align: center; margin-top: 16px; padding: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(99, 102, 241, 0.15)); border-radius: 12px; border: 1px solid var(--accent-secondary);">
                    <em style="color: var(--accent-secondary); font-weight: 600; font-size: 1.05em;">üîÆ Dans une entreprise, rien n'est isol√©... Vos d√©cisions pourraient bien avoir des r√©percussions insoup√ßonn√©es.</em>
                </p>
                <p style="text-align: center; margin-top: 12px; padding: 10px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; font-size: 0.9em;">
                    üí° <strong>Astuce :</strong> Survolez ou cliquez sur les termes <span class="tooltip-term" data-tooltip="Comme ceci ! Les bulles d'information vous aident √† comprendre les termes techniques du jeu." style="border-bottom: 1px dashed var(--accent-primary); color: var(--accent-primary);">soulign√©s</span> pour comprendre leur signification.
                </p>
            </div>
            
            <button class="btn-start" onclick="startGame()">
                üöÄ Commencer la Simulation
            </button>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Bouton D√©veloppeur -->
    <div class="dev-button" onclick="toggleDevPanel()">üõ†Ô∏è</div>
    
    <!-- Panel D√©veloppeur -->
    <div class="dev-panel" id="devPanel">
        <div class="dev-header">
            <h3>üõ†Ô∏è Panel D√©veloppeur / Admin</h3>
            <button class="dev-close" onclick="toggleDevPanel()">‚úï</button>
        </div>
        
        <!-- Onglets du panel -->
        <div class="dev-tabs" style="display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap;">
            <button onclick="showDevTab('controles')" class="dev-tab-btn active" data-tab="controles">‚öôÔ∏è Contr√¥les</button>
            <button onclick="showDevTab('donnees')" class="dev-tab-btn" data-tab="donnees">üìä Donn√©es</button>
            <button onclick="showDevTab('machines')" class="dev-tab-btn" data-tab="machines">üè≠ Machines</button>
            <button onclick="showDevTab('cartes')" class="dev-tab-btn" data-tab="cartes">üÉè Cartes</button>
        </div>
        
        <!-- TAB: Contr√¥les -->
        <div class="dev-tab-content" id="devTab-controles">
            <div class="dev-section">
                <h4>‚öôÔ∏è Navigation Manches</h4>
                <div class="dev-controls">
                    <button onclick="setManche(1)" class="dev-btn">Manche 1</button>
                    <button onclick="setManche(2)" class="dev-btn">Manche 2 (RBE)</button>
                    <button onclick="setManche(3)" class="dev-btn">Manche 3 (PIG)</button>
                </div>
                <div class="dev-controls" style="margin-top: 8px;">
                    <button onclick="forceAllReady()" class="dev-btn green">‚úì Tous Pr√™ts</button>
                    <button onclick="forceAllCompris()" class="dev-btn green" id="btnAllCompris" style="display:none;">‚úì Tous Compris</button>
                    <button onclick="skipDebriefing()" class="dev-btn" id="btnSkipDebriefing" style="display:none;">‚è≠Ô∏è Skip D√©briefing</button>
                </div>
                <div class="dev-controls" style="margin-top: 8px;">
                    <button onclick="resetGame()" class="dev-btn red">üîÑ Reset Jeu</button>
                    <button onclick="showIntro()" class="dev-btn">üìñ Voir Intro</button>
                </div>
            </div>
            
            <div class="dev-section">
                <h4>üéÆ Syst√®me de Tours (Manche 1)</h4>
                <div id="devToursStatus" style="font-size: 0.85em; margin-bottom: 10px;"></div>
                <div class="dev-controls">
                    <button onclick="devSetJoueur(1)" class="dev-btn">J1</button>
                    <button onclick="devSetJoueur(2)" class="dev-btn">J2</button>
                    <button onclick="devSetJoueur(3)" class="dev-btn">J3</button>
                    <button onclick="devSetJoueur(4)" class="dev-btn">J4</button>
                    <button onclick="devSetJoueur(5)" class="dev-btn">J5</button>
                </div>
                <div class="dev-controls" style="margin-top: 8px;">
                    <button onclick="devResetTours()" class="dev-btn">üîÑ Reset Tours</button>
                    <button onclick="devFinManche1()" class="dev-btn red">‚è≠Ô∏è Forcer Fin M1</button>
                </div>
            </div>
            
            <div class="dev-section">
                <h4>üëÅÔ∏è Options d'affichage</h4>
                <label class="dev-toggle">
                    <input type="checkbox" id="devModeToggle" onchange="toggleDevMode()">
                    <span>Voir indicateurs cach√©s (VAG, CGE, RBE)</span>
                </label>
                <label class="dev-toggle">
                    <input type="checkbox" id="vsmUnlockToggle" onchange="toggleVSMUnlock()">
                    <span>D√©bloquer VSM en Manche 1</span>
                </label>
                <label class="dev-toggle">
                    <input type="checkbox" id="infiniteBudgetToggle" onchange="toggleInfiniteBudget()">
                    <span>Budget infini</span>
                </label>
                <label class="dev-toggle">
                    <input type="checkbox" id="cardHelpToggle" onchange="toggleCardHelp()">
                    <span>Aide sur cartes (badges + scores)</span>
                </label>
            </div>
        </div>
        
        <!-- TAB: Donn√©es -->
        <div class="dev-tab-content" id="devTab-donnees" style="display: none;">
            <div class="dev-section">
                <h4>üìä Indicateurs √âconomiques</h4>
                <div class="dev-indicators" id="devHiddenIndicators"></div>
            </div>
            
            <div class="dev-section">
                <h4>üéöÔ∏è Modifier SQR (Manche 3)</h4>
                <p style="font-size: 0.75em; opacity: 0.7; margin-bottom: 10px;">S, R, Q plafonn√©s √† 95%</p>
                <div class="dev-sliders">
                    <div class="dev-slider-row">
                        <label>s (Vitesse)</label>
                        <input type="range" min="0" max="95" id="sliderS" onchange="updateHiddenFromSlider('s', this.value)">
                        <span id="valueS">60%</span>
                    </div>
                    <div class="dev-slider-row">
                        <label>q (Satisfaction)</label>
                        <input type="range" min="0" max="95" id="sliderQ" onchange="updateHiddenFromSlider('q', this.value)">
                        <span id="valueQ">70%</span>
                    </div>
                    <div class="dev-slider-row">
                        <label>r (Environnement)</label>
                        <input type="range" min="0" max="95" id="sliderR" onchange="updateHiddenFromSlider('r', this.value)">
                        <span id="valueR">55%</span>
                    </div>
                </div>
            </div>
            
            <div class="dev-section">
                <h4>üí∞ Budgets</h4>
                <div class="dev-budgets" id="devBudgets"></div>
                <button onclick="resetBudgets()" class="dev-btn" style="margin-top: 10px;">üîÑ Reset budgets</button>
            </div>
            
            <div class="dev-section">
                <h4>üí∏ CGE (Charges Globales)</h4>
                <div class="dev-cge" id="devCGE"></div>
            </div>
        </div>
        
        <!-- TAB: Machines -->
        <div class="dev-tab-content" id="devTab-machines" style="display: none;">
            <div class="dev-section">
                <h4>üè≠ √âtat des Machines</h4>
                <div id="devMachinesStatus"></div>
            </div>
            
            <div class="dev-section">
                <h4>üì¶ Mix des Ventes</h4>
                <div id="devSalesControls"></div>
            </div>
            
            <div class="dev-section">
                <h4>üó∫Ô∏è Aper√ßu VSM</h4>
                <div class="dev-vsm" id="devVSM"></div>
            </div>
        </div>
        
        <!-- TAB: Cartes -->
        <div class="dev-tab-content" id="devTab-cartes" style="display: none;">
            <div class="dev-section">
                <h4>üÉè Cartes Jou√©es</h4>
                <div class="dev-cards" id="devCards"></div>
                <button onclick="resetAllCards()" class="dev-btn red" style="margin-top: 10px;">üóëÔ∏è Supprimer toutes les cartes</button>
            </div>
        </div>
    </div>
    
    <style>
        /* Bouton Dev */
        .dev-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 52px;
            height: 52px;
            border-radius: 14px;
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            z-index: 999;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }
        .dev-button:hover { 
            transform: scale(1.08);
            border-color: var(--info);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
        }
        
        /* Panel Dev */
        .dev-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 420px;
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--accent-primary);
            z-index: 1002;
            overflow-y: auto;
            transition: right 0.3s ease;
            box-shadow: -8px 0 40px rgba(0,0,0,0.5);
        }
        .dev-panel.open { right: 0; }
        .dev-panel::-webkit-scrollbar { width: 8px; }
        .dev-panel::-webkit-scrollbar-track { background: var(--bg-card); }
        .dev-panel::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 10px; }
        
        .dev-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-default);
            background: var(--bg-card);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .dev-header h3 { font-size: 1.1em; color: var(--text-primary); }
        .dev-close {
            background: var(--danger);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .dev-close:hover { transform: scale(1.1); }
        
        .dev-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .dev-section h4 {
            font-size: 0.8em;
            margin-bottom: 12px;
            color: var(--info);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .dev-controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .dev-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .dev-btn:hover { background: var(--bg-card); border-color: var(--border-strong); }
        .dev-btn.green { background: rgba(34, 197, 94, 0.2); border-color: var(--success); color: var(--success); }
        .dev-btn.green:hover { background: rgba(34, 197, 94, 0.3); }
        .dev-btn.red { background: rgba(239, 68, 68, 0.2); border-color: var(--danger); color: var(--danger); }
        .dev-btn.red:hover { background: rgba(239, 68, 68, 0.3); }
        
        /* Onglets du panel dev */
        .dev-tab-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .dev-tab-btn:hover { background: var(--bg-card); }
        .dev-tab-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }
        .dev-tab-content { display: block; }
        
        .dev-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            cursor: pointer;
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .dev-toggle:hover { color: var(--text-primary); }
        .dev-toggle input { 
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }
        
        .dev-indicators {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .dev-indicator {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-subtle);
        }
        .dev-indicator-label { font-size: 0.7em; color: var(--text-muted); margin-bottom: 4px; }
        .dev-indicator-value { font-size: 1.1em; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        .dev-indicator-value.critical { color: var(--danger); }
        .dev-indicator-value.warning { color: var(--warning); }
        .dev-indicator-value.good { color: var(--success); }
        
        .dev-slider-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .dev-slider-row label { width: 100px; font-size: 0.8em; color: var(--text-secondary); }
        .dev-slider-row input[type="range"] { 
            flex: 1;
            accent-color: var(--accent-primary);
        }
        .dev-slider-row span { width: 50px; text-align: right; font-family: 'JetBrains Mono', monospace; font-size: 0.85em; color: var(--text-primary); }
        
        .dev-budgets {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .dev-budget-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
        }
        .dev-budget-row input {
            width: 100px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
        }
        .dev-budget-row input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        .dev-vsm {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding: 12px 0;
        }
        .dev-vsm::-webkit-scrollbar { height: 6px; }
        .dev-vsm::-webkit-scrollbar-track { background: var(--bg-card); border-radius: 10px; }
        .dev-vsm::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 10px; }
        .dev-vsm-box {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: 10px;
            padding: 10px;
            min-width: 75px;
            text-align: center;
            font-size: 0.75em;
        }
        .dev-vsm-box .emoji { font-size: 1.3em; }
        .dev-vsm-box .name { font-size: 0.65em; margin: 4px 0; color: var(--text-secondary); }
        .dev-vsm-box .metrics { font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        
        .dev-cards {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 160px;
            overflow-y: auto;
        }
        .dev-cards::-webkit-scrollbar { width: 6px; }
        .dev-cards::-webkit-scrollbar-track { background: var(--bg-card); border-radius: 10px; }
        .dev-cards::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 10px; }
        .dev-card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }
    </style>
    
    <!-- Modal R√©v√©lation - Message de la Direction -->
    <div class="modal-overlay" id="revelationModal">
        <div class="modal-content alert-manche1" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
            <h2>üì® MESSAGE DE LA DIRECTION G√âN√âRALE</h2>
            <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent-primary); margin-bottom: 20px;">
                <p style="font-style: italic; color: var(--text-secondary); margin: 0 0 12px 0;">¬´ Chers managers,</p>
                <p style="font-size: 1.1em; margin: 0;"><strong>Je viens de consulter les r√©sultats de vos d√©partements.</strong> Chacun d'entre vous a optimis√© ses propres indicateurs avec z√®le... mais regardons ensemble ce qui s'est pass√© pour l'entreprise. ¬ª</p>
            </div>
            <div class="modal-stats" id="modalStats"></div>
            
            <!-- Bilan par joueur -->
            <div style="margin: 24px 0;">
                <h3 style="color: var(--warning); margin-bottom: 16px;">üìã Bilan par Service</h3>
                <div style="display: grid; gap: 12px;">
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 14px 18px; border-radius: 10px; border-left: 3px solid var(--success);">
                        <strong style="color: var(--success);">üíº J1 - Commercial :</strong> 
                        <span style="color: var(--text-secondary);">Vous avez maximis√© la Marge... mais √† quel prix pour la capacit√© de production ?</span>
                    </div>
                    <div style="background: rgba(239, 68, 68, 0.1); padding: 14px 18px; border-radius: 10px; border-left: 3px solid var(--danger);">
                        <strong style="color: var(--danger);">üõí J2 - Approvisionnement :</strong> 
                        <span style="color: var(--text-secondary);">Vos √©conomies sur le CR ont-elles impact√© les d√©lais et la qualit√© ?</span>
                    </div>
                    <div style="background: rgba(99, 102, 241, 0.1); padding: 14px 18px; border-radius: 10px; border-left: 3px solid var(--accent-primary);">
                        <strong style="color: var(--accent-primary);">üöõ J3 - Logistique :</strong> 
                        <span style="color: var(--text-secondary);">Votre ratio Budget/CGE est-il viable √† long terme ?</span>
                    </div>
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 14px 18px; border-radius: 10px; border-left: 3px solid var(--warning);">
                        <strong style="color: var(--warning);">üè≠ J4 - Production :</strong> 
                        <span style="color: var(--text-secondary);">Le TRG est important, mais le taux de rebut a-t-il augment√© ?</span>
                    </div>
                    <div style="background: rgba(6, 182, 212, 0.1); padding: 14px 18px; border-radius: 10px; border-left: 3px solid var(--info);">
                        <strong style="color: var(--info);">‚úÖ J5 - Qualit√© :</strong> 
                        <span style="color: var(--text-secondary);">Votre taux de conformit√© (1-TR) refl√®te-t-il la r√©alit√© du terrain ?</span>
                    </div>
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)); border: 2px solid var(--accent-primary); border-radius: 16px; padding: 24px; margin: 24px 0;">
                <p style="color: var(--accent-primary); font-weight: 700; font-size: 1.05em; margin-bottom: 12px;">üìã NOUVELLES DIRECTIVES DU DG</p>
                <p style="color: var(--text-secondary); margin: 0; font-size: 1em; font-style: italic;">¬´ Avant de continuer, je vous demande de consulter l'historique de toutes les d√©cisions prises. Analysez les <strong>impacts globaux cach√©s</strong> de chaque carte. En Manche 2, vous devrez travailler <strong>ENSEMBLE</strong> pour redresser la barre avec des outils Lean. ¬ª</p>
            </div>
            <button class="btn-modal" onclick="closeModalAndGoToHistory()" style="font-size: 1.1em; padding: 20px 48px;">üìú Consulter l'Historique</button>
        </div>
    </div>
    
    <!-- Modal D√©briefing M2 vers M3 -->
    <div class="modal-overlay" id="revelationModalM2">
        <div class="modal-content alert-manche2" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
            <h2>üì® MESSAGE DE LA DIRECTION - BILAN MANCHE 2</h2>
            <div style="background: rgba(34, 197, 94, 0.1); padding: 20px; border-radius: 12px; border-left: 4px solid var(--success); margin-bottom: 20px;">
                <p style="font-style: italic; color: var(--text-secondary); margin: 0 0 12px 0;">¬´ Chers managers,</p>
                <p style="font-size: 1.1em; margin: 0;"><strong>Votre collaboration commence √† porter ses fruits.</strong> Les outils Lean ont permis d'am√©liorer nos processus. Voici l'√©volution de nos indicateurs √©conomiques. ¬ª</p>
            </div>
            <div class="modal-stats" id="modalStatsM2"></div>
            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 139, 250, 0.2)); border: 2px solid var(--accent-secondary); border-radius: 16px; padding: 24px; margin: 24px 0;">
                <p style="color: var(--accent-secondary); font-weight: 700; font-size: 1.05em; margin-bottom: 12px;">üåø PROCHAINE √âTAPE : MANCHE 3 - PERFORMANCE GLOBALE</p>
                <p style="color: var(--text-secondary); margin: 0; font-size: 1em; font-style: italic;">¬´ En Manche 3, nous allons nous concentrer sur la <strong>Performance Interactionnelle Globale (PIG)</strong> : r√©activit√© (s), qualit√© (q) et responsabilit√© environnementale (r). L'excellence op√©rationnelle est √† port√©e de main ! ¬ª</p>
            </div>
            <button class="btn-modal" onclick="passerManche3()" style="font-size: 1.1em; padding: 20px 48px;">üöÄ Passer √† la Manche 3</button>
        </div>
    </div>
    
    <!-- Modal R√©sultats Finaux -->
    <div class="modal-overlay" id="finalResultsModal">
        <div class="modal-content final-results">
            <div class="final-header">
                <div class="trophy">üèÜ</div>
                <h2>R√âSULTATS FINAUX</h2>
                <p>Simulation termin√©e - Voici le bilan de votre transformation Lean & Green</p>
            </div>
            
            <div class="final-comparison" id="finalComparison"></div>
            
            <div class="final-evolution" id="finalEvolution"></div>
            
            <div class="final-lessons">
                <h3>üìö Enseignements Cl√©s</h3>
                <div id="finalLessons"></div>
            </div>
            
            <div class="final-actions">
                <button class="btn-modal" onclick="closeFinalResults()">üîÑ Rejouer</button>
                <button class="btn-modal secondary" onclick="exportFinalReport()">üì• Exporter le Rapport</button>
            </div>
            
            <div class="final-credits" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-subtle); text-align: center; font-size: 0.85em; color: var(--text-muted);">
                <p style="margin-bottom: 8px;">üéì <strong>Jeu cr√©√© par</strong></p>
                <p style="color: var(--text-secondary); font-weight: 600;">
                    <a href="https://www.linkedin.com/in/david-renaud9/" target="_blank" style="color: var(--accent-primary); text-decoration: none; transition: opacity 0.2s;">David</a>, 
                    <a href="https://www.linkedin.com/in/liaalves/" target="_blank" style="color: var(--accent-primary); text-decoration: none; transition: opacity 0.2s;">Lia</a>, 
                    <a href="https://www.linkedin.com/in/let%C3%ADcia-godoi/" target="_blank" style="color: var(--accent-primary); text-decoration: none; transition: opacity 0.2s;">Leticia</a>, 
                    <a href="https://www.linkedin.com/in/murilo-ricardo-lago/" target="_blank" style="color: var(--accent-primary); text-decoration: none; transition: opacity 0.2s;">Murilo</a> & 
                    <a href="https://www.linkedin.com/in/karsten-kill-a8aa391a2/" target="_blank" style="color: var(--accent-primary); text-decoration: none; transition: opacity 0.2s;">Karsten</a>
                </p>
                <p style="margin-top: 8px;">√âtudiants A25 du cours <strong>GP28 - Excellence Industrielle</strong></p>
                <p style="margin-top: 4px;">Sous la direction du Professeur <a href="https://www.linkedin.com/in/josegramdi/" target="_blank" style="color: var(--accent-primary); text-decoration: none; font-weight: 700; transition: opacity 0.2s;">Jos√© Gramdi</a></p>
                <p style="margin-top: 12px; font-size: 0.9em; opacity: 0.7;">UTT - Universit√© de Technologie de Troyes</p>
            </div>
        </div>
    </div>
    
    <!-- Modal S√©lection de Cible -->
    <div class="modal-overlay" id="targetModal">
        <div class="modal-content target-selection">
            <h2 id="targetModalTitle">üéØ Choisir la cible</h2>
            <p id="targetModalDesc">Sur quel √©l√©ment appliquer cette am√©lioration ?</p>
            <div class="target-grid" id="targetGrid"></div>
            <div class="target-actions">
                <button class="btn-modal secondary" onclick="cancelTargetSelection()">Annuler</button>
            </div>
        </div>
    </div>
    
    <!-- Modal S√©lection du Joueur -->
    <div class="modal-overlay" id="playerSelectModal">
        <div class="modal-content" style="max-width: 550px;">
            <h2 style="text-align: center; margin-bottom: 8px;">üë§ Choisissez votre poste</h2>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 24px;">S√©lectionnez le d√©partement que vous allez g√©rer</p>
            
            <div class="player-select-grid" style="display: flex; flex-direction: column; gap: 12px;">
                <button class="player-select-btn" onclick="selectPlayer(1)" style="display: flex; align-items: center; gap: 16px; padding: 16px 20px; background: var(--bg-elevated); border: 2px solid var(--border-subtle); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left;">
                    <span style="font-size: 2em;">üíº</span>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1em; color: var(--text-primary);">J1 - Commercial</div>
                        <div style="font-size: 0.85em; color: var(--text-muted);">Ventes, prix, mix produits</div>
                    </div>
                </button>
                
                <button class="player-select-btn" onclick="selectPlayer(2)" style="display: flex; align-items: center; gap: 16px; padding: 16px 20px; background: var(--bg-elevated); border: 2px solid var(--border-subtle); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left;">
                    <span style="font-size: 2em;">üõí</span>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1em; color: var(--text-primary);">J2 - Approvisionnement</div>
                        <div style="font-size: 0.85em; color: var(--text-muted);">Fournisseurs, achats, d√©lais</div>
                    </div>
                </button>
                
                <button class="player-select-btn" onclick="selectPlayer(3)" style="display: flex; align-items: center; gap: 16px; padding: 16px 20px; background: var(--bg-elevated); border: 2px solid var(--border-subtle); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left;">
                    <span style="font-size: 2em;">üöõ</span>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1em; color: var(--text-primary);">J3 - Logistique</div>
                        <div style="font-size: 0.85em; color: var(--text-muted);">Transport, stocks, exp√©dition</div>
                    </div>
                </button>
                
                <button class="player-select-btn" onclick="selectPlayer(4)" style="display: flex; align-items: center; gap: 16px; padding: 16px 20px; background: var(--bg-elevated); border: 2px solid var(--border-subtle); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left;">
                    <span style="font-size: 2em;">üè≠</span>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1em; color: var(--text-primary);">J4 - Production</div>
                        <div style="font-size: 0.85em; color: var(--text-muted);">Machines, capacit√©, temps de cycle</div>
                    </div>
                </button>
                
                <button class="player-select-btn" onclick="selectPlayer(5)" style="display: flex; align-items: center; gap: 16px; padding: 16px 20px; background: var(--bg-elevated); border: 2px solid var(--border-subtle); border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left;">
                    <span style="font-size: 2em;">‚úÖ</span>
                    <div>
                        <div style="font-weight: 700; font-size: 1.1em; color: var(--text-primary);">J5 - Qualit√©</div>
                        <div style="font-size: 0.85em; color: var(--text-muted);">Inspections, contr√¥les, d√©fauts</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="game-header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>üìã TABLEAU TACTIQUE <span style="font-size: 0.5em; opacity: 0.7; font-weight: 400;">v0.6.32</span></h1>
                    <div style="font-size: 0.85em; opacity: 0.8;">ES Marbres & Granits - Simulation de Management</div>
                </div>
                <div class="controls">
                    <div class="control-group" id="selectJoueurGroup">
                        <div class="control-label">Joueur Actuel</div>
                        <div id="currentPlayerDisplay" style="font-weight: 700; font-size: 1.1em; color: var(--accent-primary); padding: 8px 16px; background: rgba(99, 102, 241, 0.15); border-radius: 8px;">J1 - Commercial</div>
                        <select id="selectJoueur" style="display: none;" onchange="changeJoueur()">
                            <option value="1">J1 - Commercial</option>
                            <option value="2">J2 - Approvisionnement</option>
                            <option value="3">J3 - Logistique</option>
                            <option value="4">J4 - Production</option>
                            <option value="5">J5 - Qualit√©</option>
                        </select>
                    </div>
                    <!-- Masqu√© : manche, TRG, budget sont affich√©s ailleurs -->
                    <div class="manche-badge" id="mancheBadge" style="display: none;">Manche 1</div>
                    <div class="player-badge" id="playerBadge" style="display: none;">J1</div>
                    <div class="kpi-badge" id="kpiBadge" style="display: none;">TRG: 85%</div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" id="navDashboard" onclick="showPage('dashboard')">üéØ Mon Poste</div>
            <div class="nav-tab" id="navVSM" onclick="showPage('vsm')">üó∫Ô∏è VSM</div>
            <div class="nav-tab" id="navRanking" onclick="showPage('ranking')">üìä Performance</div>
            <div class="nav-tab" id="navHistory" onclick="showPage('history')">üìú Historique</div>
        </div>
        
        <!-- Page Dashboard -->
        <div id="dashboard" class="page active">
            <!-- Hidden Indicators (Manche 2+) -->
            <div class="hidden-panel" id="hiddenPanel" style="display: none;">
                <h3>‚ö†Ô∏è INDICATEURS R√âV√âL√âS - Performance R√©elle de l'Entreprise</h3>
                <div class="hidden-grid" id="hiddenGrid"></div>
            </div>
            
            <!-- Collaborative Notice (Manche 2) -->
            <div class="collab-notice" id="collabNotice" style="display: none;">
                <h3>ü§ù MODE COLLABORATION ACTIV√â</h3>
                <p>Toutes les cartes sont maintenant communes. Budget partag√© : <strong id="budgetCommun">50 pts</strong></p>
                <p>D√©cidez ENSEMBLE pour maximiser l'am√©lioration de la PIG !</p>
            </div>
            
            <!-- V0.6.32 - Quick Stats Bar -->
            <div class="quick-stats-bar" id="quickStatsBar"></div>
            
            <!-- V0.6.32 - Decision Assistant -->
            <div class="decision-assistant" id="decisionAssistant">
                <div class="decision-assistant-header">
                    <div class="decision-assistant-title">
                        <span class="icon">üß†</span>
                        <span>Assistant de D√©cision</span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="decision-assistant-toggle" onclick="uxState.showAssistant = !uxState.showAssistant; render();">
                            Masquer
                        </button>
                    </div>
                </div>
                <div class="decision-tips" id="assistantTips"></div>
            </div>
            
            <!-- Section Mix des Ventes - Visible pour tous les joueurs en Manche 1 -->
            <div class="sales-section" id="salesSection" style="display: none;">
                <div class="section-header">
                    <div class="section-title">
                        <div class="title-icon">üì¶</div>
                        <span>Mix des Ventes - Quantit√©s √† Produire</span>
                    </div>
                </div>
                <div id="salesGrid" class="sales-grid"></div>
                <div id="salesGouletWarning" class="sales-goulet-warning"></div>
            </div>
            
            <!-- Section Poste du Joueur -->
            <div class="poste-section" id="posteSection"></div>
            
            <!-- Stats Row - Indicateurs sp√©cifiques au joueur -->
            <div class="stats-row" id="statsRow"></div>
            
            <!-- Main Grid -->
            <div class="main-grid">
                <!-- Process Info / Mini Ranking -->
                <div class="board-section">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="title-icon">üìä</div>
                            <span id="infoTitle">Mes Processus</span>
                        </div>
                    </div>
                    <div id="processInfo"></div>
                    
                    <!-- Mini Classement -->
                    <div class="ranking-mini">
                        <h4>üìä Performance de l'√âquipe</h4>
                        <div id="miniRanking"></div>
                    </div>
                </div>
                
                <!-- Cards Panel -->
                <div class="board-section">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="title-icon">‚ö°</div>
                            <span id="cardsTitle">Cartes Am√©lioration</span>
                        </div>
                        <div id="budgetDisplay" style="font-weight: 700; color: var(--yellow);"></div>
                    </div>
                    <!-- V0.6.32 - Card Filters -->
                    <div class="card-filters" id="cardFilters"></div>
                    <div class="cards-grid" id="cardsGrid"></div>
                </div>
            </div>
            
            <!-- Ready Section -->
            <div class="ready-section">
                <div class="ready-status" id="readyStatus"></div>
                <button class="btn-ready" id="btnReady" onclick="toggleReady()">
                    ‚úì Pr√™t pour la manche suivante
                </button>
            </div>
        </div>
        
        <!-- Page VSM -->
        <div id="vsm" class="page">
            <div class="board-section">
                <div id="vsmContent"></div>
            </div>
        </div>
        
        <!-- Page Ranking -->
        <div id="ranking" class="page">
            <div class="board-section">
                <div class="section-header">
                    <div class="section-title">
                        <div class="title-icon">üìä</div>
                        <span>Performance de l'√âquipe - Indicateurs par Service</span>
                    </div>
                </div>
                <div class="full-ranking" id="fullRanking"></div>
            </div>
        </div>
        
        <!-- Page Historique -->
        <div id="history" class="page">
            <div class="board-section">
                <div class="section-header">
                    <div class="section-title">
                        <div class="title-icon">üìú</div>
                        <span>Historique des D√©cisions</span>
                    </div>
                    <button class="history-export-btn" onclick="exportHistory()">üì• Exporter CSV</button>
                </div>
                
                <!-- Filtres -->
                <div class="history-filters">
                    <div class="filter-group">
                        <span class="filter-label">Manche</span>
                        <select class="filter-select" id="filterManche" onchange="renderHistorique()">
                            <option value="all">Toutes</option>
                            <option value="1">Manche 1</option>
                            <option value="2">Manche 2 (Collab)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Joueur</span>
                        <select class="filter-select" id="filterJoueur" onchange="renderHistorique()">
                            <option value="all">Tous</option>
                            <option value="1">J1 - Commercial</option>
                            <option value="2">J2 - Approvisionnement</option>
                            <option value="3">J3 - Logistique</option>
                            <option value="4">J4 - Production</option>
                            <option value="5">J5 - Qualit√©</option>
                            <option value="commun">Commun (Manche 2)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Type d'impact</span>
                        <select class="filter-select" id="filterImpact" onchange="renderHistorique()">
                            <option value="all">Tous</option>
                            <option value="negative">Impacts n√©gatifs cach√©s</option>
                            <option value="positive">Am√©liorations Lean/Green</option>
                        </select>
                    </div>
                </div>
                
                <!-- Statistiques -->
                <div class="history-stats" id="historyStats"></div>
                
                <!-- Section D√©briefing (visible uniquement en phase d√©briefing) -->
                <div class="debriefing-section" id="debriefingSection" style="display: none;">
                    <div class="debriefing-header">
                        <h3>üìã Phase de D√©briefing - Compr√©hension des Erreurs</h3>
                        <p>Analysez l'historique ci-dessous. Chaque joueur doit confirmer sa compr√©hension en cliquant sur son bouton.</p>
                    </div>
                    <div class="debriefing-players" id="debriefingPlayers"></div>
                    <div id="debriefingAction"></div>
                </div>
                
                <!-- Timeline -->
                <div class="history-timeline" id="historyTimeline"></div>
                
                <!-- R√©sum√© des impacts -->
                <div class="impact-summary" id="impactSummary"></div>
            </div>
        </div>
    </div>

    <script>
    // ==================== HELPER FUNCTION ====================
    // Formater les nombres avec des points comme s√©parateurs de milliers
    function formatNum(n) {
        return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
    
    // ==================== SEUILS ET LIMITES (centralis√©s) ====================
    
    const SEUILS = {
        // Seuils pour le goulet/TRG
        goulet: {
            critique: 95,       // Rouge - Surcharge
            alerte: 80,         // Orange - Attention
            avertissement: 70   // Jaune - √Ä surveiller
        },
        // Seuils pour le TRG
        trg: {
            bon: 70,
            moyen: 50
        },
        // Seuils pour la conformit√© (1 - TR)
        conformite: {
            bon: 90,
            moyen: 80
        },
        // Seuils pour le BFR
        bfr: {
            alerte: 90,
            avertissement: 70
        },
        // Seuils pour le Lead Time (jours)
        leadTime: {
            bon: 60,
            moyen: 90
        },
        // Seuils pour le taux de rebut (%)
        rebut: {
            bon: 5,
            moyen: 10
        },
        // Seuils pour le budget
        budgetBas: 30
    };
    
    // Fonction helper pour obtenir la couleur selon les seuils
    function getSeuilColor(valeur, seuils, inverse = false) {
        if (inverse) {
            // Plus bas = mieux (ex: rebut, co√ªts)
            if (valeur <= seuils.bon) return 'var(--success)';
            if (valeur <= seuils.moyen) return 'var(--warning)';
            return 'var(--danger)';
        } else {
            // Plus haut = mieux (ex: TRG, conformit√©)
            if (valeur >= seuils.bon) return 'var(--success)';
            if (valeur >= seuils.moyen) return 'var(--warning)';
            return 'var(--danger)';
        }
    }
    
    function getSeuilClass(valeur, seuils, inverse = false) {
        if (inverse) {
            if (valeur <= seuils.bon) return 'positive';
            if (valeur <= seuils.moyen) return 'warning';
            return 'negative';
        } else {
            if (valeur >= seuils.bon) return 'positive';
            if (valeur >= seuils.moyen) return 'warning';
            return 'negative';
        }
    }
    
    // ==================== CONFIGURATION JOUEURS ====================
    
    // ==================== MICRO-FLUX (PRODUITS) - Donn√©es du tableau Excel ====================
    
    const MICRO_FLUX = {
        MF1: {
            nom: "Marbre Standard",
            emoji: "‚¨ú",
            PV: 2500,           // Prix de vente
            DA: 1400,           // D√©penses d'achat
            tM1: 0.8,           // Temps machine 1 (heures)
            tM2: 1.5,           // Temps machine 2 (heures)
            tM3: 0.4,           // Temps machine 3 (heures)
            tM4: 0.8,           // Temps machine 4 (heures) - GOULET
            tM5: 1.0,           // Temps machine 5 (heures)
            LT: 60,             // Lead Time (jours)
            Tr: 0.08,           // Taux de rebus global (8%)
            delaiClient: 90,    // D√©lai client (jours)
            delaiFournisseur: 60, // D√©lai fournisseur (jours)
            venteMin: 100,
            venteMax: 800,
            QV: 100,            // Quantit√© vendue initiale = minimum (J1 doit d√©finir)
            // Indicateurs SQR par micro-flux (Manche 3)
            s: 0.60,            // Vitesse/r√©activit√©
            q: 0.70,            // Satisfaction client
            r: 0.55             // RSE/Environnement
        },
        MF2: {
            nom: "Marbre Premium",
            emoji: "üíé",
            PV: 5000,           // Prix de vente (premium)
            DA: 2400,           // D√©penses d'achat
            tM1: 1.5,           // Temps machine 1 (heures) - travail plus fin
            tM2: 2.0,           // Temps machine 2 (heures)
            tM3: 1.0,           // Temps machine 3 (heures)
            tM4: 2.5,           // Temps machine 4 (heures) - GOULET (r√©duit pour √©quilibre)
            tM5: 1.8,           // Temps machine 5 (heures)
            LT: 80,             // Lead Time (jours)
            Tr: 0.10,           // Taux de rebus global (10%)
            delaiClient: 120,   // D√©lai client (jours)
            delaiFournisseur: 60, // D√©lai fournisseur (jours)
            venteMin: 100,
            venteMax: 400,
            QV: 100,            // Quantit√© vendue initiale = minimum (J1 doit d√©finir)
            s: 0.50,            // Plus lent (produit complexe)
            q: 0.75,
            r: 0.45             // Plus polluant (mati√®re rare)
        }
    };
    
    // ==================== CO√õTS DE MAINTENANCE PAR MACHINE (‚Ç¨/h) ====================
    
    const MAINTENANCE_MACHINES = {
        M1: 100,    // Co√ªt maintenance machine 1 (‚Ç¨/h)
        M2: 90,     // Co√ªt maintenance machine 2 (‚Ç¨/h)
        M3: 70,     // Co√ªt maintenance machine 3 (‚Ç¨/h)
        M4: 180,    // Co√ªt maintenance machine 4 (‚Ç¨/h) - Goulet (critique)
        M5: 80      // Co√ªt maintenance machine 5 (‚Ç¨/h)
    };
    
    // ==================== CAPACIT√âS MACHINES (heures) ====================
    
    const CAPACITES_MACHINES = {
        M1: 1800,   // Capacit√© machine 1 (heures)
        M2: 1800,   // Capacit√© machine 2 (heures)
        M3: 1200,   // Capacit√© machine 3 (heures)
        M4: 1200,   // Capacit√© machine 4 (heures) - Goulet
        M5: 1500    // Capacit√© machine 5 (heures)
    };
    
    // ==================== TAUX DE L'ARGENT ====================
    
    const TAG = 0.12;  // Taux de l'argent (12%) - Le BFR co√ªte tr√®s cher
    
    // ==================== FORCE DE VENTE MAX ====================
    
    const FORCE_VENTE_MAX = 1500;  // Max = MF1 max (800) + MF2 max (400) + marge
    
    // ==================== MACHINES (5 machines - VSM) ====================
    // Utilise CAPACITES_MACHINES pour √©viter les doublons
    
    const MACHINES = {
        M1: { nom: "M1 - Coupe Initiale", emoji: "‚úÇÔ∏è", capacite: CAPACITES_MACHINES.M1, charge: 0 },
        M2: { nom: "M2 - Polissage", emoji: "‚ú®", capacite: CAPACITES_MACHINES.M2, charge: 0 },
        M3: { nom: "M3 - D√©marcation", emoji: "üìê", capacite: CAPACITES_MACHINES.M3, charge: 0 },
        M4: { nom: "M4 - Coupe Finale", emoji: "üéØ", capacite: CAPACITES_MACHINES.M4, charge: 0 },  // GOULET
        M5: { nom: "M5 - Finition", emoji: "üíé", capacite: CAPACITES_MACHINES.M5, charge: 0 }
    };
    
    // ==================== CONTRAINTES ====================
    
    const CONTRAINTES = {
        BFR_max: 5000000,           // BFR maximum en ‚Ç¨
        BFR_actuel: 0,
        force_vente_max: FORCE_VENTE_MAX,
        force_vente_utilisee: 0,
        taux_argent: TAG             // Taux d'int√©r√™t pour le BFR
    };
    
    // ==================== CHARGES GLOBALES D'EXPLOITATION (CGE) en ‚Ç¨ ====================
    
    const CGE_INITIAL = {
        achats: 900000,             // Charges fixes achats
        vente: 700000,              // Charges fixes vente/commercial
        production: 2900000,        // Charges fixes production
        logistique: 800000,         // Charges fixes logistique
        conception: 1200000         // Charges fixes conception/R&D
    };
    
    // ==================== FORMULES DE CALCUL √âCONOMIQUE (CR TP PIG) ====================
    
    // DAR = DA / (1 - Tr)
    function calculerDAR(mf) {
        return mf.DA / (1 - mf.Tr);
    }
    
    // DMAINT = (M1 * tM1 + M2 * tM2 + M3 * tM3 + M4 * tM4 + M5 * tM5) / (1 - Tr)
    function calculerDMAINT(mf) {
        const maintenanceBrute = MAINTENANCE_MACHINES.M1 * mf.tM1 + 
                                  MAINTENANCE_MACHINES.M2 * mf.tM2 + 
                                  MAINTENANCE_MACHINES.M3 * mf.tM3 +
                                  MAINTENANCE_MACHINES.M4 * mf.tM4 +
                                  MAINTENANCE_MACHINES.M5 * mf.tM5;
        return maintenanceBrute / (1 - mf.Tr);
    }
    
    // BFR = (DAR * LT - D√©lai F * DA + D√©lai C * PV) / 360
    function calculerBFR(mf) {
        const dar = calculerDAR(mf);
        return (dar * mf.LT - mf.delaiFournisseur * mf.DA + mf.delaiClient * mf.PV) / 360;
    }
    
    // DBFR = Tag * BFR
    function calculerDBFR(mf) {
        return TAG * calculerBFR(mf);
    }
    
    // DDP = DAR + DMAINT + DBFR
    function calculerDDP(mf) {
        return calculerDAR(mf) + calculerDMAINT(mf) + calculerDBFR(mf);
    }
    
    // VAG unitaire = PV - DDP
    function calculerVAG(mf) {
        return mf.PV - calculerDDP(mf);
    }
    
    // VAG vente = QV * VAG unitaire
    function calculerVAGVente(mf) {
        return mf.QV * calculerVAG(mf);
    }
    
    // Charge machine = QV * tMi
    function calculerChargeMachine(mfId, machineNum) {
        const mf = gameState.microFlux[mfId];
        const tM = mf[`tM${machineNum}`];
        return mf.QV * tM;
    }
    
    // BFR Total = BFR * QV
    function calculerBFRTotal() {
        let total = 0;
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            total += calculerBFR(mf) * mf.QV;
        }
        return total;
    }
    
    // Force de vente = Œ£ QV
    function calculerForceVente() {
        let total = 0;
        for (const mfId in gameState.microFlux) {
            total += gameState.microFlux[mfId].QV;
        }
        return total;
    }
    
    // CGE Total
    function calculerCGETotal() {
        const cge = gameState.cge;
        const cgeBase = cge.achats + cge.vente + cge.production + cge.logistique + cge.conception;
        
        // Surcout de degradation automatique (couts caches de non-qualite)
        // Bas√© sur TR moyen et LT moyen par rapport aux valeurs initiales
        let trMoyen = 0;
        let ltMoyen = 0;
        let count = 0;
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            trMoyen += mf.Tr;
            ltMoyen += mf.LT;
            count++;
        }
        trMoyen = count > 0 ? trMoyen / count : 0.09;
        ltMoyen = count > 0 ? ltMoyen / count : 70;
        
        // TR initial = 9%, LT initial = 70j
        // Chaque 1% de TR en plus = +50k‚Ç¨ de CGE (rebuts, retouches, r√©clamations)
        // Chaque jour de LT en plus = +3k‚Ç¨ de CGE (stockage, urgences, p√©nalit√©s)
        const surcoutTR = Math.max(0, (trMoyen - 0.09) * 5000000);
        const surcoutLT = Math.max(0, (ltMoyen - 70) * 3000);
        
        return cgeBase + surcoutTR + surcoutLT;
    }
    
    // VAG Total = Œ£ VAG vente
    function calculerVAGTotal() {
        let total = 0;
        for (const mfId in gameState.microFlux) {
            total += calculerVAGVente(gameState.microFlux[mfId]);
        }
        return total;
    }
    
    // RBE = VAG Total - CGE
    function calculerRBE() {
        return calculerVAGTotal() - calculerCGETotal();
    }
    
    // TEG = VAG Total / CGE
    function calculerTEG() {
        const cgeTotal = calculerCGETotal();
        const vagTotal = calculerVAGTotal();
        if (cgeTotal === 0) return 0;
        return vagTotal / cgeTotal;
    }
    
    // Score du Commercial bas√© sur le mix de vente
    // 100% = maximise les meilleures marges, 0% = priorise les pires marges
    function calculerScoreMixCommercial() {
        // Calculer les marges de chaque produit
        const marges = [];
        let totalQV = 0;
        
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            const marge = mf.PV - mf.DA;
            marges.push({ mfId, marge, qv: mf.QV });
            totalQV += mf.QV;
        }
        
        if (totalQV === 0) return 50;
        
        // Trier par marge d√©croissante pour identifier le meilleur et le pire
        marges.sort((a, b) => b.marge - a.marge);
        const margeMax = marges[0].marge;
        const margeMin = marges[marges.length - 1].marge;
        
        if (margeMax === margeMin) return 100; // Toutes les marges √©gales
        
        // Calculer le score pond√©r√©
        // Score = moyenne pond√©r√©e des marges normalis√©es (0-100)
        let scoreTotal = 0;
        for (const m of marges) {
            const margeNormalisee = (m.marge - margeMin) / (margeMax - margeMin); // 0 √† 1
            scoreTotal += margeNormalisee * m.qv;
        }
        
        return (scoreTotal / totalQV) * 100;
    }
    
    // Calculer les recettes totales
    function calculerRecettesTotales() {
        let recettes = 0;
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            recettes += mf.PV * mf.QV;
        }
        return recettes;
    }
    
    // Calculer le ratio Recettes/CGE pour J1
    function calculerRatioRecettesCGE() {
        const recettes = calculerRecettesTotales();
        const cgeJ1 = calculerCGEJoueur(1);
        if (cgeJ1.actuel === 0) return 0;
        return recettes / cgeJ1.actuel;
    }
    
    // CGE par joueur (coh√©rent avec le total)
    // J1 = Achats + Vente + Conception (R&D produits)
    // J2, J4, J5 = Production / 3 (r√©partie entre les 3 machines)
    // J3 = Logistique
    function calculerCGEJoueur(joueur) {
        const cge = gameState.cge;
        const cgeInit = CGE_INITIAL;
        
        switch(joueur) {
            case 1: // Approvisionnement + Conception
                return { 
                    actuel: cge.achats + cge.vente + cge.conception, 
                    initial: cgeInit.achats + cgeInit.vente + cgeInit.conception,
                    label: 'Achats, Vente & Conception'
                };
            case 2: // Production (M1)
            case 4: // Qualit√© (M2)
            case 5: // Commercial (M3)
                // Production divis√©e par 3 pour chaque poste production
                return { 
                    actuel: Math.round(cge.production / 3), 
                    initial: Math.round(cgeInit.production / 3),
                    label: 'Production'
                };
            case 3: // Logistique
                return { 
                    actuel: cge.logistique, 
                    initial: cgeInit.logistique,
                    label: 'Logistique'
                };
            default:
                return { actuel: 0, initial: 0, label: '' };
        }
    }
    
    // Charges par machine (total)
    function calculerChargesTotaleMachine(machineNum) {
        let total = 0;
        for (const mfId in gameState.microFlux) {
            total += calculerChargeMachine(mfId, machineNum);
        }
        return total;
    }
    
    // BFR total par micro-flux
    function calculerBFRTotalMF(mf) {
        return calculerBFR(mf) * mf.QV;
    }
    
    // ==================== CONFIGURATION JOUEURS ====================
    
    const JOUEURS_CONFIG = {
        1: { 
            nom: "Commercial", 
            emoji: "üíº", 
            postes: ["finition"],
            indicateurs: ["mrg", "vol", "bfr"],
            indicateurPhare: "Marge"
        },
        2: { 
            nom: "Approvisionnement", 
            emoji: "üõí", 
            postes: [],
            indicateurs: ["cr", "da", "bfr"],
            indicateurPhare: "CR"
        },
        3: { 
            nom: "Logistique", 
            emoji: "üöõ", 
            postes: ["reception", "expedition"],
            indicateurs: ["cge", "bfr", "vol"],
            indicateurPhare: "Budget/CGE"
        },
        4: { 
            nom: "Production", 
            emoji: "üè≠", 
            postes: ["decoupe_init", "decoupe_final"],
            indicateurs: ["trg", "cap", "tc", "tr"],
            indicateurPhare: "TRG Moyen"
        },
        5: { 
            nom: "Qualit√©", 
            emoji: "‚úÖ", 
            postes: ["polissage", "inspection"],
            indicateurs: ["conformite", "lt", "tr"],
            indicateurPhare: "Conformit√© (1-TR)"
        }
    };
    
    const PROCESSUS_INITIAL = [
        { id: "reception", nom: "R√©ception", emoji: "üéØ", tc: 11, wip: 30, energie: 0.8, eau: 20, op: 2 },
        { id: "decoupe_init", nom: "D√©coupage Initial", emoji: "‚úÇÔ∏è", tc: 17, wip: 80, energie: 3.5, eau: 45, op: 3 },
        { id: "polissage", nom: "Polissage", emoji: "‚ú®", tc: 18, wip: 85, energie: 5.0, eau: 120, op: 4 },
        { id: "decoupe_final", nom: "D√©coupage Final", emoji: "üîß", tc: 15, wip: 65, energie: 2.2, eau: 35, op: 2 },
        { id: "finition", nom: "Finition", emoji: "üé®", tc: 11, wip: 55, energie: 1.3, eau: 30, op: 3 },
        { id: "inspection", nom: "Inspection", emoji: "üîç", tc: 10, wip: 30, energie: 0.5, eau: 5, op: 2 },
        { id: "expedition", nom: "Exp√©dition", emoji: "üì¶", tc: 12, wip: 50, energie: 0.4, eau: 10, op: 2 }
    ];
    
    // ==================== INDICATEURS PAR JOUEUR ====================
    
    const INDICATEURS_JOUEUR_INITIAL = {
        1: { // Approvisionnement
            cout_revient: 100, demandes: 50, pression: 30, remplissage: 75,
            delai_client: 15, delai_fournisseur: 10, bfr: 25000, capital: 100000, trg: 85
        },
        2: { // Production
            trs: 78, rebut: 8, panne: 12, debit: 45, temps_moyen: 16, trg: 82
        },
        3: { // Logistique
            trs: 82, rebut: 5, panne: 8, debit: 60, temps_moyen: 11.5, trg: 86
        },
        4: { // Qualit√©
            trs: 75, rebut: 10, panne: 15, debit: 35, temps_moyen: 18, trg: 79
        },
        5: { // Commercial
            trs: 80, rebut: 6, panne: 10, debit: 50, temps_moyen: 10.5, trg: 84
        }
    };
    
    // ==================== EXPLICATIONS DES INDICATEURS ====================
    // Pour afficher des commentaires explicatifs dans les alertes
    
    const INDICATEURS_EXPLICATIONS = {
        // Indicateurs de co√ªt
        CMP: {
            nom: "Co√ªt Mati√®re Premi√®re",
            augmentation: "‚ö†Ô∏è Augmenter le CMP r√©duit vos marges directement. Chaque euro de plus en mati√®re premi√®re est un euro de moins de profit.",
            diminution: "‚úÖ R√©duire le CMP am√©liore vos marges. Attention cependant aux contreparties cach√©es : qualit√©, d√©lais, d√©pendance fournisseur."
        },
        CGE: {
            nom: "Charges Globales d'Exploitation",
            augmentation: "‚ö†Ô∏è Plus de charges = moins de r√©sultat. Les CGE incluent salaires, loyers, √©nergie, maintenance. Une hausse non justifi√©e p√©nalise la rentabilit√©.",
            diminution: "‚ö†Ô∏è ATTENTION : R√©duire les CGE peut fragiliser l'entreprise ! Les CGE financent la maintenance des machines, la formation des √©quipes et la qualit√© du service. Trop r√©duire = pannes, d√©motivation, perte de clients."
        },
        
        // Indicateurs de temps
        LT: {
            nom: "Lead Time (d√©lai de production)",
            augmentation: "‚ö†Ô∏è Un lead time plus long = plus de stock immobilis√©, plus de BFR, moins de r√©activit√© client. Les clients n'aiment pas attendre.",
            diminution: "‚úÖ R√©duire le lead time am√©liore la r√©activit√© et r√©duit le BFR. L'entreprise peut r√©pondre plus vite aux commandes."
        },
        TC: {
            nom: "Temps de Cycle",
            augmentation: "‚ö†Ô∏è Un temps de cycle plus long = moins de pi√®ces produites par heure. La productivit√© diminue.",
            diminution: "‚úÖ R√©duire le temps de cycle augmente la productivit√©. Attention √† ne pas sacrifier la qualit√© pour aller plus vite."
        },
        DF: {
            nom: "D√©lai Fournisseur",
            augmentation: "‚úÖ Un d√©lai fournisseur plus long vous laisse plus de temps pour payer, ce qui am√©liore votre BFR.",
            diminution: "‚ö†Ô∏è Payer plus vite mobilise votre tr√©sorerie plus t√¥t. Votre BFR augmente."
        },
        
        // Indicateurs de qualit√©
        TD: {
            nom: "Taux de D√©faut",
            augmentation: "‚ö†Ô∏è Plus de d√©fauts = plus de rebuts, plus de reprises, moins de satisfaction client. Les co√ªts cach√©s explosent.",
            diminution: "‚úÖ R√©duire le taux de d√©faut am√©liore la qualit√© per√ßue et r√©duit les co√ªts de non-qualit√© (rebuts, r√©clamations, retours)."
        },
        
        // Indicateurs de volume et marge
        VOL: {
            nom: "Volume des Ventes",
            augmentation: "‚úÖ Plus de volume = plus de chiffre d'affaires. Attention cependant √† la capacit√© de production et au BFR.",
            diminution: "‚ö†Ô∏è Moins de volume = moins de revenus. L'entreprise peut perdre des parts de march√©."
        },
        MRG: {
            nom: "Marge",
            augmentation: "‚úÖ Plus de marge = plus de profit par unit√© vendue. C'est un indicateur cl√© de rentabilit√©.",
            diminution: "‚ö†Ô∏è Moins de marge = moins de profit. Vendre moins cher peut attirer des clients mais √©rode la rentabilit√©."
        },
        
        // Indicateurs de capacit√© et tr√©sorerie
        CAP: {
            nom: "Capacit√© de Production",
            augmentation: "‚úÖ Plus de capacit√© = potentiel de produire plus. Permet de r√©pondre √† une demande croissante.",
            diminution: "‚ö†Ô∏è Moins de capacit√© = risque de ne pas pouvoir honorer les commandes. Le goulet de production se resserre."
        },
        BFR: {
            nom: "Besoin en Fonds de Roulement",
            augmentation: "‚ö†Ô∏è Plus de BFR = plus de tr√©sorerie immobilis√©e dans les stocks et cr√©ances. L'argent dort au lieu de travailler.",
            diminution: "‚úÖ R√©duire le BFR lib√®re de la tr√©sorerie. L'entreprise a plus de liquidit√©s pour investir ou faire face aux impr√©vus."
        }
    };
    
    // Indicateurs cach√©s globaux (s, r, q en ratio 0-1)
    const HIDDEN_INITIAL = {
        s: 0.60,    // Vitesse/r√©activit√© (LTI/LT)
        r: 0.55,    // RSE/Environnement
        q: 0.70,    // Satisfaction client
        pig: 0      // Calcul√© dynamiquement
    };
    
    // Calculer PIG initial
    HIDDEN_INITIAL.pig = calculerPIGStatic(HIDDEN_INITIAL);
    
    // ==================== CARTES MANCHE 1 - SILOS (Optimisation Locale) ====================
    // Cartes bas√©es sur le tableau Excel - organis√©es par joueur
    // Seules les cartes avec Macrofluxo "1" ou "1 e 2" sont incluses ici
    
    // Explications p√©dagogiques pour chaque carte (affich√©es apr√®s la r√©v√©lation)
    const EXPLICATIONS_CARTES = {
        "R1-20": "Vendre en gros volumes avec des remises r√©duit la marge unitaire et immobilise du capital dans les stocks clients.",
        "R1-21": "Se concentrer sur un seul produit surcharge le goulet et r√©duit la capacit√© globale de l'entreprise.",
        "R1-22": "Promettre des d√©lais courts sans moyens cr√©e du stress, des erreurs (TR+) et des co√ªts suppl√©mentaires (CGE+).",
        "R1-23": "Brader les stocks pour lib√©rer du budget d√©truit la marge et la perception de valeur du produit.",
        "R1-24": "Des d√©lais de paiement longs augmentent le cr√©dit client et immobilisent du capital (Budget consomm√©).",
        "R1-30": "Les p√©nalit√©s d'annulation peuvent faire fuir les clients h√©sitants et r√©duire les marges.",
        "R1-1": "Acheter en gros lots r√©duit le co√ªt unitaire mais immobilise beaucoup de capital et r√©duit l'agilit√©.",
        "R1-2": "Un fournisseur moins cher livre souvent plus lentement et avec moins de qualit√© (TR+).",
        "R1-3": "L'international offre des prix bas mais des d√©lais tr√®s longs et une perte de r√©activit√© totale.",
        "R1-4": "Payer plus tard lib√®re du budget mais peut d√©grader la relation fournisseur.",
        "R1-5": "Des lots plus petits sont plus chers mais permettent d'√™tre plus agile et r√©actif.",
        "R1-25": "Anticiper avec du stock cr√©e de l'immobilisation de capital et du risque d'obsolescence.",
        "R1-15": "R√©duire les exp√©ditions baisse les CGE mais allonge les d√©lais pour les clients.",
        "R1-16": "Doubler les lots de transport r√©duit les co√ªts mais cr√©e des stocks interm√©diaires et des d√©lais.",
        "R1-17": "Un transporteur cheap a des d√©lais plus longs et g√©n√®re plus de casse (TR+).",
        "R1-18": "Plus de stock de s√©curit√© √©vite les ruptures mais immobilise du capital.",
        "R1-19": "Moins de stock de s√©curit√© lib√®re du capital mais cr√©e des risques de rupture (Volume-).",
        "R1-29": "Moins d'inventaires = moins de contr√¥le = plus d'erreurs et de pertes non d√©tect√©es (TR+).",
        "R1-6": "Acc√©l√©rer une machine cr√©e plus de d√©fauts si elle n'est pas le goulet. Le flux est limit√© par le goulet !",
        "R1-7": "Acc√©l√©rer M2 sans agir sur le goulet ne fait qu'accumuler du stock devant le goulet.",
        "R1-8": "Acc√©l√©rer M3 avant le goulet cr√©e du WIP inutile qui encombre l'atelier.",
        "R1-9": "Une nouvelle machine co√ªte cher (CGE+) et n'aide que si c'est le goulet qui est renforc√©.",
        "R1-10": "Produire en gros lots r√©duit les changements mais cr√©e d'√©normes stocks et des d√©lais tr√®s longs.",
        "R1-26": "Acc√©l√©rer une machine hors goulet = cr√©er du stock inutile et des d√©fauts.",
        "R1-27": "Investir hors goulet = gaspillage. L'entreprise perd en flexibilit√© et en tr√©sorerie.",
        "R1-28": "Pousser la production cr√©e du stock qui dort et immobilise du capital.",
        "R1-11": "R√©duire les inspections acc√©l√®re mais laisse passer des d√©fauts (TR+) vers le client.",
        "R1-12": "Recycler les rebuts pollue moins mais prend du temps et peut masquer des probl√®mes qualit√©.",
        "R1-13": "Un certificat qualit√© rassure mais le processus de certification co√ªte cher (DA+).",
        "R1-14": "Des crit√®res moins stricts acc√©l√®rent mais d√©gradent la qualit√© per√ßue par le client (TR+)."
    };
    
    const CARTES_MANCHE1 = {
        1: [ // Commercial (J1) - Indicateur: Marge
            {
                id: "R1-20", nom: "Remise sur Volume", emoji: "üíº", cout: 20,
                secteur: "Commercial",
                description: "Accorder une remise aux clients pour les commandes en grande quantit√© afin d'augmenter le volume des ventes.",
                effetVisible: "‚ÜóÔ∏è Volume +20%",
                effetGlobal: "‚ö†Ô∏è Marge -10%, Budget consomm√© 15%",
                VA: 0, NVA: 24, LT_effect: 24,
                impacts: {
                    global: {"QV": 0.2, "PV": -0.1},
                    bfr: 0.15
                }
            },
            {
                id: "R1-21", nom: "Pousser Produit Rentable", emoji: "üíº", cout: 25,
                secteur: "Commercial",
                description: "Concentrer les efforts commerciaux sur le produit le plus rentable de notre gamme.",
                effetVisible: "‚ÜóÔ∏è Marge +10%",
                effetGlobal: "‚ö†Ô∏è Capacit√© -15%",
                VA: 1, NVA: 23, LT_effect: 24,
                impacts: {
                    global: {"PV": 0.1, "CAP": -0.15}
                }
            },
            {
                id: "R1-22", nom: "D√©lai Livraison Agressif", emoji: "üíº", cout: 15,
                secteur: "Commercial",
                description: "Promettre des d√©lais de livraison plus courts aux clients pour remporter des contrats.",
                effetVisible: "‚ÜóÔ∏è Volume +15%",
                effetGlobal: "‚ö†Ô∏è TR +8%, CGE +5%",
                VA: 0, NVA: -24, LT_effect: -24,
                impacts: {
                    global: {"QV": 0.15, "Tr": 0.08, "CGE": 0.05}
                }
            },
            {
                id: "R1-23", nom: "Promo pour R√©duire Stock", emoji: "üíº", cout: 20,
                secteur: "Commercial",
                description: "Lancer une promotion commerciale pour r√©duire rapidement les stocks en entrep√¥t.",
                effetVisible: "‚ÜóÔ∏è Budget lib√©r√© 30%",
                effetGlobal: "‚ö†Ô∏è Marge -15%",
                VA: 2, NVA: -18, LT_effect: -16,
                impacts: {
                    global: {"PV": -0.15},
                    bfr: -0.3
                }
            },
            {
                id: "R1-24", nom: "D√©lai Paiement Client Long", emoji: "üíº", cout: 15,
                secteur: "Commercial",
                description: "Proposer des d√©lais de paiement plus longs aux clients pour augmenter les ventes.",
                effetVisible: "‚ÜóÔ∏è Volume +15%",
                effetGlobal: "‚ö†Ô∏è Budget consomm√© 18%",
                VA: 0, NVA: 16, LT_effect: 16,
                impacts: {
                    global: {"QV": 0.15},
                    bfr: 0.18
                }
            },
            {
                id: "R1-30", nom: "P√©nalit√©s Annulation", emoji: "üíº", cout: 15,
                secteur: "Commercial",
                description: "Appliquer des p√©nalit√©s financi√®res aux clients en cas d'annulation de commande.",
                effetVisible: "‚ÜóÔ∏è Volume +10%",
                effetGlobal: "‚ö†Ô∏è Marge -5%, Budget lib√©r√© 8%",
                VA: 0, NVA: -8, LT_effect: -8,
                impacts: {
                    global: {"QV": 0.1, "PV": -0.05},
                    bfr: -0.08
                }
            }
        ],
        2: [ // Approvisionnement (J2) - Indicateur: Co√ªt de Revient (CR)
            // Note: Pour J2, BFR est affich√© comme "Budget" (Budget = BFR actuel - BFR total)
            {
                id: "R1-1", nom: "Fournisseur Lots+", emoji: "üì¶", cout: 15,
                secteur: "Approvisionnement",
                description: "Le fournisseur propose une remise int√©ressante pour l'achat de lots plus importants de mati√®re premi√®re.",
                effetVisible: "‚ÜòÔ∏è DA -8%",
                effetGlobal: "‚ö†Ô∏è TR +5%, LT +30j, Budget consomm√© 25%",
                VA: 0, NVA: 24, LT_effect: 24,
                impacts: {
                    global: {"DA": -0.08, "Tr": 0.05, "LT": 30},
                    bfr: 0.25,
                    hidden: {s: -0.05, q: -0.03}
                }
            },
            {
                id: "R1-2", nom: "Fournisseur Cheap", emoji: "üì¶", cout: 20,
                secteur: "Approvisionnement",
                description: "Changement vers un fournisseur moins cher mais avec des d√©lais de livraison plus longs.",
                effetVisible: "‚ÜòÔ∏è DA -12%",
                effetGlobal: "‚ö†Ô∏è TR +8%, LT +50j",
                VA: 0, NVA: 120, LT_effect: 120,
                impacts: {
                    global: {"DA": -0.12, "LT": 50, "Tr": 0.08},
                    hidden: {s: -0.08, q: -0.05, r: -0.03}
                }
            },
            {
                id: "R1-3", nom: "Fournisseur International", emoji: "üì¶", cout: 30,
                secteur: "Approvisionnement",
                description: "Nouveau fournisseur international offrant des prix significativement inf√©rieurs sur les mati√®res premi√®res.",
                effetVisible: "‚ÜòÔ∏è DA -20%",
                effetGlobal: "‚ö†Ô∏è TR +12%, LT +80j, Budget consomm√© 20%",
                VA: 0, NVA: 320, LT_effect: 320,
                impacts: {
                    global: {"DA": -0.2, "LT": 80, "Tr": 0.12},
                    bfr: 0.2,
                    hidden: {s: -0.12, q: -0.08, r: -0.10}
                }
            },
            {
                id: "R1-4", nom: "D√©lai Paiement Fournisseur+", emoji: "üì¶", cout: 10,
                secteur: "Approvisionnement",
                description: "N√©gocier des d√©lais de paiement plus longs avec les fournisseurs pour am√©liorer la tr√©sorerie.",
                effetVisible: "‚ÜóÔ∏è Budget lib√©r√© 12%",
                effetGlobal: "‚ö†Ô∏è LT +20j, TR +3%",
                VA: 0, NVA: 16, LT_effect: 16,
                impacts: {
                    global: {"delaiFournisseur": 80.0, "LT": 20, "Tr": 0.03},
                    bfr: -0.12,
                    hidden: {s: -0.03}
                }
            },
            {
                id: "R1-5", nom: "Lots Plus Petits", emoji: "üì¶", cout: 20,
                secteur: "Approvisionnement",
                description: "Commander des lots plus petits et augmenter la cadence de production pour r√©duire les stocks.",
                effetVisible: "‚ÜóÔ∏è Budget lib√©r√© 15%",
                effetGlobal: "‚ö†Ô∏è DA +10%, TR +4%",
                VA: 2, NVA: -42, LT_effect: -40,
                impacts: {
                    global: {"DA": 0.1, "Tr": 0.04},
                    bfr: -0.15,
                    hidden: {q: -0.02}
                }
            },
            {
                id: "R1-25", nom: "Fournisseur Cheap Q-", emoji: "üì¶", cout: 20,
                secteur: "Approvisionnement",
                description: "Fournisseur proposant de nouvelles options de mati√®re premi√®re √† prix r√©duit mais avec une qualit√© moindre.",
                effetVisible: "‚ÜòÔ∏è DA -15%",
                effetGlobal: "‚ö†Ô∏è TR +15%, LT +40j",
                VA: 0, NVA: 16, LT_effect: 16,
                impacts: {
                    global: {"DA": -0.15, "Tr": 0.15, "LT": 40},
                    hidden: {s: -0.06, q: -0.10, r: -0.05}
                }
            }
        ],
        3: [ // Logistique (J3) - Indicateur: Budget/CGE
            {
                id: "R1-15", nom: "Camions Pleins", emoji: "üöö", cout: 15,
                secteur: "Logistique",
                description: "Optimiser le remplissage des camions pour r√©duire les co√ªts de transport.",
                effetVisible: "‚ÜòÔ∏è CGE -5%",
                effetGlobal: "‚ö†Ô∏è LT +30j, TR +4%",
                VA: 0, NVA: 24, LT_effect: 24,
                impacts: {
                    global: {"CGE": -0.05, "LT": 30, "Tr": 0.04},
                    hidden: {s: -0.04, q: -0.03}
                }
            },
            {
                id: "R1-16", nom: "Lots Transport x2", emoji: "üöö", cout: 20,
                secteur: "Logistique",
                description: "Doubler la taille des lots de transport interne entre les ateliers.",
                effetVisible: "‚ÜòÔ∏è CGE -8%",
                effetGlobal: "‚ö†Ô∏è LT +45j, TR +5%, Budget consomm√© 30%",
                VA: 0, NVA: 32, LT_effect: 32,
                impacts: {
                    global: {"CGE": -0.08, "LT": 45, "Tr": 0.05},
                    bfr: 0.3,
                    hidden: {s: -0.06, q: -0.04}
                }
            },
            {
                id: "R1-17", nom: "Transport Cheap", emoji: "üöö", cout: 20,
                secteur: "Logistique",
                description: "Changer pour un transporteur moins cher mais avec des d√©lais plus longs.",
                effetVisible: "‚ÜòÔ∏è CGE -10%",
                effetGlobal: "‚ö†Ô∏è LT +50j, TR +6%",
                VA: 0, NVA: 40, LT_effect: 40,
                impacts: {
                    global: {"CGE": -0.10, "LT": 50, "Tr": 0.06},
                    hidden: {s: -0.08, q: -0.05, r: -0.04}
                }
            },
            {
                id: "R1-18", nom: "Stock S√©curit√©+", emoji: "üöö", cout: 15,
                secteur: "Logistique",
                description: "Augmenter le niveau du stock de s√©curit√© pour √©viter les ruptures de stock.",
                effetVisible: "‚ÜóÔ∏è Volume +5%",
                effetGlobal: "‚ö†Ô∏è LT +20j, Budget consomm√© 12%",
                VA: 0, NVA: 8, LT_effect: 8,
                impacts: {
                    global: {"QV": 0.05, "LT": 20},
                    bfr: 0.12,
                    hidden: {s: -0.03}
                }
            },
            {
                id: "R1-19", nom: "Stock S√©curit√©-", emoji: "üöö", cout: 15,
                secteur: "Logistique",
                description: "R√©duire le niveau du stock de s√©curit√© pour diminuer les co√ªts de stockage.",
                effetVisible: "‚ÜòÔ∏è CGE -3%, Budget lib√©r√© 6%",
                effetGlobal: "‚ö†Ô∏è Volume -5%, TR +5%",
                VA: 0, NVA: -8, LT_effect: -8,
                impacts: {
                    global: {"QV": -0.05, "CGE": -0.03, "Tr": 0.05},
                    bfr: -0.06,
                    hidden: {q: -0.04}
                }
            },
            {
                id: "R1-29", nom: "R√©duire Inventaires", emoji: "üöö", cout: 10,
                secteur: "Logistique",
                description: "R√©duire la fr√©quence des inventaires pour √©conomiser du temps de travail.",
                effetVisible: "‚ÜòÔ∏è CGE -5%, Budget lib√©r√© 5%",
                effetGlobal: "‚ö†Ô∏è TR +10%",
                VA: 0, NVA: 0, LT_effect: 0,
                impacts: {
                    global: {"CGE": -0.05, "Tr": 0.10},
                    bfr: -0.05,
                    hidden: {q: -0.06, r: -0.03}
                }
            }
        ],
        4: [ // Production (J4) - Indicateur: TRG Moyen
            {
                id: "R1-6", nom: "Acc√©l√©rer M1", emoji: "‚öôÔ∏è", cout: 25,
                secteur: "Production",
                description: "Augmenter la vitesse de la Machine 1 pour am√©liorer le d√©bit de production.",
                effetVisible: "‚ÜóÔ∏è Capacit√© +15%",
                effetGlobal: "‚ö†Ô∏è TR +10%, DMAINT +15%",
                VA: -1, NVA: 9, LT_effect: 8,
                impacts: {
                    global: {"CAP": 0.15, "Tr": 0.10, "tM1": 0.15},
                    hidden: {q: -0.04, r: -0.03}
                }
            },
            {
                id: "R1-7", nom: "Acc√©l√©rer M2", emoji: "‚öôÔ∏è", cout: 20,
                secteur: "Production",
                description: "Augmenter la vitesse de la Machine 2 pour am√©liorer le d√©bit de production.",
                effetVisible: "‚ÜóÔ∏è Capacit√© +15%",
                effetGlobal: "‚ö†Ô∏è TR +12%, DMAINT +15%",
                VA: -1, NVA: 9, LT_effect: 8,
                impacts: {
                    global: {"CAP": 0.15, "Tr": 0.12, "tM2": 0.15},
                    hidden: {q: -0.05, r: -0.03}
                }
            },
            {
                id: "R1-8", nom: "Ralentir M4", emoji: "‚öôÔ∏è", cout: 25,
                secteur: "Production",
                description: "R√©duire la vitesse de la Machine 4 pour am√©liorer la pr√©cision des coupes.",
                effetVisible: "‚ÜòÔ∏è TR -5%",
                effetGlobal: "‚ö†Ô∏è Capacit√© -10%, LT +20j",
                VA: 2, NVA: 14, LT_effect: 16,
                impacts: {
                    global: {"Tr": -0.05, "CAP": -0.1, "LT": 20},
                    hidden: {s: -0.05}
                }
            },
            {
                id: "R1-9", nom: "Machine Neuve D√©coupe", emoji: "‚öôÔ∏è", cout: 60,
                secteur: "Production",
                description: "Acheter une nouvelle machine de d√©coupe pour augmenter la capacit√© de production.",
                effetVisible: "‚ÜóÔ∏è Capacit√© +25%, LT -16h",
                effetGlobal: "‚ö†Ô∏è CGE +15k‚Ç¨, TR +5%",
                VA: 2, NVA: -18, LT_effect: -16,
                impacts: {
                    global: {"CAP": 0.25, "CGE": 15.0, "LT": -16.0, "Tr": 0.05},
                    hidden: {r: -0.05}
                }
            },
            {
                id: "R1-10", nom: "Gros Lots Production", emoji: "‚öôÔ∏è", cout: 20,
                secteur: "Production",
                description: "Produire en lots plus importants pour r√©duire les temps de changement de s√©rie.",
                effetVisible: "‚ÜóÔ∏è Capacit√© +20%",
                effetGlobal: "‚ö†Ô∏è LT +60j, TR +8%, Budget consomm√© 50%",
                VA: 0, NVA: 48, LT_effect: 48,
                impacts: {
                    global: {"CAP": 0.2, "LT": 60, "Tr": 0.08},
                    bfr: 0.5,
                    hidden: {s: -0.10, q: -0.05}
                }
            },
            {
                id: "R1-26", nom: "Acc√©l√©rer M3", emoji: "‚öôÔ∏è", cout: 10,
                secteur: "Production",
                description: "Augmenter la vitesse de la Machine 3 (D√©marcation) pour am√©liorer le d√©bit.",
                effetVisible: "‚ÜóÔ∏è Capacit√© +15%",
                effetGlobal: "‚ö†Ô∏è TR +15%, DMAINT +20%",
                VA: -1, NVA: 9, LT_effect: 8,
                impacts: {
                    global: {"CAP": 0.15, "Tr": 0.15, "tM3": 0.20},
                    hidden: {q: -0.06}
                }
            },
            {
                id: "R1-27", nom: "Machine Neuve Coupe Finale", emoji: "‚öôÔ∏è", cout: 65,
                secteur: "Production",
                description: "Acheter une nouvelle machine de coupe finale pour augmenter la capacit√©.",
                effetVisible: "‚ÜóÔ∏è Capacit√© +30%, LT -24h",
                effetGlobal: "‚ö†Ô∏è CGE +10k‚Ç¨",
                VA: 2, NVA: -26, LT_effect: -24,
                impacts: {
                    global: {"CAP": 0.3, "CGE": 10.0, "LT": -24.0}
                }
            },
            {
                id: "R1-28", nom: "Pousser Macroflux 2", emoji: "‚öôÔ∏è", cout: 20,
                secteur: "Production",
                description: "Produire le macroflux 2 pour le stock en mode pouss√© pour anticiper la demande.",
                effetVisible: "‚ÜóÔ∏è Capacit√© +20%",
                effetGlobal: "‚ö†Ô∏è Budget consomm√© 25%, TR +5%",
                VA: 0, NVA: 40, LT_effect: 40,
                impacts: {
                    global: {"CAP": 0.2, "Tr": 0.05},
                    bfr: 0.25
                }
            }
        ],
        5: [ // Qualit√© (J5) - Indicateur: Conformit√© (1-TR)
            {
                id: "R1-11", nom: "R√©duire Inspections", emoji: "‚úÖ", cout: 15,
                secteur: "Qualit√©",
                description: "R√©duire les inspections qualit√© interm√©diaires pour acc√©l√©rer la production.",
                effetVisible: "‚ÜòÔ∏è Lead Time -8h",
                effetGlobal: "‚ö†Ô∏è TR +10%, Marge -5%",
                VA: 0, NVA: -8, LT_effect: -8,
                impacts: {
                    global: {"LT": -8.0, "Tr": 0.1, "PV": -0.05}
                }
            },
            {
                id: "R1-12", nom: "√âtude Qualit√© Fournisseurs", emoji: "‚úÖ", cout: 20,
                secteur: "Qualit√©",
                description: "R√©aliser une √©tude approfondie de la qualit√© des fournisseurs de mati√®re premi√®re.",
                effetVisible: "‚ÜòÔ∏è TR -5%",
                effetGlobal: "‚ö†Ô∏è Lead Time +40h, DA +2%",
                VA: 4, NVA: 36, LT_effect: 40,
                impacts: {
                    global: {"Tr": -0.05, "LT": 40.0, "DA": 0.02}
                }
            },
            {
                id: "R1-13", nom: "Accepter D√©fauts Mineurs", emoji: "‚úÖ", cout: 10,
                secteur: "Qualit√©",
                description: "Accepter les petits d√©fauts esth√©tiques sur les produits pour acc√©l√©rer la livraison.",
                effetVisible: "‚ÜòÔ∏è Lead Time -8h",
                effetGlobal: "‚ö†Ô∏è TR +5%, Marge -8%",
                VA: 0, NVA: -8, LT_effect: -8,
                impacts: {
                    global: {"LT": -8.0, "Tr": 0.05, "PV": -0.08}
                }
            },
            {
                id: "R1-14", nom: "Contr√¥le Renforc√©", emoji: "‚úÖ", cout: 15,
                secteur: "Qualit√©",
                description: "Renforcer les contr√¥les qualit√© √† chaque √©tape de production pour r√©duire les d√©fauts.",
                effetVisible: "‚ÜòÔ∏è TR -10%",
                effetGlobal: "‚ö†Ô∏è Lead Time +16h, Temps cycle +5%",
                VA: 4, NVA: 12, LT_effect: 16,
                impacts: {
                    global: {"Tr": -0.1, "LT": 16.0, "TC": 0.05}
                }
            }
        ]
    };
    
    // ==================== CARTES MANCHE 2 - LEAN (Outils Lean et TOC) ====================
    // Cartes bas√©es sur le tableau Excel - 30 cartes au total
    
    const CARTES_MANCHE2 = [
        {
            id: "R2-1", nom: "Organisation 5S du Magasin", emoji: "üì¶", cout: 15,
            secteur: "Approvisionnement",
            description: "Organiser le magasin de mati√®res premi√®res avec la m√©thode 5S : trier, ranger, nettoyer, standardiser et maintenir.",
            effetVisible: "Organisation 5S du magasin",
            VA: 1, NVA: -5, LT_effect: -4,
            impacts: {
                global: {"LT": -4.0, "TC": -0.05, "Tr": -0.02}
            }
        },
        {
            id: "R2-2", nom: "Syst√®me Kanban Fournisseur", emoji: "üì¶", cout: 25,
            secteur: "Approvisionnement",
            description: "Mettre en place un syst√®me Kanban avec les fournisseurs pour un flux tir√© automatique des approvisionnements.",
            effetVisible: "Syst√®me Kanban avec les fournisseurs",
            VA: 2, NVA: -18, LT_effect: -16,
            impacts: {
                global: {"LT": -16.0, "delaiFournisseur": -0.2},
                bfr: -0.25
            }
        },
        {
            id: "R2-3", nom: "Lissage Heijunka des Achats", emoji: "üì¶", cout: 20,
            secteur: "Approvisionnement",
            description: "Lisser les commandes d\'achats avec la m√©thode Heijunka pour r√©duire la variabilit√© de la production.",
            effetVisible: "Lissage de la production Heijunka",
            VA: 0, NVA: -8, LT_effect: -8,
            impacts: {
                global: {"delaiFournisseur": -0.15},
                bfr: -0.1
            }
        },
        {
            id: "R2-4", nom: "Visite Gemba chez les Fournisseurs", emoji: "üì¶", cout: 30,
            secteur: "Approvisionnement",
            description: "R√©aliser des visites terrain chez les fournisseurs pour auditer la qualit√© de mani√®re collaborative.",
            effetVisible: "Visite terrain Gemba fournisseurs",
            VA: 2, NVA: -2, LT_effect: 0,
            impacts: {
                global: {"Tr": -0.08, "DA": -0.03}
            }
        },
        {
            id: "R2-5", nom: "M√©thode SMED sur la D√©coupe", emoji: "‚öôÔ∏è", cout: 20,
            secteur: "Production",
            description: "Appliquer la m√©thode SMED sur la machine de d√©coupe pour r√©duire les temps de changement de s√©rie.",
            effetVisible: "M√©thode SMED sur la d√©coupe",
            VA: -2, NVA: -6, LT_effect: -8,
            impacts: {
                global: {"TC": -0.6, "CAP": 0.1},
                bfr: -0.15
            }
        },
        {
            id: "R2-6", nom: "M√©thode SMED sur le Polissage", emoji: "‚öôÔ∏è", cout: 20,
            secteur: "Production",
            description: "Appliquer la m√©thode SMED sur la machine de polissage pour r√©duire les temps de changement de s√©rie.",
            effetVisible: "M√©thode SMED sur le polissage",
            VA: -2, NVA: -6, LT_effect: -8,
            impacts: {
                global: {"TC": -0.6, "CAP": 0.1},
                bfr: -0.15
            }
        },
        {
            id: "R2-7", nom: "M√©thode SMED sur la Coupe Finale", emoji: "‚öôÔ∏è", cout: 25,
            secteur: "Production",
            description: "Appliquer la m√©thode SMED sur la machine de coupe finale, le goulot d\'√©tranglement de la production.",
            effetVisible: "M√©thode SMED sur le goulot",
            VA: -3, NVA: -9, LT_effect: -12,
            impacts: {
                global: {"TC": -0.6, "CAP": 0.15},
                bfr: -0.2
            }
        },
        {
            id: "R2-8", nom: "Organisation 5S de l\'Atelier", emoji: "‚öôÔ∏è", cout: 10,
            secteur: "Production",
            description: "Organiser l\'atelier de production avec la m√©thode 5S pour un environnement propre et efficace.",
            effetVisible: "Organisation 5S de l\'atelier",
            VA: 1, NVA: -5, LT_effect: -4,
            impacts: {
                global: {"TC": -0.1, "Tr": -0.05, "LT": -4.0}
            }
        },
        {
            id: "R2-9", nom: "Syst√®me Kanban Interne", emoji: "‚öôÔ∏è", cout: 20,
            secteur: "Production",
            description: "Mettre en place un syst√®me Kanban interne entre les postes pour un flux tir√© et r√©duire les en-cours.",
            effetVisible: "Syst√®me Kanban interne",
            VA: 0, NVA: -16, LT_effect: -16,
            impacts: {
                global: {"LT": -16.0, "TC": -0.05},
                bfr: -0.2
            }
        },
        {
            id: "R2-10", nom: "Gestion du Goulot par la TOC", emoji: "‚öôÔ∏è", cout: 25,
            secteur: "Production",
            description: "Appliquer la m√©thode TOC Drum-Buffer-Rope pour subordonner la production au goulot d\'√©tranglement.",
            effetVisible: "Gestion par la contrainte TOC",
            VA: 0, NVA: -24, LT_effect: -24,
            impacts: {
                global: {"CAP": 0.2, "LT": -24.0},
                bfr: -0.25
            }
        },
        {
            id: "R2-11", nom: "Maintenance Productive Totale", emoji: "‚öôÔ∏è", cout: 30,
            secteur: "Production",
            description: "Mettre en place la maintenance productive totale : pr√©ventive et autonome par les op√©rateurs.",
            effetVisible: "Maintenance productive totale",
            VA: 2, NVA: -6, LT_effect: -4,
            impacts: {
                global: {"CAP": 0.15, "Tr": -0.08, "CGE": -0.05}
            }
        },
        {
            id: "R2-12", nom: "Automatisation Intelligente Jidoka", emoji: "‚öôÔ∏è", cout: 50,
            secteur: "Production",
            description: "Installer des syst√®mes d\'automatisation intelligente Jidoka : arr√™t automatique si d√©faut d√©tect√©.",
            effetVisible: "Automatisation intelligente Jidoka",
            VA: 0, NVA: -8, LT_effect: -8,
            impacts: {
                global: {"Tr": -0.15, "CAP": 0.05, "LT": -8.0}
            }
        },
        {
            id: "R2-19", nom: "Organisation 5S de l\'Entrep√¥t", emoji: "üöö", cout: 15,
            secteur: "Logistique",
            description: "Organiser l\'entrep√¥t avec la m√©thode 5S : zones d√©finies, flux visuels et rangement optimis√©.",
            effetVisible: "Organisation 5S de l\'entrep√¥t",
            VA: 0, NVA: -8, LT_effect: -8,
            impacts: {
                global: {"LT": -8.0, "Tr": -0.05, "TC": -0.03}
            }
        },
        {
            id: "R2-20", nom: "Syst√®me Kanban de Distribution", emoji: "üöö", cout: 20,
            secteur: "Logistique",
            description: "Mettre en place un syst√®me Kanban de distribution pour un flux tir√© vers les clients.",
            effetVisible: "Syst√®me Kanban de distribution",
            VA: 0, NVA: -16, LT_effect: -16,
            impacts: {
                global: {"LT": -16.0, "QV": 0.05},
                bfr: -0.2
            }
        },
        {
            id: "R2-21", nom: "Lissage Heijunka des Exp√©ditions", emoji: "üöö", cout: 25,
            secteur: "Logistique",
            description: "Lisser les exp√©ditions avec Heijunka : r√©gularit√© des livraisons et optimisation du transport.",
            effetVisible: "Lissage des exp√©ditions Heijunka",
            VA: 0, NVA: -8, LT_effect: -8,
            impacts: {
                global: {"LT": -8.0, "CGE": -0.1, "PV": 0.03}
            }
        },
        {
            id: "R2-22", nom: "Livraison en Juste-√†-Temps", emoji: "üöö", cout: 35,
            secteur: "Logistique",
            description: "Mettre en place le Juste-√†-Temps : stock client minimum avec livraisons fr√©quentes.",
            effetVisible: "Livraison en juste-√†-temps",
            VA: 0, NVA: -24, LT_effect: -24,
            impacts: {
                global: {"QV": 0.1, "LT": -24.0},
                bfr: -0.15
            }
        },
        {
            id: "R2-23", nom: "√âl√©vation de la Contrainte Logistique", emoji: "üöö", cout: 30,
            secteur: "Logistique",
            description: "√âlever la contrainte logistique avec la TOC : augmenter la capacit√© de transport et stockage.",
            effetVisible: "Gestion par la contrainte logistique",
            VA: 0, NVA: -16, LT_effect: -16,
            impacts: {
                global: {"LT": -16.0, "CAP": 0.1, "QV": 0.08}
            }
        },
        {
            id: "R2-13", nom: "Analyse des 5 Pourquoi", emoji: "‚úÖ", cout: 10,
            secteur: "Qualit√©",
            description: "Utiliser la m√©thode des 5 Pourquoi pour analyser les causes racines des probl√®mes qualit√©.",
            effetVisible: "Analyse des 5 Pourquoi",
            VA: 2, NVA: -2, LT_effect: 0,
            impacts: {
                global: {"Tr": -0.1, "TC": -0.03}
            }
        },
        {
            id: "R2-14", nom: "Contr√¥le Qualit√© Rapide QRQC", emoji: "‚úÖ", cout: 15,
            secteur: "Qualit√©",
            description: "Mettre en place le QRQC : r√©solution rapide des probl√®mes qualit√© directement sur le terrain.",
            effetVisible: "R√©solution rapide QRQC",
            VA: 0, NVA: -8, LT_effect: -8,
            impacts: {
                global: {"Tr": -0.12, "LT": -8.0, "TC": -0.05}
            }
        },
        {
            id: "R2-15", nom: "Contr√¥le Statistique des Processus", emoji: "‚úÖ", cout: 30,
            secteur: "Qualit√©",
            description: "Installer un contr√¥le statistique des processus avec des cartes de contr√¥le et indicateurs Cpk.",
            effetVisible: "Contr√¥le statistique des processus",
            VA: 1, NVA: -1, LT_effect: 0,
            impacts: {
                global: {"Tr": -0.08, "CAP": 0.03}
            }
        },
        {
            id: "R2-16", nom: "Dispositifs Anti-Erreur Poka-Yoke", emoji: "‚úÖ", cout: 25,
            secteur: "Qualit√©",
            description: "Installer des dispositifs anti-erreur Poka-Yoke : d√©trompeurs physiques sur les machines.",
            effetVisible: "Dispositifs anti-erreur Poka-Yoke",
            VA: 0, NVA: -4, LT_effect: -4,
            impacts: {
                global: {"Tr": -0.2, "TC": -0.08, "LT": -4.0}
            }
        },
        {
            id: "R2-17", nom: "Chantier d\'Am√©lioration Kaizen", emoji: "‚úÖ", cout: 20,
            secteur: "Qualit√©",
            description: "Organiser des chantiers Kaizen d\'am√©lioration continue avec une √©quipe d√©di√©e.",
            effetVisible: "Am√©lioration continue Kaizen",
            VA: 1, NVA: -5, LT_effect: -4,
            impacts: {
                global: {"Tr": -0.1, "CAP": 0.05, "CGE": -0.02}
            }
        },
        {
            id: "R2-18", nom: "Visite Gemba sur le Terrain", emoji: "‚úÖ", cout: 10,
            secteur: "Qualit√©",
            description: "Pratiquer le Gemba Walk : aller sur le terrain observer et r√©soudre les probl√®mes rapidement.",
            effetVisible: "Visite terrain Gemba qualit√©",
            VA: 0, NVA: -4, LT_effect: -4,
            impacts: {
                global: {"Tr": -0.05, "LT": -4.0}
            }
        },
        {
            id: "R2-24", nom: "Lissage Heijunka des Commandes", emoji: "üíº", cout: 20,
            secteur: "Commercial",
            description: "Lisser la prise de commandes avec Heijunka pour am√©liorer la pr√©visibilit√© de la production.",
            effetVisible: "Lissage des commandes Heijunka",
            VA: 0, NVA: -8, LT_effect: -8,
            impacts: {
                global: {"CAP": 0.08, "LT": -8.0},
                bfr: -0.12
            }
        },
        {
            id: "R2-25", nom: "√âcoute de la Voix du Client", emoji: "üíº", cout: 15,
            secteur: "Commercial",
            description: "√âcouter la voix du client pour am√©liorer le service et augmenter la satisfaction.",
            effetVisible: "√âcoute de la voix du client",
            VA: 1, NVA: -5, LT_effect: -4,
            impacts: {
                global: {"QV": 0.1, "PV": 0.05, "Tr": -0.03}
            }
        },
        {
            id: "R2-26", nom: "Segmentation par Valeur Ajout√©e", emoji: "üíº", cout: 10,
            secteur: "Commercial",
            description: "Segmenter les clients par valeur ajout√©e globale pour se concentrer sur les plus rentables.",
            effetVisible: "Segmentation par valeur ajout√©e",
            VA: 2, NVA: -2, LT_effect: 0,
            impacts: {
                global: {"PV": 0.12, "CAP": 0.05}
            }
        },
        {
            id: "R2-27", nom: "Contrats Cadres avec les Clients", emoji: "üíº", cout: 15,
            secteur: "Commercial",
            description: "N√©gocier des contrats cadres avec les clients r√©guliers pour am√©liorer la pr√©visibilit√©.",
            effetVisible: "Contrats cadres avec les clients",
            VA: 0, NVA: -8, LT_effect: -8,
            impacts: {
                global: {"QV": 0.15, "CAP": 0.05},
                bfr: -0.1
            }
        },
        {
            id: "R2-28", nom: "Priorisation par Valeur Horaire", emoji: "üíº", cout: 20,
            secteur: "Commercial",
            description: "Prioriser les ventes des produits √† haute valeur ajout√©e par heure de goulot.",
            effetVisible: "Priorisation par valeur horaire",
            VA: 3, NVA: -3, LT_effect: 0,
            impacts: {
                global: {"PV": 0.15, "CAP": 0.1}
            }
        },
        {
            id: "R2-29", nom: "Priorisation par Valorit√©", emoji: "üíº", cout: 20,
            secteur: "Commercial",
            description: "Prioriser les ventes par valorit√© : valeur par ressource rare utilis√©e.",
            effetVisible: "Priorisation par valorit√©",
            VA: 2, NVA: -2, LT_effect: 0,
            impacts: {
                global: {"PV": 0.1, "CGE": -0.05}
            }
        },
        {
            id: "R2-30", nom: "√âquilibrage du Mix Produits", emoji: "üíº", cout: 20,
            secteur: "Commercial",
            description: "√âquilibrer le mix produits pour optimiser l\'utilisation du goulot d\'√©tranglement.",
            effetVisible: "√âquilibrage optimal du mix produits",
            VA: 1, NVA: -9, LT_effect: -8,
            impacts: {
                global: {"CAP": 0.12, "PV": 0.05},
                bfr: -0.08
            }
        }
    ];
    
    // ==================== CARTES MANCHE 3 - EXCELLENCE (Green et Digital) ====================
    // Cartes bas√©es sur le tableau Excel - 30 cartes au total
    
    const CARTES_MANCHE3 = [
        {
            id: "R3-1", nom: "Second Fournisseur Qualifi√©", emoji: "üì¶", cout: 25,
            secteur: "Approvisionnement",
            description: "Qualifier un second fournisseur de marbre pour r√©duire la d√©pendance et les risques d\'approvisionnement.",
            effetVisible: "Qualification d\'un second fournisseur",
            VA: 0, NVA: -12, LT_effect: -12,
            impacts: {
                global: {"delaiFournisseur": -0.15, "Tr": -0.03},
                bfr: -0.08
            }
        },
        {
            id: "R3-2", nom: "Stock en Consignation Fournisseur", emoji: "üì¶", cout: 15,
            secteur: "Approvisionnement",
            description: "N√©gocier un stock en consignation chez le fournisseur : payer uniquement √† la consommation effective.",
            effetVisible: "Stock en consignation",
            VA: 0, NVA: -24, LT_effect: -24,
            impacts: {
                global: {"DA": 0.03, "LT": -24.0},
                bfr: -0.2
            }
        },
        {
            id: "R3-3", nom: "Centralisation des Achats", emoji: "üì¶", cout: 10,
            secteur: "Approvisionnement",
            description: "Centraliser les achats avec d\'autres marbreries pour augmenter le volume et le pouvoir de n√©gociation.",
            effetVisible: "Centralisation des achats",
            VA: 0, NVA: 8, LT_effect: 8,
            impacts: {
                global: {"DA": -0.08, "delaiFournisseur": 0.1}
            }
        },
        {
            id: "R3-4", nom: "Cahier des Charges Qualit√©", emoji: "üì¶", cout: 8,
            secteur: "Approvisionnement",
            description: "D√©finir un cahier des charges qualit√© strict avec des crit√®res d\'acceptation des mati√®res premi√®res.",
            effetVisible: "Cahier des charges qualit√©",
            VA: 2, NVA: -10, LT_effect: -8,
            impacts: {
                global: {"Tr": -0.1, "DA": 0.02, "LT": -8.0}
            }
        },
        {
            id: "R3-5", nom: "Audit RSE des Fournisseurs", emoji: "üì¶", cout: 28,
            secteur: "Approvisionnement",
            description: "R√©aliser des audits RSE r√©guliers chez les fournisseurs : conditions de travail, environnement et √©thique.",
            effetVisible: "Audits RSE annuels",
            VA: 0, NVA: 0, LT_effect: 0,
            impacts: {
                global: {"Image": 0.25, "Tr": -0.03}
            }
        },
        {
            id: "R3-6", nom: "D√©veloppement Fournisseur R√©gional", emoji: "üì¶", cout: 20,
            secteur: "Approvisionnement",
            description: "D√©velopper un fournisseur r√©gional pour plus de proximit√©, r√©activit√© et moins de transport.",
            effetVisible: "D√©veloppement fournisseur r√©gional",
            VA: 0, NVA: -40, LT_effect: -40,
            impacts: {
                global: {"LT": -40.0, "DA": 0.05, "CO2": -0.15}
            }
        },
        {
            id: "R3-7", nom: "Certification ISO 14001", emoji: "üì¶", cout: 55,
            secteur: "Approvisionnement",
            description: "Obtenir la certification ISO 14001 pour le syst√®me de management environnemental.",
            effetVisible: "Certification ISO 14001",
            VA: 0, NVA: 0, LT_effect: 0,
            impacts: {
                global: {"Image": 0.3, "QV": 0.1, "Tr": -0.05}
            }
        },
        {
            id: "R3-8", nom: "Formation Op√©rateurs Polyvalents", emoji: "‚öôÔ∏è", cout: 30,
            secteur: "Production",
            description: "Former les op√©rateurs √† trois postes minimum pour plus de flexibilit√© et couverture des absences.",
            effetVisible: "Formation polyvalence op√©rateurs",
            VA: 0, NVA: -8, LT_effect: -8,
            impacts: {
                global: {"CAP": 0.12, "Tr": -0.05, "LT": -8.0}
            }
        },
        {
            id: "R3-9", nom: "Plan de Maintenance Pr√©ventive", emoji: "‚öôÔ∏è", cout: 25,
            secteur: "Production",
            description: "Mettre en place un plan de maintenance pr√©ventive syst√©matique avec r√©visions programm√©es.",
            effetVisible: "Maintenance pr√©ventive",
            VA: 2, NVA: -10, LT_effect: -8,
            impacts: {
                global: {"CAP": 0.1, "Tr": -0.08, "CGE": -0.05}
            }
        },
        {
            id: "R3-10", nom: "R√©novation de l\'Outillage", emoji: "‚öôÔ∏è", cout: 35,
            secteur: "Production",
            description: "R√©nover et standardiser l\'outillage : disques, lames et abrasifs de qualit√© professionnelle.",
            effetVisible: "R√©novation de l\'outillage",
            VA: -1, NVA: -7, LT_effect: -8,
            impacts: {
                global: {"Tr": -0.12, "TC": -0.1, "CAP": 0.08}
            }
        },
        {
            id: "R3-11", nom: "√âclairage LED Haute Efficacit√©", emoji: "‚öôÔ∏è", cout: 35,
            secteur: "Production",
            description: "Remplacer tout l\'√©clairage industriel par des LED haute efficacit√© pour r√©duire la consommation.",
            effetVisible: "√âclairage LED haute efficacit√©",
            VA: 0, NVA: 0, LT_effect: 0,
            impacts: {
                global: {"CGE": -0.03, "Tr": -0.02}
            }
        },
        {
            id: "R3-12", nom: "Installation Panneaux Solaires", emoji: "‚öôÔ∏è", cout: 120,
            secteur: "Production",
            description: "Installer des panneaux solaires de 60 kilowatts sur le toit de l\'usine pour l\'autonomie √©nerg√©tique.",
            effetVisible: "Installation panneaux solaires",
            VA: 0, NVA: 0, LT_effect: 0,
            impacts: {
                global: {"CGE": -0.08, "CO2": -0.3, "Image": 0.2}
            }
        },
        {
            id: "R3-13", nom: "Syst√®me de R√©cup√©ration d\'Eau", emoji: "‚öôÔ∏è", cout: 15,
            secteur: "Production",
            description: "Installer un syst√®me simple de r√©cup√©ration et filtration de l\'eau de coupe.",
            effetVisible: "R√©cup√©ration de l\'eau",
            VA: 0, NVA: 0, LT_effect: 0,
            impacts: {
                global: {"Eau": -0.5, "CGE": -0.03}
            }
        },
        {
            id: "R3-21", nom: "Organisation des Tourn√©es par Zone", emoji: "üöö", cout: 8,
            secteur: "Logistique",
            description: "Organiser les livraisons par zones g√©ographiques pour optimiser les trajets et r√©duire les √©missions.",
            effetVisible: "Organisation des tourn√©es par zone",
            VA: 0, NVA: 8, LT_effect: 8,
            impacts: {
                global: {"CGE": -0.12, "CO2": -0.15, "LT": 8.0}
            }
        },
        {
            id: "R3-22", nom: "Emballage de Protection Renforc√©", emoji: "üöö", cout: 15,
            secteur: "Logistique",
            description: "Investir dans un emballage de protection renforc√© pour r√©duire la casse pendant le transport.",
            effetVisible: "Emballage de protection renforc√©",
            VA: 1, NVA: -1, LT_effect: 0,
            impacts: {
                global: {"Tr": -0.08, "PV": 0.05, "CGE": 0.02}
            }
        },
        {
            id: "R3-23", nom: "Contrat Transporteur Sp√©cialis√©", emoji: "üöö", cout: 20,
            secteur: "Logistique",
            description: "Signer un contrat avec un transporteur sp√©cialis√© dans la pierre : savoir-faire en manutention.",
            effetVisible: "Transporteur sp√©cialis√© d√©di√©",
            VA: 0, NVA: -16, LT_effect: -16,
            impacts: {
                global: {"Tr": -0.1, "LT": -16.0, "CGE": 0.05}
            }
        },
        {
            id: "R3-24", nom: "Vente des Chutes de Pierre", emoji: "üöö", cout: 5,
            secteur: "Logistique",
            description: "Vendre les chutes et rebuts de pierre aux artisans locaux, cimentiers et paysagistes.",
            effetVisible: "Vente des chutes de pierre",
            VA: 0, NVA: 0, LT_effect: 0,
            impacts: {
                global: {"Dechets": -0.6, "PV": 0.05, "Image": 0.1}
            }
        },
        {
            id: "R3-25", nom: "Stock Tampon chez les Clients", emoji: "üöö", cout: 25,
            secteur: "Logistique",
            description: "Cr√©er un petit stock tampon chez les clients r√©guliers pour des livraisons express depuis leur d√©p√¥t.",
            effetVisible: "Stock tampon chez les clients",
            VA: 0, NVA: -48, LT_effect: -48,
            impacts: {
                global: {"QV": 0.15, "LT": -48.0},
                bfr: 0.1
            }
        },
        {
            id: "R3-14", nom: "Contr√¥le Qualit√© √† la R√©ception", emoji: "‚úÖ", cout: 15,
            secteur: "Qualit√©",
            description: "Mettre en place un contr√¥le syst√©matique de la qualit√© √† la r√©ception des mati√®res premi√®res.",
            effetVisible: "Contr√¥le qualit√© √† la r√©ception",
            VA: 2, NVA: 6, LT_effect: 8,
            impacts: {
                global: {"Tr": -0.15, "LT": 8.0, "DA": -0.02}
            }
        },
        {
            id: "R3-15", nom: "Maintenance Pr√©dictive par Intelligence Artificielle", emoji: "‚úÖ", cout: 80,
            secteur: "Qualit√©",
            description: "Installer un syst√®me d\'intelligence artificielle pour la maintenance pr√©dictive des machines.",
            effetVisible: "Maintenance pr√©dictive par IA",
            VA: 0, NVA: -16, LT_effect: -16,
            impacts: {
                global: {"CAP": 0.15, "Tr": -0.12, "LT": -16.0}
            }
        },
        {
            id: "R3-16", nom: "Analyse du Cycle de Vie des Produits", emoji: "‚úÖ", cout: 32,
            secteur: "Qualit√©",
            description: "R√©aliser une analyse compl√®te du cycle de vie des produits pour identifier les impacts environnementaux.",
            effetVisible: "Analyse du cycle de vie",
            VA: 0, NVA: 0, LT_effect: 0,
            impacts: {
                global: {"Image": 0.2, "CO2": -0.1}
            }
        },
        {
            id: "R3-17", nom: "Fiches d\'Instruction Illustr√©es", emoji: "‚úÖ", cout: 8,
            secteur: "Qualit√©",
            description: "R√©diger des fiches d\'instruction illustr√©es pour chaque op√©ration critique de production.",
            effetVisible: "Fiches d\'instruction illustr√©es",
            VA: 0, NVA: -4, LT_effect: -4,
            impacts: {
                global: {"Tr": -0.08, "TC": -0.05}
            }
        },
        {
            id: "R3-18", nom: "Cercles Qualit√© Mensuels", emoji: "‚úÖ", cout: 5,
            secteur: "Qualit√©",
            description: "Cr√©er des cercles qualit√© mensuels o√π les op√©rateurs proposent des am√©liorations.",
            effetVisible: "Cercles qualit√© mensuels",
            VA: 1, NVA: -5, LT_effect: -4,
            impacts: {
                global: {"Tr": -0.05, "CAP": 0.05, "Image": 0.1}
            }
        },
        {
            id: "R3-19", nom: "Certificat Qualit√© avec Photos", emoji: "‚úÖ", cout: 5,
            secteur: "Qualit√©",
            description: "√âmettre un certificat qualit√© avec photos pour chaque commande premium livr√©e.",
            effetVisible: "Certificat qualit√© avec photos",
            VA: 1, NVA: 3, LT_effect: 4,
            impacts: {
                global: {"PV": 0.08, "Tr": -0.03, "LT": 4.0}
            }
        },
        {
            id: "R3-20", nom: "Analyse des R√©clamations Clients", emoji: "‚úÖ", cout: 5,
            secteur: "Qualit√©",
            description: "Analyser syst√©matiquement les r√©clamations clients et mettre en place des actions correctives.",
            effetVisible: "Analyse des retours d\'exp√©rience",
            VA: 1, NVA: -5, LT_effect: -4,
            impacts: {
                global: {"Tr": -0.1, "QV": 0.05}
            }
        },
        {
            id: "R3-26", nom: "R√©novation du Showroom", emoji: "üíº", cout: 30,
            secteur: "Commercial",
            description: "R√©nover le showroom avec √©chantillons, √©clairage professionnel et espace d\'accueil client.",
            effetVisible: "R√©novation du showroom",
            VA: 0, NVA: 0, LT_effect: 0,
            impacts: {
                global: {"QV": 0.12, "PV": 0.08, "Image": 0.2}
            }
        },
        {
            id: "R3-27", nom: "Programme Qualit√© de Vie au Travail", emoji: "üíº", cout: 35,
            secteur: "Commercial",
            description: "Mettre en place un programme de qualit√© de vie au travail : ergonomie, pauses et espaces d√©tente.",
            effetVisible: "Programme qualit√© de vie au travail",
            VA: 0, NVA: 0, LT_effect: 0,
            impacts: {
                global: {"CAP": 0.08, "Tr": -0.05, "Image": 0.15}
            }
        },
        {
            id: "R3-28", nom: "Syst√®me de Devis Rapide", emoji: "üíº", cout: 8,
            secteur: "Commercial",
            description: "Proposer un syst√®me de devis rapide en 24 heures avec photos et prix ferme garanti.",
            effetVisible: "Syst√®me de devis rapide",
            VA: 0, NVA: -16, LT_effect: -16,
            impacts: {
                global: {"QV": 0.1, "LT": -16.0}
            }
        },
        {
            id: "R3-29", nom: "Programme de Fid√©lisation Clients", emoji: "üíº", cout: 10,
            secteur: "Commercial",
            description: "Cr√©er un programme de fid√©lisation clients : remises progressives, priorit√© livraison et service apr√®s-vente d√©di√©.",
            effetVisible: "Programme de fid√©lisation",
            VA: 0, NVA: -4, LT_effect: -4,
            impacts: {
                global: {"QV": 0.15, "PV": -0.03},
                bfr: -0.05
            }
        },
        {
            id: "R3-30", nom: "Lancement d\'une Gamme √âconomique", emoji: "üíº", cout: 12,
            secteur: "Commercial",
            description: "Lancer une gamme √©conomique avec les chutes r√©cup√©r√©es pour un nouveau segment de march√©.",
            effetVisible: "Lancement gamme √©conomique",
            VA: 2, NVA: -2, LT_effect: 0,
            impacts: {
                global: {"QV": 0.18, "Dechets": -0.3, "PV": -0.05}
            }
        }
    ];
    
    // ==================== √âTAT DU JEU ====================
    
    let gameState = {
        manche: 1,
        joueurActuel: 1,
        // Syst√®me de budget partag√© pour Manche 1
        tourActuel: 1,
        budgets: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }, // D√©penses par joueur (pour tracking)
        budgetManche1: 300, // Budget commun partag√© pour la Manche 1
        budgetCommun: 0, // Budget pour Manche 2+
        mixValideJ1: false, // J1 doit valider le mix avant de jouer des cartes
        processus: JSON.parse(JSON.stringify(PROCESSUS_INITIAL)),
        indicateurs: JSON.parse(JSON.stringify(INDICATEURS_JOUEUR_INITIAL)),
        hidden: JSON.parse(JSON.stringify(HIDDEN_INITIAL)),
        cartesAchetees: { 1: [], 2: [], 3: [], 4: [], 5: [], commun: [], manche3: [] },
        joueursReady: { 1: false, 2: false, 3: false, 4: false, 5: false },
        joueursReadyM2: { 1: false, 2: false, 3: false, 4: false, 5: false }, // Validation Manche 2
        joueursReadyM3: { 1: false, 2: false, 3: false, 4: false, 5: false }, // Validation Manche 3
        joueursAyantPasse: { 1: false, 2: false, 3: false, 4: false, 5: false }, // Joueurs ayant pass√© ce round
        roundManche1: 1, // Num√©ro du round actuel en Manche 1
        revelationShown: false,
        hiddenRevealed: false,
        historique: [],
        // Phase de d√©briefing entre manches
        phaseDebriefing: false,
        phaseDebriefing2: false,  // D√©briefing entre manche 2 et 3
        joueursCompris: { 1: false, 2: false, 3: false, 4: false, 5: false },
        // NOUVEAU: Micro-flux et Machines
        microFlux: JSON.parse(JSON.stringify(MICRO_FLUX)),
        machines: JSON.parse(JSON.stringify(MACHINES)),
        contraintes: JSON.parse(JSON.stringify(CONTRAINTES)),
        // CGE (Charges Globales d'Exploitation) en euros
        cge: JSON.parse(JSON.stringify(CGE_INITIAL)),
        // Pour la s√©lection de cible
        carteEnAttente: null,
        cibleSelectionnee: null
    };
    // Calculer PIG initial avec la nouvelle formule
    gameState.hidden.pig = calculerPIG();
    
    // ==================== PANEL D√âVELOPPEUR ====================
    
    let devMode = {
        showHidden: false,
        unlockVSM: false,
        infiniteBudget: false,
        authenticated: false,
        showCardHelp: false  // Afficher l'aide sur les cartes (badges + score) - d√©sactiv√© en Manche 1 par d√©faut
    };
    
    // Fonction pour basculer entre les onglets du panel d√©veloppeur
    function showDevTab(tabName) {
        // Cacher tous les contenus
        document.querySelectorAll('.dev-tab-content').forEach(tab => {
            tab.style.display = 'none';
        });
        // D√©sactiver tous les boutons
        document.querySelectorAll('.dev-tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        // Afficher le contenu s√©lectionn√©
        const selectedTab = document.getElementById('devTab-' + tabName);
        if (selectedTab) {
            selectedTab.style.display = 'block';
        }
        // Activer le bouton s√©lectionn√©
        document.querySelector(`.dev-tab-btn[data-tab="${tabName}"]`)?.classList.add('active');
    }
    
    function toggleDevPanel() {
        const panel = document.getElementById('devPanel');
        
        // Si le panel est ouvert, on le ferme et on r√©initialise l'authentification
        if (panel.classList.contains('open')) {
            panel.classList.remove('open');
            devMode.authenticated = false;
            return;
        }
        
        // Si pas encore authentifi√©, demander le mot de passe
        if (!devMode.authenticated) {
            const password = prompt('üîê Mot de passe d√©veloppeur :');
            if (password === 'admin') {
                devMode.authenticated = true;
                showToast('Mode d√©veloppeur activ√© !', 'success');
            } else if (password !== null) {
                showToast('Mot de passe incorrect !', 'error');
                return;
            } else {
                return; // Annul√©
            }
        }
        
        panel.classList.add('open');
        renderDevPanel();
    }
    
    function renderDevPanel() {
        renderDevHiddenIndicators();
        renderDevSliders();
        renderDevBudgets();
        renderDevCGE();
        renderDevVSM();
        renderDevCards();
        renderDevSalesControls();
        renderDevMachinesStatus();
        renderDevToursStatus();
        
        // Afficher/cacher les boutons selon la phase
        const btnSkip = document.getElementById('btnSkipDebriefing');
        const btnAllCompris = document.getElementById('btnAllCompris');
        if (btnSkip) {
            btnSkip.style.display = gameState.phaseDebriefing ? 'inline-block' : 'none';
        }
        if (btnAllCompris) {
            btnAllCompris.style.display = gameState.phaseDebriefing ? 'inline-block' : 'none';
        }
    }
    
    // Afficher le statut du budget dans le panel dev
    function renderDevToursStatus() {
        const container = document.getElementById('devToursStatus');
        if (!container) return;
        
        const manche = gameState.manche;
        if (manche !== 1) {
            container.innerHTML = '<div style="opacity: 0.5;">Mode collaboratif (Manche 2-3)</div>';
            return;
        }
        
        const budgetRestant = gameState.budgetManche1;
        const budgetTotal = 300;
        const pct = (budgetRestant / budgetTotal) * 100;
        const barColor = pct > 50 ? 'var(--success)' : pct > 20 ? 'var(--warning)' : 'var(--danger)';
        const roundActuel = gameState.roundManche1 || 1;
        
        let html = `
            <div style="margin-bottom: 8px;"><strong>Round:</strong> ${roundActuel} | <strong>Joueur:</strong> J${gameState.joueurActuel}</div>
            <div style="margin-bottom: 8px;"><strong>Budget commun:</strong> ${budgetRestant}/${budgetTotal} pts</div>
            <div style="height: 8px; background: var(--bg-card); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; width: ${pct}%; background: ${barColor}; transition: width 0.3s;"></div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 8px;">
        `;
        
        for (let i = 1; i <= 5; i++) {
            const depense = gameState.budgets[i];
            const isCurrent = i === gameState.joueurActuel;
            const aPasse = gameState.joueursAyantPasse && gameState.joueursAyantPasse[i];
            const color = isCurrent ? 'var(--accent-primary)' : aPasse ? 'var(--danger)' : 'var(--text-muted)';
            const bg = isCurrent ? 'rgba(99, 102, 241, 0.2)' : aPasse ? 'rgba(239, 68, 68, 0.1)' : 'var(--bg-elevated)';
            
            html += `
                <div style="padding: 6px; border-radius: 6px; text-align: center; background: ${bg}; border: 1px solid ${color};">
                    <div style="font-size: 0.75em; color: ${color};">J${i} ${aPasse ? '‚è≠Ô∏è' : ''}</div>
                    <div style="font-weight: 600; color: ${color};">${depense} pts</div>
                </div>
            `;
        }
        
        html += `</div>
            <div style="margin-top: 8px; display: flex; gap: 4px;">
                <button onclick="devForceFinManche1()" class="dev-btn" style="flex: 1; padding: 4px; font-size: 0.75em;">üèÅ Forcer fin M1</button>
            </div>
        `;
        container.innerHTML = html;
    }
    
    // Forcer la fin de la Manche 1
    function devForceFinManche1() {
        gameState.phaseDebriefing = true;
        showToast('Fin de Manche 1 forc√©e', 'warning');
        render();
        setTimeout(() => {
            showRevelationModal();
        }, 500);
    }
    
    // Changer de joueur depuis le panel dev
    function devSetJoueur(joueur) {
        gameState.joueurActuel = joueur;
        document.getElementById('selectJoueur').value = joueur;
        showToast(`Joueur ${joueur} s√©lectionn√©`, 'info');
        render();
        renderDevPanel();
    }
    
    // Reset les tours (budget partag√© √† 300)
    function devResetTours() {
        gameState.budgetManche1 = 300;
        gameState.budgets = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        gameState.roundManche1 = 1;
        gameState.joueursAyantPasse = { 1: false, 2: false, 3: false, 4: false, 5: false };
        gameState.joueurActuel = 1;
        document.getElementById('selectJoueur').value = 1;
        // Reset les cartes achet√©es en manche 1
        for (let i = 1; i <= 5; i++) {
            gameState.cartesAchetees[i] = [];
        }
        showToast('Budget et rounds r√©initialis√©s !', 'success');
        render();
        renderDevPanel();
    }
    
    // Forcer la fin de la manche 1
    function devFinManche1() {
        // Mettre J5 au dernier tour
        gameState.joueurActuel = 5;
        gameState.tourActuel = 5;
        gameState.budgetManche1 = 0; // Plus de budget
        document.getElementById('selectJoueur').value = 5;
        gameState.phaseDebriefing = true;
        showToast('Fin de Manche 1 (J5, Tour 5)', 'warning');
        render();
        renderDevPanel();
        setTimeout(() => {
            showRevelationModal();
        }, 300);
    }
    
    function renderDevSalesControls() {
        const container = document.getElementById('devSalesControls');
        if (!container) return;
        
        calculerChargesMachines();
        const gouletInfo = identifierGoulet();
        
        // Message adapt√© selon la charge
        let gouletMsg = '';
        if (gouletInfo.chargePercent >= SEUILS.goulet.critique) {
            gouletMsg = `<p style="font-size: 0.75em; color: var(--danger); margin-bottom: 10px;">üî¥ SURCHARGE! ${gameState.machines[gouletInfo.goulet]?.nom || 'N/A'} √† ${Math.min(100, gouletInfo.chargePercent).toFixed(0)}%</p>`;
        } else if (gouletInfo.chargePercent >= 80) {
            gouletMsg = `<p style="font-size: 0.75em; color: var(--warning); margin-bottom: 10px;">‚ö†Ô∏è Attention: ${gameState.machines[gouletInfo.goulet]?.nom || 'N/A'} √† ${gouletInfo.chargePercent.toFixed(0)}%</p>`;
        } else {
            gouletMsg = `<p style="font-size: 0.75em; opacity: 0.7; margin-bottom: 10px;">‚úÖ Capacit√© OK (${gameState.machines[gouletInfo.goulet]?.nom || 'N/A'} √† ${gouletInfo.chargePercent.toFixed(0)}%)</p>`;
        }
        
        let html = gouletMsg;
        
        for (const [mfId, mf] of Object.entries(gameState.microFlux)) {
            const limiteGoulet = calculerCapaciteVenteMax(mfId);
            const demandeMax = mf.venteMax;
            const limiteReelle = Math.min(demandeMax, limiteGoulet);
            const vag = mf.PV - mf.DA;
            const isGouletLimitant = limiteGoulet < demandeMax;
            
            html += `
                <div class="dev-budget-row" style="margin-bottom: 8px; ${isGouletLimitant ? 'background: rgba(239, 68, 68, 0.05); border: 1px solid var(--border-subtle); border-radius: 6px; padding: 6px;' : ''}">
                    <div style="flex: 1;">
                        <span>${mf.emoji} ${mf.nom}</span>
                        <div style="font-size: 0.7em; color: var(--text-muted);">
                            VAG: ${vag}‚Ç¨ | Demande: ${demandeMax} | 
                            <span style="color: ${isGouletLimitant ? 'var(--danger)' : 'var(--success)'};">
                                ${isGouletLimitant ? 'üö´ Limite: ' + limiteGoulet : '‚úÖ OK'}
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="ajusterVentes('${mfId}', -10)" class="dev-btn" style="padding: 4px 8px;">-10</button>
                        <input type="number" value="${mf.QV}" min="${mf.venteMin}" max="${limiteReelle}" 
                               onchange="setVentes('${mfId}', this.value)" style="width: 70px;" step="100">
                        <button onclick="ajusterVentes('${mfId}', 10)" class="dev-btn" style="padding: 4px 8px;">+10</button>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function renderDevMachinesStatus() {
        const container = document.getElementById('devMachinesStatus');
        if (!container) return;
        
        calculerChargesMachines();
        const gouletInfo = identifierGoulet();
        
        let html = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">';
        
        for (const [mId, machine] of Object.entries(gameState.machines)) {
            const chargePercent = machine.capacite > 0 ? (machine.charge / machine.capacite * 100) : 0;
            const isGoulet = mId === gouletInfo.goulet && chargePercent >= 80;
            const barColor = chargePercent >= SEUILS.goulet.critique ? 'var(--danger)' : chargePercent >= SEUILS.goulet.avertissement ? 'var(--warning)' : 'var(--success)';
            
            html += `
                <div class="dev-indicator" style="${isGoulet ? 'border: 2px solid var(--danger); background: rgba(239, 68, 68, 0.1);' : ''}">
                    <div class="dev-indicator-label">${machine.emoji} ${machine.nom} ${isGoulet ? 'üî¥' : ''}</div>
                    <div class="dev-indicator-value" style="font-size: 0.9em;">${machine.charge.toFixed(0)}h / ${machine.capacite}h</div>
                    <div style="height: 4px; background: var(--bg-card); border-radius: 2px; margin-top: 4px;">
                        <div style="height: 100%; width: ${Math.min(100, chargePercent)}%; background: ${barColor}; border-radius: 2px;"></div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    function renderSalesSection() {
        const grid = document.getElementById('salesGrid');
        const warning = document.getElementById('salesGouletWarning');
        if (!grid) return;
        
        const manche = gameState.manche;
        const joueur = gameState.joueurActuel;
        const config = JOUEURS_CONFIG[joueur];
        calculerChargesMachines();
        const gouletInfo = identifierGoulet();
        
        // Calculer les contraintes actuelles
        let bfrTotal = 0;
        let forceVenteTotal = 0;
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            bfrTotal += calculerBFR(mf) * mf.QV;
            forceVenteTotal += mf.QV;
        }
        const bfrPct = (bfrTotal / gameState.contraintes.BFR_max) * 100;
        const fvPct = (forceVenteTotal / gameState.contraintes.force_vente_max) * 100;
        
        // En manche 1, seul le joueur 1 peut modifier le mix des ventes
        const canEdit = (manche >= 2) || (manche === 1 && joueur === 1) || gameState.phaseDebriefing;
        
        // D√©terminer quelle machine correspond au joueur (pour affichage temps machine)
        // J2 = M1 (Production), J3 = Logistique (pas de machine), J4 = M2 (Qualit√©), J5 = M3 (Commercial)
        const joueurMachine = { 2: 'tM1', 3: null, 4: 'tM2', 5: 'tM3' };
        const machineKey = joueurMachine[joueur];
        
        let html = '';
        
        // Consignes de guidage compactes (affich√©es uniquement au 1er tour de la manche 1)
        if (manche === 1 && !gameState.phaseDebriefing && gameState.tourActuel === 1) {
            if (joueur === 1) {
                html += `
                    <div style="grid-column: 1 / -1; background: rgba(99, 102, 241, 0.08); border: 1px solid var(--accent-primary); border-radius: 8px; padding: 10px 14px; margin-bottom: 10px;">
                        <p style="color: var(--accent-tertiary); font-weight: 600; margin-bottom: 6px; font-size: 0.8em;">üìã Commercial: Maximisez la Marge ‚Ä¢ G√©rez le mix de vente ‚Ä¢ Jouez une carte</p>
                        <p style="color: var(--text-muted); font-size: 0.75em; margin: 0;">üí° Survolez les termes pour voir leur signification</p>
                    </div>
                `;
            } else {
                html += `
                    <div style="grid-column: 1 / -1; background: rgba(99, 102, 241, 0.08); border: 1px solid var(--accent-primary); border-radius: 8px; padding: 10px 14px; margin-bottom: 10px;">
                        <p style="color: var(--accent-tertiary); font-weight: 600; margin-bottom: 6px; font-size: 0.8em;">üìã ${config.nom}: Analysez vos indicateurs ‚Ä¢ Jouez une carte ‚Ä¢ Les quantit√©s sont fix√©es par le Commercial</p>
                        <p style="color: var(--text-muted); font-size: 0.75em; margin: 0;">üí° Survolez les termes pour voir leur signification</p>
                    </div>
                `;
            }
        }
        
        // Encadr√© contraintes (visible si √©ditable)
        if (canEdit) {
            const bfrColor = bfrPct >= 90 ? 'var(--danger)' : bfrPct >= 70 ? 'var(--warning)' : 'var(--success)';
            const fvColor = fvPct >= 90 ? 'var(--danger)' : fvPct >= 70 ? 'var(--warning)' : 'var(--success)';
            const gouletColor = gouletInfo.chargePercent >= 90 ? 'var(--danger)' : gouletInfo.chargePercent >= 70 ? 'var(--warning)' : 'var(--success)';
            
            html += `
                <div style="grid-column: 1 / -1; background: var(--bg-elevated); border-radius: 12px; padding: 12px 16px; margin-bottom: 8px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 0.85em;">
                    <div>
                        <div style="color: var(--text-muted); margin-bottom: 4px;"><span class="tooltip-term" data-tooltip="BFR = Œ£ (DAR√óLT - D√©laiF√óDA + D√©laiC√óPV)/360 √ó QV. Capital immobilis√© entre achats et encaissements. Ne pas d√©passer le plafond !">üí∞ BFR</span></div>
                        <div style="color: ${bfrColor}; font-weight: 600;">${(bfrTotal/1000000).toFixed(2)}M / ${(gameState.contraintes.BFR_max/1000000).toFixed(1)}M ‚Ç¨</div>
                        <div style="height: 4px; background: var(--bg-card); border-radius: 2px; margin-top: 4px;">
                            <div style="height: 100%; width: ${Math.min(100, bfrPct)}%; background: ${bfrColor}; border-radius: 2px;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); margin-bottom: 4px;"><span class="tooltip-term" data-tooltip="Force de Vente = Œ£ QV. Capacit√© commerciale maximale de l'entreprise (nombre total d'unit√©s vendables).">üì¶ Force de Vente</span></div>
                        <div style="color: ${fvColor}; font-weight: 600;">${formatNumber(forceVenteTotal)} / ${formatNumber(gameState.contraintes.force_vente_max)} u</div>
                        <div style="height: 4px; background: var(--bg-card); border-radius: 2px; margin-top: 4px;">
                            <div style="height: 100%; width: ${Math.min(100, fvPct)}%; background: ${fvColor}; border-radius: 2px;"></div>
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); margin-bottom: 4px;"><span class="tooltip-term" data-tooltip="Goulet = Machine la plus charg√©e. Charge = Œ£ QV √ó temps_machine. Si >100%, impossible de produire toutes les commandes !">‚öôÔ∏è Goulet (${gameState.machines[gouletInfo.goulet]?.nom || 'N/A'})</span></div>
                        <div style="color: ${gouletColor}; font-weight: 600;">${Math.min(100, gouletInfo.chargePercent).toFixed(0)}% capacit√©</div>
                        <div style="height: 4px; background: var(--bg-card); border-radius: 2px; margin-top: 4px;">
                            <div style="height: 100%; width: ${Math.min(100, gouletInfo.chargePercent)}%; background: ${gouletColor}; border-radius: 2px;"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        for (const [mfId, mf] of Object.entries(gameState.microFlux)) {
            const limiteGoulet = calculerCapaciteVenteMax(mfId);
            const demandeMax = mf.venteMax; // Demande march√© fixe
            const isGouletLimitant = limiteGoulet < demandeMax;
            
            // Manche 1 : afficher marge brute (PV - DA), Manche 2+ : afficher VAG
            let valuePerUnit, totalValue, labelPerUnit;
            if (manche === 1 && !gameState.phaseDebriefing) {
                const marge = mf.PV - mf.DA;
                valuePerUnit = marge;
                totalValue = marge * mf.QV;
                labelPerUnit = 'Marge';
            } else {
                const vag = calculerVAG(mf);
                valuePerUnit = Math.round(vag);
                totalValue = vag * mf.QV;
                labelPerUnit = 'VAG';
            }
            
            // Calcul du temps machine pour ce produit (pour joueurs production)
            const tempsMachine = machineKey ? mf[machineKey] : null;
            const chargeTotal = machineKey ? (mf.QV * mf[machineKey]).toFixed(0) : null;
            
            // Identifier quelle machine est le goulet pour ce produit
            let gouletInfo = '';
            if (isGouletLimitant) {
                const goulet = identifierGoulet();
                if (goulet) {
                    gouletInfo = `‚ö†Ô∏è Limit√© par ${goulet.id} (${goulet.chargePercent.toFixed(0)}%)`;
                }
            }
            
            if (canEdit) {
                // Affichage avec contr√¥les (J1 en M1, ou tous en M2+)
                const labelValue = manche === 1 && !gameState.phaseDebriefing ? 'Marge/u' : 'VAG/u';
                const tooltipValue = manche === 1 && !gameState.phaseDebriefing ? 
                    'Marge Brute Unitaire = PV - DA. Indicateur simplifi√© visible en Manche 1.' : 
                    'VAG Unitaire = PV - DDP. Valeur Ajout√©e r√©elle int√©grant DA, maintenance et BFR.';
                const labelTotal = manche === 1 && !gameState.phaseDebriefing ? 'Marge Tot.' : 'VAG Tot.';
                const tooltipTotal = manche === 1 && !gameState.phaseDebriefing ? 
                    'Marge Brute Totale = (PV - DA) √ó QV. Indicateur simplifi√©.' : 
                    'VAG Totale = VAG √ó QV. Contribution r√©elle de ce produit √† la richesse cr√©√©e.';
                
                // Limite r√©elle = min entre demande et goulet (INFRANCHISSABLE)
                const limiteReelle = Math.min(demandeMax, limiteGoulet);
                
                // Calcul des pourcentages pour la barre visuelle
                const pctQV = ((mf.QV - mf.venteMin) / (demandeMax - mf.venteMin)) * 100;
                const pctGoulet = isGouletLimitant ? ((limiteGoulet - mf.venteMin) / (demandeMax - mf.venteMin)) * 100 : 100;
                const isAtLimit = mf.QV >= limiteReelle * 0.95;
                
                html += `
                    <div class="sales-card ${isGouletLimitant && isAtLimit ? 'goulet-warning' : ''}">
                        <div class="sales-card-header">
                            <div class="sales-card-name"><span>${mf.emoji}</span>${mf.nom}</div>
                            <div class="sales-card-vag" style="color: var(--success);"><span class="tooltip-term" data-tooltip="${tooltipValue}">${formatNumber(valuePerUnit)}‚Ç¨/u</span></div>
                        </div>
                        <div class="sales-card-controls">
                            <button onclick="ajusterVentes('${mfId}', -100)">‚àí100</button>
                            <button onclick="ajusterVentes('${mfId}', -10)">‚àí10</button>
                            <input type="number" value="${mf.QV}" min="${mf.venteMin}" max="${limiteReelle}" step="100"
                                   onchange="setVentes('${mfId}', this.value)"
                                   style="${isGouletLimitant && isAtLimit ? 'border-color: var(--warning); background: rgba(245, 158, 11, 0.1);' : ''}">
                            <button onclick="ajusterVentes('${mfId}', 10)">+10</button>
                            <button onclick="ajusterVentes('${mfId}', 100)">+100</button>
                        </div>
                        <div class="sales-minmax-bar">
                            <div class="sales-minmax-labels">
                                <span class="tooltip-term" data-tooltip="Demande minimum du march√©">Min: ${mf.venteMin}</span>
                                <span style="color: var(--accent-primary); font-weight: 600;">QV: ${mf.QV}</span>
                                <span class="tooltip-term" data-tooltip="Demande maximum du march√© (objectif commercial)${isGouletLimitant ? ' - ‚ö†Ô∏è Limit√© par goulet √† ' + limiteGoulet : ''}">Max: ${demandeMax}</span>
                            </div>
                            <div class="sales-minmax-track" style="position: relative;">
                                <!-- Barre de progression QV -->
                                <div class="sales-minmax-fill ${isAtLimit ? 'warning' : ''}" 
                                     style="width: ${Math.min(100, pctQV)}%"></div>
                                <!-- Marqueur du goulet si limitant (BARRI√àRE ROUGE) -->
                                ${isGouletLimitant ? `
                                <div class="sales-goulet-marker" style="position: absolute; left: ${pctGoulet}%; top: -4px; bottom: -4px; width: 4px; background: var(--danger); border-radius: 2px; box-shadow: 0 0 6px rgba(239, 68, 68, 0.6);" 
                                     title="üö´ LIMITE GOULET: ${limiteGoulet} unit√©s (infranchissable)"></div>
                                ` : ''}
                            </div>
                        </div>
                        ${isGouletLimitant ? `
                        <div class="sales-goulet-info" style="font-size: 0.75em; color: var(--danger); margin-top: 6px; padding: 6px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; display: flex; align-items: center; gap: 6px;">
                            <span>üö´</span>
                            <span><strong>Limite production:</strong> max ${limiteGoulet} unit√©s</span>
                            <span style="color: var(--text-muted);">|</span>
                            <span>${gouletInfo}</span>
                        </div>
                        ` : ''}
                        <div class="sales-card-info">
                            <span style="color: var(--success); font-weight: 600;"><span class="tooltip-term" data-tooltip="${tooltipTotal}">${labelTotal}: ${formatNumber(Math.round(totalValue))}‚Ç¨</span></span>
                        </div>
                    </div>
                `;
            } else {
                // Affichage lecture seule pour joueurs production en M1
                html += `
                    <div class="sales-card" style="opacity: 0.95;">
                        <div class="sales-card-header">
                            <div class="sales-card-name"><span>${mf.emoji}</span>${mf.nom}</div>
                            <div class="sales-card-vag" style="color: var(--accent-primary); font-size: 1.1em;"><span class="tooltip-term" data-tooltip="QV = Quantit√© √† Vendre. Fix√©e par le service Commercial.">${formatNumber(mf.QV)} unit√©s</span></div>
                        </div>
                        <div class="sales-card-details" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px 0; font-size: 0.85em;">
                            <div><span class="tooltip-term" data-tooltip="DA = D√©penses d'Achat. Co√ªt d'achat unitaire des mati√®res premi√®res." style="color: var(--text-muted);">Co√ªt achat:</span> <strong>${formatNumber(mf.DA)}‚Ç¨</strong></div>
                            <div><span class="tooltip-term" data-tooltip="PV = Prix de Vente. Prix unitaire factur√© au client." style="color: var(--text-muted);">Prix vente:</span> <strong>${formatNumber(mf.PV)}‚Ç¨</strong></div>
                            ${tempsMachine !== null ? `
                            <div><span class="tooltip-term" data-tooltip="Temps machine par unit√©. Utilis√© pour calculer la charge totale sur votre machine." style="color: var(--text-muted);">Temps/unit√©:</span> <strong>${tempsMachine}h</strong></div>
                            <div><span class="tooltip-term" data-tooltip="Charge Totale = QV √ó Temps/unit√©. Heures n√©cessaires sur votre machine pour ce produit." style="color: var(--text-muted);">Charge totale:</span> <strong style="color: var(--warning);">${chargeTotal}h</strong></div>
                            ` : `
                            <div><span class="tooltip-term" data-tooltip="Tr = Taux de Rebut. % de pi√®ces d√©fectueuses. Impacte le DAR = DA/(1-Tr)." style="color: var(--text-muted);">Taux rebut:</span> <strong>${(mf.Tr * 100).toFixed(0)}%</strong></div>
                            <div><span class="tooltip-term" data-tooltip="LT = Lead Time. D√©lai de production en jours. Impacte le BFR." style="color: var(--text-muted);">Lead Time:</span> <strong>${mf.LT}j</strong></div>
                            `}
                        </div>
                        <div class="sales-card-info" style="font-size: 0.8em; color: var(--text-muted); text-align: center; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                            <span>üìã Quantit√©s fix√©es par le service Commercial</span>
                        </div>
                    </div>
                `;
            }
        }
        
        grid.innerHTML = html;
        
        // Bouton de validation du mix pour J1 en Manche 1
        if (manche === 1 && joueur === 1 && !gameState.mixValideJ1 && !gameState.phaseDebriefing) {
            const validationBtn = document.createElement('div');
            validationBtn.style.cssText = 'grid-column: 1 / -1; margin-top: 16px; text-align: center;';
            validationBtn.innerHTML = `
                <button onclick="validerMixJ1()" style="
                    background: var(--gradient-success);
                    color: #000;
                    border: none;
                    padding: 16px 32px;
                    border-radius: 12px;
                    font-size: 1.1em;
                    font-weight: 700;
                    cursor: pointer;
                    box-shadow: 0 4px 16px rgba(34, 197, 94, 0.4);
                ">
                    ‚úÖ Valider le Mix de Ventes
                </button>
                <p style="color: var(--text-muted); font-size: 0.85em; margin-top: 8px;">
                    Vous devez valider le mix avant de pouvoir jouer des cartes
                </p>
            `;
            grid.appendChild(validationBtn);
        }
        
        // Afficher l'avertissement du goulet si > 80% (seulement manche 2+ ou mode dev)
        if (gouletInfo.chargePercent >= 80 && (manche >= 2 || devMode.showHidden)) {
            const gouletMachine = gameState.machines[gouletInfo.goulet];
            warning.innerHTML = `
                <div style="font-weight: 700; color: var(--danger); margin-bottom: 8px;">
                    üî¥ GOULET D'√âTRANGLEMENT D√âTECT√â
                </div>
                <div>
                    <strong>${gouletMachine.emoji} ${gouletMachine.nom}</strong> est √† 
                    <strong>${Math.min(100, gouletInfo.chargePercent).toFixed(0)}%</strong> de capacit√© 
                    (${gouletMachine.charge.toFixed(0)}h / ${gouletMachine.capacite}h)
                </div>
                <div style="margin-top: 8px; font-size: 0.9em; color: var(--text-secondary);">
                    R√©duisez les ventes ou am√©liorez cette machine avec SMED/TPM pour d√©bloquer le syst√®me.
                </div>
            `;
            warning.classList.add('active');
        } else {
            warning.classList.remove('active');
        }
    }
    
    function ajusterVentes(mfId, delta) {
        const mf = gameState.microFlux[mfId];
        const demandeMax = mf.venteMax; // Demande march√© fixe (affichage)
        const limiteGoulet = calculerCapaciteVenteMax(mfId); // Limite de production (BLOQUANTE)
        
        // La limite du goulet est INFRANCHISSABLE
        const limiteReelle = Math.min(demandeMax, limiteGoulet);
        const nouvelleValeur = Math.max(mf.venteMin, Math.min(limiteReelle, mf.QV + delta));
        
        // Si on essaie de d√©passer et qu'on est bloqu√© par le goulet
        if (mf.QV + delta > limiteGoulet && limiteGoulet < demandeMax) {
            showToast(`üö´ Bloqu√© par le goulet ! Max productible: ${limiteGoulet} unit√©s`, 'warning');
        }
        
        mf.QV = nouvelleValeur;
        calculerChargesMachines();
        renderDevPanel();
        render();
    }
    
    function setVentes(mfId, valeur) {
        const mf = gameState.microFlux[mfId];
        const demandeMax = mf.venteMax; // Demande march√© fixe (affichage)
        const limiteGoulet = calculerCapaciteVenteMax(mfId); // Limite de production (BLOQUANTE)
        
        // La limite du goulet est INFRANCHISSABLE
        const limiteReelle = Math.min(demandeMax, limiteGoulet);
        const valeurDemandee = parseInt(valeur) || 0;
        const nouvelleValeur = Math.max(mf.venteMin, Math.min(limiteReelle, valeurDemandee));
        
        // Si on essaie de d√©passer et qu'on est bloqu√© par le goulet
        if (valeurDemandee > limiteGoulet && limiteGoulet < demandeMax) {
            showToast(`üö´ Bloqu√© par le goulet ! Max productible: ${limiteGoulet} unit√©s`, 'warning');
        }
        
        mf.QV = nouvelleValeur;
        calculerChargesMachines();
        renderDevPanel();
        render();
    }
    
    function validerMixJ1() {
        gameState.mixValideJ1 = true;
        showToast('‚úÖ Mix de ventes valid√© ! Vous pouvez maintenant jouer des cartes.', 'success');
        render();
    }
    
    function forceAllCompris() {
        for (let i = 1; i <= 5; i++) {
            gameState.joueursCompris[i] = true;
        }
        showToast('Tous les joueurs ont compris !', 'success');
        
        // V√©rifier si on peut passer √† la manche 2 (collaborative)
        if (Object.values(gameState.joueursCompris).every(c => c)) {
            setTimeout(() => {
                gameState.phaseDebriefing = false;
                gameState.manche = 2;
                for (let i = 1; i <= 5; i++) gameState.joueursReady[i] = false;
                // Fusionner les budgets pour la collaboration
                gameState.budgetCommun = Object.values(gameState.budgets).reduce((a, b) => a + b, 0);
                showToast('ü§ù Passage √† la Manche 2 - Collaboration !', 'success');
                render();
                renderDevPanel();
            }, 500);
        }
        
        render();
        renderDevPanel();
    }
    
    function renderDevHiddenIndicators() {
        const h = gameState.hidden;
        const vagActuel = calculerVAGTotal();
        const cgeActuel = calculerCGETotal();
        const rbeActuel = calculerRBE();
        const tegActuel = calculerTEG();
        const bfrTotal = calculerBFRTotal();
        
        // Calculer les moyennes pond√©r√©es par QV
        let daTotal = 0, ddpTotal = 0, trTotal = 0, ltTotal = 0, qvTotal = 0;
        let darTotal = 0, dmaintTotal = 0, dbfrTotal = 0;
        
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            const qv = mf.QV;
            qvTotal += qv;
            daTotal += mf.DA * qv;
            ddpTotal += calculerDDP(mf) * qv;
            darTotal += calculerDAR(mf) * qv;
            dmaintTotal += calculerDMAINT(mf) * qv;
            dbfrTotal += calculerDBFR(mf) * qv;
            trTotal += mf.Tr * qv;
            ltTotal += mf.LT * qv;
        }
        
        const daMoyen = qvTotal > 0 ? daTotal / qvTotal : 0;
        const ddpMoyen = qvTotal > 0 ? ddpTotal / qvTotal : 0;
        const darMoyen = qvTotal > 0 ? darTotal / qvTotal : 0;
        const dmaintMoyen = qvTotal > 0 ? dmaintTotal / qvTotal : 0;
        const dbfrMoyen = qvTotal > 0 ? dbfrTotal / qvTotal : 0;
        const trMoyen = qvTotal > 0 ? trTotal / qvTotal : 0;
        const ltMoyen = qvTotal > 0 ? ltTotal / qvTotal : 0;
        const vagMoyen = qvTotal > 0 ? vagActuel / qvTotal : 0;
        
        // Calcul des surcouts de degradation (pour affichage)
        const surcoutTR = Math.max(0, (trMoyen - 0.09) * 5000000);
        const surcoutLT = Math.max(0, (ltMoyen - 70) * 3000);
        const surcoutTotal = surcoutTR + surcoutLT;
        
        // CGE de base (sans surcouts)
        const cge = gameState.cge;
        const cgeBase = cge.achats + cge.vente + cge.production + cge.logistique + cge.conception;
        
        document.getElementById('devHiddenIndicators').innerHTML = `
            <div style="font-weight: 600; color: var(--accent-tertiary); margin-bottom: 8px; grid-column: span 3;">üìä Indicateurs Cach√©s (s, r, q)</div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">Vitesse (s)</div>
                <div class="dev-indicator-value ${getHiddenClass(h.s)}">${(h.s*100).toFixed(0)}%</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">Environnement (r)</div>
                <div class="dev-indicator-value ${getHiddenClass(h.r)}">${(h.r*100).toFixed(0)}%</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">Satisfaction (q)</div>
                <div class="dev-indicator-value ${getHiddenClass(h.q)}">${(h.q*100).toFixed(0)}%</div>
            </div>
            
            <div style="font-weight: 600; color: var(--accent-tertiary); margin-top: 12px; margin-bottom: 8px; grid-column: span 3; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">üí∞ Indicateurs √âconomiques</div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">DA Moyen</div>
                <div class="dev-indicator-value" style="color: var(--warning);">‚Ç¨${daMoyen.toFixed(0)}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">DAR Moyen</div>
                <div class="dev-indicator-value" style="color: var(--warning);">‚Ç¨${darMoyen.toFixed(0)}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">DMAINT Moyen</div>
                <div class="dev-indicator-value" style="color: var(--warning);">‚Ç¨${dmaintMoyen.toFixed(0)}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">DBFR Moyen</div>
                <div class="dev-indicator-value" style="color: var(--warning);">‚Ç¨${dbfrMoyen.toFixed(0)}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">DDP Moyen (CR)</div>
                <div class="dev-indicator-value" style="color: var(--danger);">‚Ç¨${ddpMoyen.toFixed(0)}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">VAG Unitaire Moy.</div>
                <div class="dev-indicator-value" style="color: var(--success);">‚Ç¨${vagMoyen.toFixed(0)}</div>
            </div>
            
            <div style="font-weight: 600; color: var(--accent-tertiary); margin-top: 12px; margin-bottom: 8px; grid-column: span 3; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">üìà Indicateurs Globaux</div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">VAG Total</div>
                <div class="dev-indicator-value" style="color: var(--success);">‚Ç¨${formatNumber(Math.round(vagActuel))}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">CGE Base</div>
                <div class="dev-indicator-value" style="color: var(--text-muted);">‚Ç¨${formatNumber(Math.round(cgeBase))}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">‚ö†Ô∏è Surcout TR</div>
                <div class="dev-indicator-value" style="color: ${surcoutTR > 0 ? 'var(--danger)' : 'var(--success)'};">+‚Ç¨${formatNumber(Math.round(surcoutTR))}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">‚ö†Ô∏è Surcout LT</div>
                <div class="dev-indicator-value" style="color: ${surcoutLT > 0 ? 'var(--danger)' : 'var(--success)'};">+‚Ç¨${formatNumber(Math.round(surcoutLT))}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">CGE Total</div>
                <div class="dev-indicator-value" style="color: var(--warning);">‚Ç¨${formatNumber(Math.round(cgeActuel))}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">RBE</div>
                <div class="dev-indicator-value" style="color: ${rbeActuel >= 0 ? 'var(--success)' : 'var(--danger)'};">‚Ç¨${formatNumber(Math.round(rbeActuel))}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">TEG</div>
                <div class="dev-indicator-value" style="color: ${tegActuel >= 1.5 ? 'var(--success)' : 'var(--warning)'};">${tegActuel.toFixed(2)}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">BFR Total</div>
                <div class="dev-indicator-value" style="color: var(--warning);">‚Ç¨${formatNumber(Math.round(bfrTotal))}</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">QV Total</div>
                <div class="dev-indicator-value" style="color: var(--text-primary);">${qvTotal}</div>
            </div>
            
            <div style="font-weight: 600; color: var(--accent-tertiary); margin-top: 12px; margin-bottom: 8px; grid-column: span 3; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">üîß Indicateurs Production</div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">TR Moyen</div>
                <div class="dev-indicator-value" style="color: ${trMoyen < 0.05 ? 'var(--success)' : 'var(--danger)'};">${(trMoyen*100).toFixed(1)}%</div>
            </div>
            <div class="dev-indicator">
                <div class="dev-indicator-label">LT Moyen</div>
                <div class="dev-indicator-value" style="color: ${ltMoyen < 100 ? 'var(--success)' : 'var(--warning)'};">${ltMoyen.toFixed(0)}j</div>
            </div>
            
            <div class="dev-indicator" style="grid-column: span 3; background: rgba(124, 58, 237, 0.3); margin-top: 12px;">
                <div class="dev-indicator-label">üéØ PIG = s √ó q √ó r √ó TEG</div>
                <div class="dev-indicator-value" style="color: ${h.pig >= 1 ? 'var(--success)' : 'var(--danger)'}; font-size: 1.3em;">${h.pig.toFixed(3)}</div>
            </div>
            
            <div style="font-weight: 600; color: var(--accent-tertiary); margin-top: 12px; margin-bottom: 8px; grid-column: span 3; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">üì¶ VAG par Produit (cl√© p√©dagogique)</div>
            ${Object.entries(gameState.microFlux).map(([mfId, mf]) => {
                const vagUnit = calculerVAG(mf);
                const margeBrute = mf.PV - mf.DA;
                const vagParHeureGoulet = vagUnit / mf.tM4;
                return `
                    <div class="dev-indicator" style="grid-column: span 3; background: rgba(99, 102, 241, 0.1); padding: 8px; margin-bottom: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <span style="font-weight: 600;">${mf.emoji} ${mf.nom}</span>
                            <span style="font-size: 0.8em; color: var(--text-muted);">tM4=${mf.tM4}h</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 0.85em;">
                            <div>
                                <div style="color: var(--text-muted);">Marge brute</div>
                                <div style="color: var(--warning); font-weight: 600;">‚Ç¨${margeBrute}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">VAG r√©elle</div>
                                <div style="color: ${vagUnit > 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">‚Ç¨${vagUnit.toFixed(0)}</div>
                            </div>
                            <div>
                                <div style="color: var(--text-muted);">VAG/h goulet</div>
                                <div style="color: ${vagParHeureGoulet > 200 ? 'var(--success)' : 'var(--warning)'}; font-weight: 700;">‚Ç¨${vagParHeureGoulet.toFixed(0)}/h</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        `;
    }
    
    function renderDevSliders() {
        const h = gameState.hidden;
        document.getElementById('sliderS').value = Math.min(95, h.s * 100);
        document.getElementById('valueS').textContent = (h.s * 100).toFixed(0) + '%';
        document.getElementById('sliderR').value = Math.min(95, h.r * 100);
        document.getElementById('valueR').textContent = (h.r * 100).toFixed(0) + '%';
        document.getElementById('sliderQ').value = Math.min(95, h.q * 100);
        document.getElementById('valueQ').textContent = (h.q * 100).toFixed(0) + '%';
    }
    
    function renderDevBudgets() {
        let html = '';
        
        // Budget partag√© pour Manche 1
        html += `
            <div class="dev-budget-row" style="background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 6px; margin-bottom: 8px;">
                <span style="font-weight: 600;">üí∞ Budget M1 (partag√©)</span>
                <input type="number" value="${gameState.budgetManche1}" onchange="setBudgetManche1(this.value)">
            </div>
            <div style="font-size: 0.75em; color: var(--text-muted); margin-bottom: 8px;">D√©penses par joueur :</div>
        `;
        
        for (let i = 1; i <= 5; i++) {
            html += `
                <div class="dev-budget-row">
                    <span>J${i} - ${JOUEURS_CONFIG[i].nom}</span>
                    <span style="color: var(--text-secondary);">${gameState.budgets[i]} pts</span>
                </div>
            `;
        }
        html += `
            <div class="dev-budget-row" style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; margin-top: 5px;">
                <span>üí∞ Budget Commun (M2/M3)</span>
                <input type="number" value="${gameState.budgetCommun}" onchange="setBudgetCommun(this.value)">
            </div>
        `;
        document.getElementById('devBudgets').innerHTML = html;
    }
    
    // Setter pour le budget partag√© de Manche 1
    function setBudgetManche1(value) {
        gameState.budgetManche1 = parseInt(value) || 0;
        render();
        renderDevPanel();
    }
    
    function renderDevCGE() {
        const cge = gameState.cge;
        const total = calculerCGETotal();
        const labels = { achats: 'üì¶ Achats', vente: 'üíº Vente', production: 'üè≠ Production', logistique: 'üöõ Logistique', conception: 'üí° Conception' };
        
        let html = '<div style="font-size: 0.75em; color: var(--text-muted); margin-bottom: 8px;">Valeurs brutes :</div>';
        for (const [key, value] of Object.entries(cge)) {
            html += `
                <div class="dev-budget-row">
                    <span>${labels[key] || key}</span>
                    <input type="number" value="${value}" onchange="setCGE('${key}', this.value)" style="width: 90px;">
                </div>
            `;
        }
        html += `
            <div class="dev-budget-row" style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; margin-top: 5px; font-weight: bold;">
                <span>üìä Total CGE</span>
                <span style="color: var(--warning);">‚Ç¨${formatNumber(total)}</span>
            </div>
        `;
        
        // Ajouter la r√©partition par joueur pour v√©rification
        html += '<div style="font-size: 0.75em; color: var(--text-muted); margin-top: 12px; margin-bottom: 8px;">R√©partition par joueur :</div>';
        const joueurLabels = ['', 'J1 (Ach+Ven+Con)', 'J2 (Prod/3)', 'J3 (Log)', 'J4 (Prod/3)', 'J5 (Prod/3)'];
        let totalJoueurs = 0;
        for (let j = 1; j <= 5; j++) {
            const cgeJ = calculerCGEJoueur(j);
            totalJoueurs += cgeJ.actuel;
            html += `
                <div class="dev-budget-row" style="font-size: 0.85em;">
                    <span>${joueurLabels[j]}</span>
                    <span>‚Ç¨${formatNumber(cgeJ.actuel)}</span>
                </div>
            `;
        }
        html += `
            <div class="dev-budget-row" style="font-size: 0.85em; font-weight: bold;">
                <span>Œ£ Joueurs</span>
                <span style="color: ${Math.abs(totalJoueurs - total) < 100 ? 'var(--success)' : 'var(--danger)'};">‚Ç¨${formatNumber(totalJoueurs)}</span>
            </div>
        `;
        
        document.getElementById('devCGE').innerHTML = html;
    }
    
    function setCGE(key, value) {
        gameState.cge[key] = Math.max(0, parseInt(value) || 0);
        gameState.hidden.pig = calculerPIG();
        render();
        renderDevPanel();
    }
    
    function renderDevVSM() {
        document.getElementById('devVSM').innerHTML = gameState.processus.map(p => `
            <div class="dev-vsm-box">
                <div class="emoji">${p.emoji}</div>
                <div class="name">${p.nom}</div>
                <div class="metrics">TC: ${p.tc.toFixed(1)}h</div>
                <div class="metrics">WIP: ${Math.round(p.wip)}</div>
            </div>
        `).join('');
    }
    
    function renderDevCards() {
        let allCards = [];
        for (let i = 1; i <= 5; i++) {
            gameState.cartesAchetees[i].forEach(cardId => {
                const carte = CARTES_MANCHE1[i]?.find(c => c.id === cardId);
                if (carte) allCards.push({ joueur: i, ...carte });
            });
        }
        gameState.cartesAchetees.commun.forEach(cardId => {
            const carte = CARTES_MANCHE2.find(c => c.id === cardId);
            if (carte) allCards.push({ joueur: 'M2', ...carte });
        });
        gameState.cartesAchetees.manche3.forEach(cardId => {
            const carte = CARTES_MANCHE3.find(c => c.id === cardId);
            if (carte) allCards.push({ joueur: 'M3', ...carte });
        });
        
        if (allCards.length === 0) {
            document.getElementById('devCards').innerHTML = '<div style="opacity: 0.5; font-size: 0.85em;">Aucune carte jou√©e</div>';
            return;
        }
        
        document.getElementById('devCards').innerHTML = allCards.map(c => `
            <div class="dev-card-row">
                <span>${c.emoji} ${c.nom}</span>
                <span style="opacity: 0.7;">${typeof c.joueur === 'number' ? 'J' + c.joueur : c.joueur}</span>
            </div>
        `).join('');
    }
    
    function setManche(manche) {
        gameState.manche = manche;
        if (manche === 1) {
            // Recacher la VSM et l'historique comme au d√©but
            gameState.hiddenRevealed = false;
            gameState.revelationShown = false;
            gameState.phaseDebriefing = false;
            gameState.phaseDebriefing2 = false;
            gameState.joueurActuel = 1;
            gameState.tourActuel = 1;
            gameState.budgetManche1 = 300;
            gameState.budgets = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            for (let i = 1; i <= 5; i++) gameState.joueursCompris[i] = false;
        } else if (manche >= 2) {
            gameState.hiddenRevealed = true;
            gameState.revelationShown = true;
        }
        if (manche === 2) {
            gameState.budgetCommun = gameState.budgetCommun || 300;
        } else if (manche === 3) {
            gameState.budgetCommun = gameState.budgetCommun || 300;
        }
        for (let i = 1; i <= 5; i++) gameState.joueursReady[i] = false;
        showToast(`Manche ${manche} activ√©e !`, 'success');
        render();
        renderDevPanel();
    }
    
    function forceAllReady() {
        for (let i = 1; i <= 5; i++) gameState.joueursReady[i] = true;
        showToast('Tous les joueurs sont pr√™ts !', 'success');
        render();
    }
    
    function startGame() {
        const intro = document.getElementById('introOverlay');
        intro.style.transition = 'opacity 0.5s ease-out';
        intro.style.opacity = '0';
        setTimeout(() => {
            intro.classList.add('hidden');
            // Initialiser le mix au minimum (J1 doit le d√©finir)
            initialiserMixMinimum();
            // Commencer avec le joueur 1, tour 1
            gameState.joueurActuel = 1;
            gameState.tourActuel = 1;
            document.getElementById('selectJoueur').value = 1;
            render();
            // Afficher le modal du premier tour
            showPlayerTurnModal(1);
        }, 500);
    }
    
    // Initialiser le mix de ventes au maximum possible (limit√© par le goulet)
    // Initialiser le mix de ventes au minimum (J1 doit le d√©finir lui-m√™me)
    function initialiserMixMinimum() {
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            mf.QV = mf.venteMin;
        }
        
        // Recalculer les charges
        calculerChargesMachines();
        
        console.log('Mix initialis√© au minimum:', 
            Object.entries(gameState.microFlux).map(([id, mf]) => `${id}: ${mf.QV}`).join(', '));
    }
    
    function selectPlayer(joueur) {
        // Cette fonction est maintenant utilis√©e seulement depuis le panel dev
        gameState.joueurActuel = joueur;
        document.getElementById('selectJoueur').value = joueur;
        document.getElementById('playerSelectModal').classList.remove('active');
        showToast(`Vous √™tes le Joueur ${joueur} - ${JOUEURS_CONFIG[joueur].nom}`, 'success');
        render();
    }
    
    function showIntro() {
        const intro = document.getElementById('introOverlay');
        intro.classList.remove('hidden');
        intro.style.opacity = '1';
    }
    
    function resetGame(skipConfirm = false) {
        if (!skipConfirm && !confirm('R√©initialiser compl√®tement le jeu ?')) return;
        gameState = {
            manche: 1,
            joueurActuel: 1,
            // Budget partag√© de 300 points pour la Manche 1
            tourActuel: 1,
            roundManche1: 1,
            joueursAyantPasse: { 1: false, 2: false, 3: false, 4: false, 5: false },
            budgets: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }, // D√©penses par joueur
            budgetManche1: 300, // Budget commun partag√©
            budgetCommun: 0,
            mixValideJ1: false, // J1 doit valider le mix avant de jouer des cartes
            processus: JSON.parse(JSON.stringify(PROCESSUS_INITIAL)),
            indicateurs: JSON.parse(JSON.stringify(INDICATEURS_JOUEUR_INITIAL)),
            hidden: JSON.parse(JSON.stringify(HIDDEN_INITIAL)),
            cartesAchetees: { 1: [], 2: [], 3: [], 4: [], 5: [], commun: [], manche3: [] },
            joueursReady: { 1: false, 2: false, 3: false, 4: false, 5: false },
            joueursReadyM2: { 1: false, 2: false, 3: false, 4: false, 5: false },
            joueursReadyM3: { 1: false, 2: false, 3: false, 4: false, 5: false },
            revelationShown: false,
            hiddenRevealed: false,
            historique: [],
            phaseDebriefing: false,
            phaseDebriefing2: false,
            joueursCompris: { 1: false, 2: false, 3: false, 4: false, 5: false },
            // Reset micro-flux et machines
            microFlux: JSON.parse(JSON.stringify(MICRO_FLUX)),
            machines: JSON.parse(JSON.stringify(MACHINES)),
            contraintes: JSON.parse(JSON.stringify(CONTRAINTES)),
            cge: JSON.parse(JSON.stringify(CGE_INITIAL)),
            carteEnAttente: null,
            cibleSelectionnee: null
        };
        // Initialiser le mix au minimum (J1 doit le d√©finir)
        initialiserMixMinimum();
        gameState.hidden.pig = calculerPIG();
        showToast('Jeu r√©initialis√© !', 'success');
        render();
        renderDevPanel();
        // Scroller vers le haut de la page
        window.scrollTo({ top: 0, behavior: 'smooth' });
        // Afficher l'intro
        showIntro();
    }
    
    function toggleDevMode() {
        devMode.showHidden = document.getElementById('devModeToggle').checked;
        if (devMode.showHidden) {
            gameState.hiddenRevealed = true;
        }
        render();
    }
    
    function toggleVSMUnlock() {
        devMode.unlockVSM = document.getElementById('vsmUnlockToggle').checked;
        render();
    }
    
    function toggleInfiniteBudget() {
        devMode.infiniteBudget = document.getElementById('infiniteBudgetToggle').checked;
        if (devMode.infiniteBudget) {
            gameState.budgetManche1 = 999999; // Budget partag√© infini
            gameState.budgetCommun = 999999;
            showToast('Budget infini activ√© !', 'success');
        }
        render();
        renderDevPanel();
    }
    
    function toggleCardHelp() {
        devMode.showCardHelp = document.getElementById('cardHelpToggle').checked;
        showToast(devMode.showCardHelp ? 'üè∑Ô∏è Aide sur cartes activ√©e (badges + scores)' : 'üè∑Ô∏è Aide sur cartes d√©sactiv√©e', 'info');
        render();
    }
    
    function updateHiddenFromSlider(key, value) {
        // S, R, Q - plafonner √† 95%
        const cappedValue = Math.min(95, parseFloat(value));
        gameState.hidden[key] = cappedValue / 100;
        document.getElementById('value' + key.charAt(0).toUpperCase()).textContent = cappedValue + '%';
        gameState.hidden.pig = calculerPIG();
        renderDevHiddenIndicators();
        render();
    }
    
    function setBudget(joueur, value) {
        gameState.budgets[joueur] = parseInt(value) || 0;
        render();
    }
    
    function setBudgetCommun(value) {
        gameState.budgetCommun = parseInt(value) || 0;
        render();
    }
    
    function resetBudgets() {
        gameState.budgetManche1 = 300;
        gameState.budgets = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
        gameState.budgetCommun = 300;
        showToast('Budgets r√©initialis√©s', 'success');
        render();
        renderDevPanel();
    }
    
    function resetAllCards() {
        if (!confirm('Supprimer toutes les cartes achet√©es ?')) return;
        gameState.cartesAchetees = { 1: [], 2: [], 3: [], 4: [], 5: [], commun: [], manche3: [] };
        showToast('Toutes les cartes supprim√©es', 'success');
        render();
        renderDevPanel();
    }
    
    // ==================== FONCTIONS ====================
    
    // Fonction helper pour plafonner S, R, Q
    function clampSRQ(value) {
        return Math.min(0.95, Math.max(0.01, value));
    }
    
    // Fonction statique pour calculer PIG (utilisable avant gameState)
    function calculerPIGStatic(h) {
        const s = clampSRQ(h.s);
        const r = clampSRQ(h.r);
        const q = clampSRQ(h.q);
        
        // Calculer VAG total initial √† partir de MICRO_FLUX
        let vagTotal = 0;
        for (const mfId in MICRO_FLUX) {
            const mf = MICRO_FLUX[mfId];
            // Utiliser les fonctions de calcul
            const dar = calculerDAR(mf);
            const dmaint = calculerDMAINT(mf);
            const dbfr = calculerDBFR(mf);
            const ddp = dar + dmaint + dbfr;
            vagTotal += (mf.PV - ddp) * mf.QV;
        }
        
        // Calculer CGE total initial
        let cgeTotal = 0;
        for (const key in CGE_INITIAL) {
            cgeTotal += CGE_INITIAL[key];
        }
        
        // TEG = VAG / CGE
        const teg = Math.max(0.01, vagTotal) / Math.max(1, cgeTotal);
        
        // PIG = s √ó q √ó r √ó TEG
        return s * q * r * teg;
    }
    
    function calculerPIG() {
        const h = gameState.hidden;
        const s = clampSRQ(h.s);
        const r = clampSRQ(h.r);
        const q = clampSRQ(h.q);
        
        const vag = Math.max(0.01, calculerVAGTotal());
        const cge = Math.max(1, calculerCGETotal());
        
        // TEG = VAG / CGE
        const teg = vag / cge;
        
        // PIG = s √ó q √ó r √ó TEG
        return s * q * r * teg;
    }
    
    function showToast(message, type = 'success', duration = 3500) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}</span> ${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), duration);
    }
    
    function getHiddenClass(value, type) {
        if (type === 'percent') {
            if (value < 30) return 'critical';
            if (value < 50) return 'warning';
            return 'good';
        }
        if (value < 0.3) return 'critical';
        if (value < 0.5) return 'warning';
        return 'good';
    }
    
    function acheterCarte(carteId) {
        const manche = gameState.manche;
        const joueur = gameState.joueurActuel;
        let carte, cartesListe;
        
        if (manche === 1) {
            carte = CARTES_MANCHE1[joueur].find(c => c.id === carteId);
            cartesListe = gameState.cartesAchetees[joueur];
            
            // V√©rifier le budget PARTAG√â (sauf mode dev budget infini)
            if (!devMode.infiniteBudget && gameState.budgetManche1 < carte.cout) {
                showToast('Budget commun insuffisant !', 'error');
                return;
            }
        } else if (manche === 2) {
            // Manche 2 = Am√©lioration tableau √©conomique (RBE)
            carte = CARTES_MANCHE2.find(c => c.id === carteId);
            cartesListe = gameState.cartesAchetees.commun;
            
            if (gameState.budgetCommun < carte.cout) {
                showToast('Budget insuffisant !', 'error');
                return;
            }
        } else {
            // Manche 3 = Am√©lioration SQR (PIG)
            carte = CARTES_MANCHE3.find(c => c.id === carteId);
            cartesListe = gameState.cartesAchetees.manche3;
            
            if (gameState.budgetCommun < carte.cout) {
                showToast('Budget insuffisant !', 'error');
                return;
            }
        }
        
        if (!carte || cartesListe.includes(carteId)) return;
        
        // Si la carte n√©cessite une s√©lection de cible, ouvrir le modal
        if (carte.typeCible && carte.ciblesValides) {
            gameState.carteEnAttente = carte;
            showTargetModal(carte);
            return;
        }
        
        // Sinon, acheter directement
        finaliserAchat(carte, null);
    }
    
    function showTargetModal(carte) {
        const modal = document.getElementById('targetModal');
        const title = document.getElementById('targetModalTitle');
        const desc = document.getElementById('targetModalDesc');
        const grid = document.getElementById('targetGrid');
        
        title.textContent = `${carte.emoji} ${carte.nom} - Choisir la cible`;
        desc.textContent = carte.description;
        
        // Calculer les charges des machines
        calculerChargesMachines();
        
        let html = '';
        
        if (carte.typeCible === 'machine') {
            // Afficher les machines
            for (const cibleId of carte.ciblesValides) {
                const machine = gameState.machines[cibleId];
                const chargePercent = (machine.charge / machine.capacite * 100);
                const isBottleneck = chargePercent >= 95;
                const barClass = chargePercent >= 95 ? 'high' : chargePercent >= 70 ? 'medium' : 'low';
                
                html += `
                    <div class="target-card ${isBottleneck ? 'bottleneck' : ''}" onclick="selectTarget('${cibleId}')">
                        <div class="target-card-emoji">${machine.emoji}</div>
                        <div class="target-card-name">${machine.nom}</div>
                        <div class="target-card-stats">
                            <div>Capacit√©: ${machine.capacite}h</div>
                            <div>Charge: ${machine.charge.toFixed(0)}h</div>
                        </div>
                        <div class="target-card-bar">
                            <div class="target-card-bar-fill ${barClass}" style="width: ${Math.min(100, chargePercent)}%"></div>
                        </div>
                    </div>
                `;
            }
        } else if (carte.typeCible === 'microflux') {
            // Afficher les micro-flux
            for (const cibleId of carte.ciblesValides) {
                const mf = gameState.microFlux[cibleId];
                const vag = mf.PV - mf.DA;
                
                html += `
                    <div class="target-card" onclick="selectTarget('${cibleId}')">
                        <div class="target-card-emoji">${mf.emoji}</div>
                        <div class="target-card-name">${mf.nom}</div>
                        <div class="target-card-stats">
                            <div>LT: ${mf.LT} jours</div>
                            <div>Rebus: ${(mf.Tr * 100).toFixed(1)}%</div>
                            <div>VAG: ${vag}‚Ç¨</div>
                            <div>QV: ${mf.QV}</div>
                        </div>
                    </div>
                `;
            }
        }
        
        grid.innerHTML = html;
        modal.classList.add('active');
    }
    
    function selectTarget(cibleId) {
        const carte = gameState.carteEnAttente;
        if (!carte) return;
        
        document.getElementById('targetModal').classList.remove('active');
        finaliserAchat(carte, cibleId);
        gameState.carteEnAttente = null;
    }
    
    function cancelTargetSelection() {
        document.getElementById('targetModal').classList.remove('active');
        gameState.carteEnAttente = null;
    }
    
    function finaliserAchat(carte, cibleId) {
        const manche = gameState.manche;
        const joueur = gameState.joueurActuel;
        let cartesListe;
        
        if (manche === 1) {
            cartesListe = gameState.cartesAchetees[joueur];
        } else if (manche === 2) {
            cartesListe = gameState.cartesAchetees.commun;
        } else {
            cartesListe = gameState.cartesAchetees.manche3;
        }
        
        // D√©duire le co√ªt
        if (manche === 1) {
            gameState.budgetManche1 -= carte.cout;
            gameState.budgets[joueur] += carte.cout; // Track d√©penses par joueur
        } else {
            gameState.budgetCommun -= carte.cout;
        }
        
        cartesListe.push(carte.id);
        
        // Enregistrer dans l'historique
        gameState.historique.push({
            id: carte.id,
            timestamp: new Date().toISOString(),
            manche: manche,
            joueur: manche >= 2 ? 'commun' : joueur,
            carte: {
                nom: carte.nom,
                emoji: carte.emoji,
                cout: carte.cout,
                description: carte.description,
                effetVisible: carte.effetVisible || null,
                effetGlobal: carte.effetGlobal || null,
                type: carte.type || null
            },
            impacts: carte.impacts || null,
            cible: cibleId,
            budgetRestant: manche >= 2 ? gameState.budgetCommun : gameState.budgetManche1
        });
        
        // Appliquer les effets
        if (carte.impacts) {
            // Effets sur indicateurs joueur (Manche 1)
            if (carte.impacts.joueur && manche === 1) {
                for (const [key, value] of Object.entries(carte.impacts.joueur)) {
                    if (gameState.indicateurs[joueur][key] !== undefined) {
                        if (key === 'trg') {
                            gameState.indicateurs[joueur][key] = Math.min(100, gameState.indicateurs[joueur][key] + value);
                        } else if (value < 0 && Math.abs(value) < 1) {
                            gameState.indicateurs[joueur][key] *= (1 + value/100);
                        } else {
                            gameState.indicateurs[joueur][key] += value;
                        }
                    }
                }
            }
            
            // Effets cach√©s (s, q, r) - accepte "cache" ou "hidden"
            const cacheImpacts = carte.impacts.cache || carte.impacts.hidden;
            if (cacheImpacts) {
                for (const [key, value] of Object.entries(cacheImpacts)) {
                    if (key === 's' || key === 'q' || key === 'r') {
                        gameState.hidden[key] = Math.max(0, Math.min(0.95, gameState.hidden[key] + value));
                    }
                }
            }
            
            // Effets sur CGE (en euros)
            if (carte.impacts.cge) {
                for (const [key, value] of Object.entries(carte.impacts.cge)) {
                    if (gameState.cge[key] !== undefined) {
                        gameState.cge[key] = Math.max(0, gameState.cge[key] + value);
                    }
                }
            }
            
            // Effets globaux sur tous les micro-flux (fournisseurs)
            if (carte.impacts.global) {
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    // DA en % (positif = augmentation, n√©gatif = r√©duction)
                    if (carte.impacts.global.DA !== undefined) {
                        mf.DA = Math.round(mf.DA * (1 + carte.impacts.global.DA));
                    }
                    // PV en % (positif = augmentation, n√©gatif = r√©duction)
                    if (carte.impacts.global.PV !== undefined) {
                        mf.PV = Math.round(mf.PV * (1 + carte.impacts.global.PV));
                    }
                    // QV en % (positif = augmentation, n√©gatif = r√©duction)
                    if (carte.impacts.global.QV !== undefined) {
                        mf.QV = Math.round(mf.QV * (1 + carte.impacts.global.QV));
                        // Respecter les bornes min/max
                        mf.QV = Math.max(mf.venteMin, Math.min(mf.venteMax, mf.QV));
                    }
                    // LT en valeur absolue (jours)
                    if (carte.impacts.global.LT !== undefined) {
                        mf.LT = Math.max(10, mf.LT + carte.impacts.global.LT);
                    }
                    // Tr en valeur absolue
                    if (carte.impacts.global.Tr !== undefined) {
                        mf.Tr = Math.max(0.01, Math.min(0.50, mf.Tr + carte.impacts.global.Tr));
                    }
                    // tM1 en % (temps machine 1)
                    if (carte.impacts.global.tM1 !== undefined) {
                        mf.tM1 = Math.max(0.05, mf.tM1 * (1 + carte.impacts.global.tM1));
                    }
                    // tM2 en % (temps machine 2)
                    if (carte.impacts.global.tM2 !== undefined) {
                        mf.tM2 = Math.max(0.05, mf.tM2 * (1 + carte.impacts.global.tM2));
                    }
                    // tM3 en % (temps machine 3)
                    if (carte.impacts.global.tM3 !== undefined) {
                        mf.tM3 = Math.max(0.05, mf.tM3 * (1 + carte.impacts.global.tM3));
                    }
                    // D√©lai client en valeur absolue (jours)
                    if (carte.impacts.global.delaiClient !== undefined) {
                        mf.delaiClient = Math.max(0, mf.delaiClient + carte.impacts.global.delaiClient);
                    }
                    // D√©lai fournisseur en valeur absolue (jours)
                    if (carte.impacts.global.delaiFournisseur !== undefined) {
                        mf.delaiFournisseur = Math.max(0, mf.delaiFournisseur + carte.impacts.global.delaiFournisseur);
                    }
                    // TC - Temps de cycle en % (affecte tous les temps de production)
                    if (carte.impacts.global.TC !== undefined) {
                        const tcFactor = 1 + carte.impacts.global.TC;
                        mf.tReception = Math.max(0.1, mf.tReception * tcFactor);
                        mf.tDecoupeInit = Math.max(0.1, mf.tDecoupeInit * tcFactor);
                        mf.tPolissage = Math.max(0.1, mf.tPolissage * tcFactor);
                        mf.tDecoupeFinal = Math.max(0.1, mf.tDecoupeFinal * tcFactor);
                        mf.tFinition = Math.max(0.1, mf.tFinition * tcFactor);
                        mf.tInspection = Math.max(0.1, mf.tInspection * tcFactor);
                        mf.tExpedition = Math.max(0.1, mf.tExpedition * tcFactor);
                    }
                }
                
                // CAP - Capacit√© machine en % (affecte toutes les machines)
                if (carte.impacts.global.CAP !== undefined) {
                    for (const machineId in gameState.machines) {
                        const machine = gameState.machines[machineId];
                        machine.capacite = Math.round(machine.capacite * (1 + carte.impacts.global.CAP));
                    }
                }
                
                // CGE - Charges g√©n√©rales en valeur absolue (k‚Ç¨)
                if (carte.impacts.global.CGE !== undefined) {
                    // Afficher alerte si r√©duction CGE
                    if (carte.impacts.global.CGE < 0) {
                        setTimeout(() => {
                            // CGE r√©duit - pas de notification
                        }, 1000);
                    }
                    
                    // Si CGE est un % (entre -1 et 1), appliquer sur le total
                    if (carte.impacts.global.CGE > -1 && carte.impacts.global.CGE < 1) {
                        for (const key in gameState.cge) {
                            gameState.cge[key] = Math.max(0, gameState.cge[key] * (1 + carte.impacts.global.CGE));
                        }
                    } else {
                        // Sinon c'est une valeur absolue √† ajouter
                        gameState.cge.autres = (gameState.cge.autres || 0) + (carte.impacts.global.CGE * 1000);
                    }
                }
            }
            
            // Effets sur les capacit√©s machines
            if (carte.impacts.machineCapacite) {
                for (const [machineId, value] of Object.entries(carte.impacts.machineCapacite)) {
                    if (gameState.machines[machineId]) {
                        gameState.machines[machineId].capacite += value;
                    }
                }
            }
            
            // R√©duction DMAINT globale
            if (carte.impacts.globalMaint !== undefined) {
                for (const mfId in gameState.microFlux) {
                    gameState.microFlux[mfId].DMAINT = Math.max(0, gameState.microFlux[mfId].DMAINT + carte.impacts.globalMaint);
                }
            }
            
            // Effets sur BFR max
            if (carte.impacts.bfr_max !== undefined) {
                gameState.contraintes.BFR_max += carte.impacts.bfr_max;
            }
            
            // Effets sur force de vente
            if (carte.impacts.force_vente !== undefined) {
                gameState.contraintes.force_vente_max += carte.impacts.force_vente;
            }
            
            // Effets sur machine (si cible s√©lectionn√©e)
            if (carte.impacts.machine && cibleId && gameState.machines[cibleId]) {
                for (const [key, value] of Object.entries(carte.impacts.machine)) {
                    if (key === 'capacite') {
                        gameState.machines[cibleId].capacite += value;
                    }
                }
            }
            
            // Effets sur micro-flux (si cible s√©lectionn√©e)
            if (carte.impacts.microflux && cibleId && gameState.microFlux[cibleId]) {
                const mf = gameState.microFlux[cibleId];
                for (const [key, value] of Object.entries(carte.impacts.microflux)) {
                    if (key === 'LT') {
                        mf.LT = Math.max(10, mf.LT + value);
                    } else if (key === 'Tr') {
                        mf.Tr = Math.max(0.01, mf.Tr + value);
                    } else if (key === 'PV') {
                        // PV en % sur ce micro-flux
                        mf.PV = Math.round(mf.PV * (1 + value));
                    } else if (key === 'tM1') {
                        mf.tM1 = Math.max(0.05, mf.tM1 * (1 + value));
                    } else if (key === 'tM2') {
                        mf.tM2 = Math.max(0.05, mf.tM2 * (1 + value));
                    } else if (key === 'tM3') {
                        mf.tM3 = Math.max(0.05, mf.tM3 * (1 + value));
                    } else if (key === 'tempsReduction') {
                        // R√©duction de tous les temps machines
                        const factor = 1 - value;
                        mf.tReception = Math.max(0.1, mf.tReception * factor);
                        mf.tDecoupeInit = Math.max(0.1, mf.tDecoupeInit * factor);
                        mf.tPolissage = Math.max(0.1, mf.tPolissage * factor);
                        mf.tDecoupeFinal = Math.max(0.1, mf.tDecoupeFinal * factor);
                        mf.tFinition = Math.max(0.1, mf.tFinition * factor);
                        mf.tInspection = Math.max(0.1, mf.tInspection * factor);
                        mf.tExpedition = Math.max(0.1, mf.tExpedition * factor);
                    }
                }
            }
            
            // Effets sur SQR par micro-flux (Manche 3 uniquement)
            if (carte.impacts.microfluxSQR && cibleId && gameState.microFlux[cibleId]) {
                const mf = gameState.microFlux[cibleId];
                for (const [key, value] of Object.entries(carte.impacts.microfluxSQR)) {
                    if (key === 's' || key === 'q' || key === 'r') {
                        mf[key] = Math.max(0, Math.min(0.95, mf[key] + value));
                    }
                }
            }
        }
        
        // Recalculer les charges machines apr√®s modification
        calculerChargesMachines();
        
        // NOUVEAU: Ajuster automatiquement le mix si le goulet d√©passe la capacit√©
        ajusterMixPourGoulet();
        
        gameState.hidden.pig = calculerPIG();
        
        // Message de succ√®s avec info sur la cible
        let msg = `${carte.emoji} ${carte.nom} achet√© !`;
        if (cibleId) {
            if (gameState.machines[cibleId]) {
                msg += ` (${gameState.machines[cibleId].nom})`;
            } else if (gameState.microFlux[cibleId]) {
                msg += ` (${gameState.microFlux[cibleId].nom})`;
            }
        }
        showToast(msg, 'success');
        
        // En Manche 1 : syst√®me de tours - passer au joueur suivant
        if (manche === 1 && !devMode.infiniteBudget) {
            // Le joueur a achet√© donc il n'a pas pass√©
            if (gameState.joueursAyantPasse) {
                gameState.joueursAyantPasse[joueur] = false;
            }
            
            // V√©rifier si le budget est √©puis√©
            const budgetEpuise = gameState.budgetManche1 <= 0;
            
            // V√©rifier si on peut continuer (au moins un joueur peut jouer)
            const peutContinuer = !verifierFinManche1();
            
            if (budgetEpuise || !peutContinuer) {
                // Fin de la Manche 1 ‚Üí Afficher le modal de fin avec bouton vers historique
                gameState.phaseDebriefing = true;
                render();
                setTimeout(() => {
                    showEndManche1Modal();
                }, 500);
                return;
            }
            
            // Passer au joueur suivant
            passerAuJoueurSuivant();
            return;
        }
        
        render();
    }
    
    // Modal de fin de Manche 1
    function showEndManche1Modal() {
        // D'abord montrer le modal de r√©v√©lation des indicateurs
        showRevelationModal();
    }
    
    // Modal pour annoncer le tour d'un joueur
    function showPlayerTurnModal(joueurParam) {
        const joueur = joueurParam || gameState.joueurActuel;
        const config = JOUEURS_CONFIG[joueur];
        const budgetRestant = gameState.budgetManche1;
        const roundActuel = gameState.roundManche1 || 1;
        
        // Si c'est le tour du J1 (Commercial), remettre le mix au minimum
        // Le J1 doit d√©finir lui-m√™me les quantit√©s optimales
        if (joueur === 1 && gameState.manche === 1) {
            for (const mfId in gameState.microFlux) {
                const mf = gameState.microFlux[mfId];
                mf.QV = mf.venteMin;
            }
            calculerChargesMachines();
            console.log('Mix r√©initialis√© au minimum pour J1:', 
                Object.entries(gameState.microFlux).map(([id, mf]) => `${id}: ${mf.QV}`).join(', '));
        }
        
        // Consignes personnalis√©es par service (uniquement au 1er round)
        let consignes = '';
        if (roundActuel === 1) {
            const consignesParService = {
                1: `<li><strong>Param√©trez le mix de vente !</strong> Ajustez les quantit√©s QV dans le tableau ci-dessous.</li>
                    <li><strong>Analysez vos chiffres !</strong> Marge, DA, recettes ‚Äî je veux des r√©sultats.</li>
                    <li><strong>Choisissez vos cartes.</strong> Am√©liorez VOS indicateurs, c'est votre responsabilit√©.</li>`,
                2: `<li><strong>R√©duisez le co√ªt de revient !</strong> N√©gociez avec les fournisseurs, optimisez les DA.</li>
                    <li><strong>Surveillez les d√©lais d'approvisionnement.</strong> Pas de rupture de stock !</li>
                    <li><strong>G√©rez le Budget.</strong> Chaque euro immobilis√© co√ªte cher.</li>`,
                3: `<li><strong>Optimisez les flux logistiques !</strong> R√©duisez les co√ªts de transport et de stockage.</li>
                    <li><strong>Ma√Ætrisez les CGE !</strong> Les Charges Globales d'Exploitation doivent √™tre optimis√©es.</li>
                    <li><strong>Am√©liorez les d√©lais de livraison.</strong> Les clients n'attendent pas !</li>`,
                4: `<li><strong>Pilotez par le GOULET !</strong> Identifiez la machine √† 100% et adaptez la production.</li>
                    <li><strong>N'augmentez pas b√™tement les autres machines.</strong> √áa cr√©e du stock inutile !</li>
                    <li><strong>R√©duisez le TR (Taux de Rebut).</strong> Chaque pi√®ce jet√©e co√ªte cher.</li>`,
                5: `<li><strong>Garantissez la conformit√© !</strong> Z√©ro d√©faut, c'est l'objectif.</li>
                    <li><strong>R√©duisez le TR (Taux de Rebut).</strong> Chaque pi√®ce jet√©e co√ªte cher.</li>
                    <li><strong>Am√©liorez le Lead Time.</strong> Rapidit√© ET qualit√©.</li>`
            };
            
            consignes = `
                <div style="background: rgba(99, 102, 241, 0.15); border: 1px solid var(--accent-primary); border-radius: 12px; padding: 12px; margin-bottom: 16px; text-align: left;">
                    <p style="color: var(--accent-tertiary); font-weight: 700; margin-bottom: 8px; font-size: 0.85em;">üëî MESSAGE DU PATRON - ${config.nom}</p>
                    <ul style="color: var(--text-secondary); margin: 0; padding-left: 16px; font-size: 0.8em; line-height: 1.5;">
                        ${consignesParService[joueur]}
                        <li>üí° <em>Passez la souris sur les termes pour comprendre leur signification.</em></li>
                    </ul>
                </div>
            `;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay active';
        modal.id = 'playerTurnModal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px; text-align: center;">
                <div style="font-size: 4em; margin-bottom: 16px;">${config.emoji}</div>
                <h2 style="color: var(--accent-tertiary); margin-bottom: 8px;">Round ${roundActuel}</h2>
                <h3 style="color: var(--text-primary); margin-bottom: 16px;">Au tour de J${joueur} ‚Äì ${config.nom}</h3>
                ${consignes}
                <div style="background: rgba(16, 185, 129, 0.15); border: 1px solid var(--accent-secondary); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <p style="color: var(--accent-secondary); font-weight: 700; margin-bottom: 8px;">üí∞ Budget commun de l'√©quipe</p>
                    <p style="color: var(--text-primary); font-size: 1.8em; font-weight: 700; margin: 0;">${budgetRestant} points</p>
                    <p style="color: var(--text-muted); font-size: 0.85em; margin-top: 8px;">Choisissez une carte ou passez votre tour.</p>
                </div>
                <button class="btn-modal" onclick="closePlayerTurnModal()">
                    üéÆ C'est parti !
                </button>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function closePlayerTurnModal() {
        const modal = document.getElementById('playerTurnModal');
        if (modal) {
            modal.remove();
        }
        render();
    }
    
    function calculerChargesMachines() {
        // Reset charges
        for (const mId in gameState.machines) {
            gameState.machines[mId].charge = 0;
        }
        
        // Calculer la charge de chaque machine bas√©e sur les micro-flux
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            // Charge = QV * tMi
            if (gameState.machines.M1) gameState.machines.M1.charge += mf.QV * (mf.tM1 || 0);
            if (gameState.machines.M2) gameState.machines.M2.charge += mf.QV * (mf.tM2 || 0);
            if (gameState.machines.M3) gameState.machines.M3.charge += mf.QV * (mf.tM3 || 0);
            if (gameState.machines.M4) gameState.machines.M4.charge += mf.QV * (mf.tM4 || 0);
            if (gameState.machines.M5) gameState.machines.M5.charge += mf.QV * (mf.tM5 || 0);
        }
    }
    
    // Ajuster automatiquement le mix de vente pour ne pas d√©passer la capacit√© du goulet
    function ajusterMixPourGoulet() {
        calculerChargesMachines();
        
        // Trouver la machine la plus charg√©e (goulet)
        let maxChargeRatio = 0;
        let gouletId = null;
        
        for (const [machineId, machine] of Object.entries(gameState.machines)) {
            if (machine.capacite > 0) {
                const ratio = machine.charge / machine.capacite;
                if (ratio > maxChargeRatio) {
                    maxChargeRatio = ratio;
                    gouletId = machineId;
                }
            }
        }
        
        // Si pas de surcharge, rien √† faire
        if (maxChargeRatio <= 1.0 || !gouletId) {
            return;
        }
        
        const machine = gameState.machines[gouletId];
        const exces = machine.charge - machine.capacite;
        
        // Collecter les infos sur chaque micro-flux
        const mfInfos = [];
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            const tempsGoulet = mf[`t${gouletId}`] || 0;
            if (tempsGoulet > 0 && mf.QV > mf.venteMin) {
                // Calculer la marge unitaire (PV - DA)
                const margeUnitaire = mf.PV - mf.DA;
                // Efficacit√© = marge par heure de goulet utilis√©e
                const efficacite = margeUnitaire / tempsGoulet;
                mfInfos.push({
                    mfId,
                    mf,
                    tempsGoulet,
                    efficacite,
                    reductionPossible: mf.QV - mf.venteMin
                });
            }
        }
        
        // Trier par efficacit√© croissante (on r√©duit d'abord les moins rentables)
        mfInfos.sort((a, b) => a.efficacite - b.efficacite);
        
        // R√©duire progressivement les QV pour √©liminer l'exc√®s
        let excesRestant = exces;
        const reductions = [];
        
        for (const info of mfInfos) {
            if (excesRestant <= 0) break;
            
            // Combien d'unit√©s peut-on retirer pour ce micro-flux?
            const unitesARetirer = Math.min(
                info.reductionPossible,
                Math.ceil(excesRestant / info.tempsGoulet)
            );
            
            if (unitesARetirer > 0) {
                const tempsLibere = unitesARetirer * info.tempsGoulet;
                excesRestant -= tempsLibere;
                
                // Appliquer la r√©duction
                info.mf.QV -= unitesARetirer;
                reductions.push({
                    nom: info.mf.nom,
                    emoji: info.mf.emoji,
                    reduction: unitesARetirer,
                    nouveauQV: info.mf.QV
                });
            }
        }
        
        // Recalculer les charges apr√®s ajustement
        calculerChargesMachines();
        
        // Notifier l'utilisateur si des ajustements ont √©t√© faits
        if (reductions.length > 0) {
            const details = reductions.map(r => `${r.emoji} ${r.nom}: -${r.reduction} ‚Üí ${r.nouveauQV}`).join('\n');
            showToast(`‚ö†Ô∏è Mix ajust√© automatiquement (goulet ${gouletId})`, 'warning');
            console.log('Ajustements automatiques du mix:', details);
        }
    }
    
    // Calculer la capacit√© de vente maximale (limit√©e par le goulet, BFR et force de vente)
    function calculerCapaciteVenteMax(mfId) {
        const mf = gameState.microFlux[mfId];
        let minCapacite = Infinity;
        
        // 1. Contrainte machines (goulet)
        const machineTemps = {
            M1: mf.tM1 || 0,
            M2: mf.tM2 || 0,
            M3: mf.tM3 || 0,
            M4: mf.tM4 || 0,
            M5: mf.tM5 || 0
        };
        
        for (const [machineId, temps] of Object.entries(machineTemps)) {
            if (temps > 0) {
                const machine = gameState.machines[machineId];
                // Capacit√© restante = capacit√© totale - charge des autres produits
                const chargeAutres = machine.charge - (mf.QV * temps);
                const capaciteRestante = machine.capacite - chargeAutres;
                const unitesPossibles = Math.floor(capaciteRestante / temps);
                minCapacite = Math.min(minCapacite, unitesPossibles);
            }
        }
        
        // 2. Contrainte BFR
        const bfr = calculerBFR(mf);
        if (bfr > 0) {
            // BFR actuel des autres produits
            let bfrAutres = 0;
            for (const otherId in gameState.microFlux) {
                if (otherId !== mfId) {
                    const otherMf = gameState.microFlux[otherId];
                    bfrAutres += calculerBFR(otherMf) * otherMf.QV;
                }
            }
            const bfrDisponible = gameState.contraintes.BFR_max - bfrAutres;
            const unitesBFR = Math.floor(bfrDisponible / bfr);
            minCapacite = Math.min(minCapacite, unitesBFR);
        }
        
        // 3. Contrainte force de vente
        let qvAutres = 0;
        for (const otherId in gameState.microFlux) {
            if (otherId !== mfId) {
                qvAutres += gameState.microFlux[otherId].QV;
            }
        }
        const forceVenteDisponible = gameState.contraintes.force_vente_max - qvAutres;
        minCapacite = Math.min(minCapacite, forceVenteDisponible);
        
        return Math.max(0, Math.min(minCapacite, mf.venteMax));
    }
    
    // Identifier le goulet d'√©tranglement
    function identifierGoulet() {
        let goulet = null;
        let maxCharge = 0;
        
        for (const [mId, machine] of Object.entries(gameState.machines)) {
            const chargePercent = machine.capacite > 0 ? (machine.charge / machine.capacite * 100) : 0;
            if (chargePercent > maxCharge) {
                maxCharge = chargePercent;
                goulet = mId;
            }
        }
        
        return { goulet, chargePercent: maxCharge };
    }
    
    function toggleReady() {
        const joueur = gameState.joueurActuel;
        gameState.joueursReady[joueur] = !gameState.joueursReady[joueur];
        
        if (Object.values(gameState.joueursReady).every(r => r)) {
            if (gameState.manche === 1) {
                // Fin de Manche 1 ‚Üí Entrer en phase de d√©briefing
                entrerPhaseDebriefing();
            } else if (gameState.manche === 2) {
                // Fin de Manche 2 ‚Üí Entrer en phase de d√©briefing 2
                entrerPhaseDebriefing2();
            } else if (gameState.manche === 3) {
                // Fin de Manche 3 ‚Üí Afficher les r√©sultats finaux
                showFinalResults();
            }
        }
        render();
    }
    
    // Fonction pour passer son tour en Manche 1
    function passerTour() {
        const j = gameState.joueurActuel;
        
        // Initialiser le tracking des passes si n√©cessaire
        if (!gameState.joueursAyantPasse) {
            gameState.joueursAyantPasse = { 1: false, 2: false, 3: false, 4: false, 5: false };
        }
        
        // Marquer ce joueur comme ayant pass√©
        gameState.joueursAyantPasse[j] = true;
        
        showToast(`‚è≠Ô∏è J${j} ‚Äì ${JOUEURS_CONFIG[j].nom} passe son tour`, 'info');
        
        // V√©rifier si tous les joueurs ont pass√© ou ne peuvent plus jouer
        if (verifierFinManche1()) {
            // Tous les joueurs ont pass√© ou ne peuvent plus jouer
            showToast('üèÅ Fin de la Manche 1 - Plus personne ne peut jouer', 'warning');
            setTimeout(() => {
                entrerPhaseDebriefing();
            }, 1000);
            return;
        }
        
        // Passer au joueur suivant
        passerAuJoueurSuivant();
    }
    
    // V√©rifier si la Manche 1 doit se terminer
    function verifierFinManche1() {
        const budgetRestant = gameState.budgetManche1;
        
        // V√©rifier pour chaque joueur s'il peut acheter au moins une carte
        for (let joueur = 1; joueur <= 5; joueur++) {
            const cartes = CARTES_MANCHE1[joueur] || [];
            const cartesAchetees = gameState.cartesAchetees[joueur] || [];
            
            // V√©rifier si ce joueur peut acheter au moins une carte
            const peutAcheter = cartes.some(c => 
                !cartesAchetees.includes(c.id) && budgetRestant >= c.cout
            );
            
            // Si le joueur peut acheter ET n'a pas pass√©, la manche continue
            if (peutAcheter && !gameState.joueursAyantPasse[joueur]) {
                return false;
            }
        }
        
        // Si on arrive ici, tous les joueurs ont soit pass√©, soit ne peuvent plus acheter
        return true;
    }
    
    // Passer au joueur suivant (reset les passes quand on revient au d√©but)
    function passerAuJoueurSuivant() {
        const ordreJoueurs = [1, 2, 3, 4, 5];
        const indexActuel = ordreJoueurs.indexOf(gameState.joueurActuel);
        const prochainIndex = (indexActuel + 1) % 5;
        const prochainJoueur = ordreJoueurs[prochainIndex];
        
        // Si on a fait un tour complet, r√©initialiser les passes pour un nouveau round
        if (prochainIndex === 0) {
            gameState.joueursAyantPasse = { 1: false, 2: false, 3: false, 4: false, 5: false };
            gameState.roundManche1 = (gameState.roundManche1 || 1) + 1;
        }
        
        gameState.joueurActuel = prochainJoueur;
        
        // Montrer le modal du joueur suivant
        showPlayerTurnModal();
        render();
    }
    
    // Toggle ready status for Manche 2 and 3 validation
    function toggleReadyManche(joueurId) {
        const manche = gameState.manche;
        
        if (manche === 2) {
            gameState.joueursReadyM2[joueurId] = !gameState.joueursReadyM2[joueurId];
            const nom = JOUEURS_CONFIG[joueurId].nom;
            if (gameState.joueursReadyM2[joueurId]) {
                showToast(`${JOUEURS_CONFIG[joueurId].emoji} ${nom} est pr√™t !`, 'success');
            }
        } else if (manche === 3) {
            gameState.joueursReadyM3[joueurId] = !gameState.joueursReadyM3[joueurId];
            const nom = JOUEURS_CONFIG[joueurId].nom;
            if (gameState.joueursReadyM3[joueurId]) {
                showToast(`${JOUEURS_CONFIG[joueurId].emoji} ${nom} est pr√™t !`, 'success');
            }
        }
        
        render();
    }
    
    // Pass to Manche 3 from validation screen
    function passerManche3FromValidation() {
        // Check all players are ready
        if (!Object.values(gameState.joueursReadyM2).every(r => r)) {
            showToast('Tous les joueurs doivent √™tre pr√™ts !', 'error');
            return;
        }
        
        // Show revelation modal M2 then pass to Manche 3
        showRevelationModalM2();
    }
    
    // Terminate simulation from Manche 3 validation
    function terminerSimulation() {
        // Check all players are ready
        if (!Object.values(gameState.joueursReadyM3).every(r => r)) {
            showToast('Tous les joueurs doivent √™tre pr√™ts !', 'error');
            return;
        }
        
        // Show final results
        showFinalResults();
    }
    
    function entrerPhaseDebriefing() {
        // R√©initialiser les statuts "pr√™t"
        for (let i = 1; i <= 5; i++) gameState.joueursReady[i] = false;
        
        // Activer la phase de d√©briefing
        gameState.phaseDebriefing = true;
        gameState.hiddenRevealed = true;
        
        // Afficher le modal de r√©v√©lation
        showRevelationModal();
        
        render();
        renderDevPanel();
    }
    
    function entrerPhaseDebriefing2() {
        // R√©initialiser les statuts "pr√™t"
        for (let i = 1; i <= 5; i++) gameState.joueursReady[i] = false;
        
        // Activer la phase de d√©briefing 2
        gameState.phaseDebriefing2 = true;
        
        // Afficher le modal de r√©v√©lation M2
        showRevelationModalM2();
        
        render();
        renderDevPanel();
    }
    
    function confirmerComprehension() {
        // Fonction legacy - utiliser toggleComprisJoueur √† la place
        const joueur = gameState.joueurActuel;
        toggleComprisJoueur(joueur);
    }
    
    function finirDebriefingEtPasserManche2() {
        gameState.phaseDebriefing = false;
        gameState.manche = 2;
        
        // Budget commun de 300 pts pour la collaboration
        gameState.budgetCommun = 300;
        
        // R√©initialiser les √©tats
        for (let i = 1; i <= 5; i++) {
            gameState.joueursCompris[i] = false;
            gameState.joueursReady[i] = false;
        }
        
        // Retourner √† la page principale
        showPage('dashboard');
        
        showToast('üéâ Bienvenue en Manche 2 - Mode Collaboratif !', 'success');
        render();
        renderDevPanel();
    }
    
    function skipDebriefing() {
        if (!gameState.phaseDebriefing) return;
        finirDebriefingEtPasserManche2();
        showToast('‚è≠Ô∏è D√©briefing saut√© (mode dev)', 'warning');
    }
    
    function showFinalResults() {
        const modal = document.getElementById('finalResultsModal');
        const h = gameState.hidden;
        const hi = HIDDEN_INITIAL;
        
        // Calculer les statistiques finales
        const totalCartes = gameState.historique.length;
        const cartesM1 = gameState.historique.filter(e => e.manche === 1).length;
        const cartesM2 = gameState.historique.filter(e => e.manche === 2).length;
        const cartesM3 = gameState.historique.filter(e => e.manche === 3).length;
        const totalDepense = gameState.historique.reduce((sum, e) => sum + e.carte.cout, 0);
        
        // Comparaison avant/apr√®s
        // Calculer VAG et CGE actuels
        const vagActuel = calculerVAGTotal();
        const cgeActuel = calculerCGETotal();
        const rbeActuel = calculerRBE();
        
        // Calculer VAG et CGE initiaux (simul√©s)
        let vagInitial = 0;
        for (const mfId in MICRO_FLUX) {
            const mf = MICRO_FLUX[mfId];
            // Utiliser les fonctions de calcul
            const dar = calculerDAR(mf);
            const dmaint = calculerDMAINT(mf);
            const dbfr = calculerDBFR(mf);
            const ddp = dar + dmaint + dbfr;
            const vag = mf.PV - ddp;
            vagInitial += vag * mf.QV;
        }
        let cgeInitial = 0;
        for (const key in CGE_INITIAL) cgeInitial += CGE_INITIAL[key];
        
        document.getElementById('finalComparison').innerHTML = `
            <div class="final-comparison-card before">
                <h4>‚ùå Apr√®s Manche 1 (Avant correction)</h4>
                <div class="final-stat-row">
                    <span class="final-stat-label">PIG Initial</span>
                    <span class="final-stat-value">${hi.pig.toFixed(2)}</span>
                </div>
                <div class="final-stat-row">
                    <span class="final-stat-label">Vitesse (s)</span>
                    <span class="final-stat-value">${(hi.s * 100).toFixed(0)}%</span>
                </div>
                <div class="final-stat-row">
                    <span class="final-stat-label">Environnement (r)</span>
                    <span class="final-stat-value">${(hi.r * 100).toFixed(0)}%</span>
                </div>
                <div class="final-stat-row">
                    <span class="final-stat-label">Satisfaction (q)</span>
                    <span class="final-stat-value">${(hi.q * 100).toFixed(0)}%</span>
                </div>
                <div class="final-stat-row">
                    <span class="final-stat-label">VAG / CGE</span>
                    <span class="final-stat-value">‚Ç¨${formatNumber(Math.round(vagInitial))} / ‚Ç¨${formatNumber(Math.round(cgeInitial))}</span>
                </div>
            </div>
            <div class="final-comparison-card after">
                <h4>‚úÖ R√©sultats Finaux</h4>
                <div class="final-stat-row">
                    <span class="final-stat-label">PIG Final</span>
                    <span class="final-stat-value" style="color: ${h.pig > hi.pig ? 'var(--success)' : 'var(--danger)'}">${h.pig.toFixed(2)}</span>
                </div>
                <div class="final-stat-row">
                    <span class="final-stat-label">Vitesse (s)</span>
                    <span class="final-stat-value" style="color: ${h.s > hi.s ? 'var(--success)' : 'var(--danger)'}">${(h.s * 100).toFixed(0)}%</span>
                </div>
                <div class="final-stat-row">
                    <span class="final-stat-label">Environnement (r)</span>
                    <span class="final-stat-value" style="color: ${h.r > hi.r ? 'var(--success)' : 'var(--danger)'}">${(h.r * 100).toFixed(0)}%</span>
                </div>
                <div class="final-stat-row">
                    <span class="final-stat-label">Satisfaction (q)</span>
                    <span class="final-stat-value" style="color: ${h.q > hi.q ? 'var(--success)' : 'var(--danger)'}">${(h.q * 100).toFixed(0)}%</span>
                </div>
                <div class="final-stat-row">
                    <span class="final-stat-label">VAG / CGE</span>
                    <span class="final-stat-value" style="color: ${rbeActuel > (vagInitial - cgeInitial) ? 'var(--success)' : 'var(--danger)'}">‚Ç¨${formatNumber(Math.round(vagActuel))} / ‚Ç¨${formatNumber(Math.round(cgeActuel))}</span>
                </div>
                <div class="final-stat-row">
                    <span class="final-stat-label">RBE</span>
                    <span class="final-stat-value" style="color: ${rbeActuel >= 0 ? 'var(--success)' : 'var(--danger)'}">‚Ç¨${formatNumber(Math.round(rbeActuel))}</span>
                </div>
            </div>
        `;
        
        // √âvolution des indicateurs
        const pigChange = ((h.pig - hi.pig) / hi.pig * 100);
        const sChange = ((h.s - hi.s) / hi.s * 100);
        const rChange = ((h.r - hi.r) / hi.r * 100);
        const qChange = ((h.q - hi.q) / hi.q * 100);
        
        document.getElementById('finalEvolution').innerHTML = `
            <h3>üìä √âvolution des Performances</h3>
            <div class="evolution-grid">
                <div class="evolution-item">
                    <div class="evolution-label">PIG</div>
                    <div class="evolution-change ${pigChange >= 0 ? 'positive' : 'negative'}">${pigChange >= 0 ? '+' : ''}${pigChange.toFixed(1)}%</div>
                </div>
                <div class="evolution-item">
                    <div class="evolution-label">Vitesse (s)</div>
                    <div class="evolution-change ${sChange >= 0 ? 'positive' : 'negative'}">${sChange >= 0 ? '+' : ''}${sChange.toFixed(1)}%</div>
                </div>
                <div class="evolution-item">
                    <div class="evolution-label">Environnement (r)</div>
                    <div class="evolution-change ${rChange >= 0 ? 'positive' : 'negative'}">${rChange >= 0 ? '+' : ''}${rChange.toFixed(1)}%</div>
                </div>
                <div class="evolution-item">
                    <div class="evolution-label">Satisfaction (q)</div>
                    <div class="evolution-change ${qChange >= 0 ? 'positive' : 'negative'}">${qChange >= 0 ? '+' : ''}${qChange.toFixed(1)}%</div>
                </div>
                <div class="evolution-item">
                    <div class="evolution-label">Cartes Jou√©es</div>
                    <div class="evolution-change neutral">${totalCartes}</div>
                </div>
            </div>
        `;
        
        // Enseignements
        const lessons = [];
        if (cartesM1 > 0) {
            lessons.push({ icon: '‚ö†Ô∏è', text: `Manche 1 : ${cartesM1} d√©cisions individuelles ont g√©n√©r√© des impacts cach√©s n√©gatifs sur la performance globale.` });
        }
        if (pigChange < 0) {
            lessons.push({ icon: 'üìâ', text: `Le PIG a diminu√© de ${Math.abs(pigChange).toFixed(1)}% - les optimisations locales ont nui √† la performance globale.` });
        } else {
            lessons.push({ icon: 'üìà', text: `Le PIG a augment√© de ${pigChange.toFixed(1)}% - la collaboration a permis de r√©parer et am√©liorer le syst√®me.` });
        }
        if (cartesM2 > 0) {
            lessons.push({ icon: 'ü§ù', text: `Manche 2 : ${cartesM2} am√©liorations Lean/Green collaboratives ont √©t√© mises en ≈ìuvre.` });
        }
        lessons.push({ icon: 'üí°', text: `Enseignement cl√© : Optimiser son poste sans vision globale peut d√©truire la valeur pour le client et l'entreprise.` });
        lessons.push({ icon: 'üéØ', text: `Le Lean & Green n√©cessite une approche syst√©mique : PIG = s √ó q √ó r √ó TEG` });
        
        document.getElementById('finalLessons').innerHTML = lessons.map(l => `
            <div class="lesson-item">
                <span class="lesson-icon">${l.icon}</span>
                <span>${l.text}</span>
            </div>
        `).join('');
        
        modal.classList.add('active');
    }
    
    function closeFinalResults() {
        document.getElementById('finalResultsModal').classList.remove('active');
        resetGame(true); // true = skip confirmation
    }
    
    function exportFinalReport() {
        const h = gameState.hidden;
        const hi = HIDDEN_INITIAL;
        
        let report = `TABLEAU TACTIQUE - RAPPORT FINAL\n`;
        report += `${'='.repeat(50)}\n\n`;
        report += `Date: ${new Date().toLocaleDateString('fr-FR')}\n\n`;
        
        report += `INDICATEURS DE D√âPART:\n`;
        report += `- PIG: ${hi.pig.toFixed(2)}\n`;
        report += `- Vitesse (s): ${(hi.s * 100).toFixed(0)}%\n`;
        report += `- Environnement (r): ${(hi.r * 100).toFixed(0)}%\n`;
        report += `- Satisfaction (q): ${(hi.q * 100).toFixed(0)}%\n`;
        report += `- VAG: ‚Ç¨${formatNumber(Math.round(vagInitial))} | CGE: ‚Ç¨${formatNumber(Math.round(cgeInitial))}\n\n`;
        
        report += `R√âSULTATS FINAUX:\n`;
        report += `- PIG: ${h.pig.toFixed(2)}\n`;
        report += `- Vitesse (s): ${(h.s * 100).toFixed(0)}%\n`;
        report += `- Environnement (r): ${(h.r * 100).toFixed(0)}%\n`;
        report += `- Satisfaction (q): ${(h.q * 100).toFixed(0)}%\n`;
        report += `- VAG: ‚Ç¨${formatNumber(Math.round(vagActuel))} | CGE: ‚Ç¨${formatNumber(Math.round(cgeActuel))}\n`;
        report += `- RBE: ‚Ç¨${formatNumber(Math.round(rbeActuel))}\n\n`;
        
        report += `HISTORIQUE DES D√âCISIONS:\n`;
        gameState.historique.forEach((e, i) => {
            report += `${i+1}. [M${e.manche}] ${e.carte.nom} (J${e.joueur}) - ${e.carte.cout} pts\n`;
        });
        
        const blob = new Blob([report], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tableau_tactique_rapport_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('Rapport export√© !', 'success');
    }
    
    function passerMancheSuivante() {
        for (let i = 1; i <= 5; i++) gameState.joueursReady[i] = false;
        gameState.manche++;
        
        if (gameState.manche === 2) {
            // Passage √† la manche 2 : Focus RBE
            gameState.budgetCommun = 300;
            showToast('üí∞ Manche 2 : Maximisez le RBE !', 'success');
        } else if (gameState.manche === 3) {
            // Passage √† la manche 3 : Focus PIG
            gameState.budgetCommun = 300;
            showToast('üåø Manche 3 : Maximisez le PIG !', 'success');
        }
        render();
    }
    
    // Fonction de formatage des nombres (max 4 chiffres)
    function formatNumber(num) {
        const absNum = Math.abs(num);
        if (absNum >= 1000000000) {
            return (num / 1000000000).toFixed(1) + 'G';
        } else if (absNum >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (absNum >= 10000) {
            return (num / 1000).toFixed(0) + 'k';
        } else if (absNum >= 1000) {
            return (num / 1000).toFixed(1) + 'k';
        } else {
            return Math.round(num).toString();
        }
    }
    
    function showRevelationModal() {
        gameState.revelationShown = true;
        const modal = document.getElementById('revelationModal');
        const statsDiv = document.getElementById('modalStats');
        
        // Calculer VAG et CGE
        const vagActuel = calculerVAGTotal();
        const cgeActuel = calculerCGETotal();
        let vagInitial = 0;
        for (const mfId in MICRO_FLUX) {
            const mf = MICRO_FLUX[mfId];
            const dar = calculerDAR(mf);
            const dmaint = calculerDMAINT(mf);
            const dbfrUnitaire = calculerDBFR(mf);
            const ddp = dar + dmaint + dbfrUnitaire;
            vagInitial += (mf.PV - ddp) * mf.QV;
        }
        let cgeInitial = 0;
        for (const key in CGE_INITIAL) cgeInitial += CGE_INITIAL[key];
        
        // Calculer RBE
        const rbeActuel = calculerRBE();
        const rbeInitial = vagInitial - cgeInitial;
        const rbeChange = rbeActuel - rbeInitial;
        const rbeChangePercent = (rbeChange / Math.abs(rbeInitial)) * 100;
        
        const vagChange = vagActuel - vagInitial;
        const cgeChange = cgeActuel - cgeInitial;
        
        // Commentaires VAG
        let vagComment = '';
        const vagChangePercent = vagInitial !== 0 ? (vagChange / Math.abs(vagInitial)) * 100 : 0;
        if (vagChangePercent < -20) {
            vagComment = `<div class="modal-comment critical">¬´ La Valeur Ajout√©e s'effondre. Les co√ªts cach√©s ont d√©vor√© nos marges. Nous devons r√©agir. ¬ª</div>`;
        } else if (vagChangePercent < -5) {
            vagComment = `<div class="modal-comment warning">¬´ La VAG diminue. Vos optimisations locales ont eu des effets inattendus sur la cr√©ation de valeur. ¬ª</div>`;
        } else if (vagChangePercent > 10) {
            vagComment = `<div class="modal-comment good">¬´ Excellent ! La VAG progresse. L'entreprise cr√©e plus de valeur. ¬ª</div>`;
        }
        
        // Commentaires CGE
        let cgeComment = '';
        const cgeChangePercent = cgeInitial !== 0 ? (cgeChange / cgeInitial) * 100 : 0;
        if (cgeChangePercent > 15) {
            cgeComment = `<div class="modal-comment critical">¬´ Les charges explosent ! O√π est pass√© le contr√¥le budg√©taire ? ¬ª</div>`;
        } else if (cgeChangePercent > 5) {
            cgeComment = `<div class="modal-comment warning">¬´ Les charges augmentent. Restons vigilants. ¬ª</div>`;
        } else if (cgeChangePercent < -10) {
            cgeComment = `<div class="modal-comment good">¬´ Bonne ma√Ætrise des charges, mais attention √† ne pas sacrifier la qualit√©. ¬ª</div>`;
        }
        
        // Commentaire RBE
        let rbeComment = '';
        if (rbeChangePercent < -30) {
            rbeComment = `<div class="modal-comment critical" style="grid-column: span 2; margin-top: 16px; padding: 16px; font-size: 1em;">
                <strong>¬´ Je suis tr√®s pr√©occup√© par ces r√©sultats.</strong><br><br>
                Chacun d'entre vous a fait son travail... mais l'entreprise est perdante. Les r√©percussions en cascade de vos d√©cisions individuelles ont cr√©√© un d√©sastre collectif.<br><br>
                <em>Cela ne peut plus continuer ainsi. ¬ª</em>
            </div>`;
        } else if (rbeChangePercent < -10) {
            rbeComment = `<div class="modal-comment warning" style="grid-column: span 2; margin-top: 16px; padding: 16px; font-size: 1em;">
                <strong>¬´ Le r√©sultat se d√©grade.</strong><br><br>
                Vos d√©cisions ont eu des impacts crois√©s que vous n'aviez peut-√™tre pas anticip√©s. Il est temps de changer d'approche. ¬ª
            </div>`;
        } else if (rbeChangePercent > 10) {
            rbeComment = `<div class="modal-comment good" style="grid-column: span 2; margin-top: 16px; padding: 16px; font-size: 1em;">
                <strong>¬´ Bravo, le r√©sultat s'am√©liore !</strong> Continuez dans cette voie. ¬ª
            </div>`;
        }
        
        statsDiv.innerHTML = `
            <div class="modal-stat" style="grid-column: span 2;">
                <div class="modal-stat-label">üìä VAG (Valeur Ajout√©e Globale)</div>
                <div class="modal-stat-value ${vagChange < 0 ? 'negative' : 'positive'}" style="font-size: 1.3em;">
                    ‚Ç¨${formatNumber(vagInitial)} ‚Üí ‚Ç¨${formatNumber(vagActuel)}
                    <span style="font-size: 0.7em; margin-left: 8px;">(${vagChangePercent >= 0 ? '+' : ''}${vagChangePercent.toFixed(1)}%)</span>
                </div>
                ${vagComment}
            </div>
            <div class="modal-stat" style="grid-column: span 2;">
                <div class="modal-stat-label">üí∞ CGE (Charges Globales d'Exploitation)</div>
                <div class="modal-stat-value ${cgeChange > 0 ? 'negative' : cgeChange < 0 ? 'positive' : ''}" style="font-size: 1.3em;">
                    ‚Ç¨${formatNumber(cgeInitial)} ‚Üí ‚Ç¨${formatNumber(cgeActuel)}
                    <span style="font-size: 0.7em; margin-left: 8px;">(${cgeChangePercent >= 0 ? '+' : ''}${cgeChangePercent.toFixed(1)}%)</span>
                </div>
                ${cgeComment}
            </div>
            <div class="modal-stat" style="grid-column: span 2; background: ${rbeChange < 0 ? 'rgba(239, 68, 68, 0.3)' : 'rgba(34, 197, 94, 0.3)'}; padding: 20px;">
                <div class="modal-stat-label" style="font-size: 1.1em;">üíπ RBE = VAG ‚àí CGE (R√©sultat Brut d'Exploitation)</div>
                <div class="modal-stat-value" style="font-size: 1.6em; color: ${rbeChange < 0 ? 'var(--danger)' : 'var(--success)'};">
                    ‚Ç¨${formatNumber(rbeInitial)} ‚Üí ‚Ç¨${formatNumber(rbeActuel)}
                    <span style="font-size: 0.6em; margin-left: 8px;">(${rbeChangePercent >= 0 ? '+' : ''}${rbeChangePercent.toFixed(1)}%)</span>
                </div>
            </div>
            ${rbeComment}
        `;
        modal.classList.add('active');
    }
    
    function closeModal() {
        document.getElementById('revelationModal').classList.remove('active');
    }
    
    function closeModalAndGoToHistory() {
        document.getElementById('revelationModal').classList.remove('active');
        // Aller directement √† la page historique
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('history').classList.add('active');
        document.getElementById('navHistory').classList.add('active');
    }
    
    function showRevelationModalM2() {
        const modal = document.getElementById('revelationModalM2');
        const statsDiv = document.getElementById('modalStatsM2');
        const h = gameState.hidden;
        const hi = HIDDEN_INITIAL;
        
        // Calculer TEG pour le PIG
        const teg = calculerTEG();
        const tegInitial = 1.0; // TEG initial th√©orique
        
        // Calculer VAG, CGE et RBE
        const vagActuel = calculerVAGTotal();
        const cgeActuel = calculerCGETotal();
        const rbeActuel = calculerRBE();
        
        // Valeurs initiales (approximatives)
        let vagInitial = 0, cgeInitial = 0;
        for (const mfId in MICRO_FLUX) {
            const mf = MICRO_FLUX[mfId];
            vagInitial += calculerVAG(mf) * mf.QV;
        }
        for (const key in CGE_INITIAL) cgeInitial += CGE_INITIAL[key];
        const rbeInitial = vagInitial - cgeInitial;
        
        // Calculer PIG actuel et initial
        const pigActuel = h.s * h.q * h.r * teg;
        const pigInitial = hi.s * hi.q * hi.r * tegInitial;
        const pigChange = pigActuel - pigInitial;
        const pigChangePercent = pigInitial !== 0 ? (pigChange / pigInitial) * 100 : 0;
        
        // Variations des indicateurs
        const sChange = h.s - hi.s;
        const qChange = h.q - hi.q;
        const rChange = h.r - hi.r;
        const vagChange = vagActuel - vagInitial;
        const rbeChange = rbeActuel - rbeInitial;
        
        // Commentaires sur s (R√©activit√©/Vitesse)
        let sComment = '';
        if (sChange < -0.15) {
            sComment = `<div class="modal-comment critical">‚ö†Ô∏è Les d√©lais explosent, les stocks s'accumulent. L'entreprise est devenue lente et rigide.</div>`;
        } else if (sChange < -0.05) {
            sComment = `<div class="modal-comment warning">üì¶ La r√©activit√© diminue. Les flux sont ralentis.</div>`;
        } else if (sChange > 0.05) {
            sComment = `<div class="modal-comment good">‚úÖ L'entreprise est plus r√©active et agile.</div>`;
        }
        
        // Commentaires sur q (Satisfaction Client)
        let qComment = '';
        if (qChange < -0.15) {
            qComment = `<div class="modal-comment critical">‚ö†Ô∏è Les clients fuient ! Qualit√© d√©grad√©e, retards, r√©clamations en hausse.</div>`;
        } else if (qChange < -0.05) {
            qComment = `<div class="modal-comment warning">üòü La satisfaction client diminue progressivement.</div>`;
        } else if (qChange > 0.05) {
            qComment = `<div class="modal-comment good">‚úÖ Les clients sont plus satisfaits.</div>`;
        }
        
        // Commentaires sur r (RSE/Environnement)
        let rComment = '';
        if (rChange < -0.15) {
            rComment = `<div class="modal-comment critical">‚ö†Ô∏è L'empreinte environnementale explose ! Transports, d√©chets, √©nergie...</div>`;
        } else if (rChange < -0.05) {
            rComment = `<div class="modal-comment warning">üåç L'impact environnemental se d√©grade.</div>`;
        } else if (rChange > 0.05) {
            rComment = `<div class="modal-comment good">‚úÖ L'entreprise est plus responsable.</div>`;
        }
        
        // Commentaire PIG
        let pigComment = '';
        if (pigChangePercent < -30) {
            pigComment = `<div class="modal-comment critical" style="grid-column: span 2; margin-top: 16px; padding: 16px; font-size: 1em;">
                üíÄ <strong>PERFORMANCE GLOBALE EN CHUTE LIBRE</strong><br><br>
                Le PIG s'est effondr√©. L'entreprise est moins r√©active, moins satisfaisante pour les clients, et moins responsable.
            </div>`;
        } else if (pigChangePercent < -10) {
            pigComment = `<div class="modal-comment warning" style="grid-column: span 2; margin-top: 16px; padding: 16px; font-size: 1em;">
                ‚ö†Ô∏è <strong>Le PIG diminue</strong> - La performance interactionnelle globale se d√©grade.
            </div>`;
        } else if (pigChangePercent > 10) {
            pigComment = `<div class="modal-comment good" style="grid-column: span 2; margin-top: 16px; padding: 16px; font-size: 1em;">
                üéâ <strong>Excellent !</strong> Le PIG s'am√©liore. L'entreprise progresse sur tous les fronts !
            </div>`;
        }
        
        statsDiv.innerHTML = `
            <div class="modal-stat" style="background: ${vagChange < 0 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)'};">
                <div class="modal-stat-label">üìà VAG Totale (Valeur Ajout√©e)</div>
                <div class="modal-stat-value ${vagChange < 0 ? 'negative' : 'positive'}" style="font-size: 1.2em;">
                    ‚Ç¨${formatNumber(Math.round(vagInitial))} ‚Üí ‚Ç¨${formatNumber(Math.round(vagActuel))}
                    <span style="font-size: 0.7em; margin-left: 8px;">(${vagChange >= 0 ? '+' : ''}‚Ç¨${formatNumber(Math.round(vagChange))})</span>
                </div>
            </div>
            <div class="modal-stat" style="background: ${rbeChange < 0 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)'};">
                <div class="modal-stat-label">üí∞ RBE (R√©sultat Brut)</div>
                <div class="modal-stat-value ${rbeChange < 0 ? 'negative' : 'positive'}" style="font-size: 1.2em;">
                    ‚Ç¨${formatNumber(Math.round(rbeInitial))} ‚Üí ‚Ç¨${formatNumber(Math.round(rbeActuel))}
                    <span style="font-size: 0.7em; margin-left: 8px;">(${rbeChange >= 0 ? '+' : ''}‚Ç¨${formatNumber(Math.round(rbeChange))})</span>
                </div>
            </div>
            <div class="modal-stat">
                <div class="modal-stat-label">‚ö° R√©activit√© (s)</div>
                <div class="modal-stat-value ${sChange < 0 ? 'negative' : 'positive'}" style="font-size: 1.2em;">
                    ${(hi.s*100).toFixed(0)}% ‚Üí ${(h.s*100).toFixed(0)}%
                    <span style="font-size: 0.7em; margin-left: 8px;">(${sChange >= 0 ? '+' : ''}${(sChange*100).toFixed(0)}%)</span>
                </div>
                ${sComment}
            </div>
            <div class="modal-stat">
                <div class="modal-stat-label">üòä Satisfaction Client (q)</div>
                <div class="modal-stat-value ${qChange < 0 ? 'negative' : 'positive'}" style="font-size: 1.2em;">
                    ${(hi.q*100).toFixed(0)}% ‚Üí ${(h.q*100).toFixed(0)}%
                    <span style="font-size: 0.7em; margin-left: 8px;">(${qChange >= 0 ? '+' : ''}${(qChange*100).toFixed(0)}%)</span>
                </div>
                ${qComment}
            </div>
            <div class="modal-stat" style="grid-column: span 2;">
                <div class="modal-stat-label">üåç Responsabilit√© Environnementale (r)</div>
                <div class="modal-stat-value ${rChange < 0 ? 'negative' : 'positive'}" style="font-size: 1.2em;">
                    ${(hi.r*100).toFixed(0)}% ‚Üí ${(h.r*100).toFixed(0)}%
                    <span style="font-size: 0.7em; margin-left: 8px;">(${rChange >= 0 ? '+' : ''}${(rChange*100).toFixed(0)}%)</span>
                </div>
                ${rComment}
            </div>
            <div class="modal-stat" style="grid-column: span 2; background: ${pigChange < 0 ? 'rgba(239, 68, 68, 0.3)' : 'rgba(34, 197, 94, 0.3)'}; padding: 20px;">
                <div class="modal-stat-label" style="font-size: 1.1em;">üéØ PIG = s √ó q √ó r √ó TEG (Performance Interactionnelle Globale)</div>
                <div class="modal-stat-value" style="font-size: 1.6em; color: ${pigChange < 0 ? 'var(--danger)' : 'var(--success)'};">
                    ${pigInitial.toFixed(2)} ‚Üí ${pigActuel.toFixed(2)}
                    <span style="font-size: 0.6em; margin-left: 8px;">(${pigChangePercent >= 0 ? '+' : ''}${pigChangePercent.toFixed(1)}%)</span>
                </div>
            </div>
            ${pigComment}
        `;
        modal.classList.add('active');
    }
    
    function passerManche3() {
        document.getElementById('revelationModalM2').classList.remove('active');
        
        gameState.phaseDebriefing2 = false;
        gameState.manche = 3;
        gameState.budgetCommun = 300;
        
        // R√©initialiser les √©tats
        for (let i = 1; i <= 5; i++) {
            gameState.joueursReady[i] = false;
        }
        
        showToast('üåø Bienvenue en Manche 3 - Optimisez le PIG !', 'success');
        render();
        renderDevPanel();
    }
    
    function changeJoueur() {
        const manche = gameState.manche;
        
        // En Manche 1 : les joueurs jouent √† tour de r√¥le, pas de changement manuel
        if (manche === 1 && !gameState.phaseDebriefing && !devMode.showHidden) {
            showToast('En Manche 1, les joueurs jouent √† tour de r√¥le !', 'warning');
            document.getElementById('selectJoueur').value = gameState.joueurActuel;
            return;
        }
        
        // En Manche 2 et 3 : mode collaboratif, pas de changement
        if (manche >= 2 && !devMode.showHidden) {
            showToast('Mode collaboratif : tous les joueurs partagent la vue !', 'info');
            document.getElementById('selectJoueur').value = gameState.joueurActuel;
            return;
        }
        
        gameState.joueurActuel = parseInt(document.getElementById('selectJoueur').value);
        render();
    }
    
    function showPage(pageId) {
        if (pageId === 'vsm' && gameState.manche === 1 && !gameState.phaseDebriefing && !devMode.unlockVSM) {
            showToast('VSM disponible √† partir de la Manche 2', 'warning');
            return;
        }
        // Historique toujours accessible
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        // Activer l'onglet correspondant
        const navMap = { 'dashboard': 'navDashboard', 'vsm': 'navVSM', 'ranking': 'navRanking', 'history': 'navHistory' };
        if (navMap[pageId]) {
            const navEl = document.getElementById(navMap[pageId]);
            if (navEl) navEl.classList.add('active');
        }
    }
    
    function render() {
        const j = gameState.joueurActuel;
        const config = JOUEURS_CONFIG[j];
        const indic = gameState.indicateurs[j];
        const manche = gameState.manche;
        const h = gameState.hidden;
        
        // Ajuster le layout selon la manche
        const mainGrid = document.querySelector('.main-grid');
        if (mainGrid) {
            if (manche >= 2) {
                mainGrid.classList.add('full-width-cards');
            } else {
                mainGrid.classList.remove('full-width-cards');
            }
        }
        
        // Update current player display
        const currentPlayerDisplay = document.getElementById('currentPlayerDisplay');
        if (currentPlayerDisplay) {
            if (manche >= 2) {
                currentPlayerDisplay.textContent = 'ü§ù Mode Collaboratif';
            } else {
                currentPlayerDisplay.textContent = `J${j} ‚Äì ${config.nom}`;
            }
        }
        
        // Header - Afficher "D√©briefing" si phase active
        if (gameState.phaseDebriefing) {
            document.getElementById('mancheBadge').textContent = '‚ö†Ô∏è D√©briefing';
            document.getElementById('mancheBadge').style.background = 'linear-gradient(135deg, #ef4444, #f43f5e)';
        } else if (gameState.phaseDebriefing2) {
            document.getElementById('mancheBadge').textContent = '‚ö†Ô∏è D√©briefing M2';
            document.getElementById('mancheBadge').style.background = 'linear-gradient(135deg, #f59e0b, #eab308)';
        } else {
            document.getElementById('mancheBadge').textContent = `Manche ${manche}`;
            document.getElementById('mancheBadge').style.background = '';
        }
        document.getElementById('playerBadge').textContent = `J${j} ‚Äì ${config.nom}`;
        
        // Cacher le s√©lecteur de joueur en Manche 2 et 3 (mode collaboratif)
        const selectJoueurGroup = document.getElementById('selectJoueurGroup');
        if (manche >= 2 && !devMode.showHidden) {
            selectJoueurGroup.style.display = 'none';
            document.getElementById('playerBadge').textContent = 'ü§ù √âquipe';
        } else {
            selectJoueurGroup.style.display = '';
        }
        
        // D√©sactiver le changement de joueur en Manche 1 (tour par tour)
        const selectJoueur = document.getElementById('selectJoueur');
        if (manche === 1 && !devMode.showHidden) {
            selectJoueur.disabled = true;
            selectJoueur.style.opacity = '0.6';
            selectJoueur.style.cursor = 'not-allowed';
            selectJoueur.title = 'Les joueurs jouent √† tour de r√¥le';
        } else {
            selectJoueur.disabled = false;
            selectJoueur.style.opacity = '1';
            selectJoueur.style.cursor = 'pointer';
            selectJoueur.title = '';
        }
        
        // Indicateur principal par joueur en M1
        const kpiBadge = document.getElementById('kpiBadge');
        if (manche === 1 && !gameState.phaseDebriefing) {
            if (j === 1) {
                // J1 Commercial: Marge
                let margeTotal = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    margeTotal += (mf.PV - mf.DA) * mf.QV;
                }
                kpiBadge.textContent = `Marge: ${formatNumber(Math.round(margeTotal/1000))}k‚Ç¨`;
                kpiBadge.style.background = margeTotal >= 500000 ? 'linear-gradient(135deg, #22c55e, #10b981)' : margeTotal >= 300000 ? 'linear-gradient(135deg, #f59e0b, #eab308)' : 'linear-gradient(135deg, #ef4444, #f43f5e)';
            } else if (j === 2) {
                // J2 Appro: CR moyen
                let crTotal = 0;
                let qvTotal = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    crTotal += calculerDDP(mf) * mf.QV;
                    qvTotal += mf.QV;
                }
                const crMoyen = qvTotal > 0 ? crTotal / qvTotal : 0;
                kpiBadge.textContent = `CR: ${formatNumber(Math.round(crMoyen))}‚Ç¨`;
                kpiBadge.style.background = crMoyen <= 1500 ? 'linear-gradient(135deg, #22c55e, #10b981)' : crMoyen <= 2000 ? 'linear-gradient(135deg, #f59e0b, #eab308)' : 'linear-gradient(135deg, #ef4444, #f43f5e)';
            } else if (j === 3) {
                // J3 Logistique: Budget/CGE
                const bfrTotal = calculerBFRTotal();
                const bfrActuel = gameState.contraintes.BFR_actuel || 0;
                const budgetDisponible = bfrTotal - bfrActuel;
                const cgeTotal = calculerCGETotal();
                const ratio = cgeTotal > 0 ? budgetDisponible / cgeTotal : 0;
                kpiBadge.textContent = `Budget/CGE: ${ratio.toFixed(2)}`;
                kpiBadge.style.background = ratio >= 1.5 ? 'linear-gradient(135deg, #22c55e, #10b981)' : ratio >= 1 ? 'linear-gradient(135deg, #f59e0b, #eab308)' : 'linear-gradient(135deg, #ef4444, #f43f5e)';
            } else if (j === 4) {
                // J4 Production: TRG moyen
                let trgSum = 0;
                let machineCount = 0;
                for (const [machineId, machine] of Object.entries(gameState.machines)) {
                    const chargePercent = machine.capacite > 0 ? Math.min(100, (machine.charge / machine.capacite * 100)) : 0;
                    trgSum += chargePercent;
                    machineCount++;
                }
                const trgMoyen = machineCount > 0 ? trgSum / machineCount : 0;
                kpiBadge.textContent = `TRG: ${trgMoyen.toFixed(0)}%`;
                kpiBadge.style.background = trgMoyen >= 70 ? 'linear-gradient(135deg, #22c55e, #10b981)' : trgMoyen >= 50 ? 'linear-gradient(135deg, #f59e0b, #eab308)' : 'linear-gradient(135deg, #ef4444, #f43f5e)';
            } else {
                // J5 Qualit√©: Conformit√© (1-TR)
                let trTotal = 0;
                for (const mfId in gameState.microFlux) {
                    trTotal += gameState.microFlux[mfId].Tr;
                }
                const trMoyen = Object.keys(gameState.microFlux).length > 0 ? trTotal / Object.keys(gameState.microFlux).length : 0;
                const conformite = (1 - trMoyen) * 100;
                kpiBadge.textContent = `Conf: ${conformite.toFixed(0)}%`;
                kpiBadge.style.background = conformite >= 90 ? 'linear-gradient(135deg, #22c55e, #10b981)' : conformite >= 80 ? 'linear-gradient(135deg, #f59e0b, #eab308)' : 'linear-gradient(135deg, #ef4444, #f43f5e)';
            }
        } else if (manche === 2) {
            const rbe = calculerRBE();
            kpiBadge.textContent = `RBE: ${(rbe / 1000).toFixed(0)}k ‚Ç¨`;
            kpiBadge.style.background = rbe >= 0 ? 'linear-gradient(135deg, #22c55e, #10b981)' : 'linear-gradient(135deg, #ef4444, #f43f5e)';
        } else if (manche === 3) {
            kpiBadge.textContent = `PIG: ${(h.pig * 100).toFixed(1)}%`;
            kpiBadge.style.background = 'linear-gradient(135deg, #8b5cf6, #6366f1)';
        } else {
            // D√©briefing
            const rbe = calculerRBE();
            kpiBadge.textContent = `RBE: ${(rbe / 1000).toFixed(0)}k ‚Ç¨`;
            kpiBadge.style.background = rbe >= 0 ? 'linear-gradient(135deg, #22c55e, #10b981)' : 'linear-gradient(135deg, #ef4444, #f43f5e)';
        }
        
        // VSM Lock - d√©bloqu√© en phase d√©briefing
        const navVSM = document.getElementById('navVSM');
        if (manche === 1 && !gameState.phaseDebriefing && !devMode.unlockVSM) {
            navVSM.classList.add('locked');
            navVSM.textContent = 'üîí VSM';
        } else {
            navVSM.classList.remove('locked');
            navVSM.textContent = 'üó∫Ô∏è VSM';
        }
        
        // History Lock - d√©bloqu√© d√®s le d√©but, mais contenu adapt√© par manche
        const navHistory = document.getElementById('navHistory');
        navHistory.classList.remove('locked');
        // Afficher un indicateur si en phase d√©briefing
        if (gameState.phaseDebriefing) {
            const comprisCount = Object.values(gameState.joueursCompris).filter(c => c).length;
            navHistory.textContent = `üìú Historique (${comprisCount}/5)`;
        } else if (manche === 1) {
            const nbCartes = gameState.historique.length;
            navHistory.textContent = `üìú Historique${nbCartes > 0 ? ` (${nbCartes})` : ''}`;
        } else {
            navHistory.textContent = 'üìú Historique';
        }
        
        renderPosteSection();
        renderStats();
        renderProcessInfo();
        renderMiniRanking();
        renderCartes();
        renderReadySection();
        renderHiddenPanel();
        renderVSM();
        renderFullRanking();
        renderHistorique();
    }
    
    function renderPosteSection() {
        const j = gameState.joueurActuel;
        const config = JOUEURS_CONFIG[j];
        const indic = gameState.indicateurs[j];
        const manche = gameState.manche;
        
        // ==================== MANCHE 1 : Affichage sp√©cifique par joueur ====================
        if (manche === 1 && !gameState.phaseDebriefing) {
            let statsHTML = '';
            let tableHTML = '';
            let headerRight = '';
            
            // Calculs communs
            const bfrTotal = calculerBFRTotal();
            const bfrActuel = gameState.contraintes.BFR_actuel || 0;
            const budgetDisponible = bfrTotal - bfrActuel;
            calculerChargesMachines();
            
            if (j === 1) {
                // ==================== JOUEUR 1 - COMMERCIAL ====================
                // Indicateur phare: Marge
                let margeTotal = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    margeTotal += (mf.PV - mf.DA) * mf.QV;
                }
                
                headerRight = `<div class="poste-trg" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3));">Marge: ‚Ç¨${formatNumber(Math.round(margeTotal))}</div>`;
                
                statsHTML = `
                    <div class="poste-stat" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2)); border: 1px solid var(--success);">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Marge Brute Totale = Œ£ (PV - DA) √ó QV. B√©n√©fice avant charges. Objectif : la maximiser !">üíµ Marge Totale</span></div>
                        <div class="poste-stat-value" style="font-size: 1.3em; color: var(--success);">‚Ç¨${formatNumber(Math.round(margeTotal))}</div>
                    </div>
                    <div class="poste-stat">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Capital disponible pour financer les achats et la production.">üí≥ Budget</span></div>
                        <div class="poste-stat-value" style="color: ${budgetDisponible > 0 ? 'var(--success)' : 'var(--danger)'};">‚Ç¨${formatNumber(Math.round(budgetDisponible))}</div>
                    </div>
                `;
                
                // Tableau: Marge, QV par produit
                tableHTML = `
                    <div class="excel-table-container" style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9em;">üìä Performance Commerciale</h4>
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th><span class="tooltip-term" data-tooltip="Prix de Vente unitaire">PV</span> (‚Ç¨)</th>
                                    <th><span class="tooltip-term" data-tooltip="D√©penses d'Achat : Co√ªt unitaire des mati√®res premi√®res">DA</span> (‚Ç¨)</th>
                                    <th><span class="tooltip-term" data-tooltip="Marge unitaire = PV - DA">Marge</span> (‚Ç¨)</th>
                                    <th><span class="tooltip-term" data-tooltip="Quantit√© √† vendre">QV</span></th>
                                    <th><span class="tooltip-term" data-tooltip="Marge totale = Marge √ó QV">Marge Tot.</span> (‚Ç¨)</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    const marge = mf.PV - mf.DA;
                    const margeT = marge * mf.QV;
                    tableHTML += `
                                <tr class="mf-row">
                                    <td class="mf-name"><span>${mf.emoji}</span> ${mf.nom}</td>
                                    <td>${formatNumber(mf.PV)}</td>
                                    <td style="color: var(--warning);">${formatNumber(mf.DA)}</td>
                                    <td style="color: var(--success); font-weight: 600;">${formatNumber(marge)}</td>
                                    <td>${formatNumber(mf.QV)}</td>
                                    <td style="color: var(--success); font-weight: 600;">${formatNumber(margeT)}</td>
                                </tr>`;
                }
                tableHTML += `</tbody></table></div>`;
                
            } else if (j === 2) {
                // ==================== JOUEUR 2 - APPROVISIONNEMENT ====================
                // Indicateur phare: CR (Co√ªt de Revient)
                let crTotal = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    crTotal += calculerDDP(mf) * mf.QV;
                }
                const crMoyen = Object.keys(gameState.microFlux).length > 0 ? crTotal / Object.values(gameState.microFlux).reduce((sum, mf) => sum + mf.QV, 0) : 0;
                
                headerRight = `<div class="poste-trg" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(248, 113, 113, 0.3));">CR Moyen: ‚Ç¨${crMoyen.toFixed(0)}</div>`;
                
                statsHTML = `
                    <div class="poste-stat" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(248, 113, 113, 0.2)); border: 1px solid var(--danger);">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Co√ªt de Revient : Co√ªt total de production d'une unit√©. Objectif : le minimiser !">üí∞ CR Moyen</span></div>
                        <div class="poste-stat-value" style="font-size: 1.3em; color: var(--danger);">‚Ç¨${crMoyen.toFixed(0)}</div>
                    </div>
                    <div class="poste-stat">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Montant disponible pour vos investissements en approvisionnement.">üí≥ Budget</span></div>
                        <div class="poste-stat-value" style="color: ${budgetDisponible > 0 ? 'var(--success)' : 'var(--danger)'};">‚Ç¨${formatNumber(Math.round(budgetDisponible))}</div>
                    </div>
                `;
                
                // Tableau: DA et CR par produit
                tableHTML = `
                    <div class="excel-table-container" style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9em;">üìä Co√ªts d'Achat</h4>
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th><span class="tooltip-term" data-tooltip="D√©penses d'Achat : Co√ªt unitaire des mati√®res premi√®res">DA</span> (‚Ç¨)</th>
                                    <th><span class="tooltip-term" data-tooltip="Co√ªt de Revient unitaire">CR</span> (‚Ç¨)</th>
                                    <th><span class="tooltip-term" data-tooltip="Quantit√© √† produire">QV</span></th>
                                    <th><span class="tooltip-term" data-tooltip="Co√ªt total des achats pour ce produit">DA Total</span> (‚Ç¨)</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    const cr = calculerDDP(mf);
                    const daTotal = mf.DA * mf.QV;
                    tableHTML += `
                                <tr class="mf-row">
                                    <td class="mf-name"><span>${mf.emoji}</span> ${mf.nom}</td>
                                    <td>${formatNumber(mf.DA)}</td>
                                    <td style="color: var(--danger);">${formatNumber(Math.round(cr))}</td>
                                    <td>${formatNumber(mf.QV)}</td>
                                    <td style="color: var(--warning); font-weight: 600;">${formatNumber(daTotal)}</td>
                                </tr>`;
                }
                tableHTML += `</tbody></table></div>`;
                
            } else if (j === 3) {
                // ==================== JOUEUR 3 - LOGISTIQUE ====================
                // Indicateur phare: CGE Total
                const cgeTotal = calculerCGETotal();
                
                headerRight = `<div class="poste-trg" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3));">CGE: ‚Ç¨${formatNumber(Math.round(cgeTotal))}</div>`;
                
                statsHTML = `
                    <div class="poste-stat" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2)); border: 1px solid var(--accent-primary);">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Charges Globales d'Exploitation : co√ªts fixes totaux de l'entreprise.">üí∞ CGE Total</span></div>
                        <div class="poste-stat-value" style="font-size: 1.3em; color: var(--warning);">‚Ç¨${formatNumber(Math.round(cgeTotal))}</div>
                    </div>
                    <div class="poste-stat">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Capital disponible pour financer les op√©rations.">üí≥ Budget</span></div>
                        <div class="poste-stat-value" style="color: ${budgetDisponible > 0 ? 'var(--success)' : 'var(--danger)'};">‚Ç¨${formatNumber(Math.round(budgetDisponible))}</div>
                    </div>
                `;
                
                // Tableau: CGE par d√©partement
                tableHTML = `
                    <div class="excel-table-container" style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9em;">üìä Charges d'Exploitation</h4>
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th>D√©partement</th>
                                    <th><span class="tooltip-term" data-tooltip="Charges fixes du d√©partement">CGE</span> (‚Ç¨)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>üõí Achats</td><td>${formatNumber(gameState.cge.achats)}</td></tr>
                                <tr><td>üíº Vente</td><td>${formatNumber(gameState.cge.vente)}</td></tr>
                                <tr><td>üè≠ Production</td><td>${formatNumber(gameState.cge.production)}</td></tr>
                                <tr><td>üöö Logistique</td><td>${formatNumber(gameState.cge.logistique)}</td></tr>
                                <tr><td>üî¨ Conception</td><td>${formatNumber(gameState.cge.conception)}</td></tr>
                                <tr class="total-row"><td style="font-weight: 700;">TOTAL</td><td style="font-weight: 700; color: var(--warning);">${formatNumber(cgeTotal)}</td></tr>
                            </tbody>
                        </table>
                    </div>`;
                
            } else if (j === 4) {
                // ==================== JOUEUR 4 - PRODUCTION ====================
                // Indicateur phare: Moyenne TRG de toutes les machines
                let trgSum = 0;
                let machineCount = 0;
                for (const [machineId, machine] of Object.entries(gameState.machines)) {
                    const chargePercent = machine.capacite > 0 ? Math.min(100, (machine.charge / machine.capacite * 100)) : 0;
                    trgSum += chargePercent;
                    machineCount++;
                }
                const trgMoyen = machineCount > 0 ? trgSum / machineCount : 0;
                
                headerRight = `<div class="poste-trg" style="background: ${trgMoyen >= 70 ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3))' : 'linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(248, 113, 113, 0.3))'};">TRG Moyen: ${trgMoyen.toFixed(0)}%</div>`;
                
                // Taux de rebut moyen
                let trTotal = 0;
                for (const mfId in gameState.microFlux) {
                    trTotal += gameState.microFlux[mfId].Tr;
                }
                const trMoyen = Object.keys(gameState.microFlux).length > 0 ? (trTotal / Object.keys(gameState.microFlux).length * 100) : 0;
                
                statsHTML = `
                    <div class="poste-stat" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2)); border: 1px solid var(--success);">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Taux de Rendement Global moyen de toutes les machines. Objectif : ‚â•85%">‚öôÔ∏è TRG Moyen</span></div>
                        <div class="poste-stat-value" style="font-size: 1.3em; color: ${trgMoyen >= 70 ? 'var(--success)' : trgMoyen >= 50 ? 'var(--warning)' : 'var(--danger)'};">${trgMoyen.toFixed(0)}%</div>
                    </div>
                    <div class="poste-stat">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Taux de Rebut moyen sur tous les produits">üî¥ Rebut Moyen</span></div>
                        <div class="poste-stat-value" style="color: ${trMoyen <= 5 ? 'var(--success)' : trMoyen <= 10 ? 'var(--warning)' : 'var(--danger)'};">${trMoyen.toFixed(1)}%</div>
                    </div>
                `;
                
                // Tableau: Capacit√©s machines, TRG, Rebut, Temps de cycle
                tableHTML = `
                    <div class="excel-table-container" style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9em;">üìä √âtat des Machines</h4>
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th>Machine</th>
                                    <th><span class="tooltip-term" data-tooltip="Capacit√© maximale de la machine en heures">Capacit√©</span> (h)</th>
                                    <th><span class="tooltip-term" data-tooltip="Charge actuelle = Œ£ QV √ó temps">Charge</span> (h)</th>
                                    <th><span class="tooltip-term" data-tooltip="Taux de Rendement Global = Charge/Capacit√©">TRG</span> (%)</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                for (const [machineId, machine] of Object.entries(gameState.machines)) {
                    const trg = machine.capacite > 0 ? Math.min(100, (machine.charge / machine.capacite * 100)) : 0;
                    const color = trg >= 70 ? 'var(--success)' : trg >= 50 ? 'var(--warning)' : 'var(--danger)';
                    const isGoulet = machineId === 'M4';
                    tableHTML += `
                                <tr class="mf-row" ${isGoulet ? 'style="background: rgba(245, 158, 11, 0.1);"' : ''}>
                                    <td class="mf-name"><span>${machine.emoji}</span> ${machine.nom} ${isGoulet ? '‚ö†Ô∏è' : ''}</td>
                                    <td>${formatNumber(machine.capacite)}</td>
                                    <td>${formatNumber(Math.round(machine.charge))}</td>
                                    <td style="color: ${color}; font-weight: 600;">${trg.toFixed(0)}%</td>
                                </tr>`;
                }
                
                // Ajouter les taux de rebut par produit
                tableHTML += `</tbody></table></div>
                    <div class="excel-table-container" style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9em;">üìä Taux de Rebut par Produit</h4>
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th><span class="tooltip-term" data-tooltip="Taux de Rebut : % de produits d√©fectueux">Rebut</span> (%)</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    const trPct = (mf.Tr * 100).toFixed(1);
                    tableHTML += `
                                <tr class="mf-row">
                                    <td class="mf-name"><span>${mf.emoji}</span> ${mf.nom}</td>
                                    <td style="color: ${mf.Tr <= 0.05 ? 'var(--success)' : mf.Tr <= 0.10 ? 'var(--warning)' : 'var(--danger)'};">${trPct}%</td>
                                </tr>`;
                }
                tableHTML += `</tbody></table></div>`;
                
            } else {
                // ==================== JOUEUR 5 - QUALIT√â ====================
                // Indicateur phare: 1-TR (taux de conformit√©)
                let trTotal = 0;
                for (const mfId in gameState.microFlux) {
                    trTotal += gameState.microFlux[mfId].Tr;
                }
                const trMoyen = Object.keys(gameState.microFlux).length > 0 ? trTotal / Object.keys(gameState.microFlux).length : 0;
                const tauxConformite = (1 - trMoyen) * 100;
                
                headerRight = `<div class="poste-trg" style="background: ${tauxConformite >= 90 ? 'linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.3))' : 'linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(248, 113, 113, 0.3))'};">Conformit√©: ${tauxConformite.toFixed(1)}%</div>`;
                
                statsHTML = `
                    <div class="poste-stat" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2)); border: 1px solid var(--success);">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Taux de Conformit√© = 1 - Taux de Rebut. % de produits livrables aux clients. Objectif : ‚â•95%">‚úÖ Conformit√© (1-TR)</span></div>
                        <div class="poste-stat-value" style="font-size: 1.3em; color: ${tauxConformite >= 90 ? 'var(--success)' : tauxConformite >= 80 ? 'var(--warning)' : 'var(--danger)'};">${tauxConformite.toFixed(1)}%</div>
                    </div>
                    <div class="poste-stat">
                        <div class="poste-stat-label"><span class="tooltip-term" data-tooltip="Taux de Rebut moyen = % de produits d√©fectueux">üî¥ Rebut Moyen</span></div>
                        <div class="poste-stat-value" style="color: ${trMoyen <= 0.05 ? 'var(--success)' : trMoyen <= 0.10 ? 'var(--warning)' : 'var(--danger)'};">${(trMoyen * 100).toFixed(1)}%</div>
                    </div>
                `;
                
                // Tableau: Lead Time et Rebut par produit
                tableHTML = `
                    <div class="excel-table-container" style="margin-top: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 12px; font-size: 0.9em;">üìä D√©lais et Qualit√©</h4>
                        <table class="excel-table">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th><span class="tooltip-term" data-tooltip="Lead Time : D√©lai total de production en jours">LT</span> (jours)</th>
                                    <th><span class="tooltip-term" data-tooltip="Taux de Rebut : % de produits d√©fectueux">Rebut</span> (%)</th>
                                    <th><span class="tooltip-term" data-tooltip="Taux de Conformit√© = 1 - Rebut">Conformit√©</span> (%)</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    const conformite = (1 - mf.Tr) * 100;
                    tableHTML += `
                                <tr class="mf-row">
                                    <td class="mf-name"><span>${mf.emoji}</span> ${mf.nom}</td>
                                    <td>${formatNumber(mf.LT)}</td>
                                    <td style="color: ${mf.Tr <= 0.05 ? 'var(--success)' : mf.Tr <= 0.10 ? 'var(--warning)' : 'var(--danger)'};">${(mf.Tr * 100).toFixed(1)}%</td>
                                    <td style="color: ${conformite >= 90 ? 'var(--success)' : conformite >= 80 ? 'var(--warning)' : 'var(--danger)'}; font-weight: 600;">${conformite.toFixed(1)}%</td>
                                </tr>`;
                }
                tableHTML += `</tbody></table></div>`;
            }
            
            document.getElementById('posteSection').innerHTML = `
                <div class="poste-header">
                    <div class="poste-title">${config.emoji} ${config.nom}</div>
                    ${headerRight}
                </div>
                <div class="poste-stats">${statsHTML}</div>
                ${tableHTML}
            `;
            return;
        }
        
        // ==================== MANCHE 2 : Tableau Excel avec RBE en vedette ====================
        // ==================== MANCHE 3 : Tableau Excel + s/q/r par micro-flux et PIG en vedette ====================
        
        // Calculer toutes les valeurs pour chaque micro-flux
        const mfData = [];
        let vagTotal = 0;
        let bfrTotalSum = 0;
        let forceVente = 0;
        
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            const dar = calculerDAR(mf);
            const dmaint = calculerDMAINT(mf);
            const bfr = calculerBFR(mf);
            const dbfr = calculerDBFR(mf);
            const ddp = calculerDDP(mf);
            const vag = calculerVAG(mf);
            const vagVente = calculerVAGVente(mf);
            const chM1 = mf.QV * mf.tM1;
            const chM2 = mf.QV * mf.tM2;
            const chM3 = mf.QV * mf.tM3;
            const chM4 = mf.QV * mf.tM4;
            const chM5 = mf.QV * mf.tM5;
            const bfrTotal = bfr * mf.QV;
            
            vagTotal += vagVente;
            bfrTotalSum += bfrTotal;
            forceVente += mf.QV;
            
            mfData.push({
                id: mfId,
                nom: mf.nom,
                emoji: mf.emoji,
                PV: mf.PV,
                DA: mf.DA,
                tM1: mf.tM1,
                tM2: mf.tM2,
                tM3: mf.tM3,
                tM4: mf.tM4,
                tM5: mf.tM5,
                LT: mf.LT,
                Tr: mf.Tr,
                delaiClient: mf.delaiClient,
                delaiFournisseur: mf.delaiFournisseur,
                venteMin: mf.venteMin,
                QV: mf.QV,
                venteMax: mf.venteMax,
                BFR: bfr,
                DBFR: dbfr,
                DMAINT: dmaint,
                DAR: dar,
                DDP: ddp,
                VAG: vag,
                VAGVente: vagVente,
                ChM1: chM1,
                ChM2: chM2,
                ChM3: chM3,
                ChM4: chM4,
                ChM5: chM5,
                BFRTotal: bfrTotal,
                // SQR par micro-flux (pour manche 3)
                s: mf.s,
                q: mf.q,
                r: mf.r
            });
        }
        
        // Charges totales par machine
        const chargeM1 = mfData.reduce((sum, mf) => sum + mf.ChM1, 0);
        const chargeM2 = mfData.reduce((sum, mf) => sum + mf.ChM2, 0);
        const chargeM3 = mfData.reduce((sum, mf) => sum + mf.ChM3, 0);
        const chargeM4 = mfData.reduce((sum, mf) => sum + mf.ChM4, 0);
        const chargeM5 = mfData.reduce((sum, mf) => sum + mf.ChM5, 0);
        
        // CGE et RBE
        const cge = gameState.cge;
        const cgeTotal = cge.achats + cge.vente + cge.production + cge.logistique + cge.conception;
        const rbe = vagTotal - cgeTotal;
        const teg = cgeTotal !== 0 ? vagTotal / cgeTotal : 0;
        
        // Indicateurs globaux
        const h = gameState.hidden;
        const pig = h.pig;
        
        // D√©finitions des tooltips
        const tooltips = {
            PV: "Prix de Vente : Prix auquel le produit est vendu au client",
            DA: "D√©penses d'Achat : Co√ªt d'achat des mati√®res premi√®res",
            tM1: "Temps Machine 1 : Temps de traitement sur la machine 1 (heures)",
            tM2: "Temps Machine 2 : Temps de traitement sur la machine 2 (heures)",
            tM3: "Temps Machine 3 : Temps de traitement sur la machine 3 (heures)",
            LT: "Lead Time : D√©lai total de production (jours)",
            Tr: "Taux de Rebut : Pourcentage de pi√®ces d√©fectueuses",
            DelaiC: "D√©lai Client : D√©lai de paiement accord√© au client (jours)",
            DelaiF: "D√©lai Fournisseur : D√©lai de paiement accord√© par le fournisseur (jours)",
            BFR: "Besoin en Fonds de Roulement : Capital n√©cessaire pour financer le cycle d'exploitation. BFR = (DAR√óLT - D√©laiF√óDA + D√©laiC√óPV) / 360",
            DBFR: "D√©penses du BFR : Co√ªt financier du BFR. DBFR = Tag √ó BFR",
            DMAINT: "D√©penses de Maintenance : Co√ªt de maintenance des machines. DMAINT = Œ£(Mi√ótMi) / (1-Tr)",
            DAR: "D√©penses d'Achat Relatives : Co√ªt d'achat ajust√© du taux de rebut. DAR = DA / (1-Tr)",
            DDP: "D√©penses Directement Proportionnelles : Co√ªts variables par unit√©. DDP = DAR + DMAINT + DBFR",
            VAG: "Valeur Ajout√©e Globale : Marge g√©n√©r√©e par unit√©. VAG = PV - DDP",
            VAGVente: "VAG des Ventes : Valeur ajout√©e totale g√©n√©r√©e. VAG Vente = QV √ó VAG",
            QV: "Quantit√© Vendue : Nombre d'unit√©s vendues",
            ChM: "Charge Machine : Temps total d'utilisation. ChMi = QV √ó tMi",
            CGE: "Charges Globales d'Exploitation : Somme des charges fixes (Achats + Vente + Production + Logistique + Conception)",
            RBE: "R√©sultat Brut d'Exploitation : B√©n√©fice avant imp√¥ts. RBE = VAG Totale - CGE",
            TEG: "Taux d'Efficience Globale : Ratio de performance √©conomique. TEG = VAG Totale / CGE",
            Tag: "Taux de l'Argent : Taux d'int√©r√™t pour le calcul du co√ªt du BFR",
            s: "Vitesse/R√©activit√© : Capacit√© √† livrer rapidement (0-95%)",
            q: "Qualit√©/Satisfaction Client : Niveau de satisfaction client (0-95%)",
            r: "RSE/Environnement : Performance environnementale et sociale (0-95%)",
            PIG: "Performance Int√©gr√©e Globale : Indicateur √©quilibr√©. PIG = s √ó q √ó r √ó TEG"
        };
        
        // Fonction helper pour cr√©er un terme avec tooltip
        const tt = (term, key) => `<span class="tooltip-term" data-tooltip="${tooltips[key] || ''}">${term}</span>`;
        
        // G√©n√©rer le tableau
        let tableHTML = `
            <div class="excel-table-container">
                <table class="excel-table">
                    <!-- En-t√™tes Caract√©ristiques Produits -->
                    <thead>
                        <tr>
                            <th rowspan="2"></th>
                            <th colspan="11" class="section-header-blue">Caract√©ristiques Produits</th>
                            <th colspan="6" class="section-header-green">${tt('DDP', 'DDP')} Unitaires</th>
                            <th colspan="2" class="section-header-yellow">${tt('VAG', 'VAG')}</th>
                        </tr>
                        <tr>
                            <th>${tt('PV', 'PV')}</th>
                            <th>${tt('DA', 'DA')}</th>
                            <th>${tt('tM1', 'tM1')}</th>
                            <th>${tt('tM2', 'tM2')}</th>
                            <th>${tt('tM3', 'tM3')}</th>
                            <th>${tt('tM4', 'tM4')}</th>
                            <th>${tt('tM5', 'tM5')}</th>
                            <th>${tt('LT', 'LT')}</th>
                            <th>${tt('Tr', 'Tr')}</th>
                            <th>${tt('D√©lai C.', 'DelaiC')}</th>
                            <th>${tt('D√©lai F.', 'DelaiF')}</th>
                            <th>${tt('BFR', 'BFR')}</th>
                            <th>${tt('DBFR', 'DBFR')}</th>
                            <th>${tt('DMAINT', 'DMAINT')}</th>
                            <th>${tt('DAR', 'DAR')}</th>
                            <th>${tt('DDP', 'DDP')}</th>
                            <th>${tt('VAG', 'VAG')}</th>
                            <th>${tt('VAG Ventes', 'VAGVente')}</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        // Lignes pour chaque micro-flux
        mfData.forEach(mf => {
            tableHTML += `
                        <tr class="mf-row">
                            <td class="mf-name"><span>${mf.emoji}</span> ${mf.id}</td>
                            <td>${formatNumber(mf.PV)}</td>
                            <td>${formatNumber(mf.DA)}</td>
                            <td>${mf.tM1}</td>
                            <td>${mf.tM2}</td>
                            <td>${mf.tM3}</td>
                            <td>${mf.tM4}</td>
                            <td>${mf.tM5}</td>
                            <td>${mf.LT}</td>
                            <td>${(mf.Tr * 100).toFixed(0)}%</td>
                            <td>${mf.delaiClient}</td>
                            <td>${mf.delaiFournisseur}</td>
                            <td>${formatNumber(Math.round(mf.BFR))}</td>
                            <td>${formatNumber(Math.round(mf.DBFR))}</td>
                            <td>${formatNumber(Math.round(mf.DMAINT))}</td>
                            <td>${formatNumber(Math.round(mf.DAR))}</td>
                            <td>${formatNumber(Math.round(mf.DDP))}</td>
                            <td>${formatNumber(Math.round(mf.VAG))}</td>
                            <td class="${mf.VAGVente >= 0 ? 'value-positive' : 'value-negative'}">${formatNumber(Math.round(mf.VAGVente))}</td>
                        </tr>`;
        });
        
        tableHTML += `
                        <tr class="total-row">
                            <td colspan="18" style="text-align: right;">${tt('VAG Totale', 'VAGVente')}</td>
                            <td class="${vagTotal >= 0 ? 'value-positive' : 'value-negative'}">${formatNumber(Math.round(vagTotal))}</td>
                        </tr>
                    </tbody>
                </table>
            </div>`;
        
        // Deuxi√®me tableau: Ventes et Charges
        // Calcul des pourcentages de contraintes
        const pctForceVente = (forceVente / FORCE_VENTE_MAX) * 100;
        const pctBFR = (bfrTotalSum / CONTRAINTES.BFR_max) * 100;
        
        // Fonction helper pour d√©terminer la classe de contrainte
        const getConstraintClass = (pct) => {
            if (pct >= 100) return 'constraint-danger';
            if (pct >= 80) return 'constraint-warning';
            return 'constraint-ok';
        };
        const getBarClass = (pct) => {
            if (pct >= 100) return 'danger';
            if (pct >= 80) return 'warning';
            return 'ok';
        };
        
        tableHTML += `
            <div class="excel-table-container" style="margin-top: 20px;">
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th rowspan="2"></th>
                            <th colspan="3" class="section-header-yellow">Ventes</th>
                            <th colspan="6" class="section-header-blue">Charges Machines (h)</th>
                            <th class="section-header-green">BFR</th>
                        </tr>
                        <tr>
                            <th>Min</th>
                            <th>${tt('QV', 'QV')}</th>
                            <th>Max</th>
                            <th>${tt('ChM1', 'ChM')}</th>
                            <th>${tt('ChM2', 'ChM')}</th>
                            <th>${tt('ChM3', 'ChM')}</th>
                            <th style="background: rgba(239, 68, 68, 0.3);">${tt('ChM4', 'ChM')} ‚ö†Ô∏è</th>
                            <th>${tt('ChM5', 'ChM')}</th>
                            <th>${tt('BFR total', 'BFR')}</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        mfData.forEach((mf, idx) => {
            tableHTML += `
                        <tr class="mf-row">
                            <td class="mf-name"><span>${mf.emoji}</span> ${mf.id}</td>
                            <td>${mf.venteMin}</td>
                            <td>${mf.QV}</td>
                            <td>${mf.venteMax}</td>
                            <td>${formatNumber(Math.round(mf.ChM1))}</td>
                            <td>${formatNumber(Math.round(mf.ChM2))}</td>
                            <td>${formatNumber(Math.round(mf.ChM3))}</td>
                            <td style="background: rgba(239, 68, 68, 0.1);">${formatNumber(Math.round(mf.ChM4))}</td>
                            <td>${formatNumber(Math.round(mf.ChM5))}</td>
                            <td>${formatNumber(Math.round(mf.BFRTotal))} ‚Ç¨</td>
                        </tr>`;
        });
        
        // Ligne totaux
        const pctM1 = (chargeM1 / CAPACITES_MACHINES.M1) * 100;
        const pctM2 = (chargeM2 / CAPACITES_MACHINES.M2) * 100;
        const pctM3 = (chargeM3 / CAPACITES_MACHINES.M3) * 100;
        const pctM4 = (chargeM4 / CAPACITES_MACHINES.M4) * 100;
        const pctM5 = (chargeM5 / CAPACITES_MACHINES.M5) * 100;
        
        tableHTML += `
                        <tr class="total-row">
                            <td><strong>Charge</strong></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td class="capacity-cell ${getConstraintClass(pctM1)}">
                                <strong>${formatNumber(Math.round(chargeM1))}h</strong>
                                <div class="constraint-bar-container">
                                    <div class="constraint-bar-fill ${getBarClass(pctM1)}" style="width: ${Math.min(pctM1, 100)}%"></div>
                                </div>
                            </td>
                            <td class="capacity-cell ${getConstraintClass(pctM2)}">
                                <strong>${formatNumber(Math.round(chargeM2))}h</strong>
                                <div class="constraint-bar-container">
                                    <div class="constraint-bar-fill ${getBarClass(pctM2)}" style="width: ${Math.min(pctM2, 100)}%"></div>
                                </div>
                            </td>
                            <td class="capacity-cell ${getConstraintClass(pctM3)}">
                                <strong>${formatNumber(Math.round(chargeM3))}h</strong>
                                <div class="constraint-bar-container">
                                    <div class="constraint-bar-fill ${getBarClass(pctM3)}" style="width: ${Math.min(pctM3, 100)}%"></div>
                                </div>
                            </td>
                            <td class="capacity-cell ${getConstraintClass(pctM4)}" style="background: rgba(239, 68, 68, 0.15);">
                                <strong>${formatNumber(Math.round(chargeM4))}h</strong>
                                <div class="constraint-bar-container">
                                    <div class="constraint-bar-fill ${getBarClass(pctM4)}" style="width: ${Math.min(pctM4, 100)}%"></div>
                                </div>
                            </td>
                            <td class="capacity-cell ${getConstraintClass(pctM5)}">
                                <strong>${formatNumber(Math.round(chargeM5))}h</strong>
                                <div class="constraint-bar-container">
                                    <div class="constraint-bar-fill ${getBarClass(pctM5)}" style="width: ${Math.min(pctM5, 100)}%"></div>
                                </div>
                            </td>
                            <td class="${getConstraintClass(pctBFR)}">
                                <strong>${formatNumber(Math.round(bfrTotalSum))} ‚Ç¨</strong>
                                <div class="constraint-bar-container">
                                    <div class="constraint-bar-fill ${getBarClass(pctBFR)}" style="width: ${Math.min(pctBFR, 100)}%"></div>
                                </div>
                            </td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>Capacit√©</strong></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td><strong>${CAPACITES_MACHINES.M1}h</strong></td>
                            <td><strong>${CAPACITES_MACHINES.M2}h</strong></td>
                            <td><strong>${CAPACITES_MACHINES.M3}h</strong></td>
                            <td style="background: rgba(239, 68, 68, 0.1);"><strong>${CAPACITES_MACHINES.M4}h</strong></td>
                            <td><strong>${CAPACITES_MACHINES.M5}h</strong></td>
                            <td><strong>Max: ${(CONTRAINTES.BFR_max / 1000000).toFixed(1)}M ‚Ç¨</strong></td>
                        </tr>
                        <tr class="total-row">
                            <td><strong>TRG</strong></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td class="${pctM1 >= SEUILS.goulet.critique ? 'value-negative' : pctM1 >= SEUILS.goulet.alerte ? 'value-warning' : 'value-positive'}"><strong>${pctM1.toFixed(0)}%</strong></td>
                            <td class="${pctM2 >= SEUILS.goulet.critique ? 'value-negative' : pctM2 >= SEUILS.goulet.alerte ? 'value-warning' : 'value-positive'}"><strong>${pctM2.toFixed(0)}%</strong></td>
                            <td class="${pctM3 >= SEUILS.goulet.critique ? 'value-negative' : pctM3 >= SEUILS.goulet.alerte ? 'value-warning' : 'value-positive'}"><strong>${pctM3.toFixed(0)}%</strong></td>
                            <td style="background: rgba(239, 68, 68, 0.15);" class="${pctM4 >= SEUILS.goulet.critique ? 'value-negative' : pctM4 >= SEUILS.goulet.alerte ? 'value-warning' : 'value-positive'}"><strong>${pctM4.toFixed(0)}% ‚ö†Ô∏è</strong></td>
                            <td class="${pctM5 >= SEUILS.goulet.critique ? 'value-negative' : pctM5 >= SEUILS.goulet.alerte ? 'value-warning' : 'value-positive'}"><strong>${pctM5.toFixed(0)}%</strong></td>
                            <td><strong>${pctBFR.toFixed(0)}%</strong></td>
                        </tr>
                        <tr>
                            <td><strong>Force Vente</strong></td>
                            <td></td>
                            <td class="${getConstraintClass(pctForceVente)}">
                                <strong>${forceVente} / ${FORCE_VENTE_MAX}</strong>
                                <div class="constraint-bar-container">
                                    <div class="constraint-bar-fill ${getBarClass(pctForceVente)}" style="width: ${Math.min(pctForceVente, 100)}%"></div>
                                </div>
                            </td>
                            <td></td>
                            <td><strong>${MAINTENANCE_MACHINES.M1} ‚Ç¨/h</strong></td>
                            <td><strong>${MAINTENANCE_MACHINES.M2} ‚Ç¨/h</strong></td>
                            <td><strong>${MAINTENANCE_MACHINES.M3} ‚Ç¨/h</strong></td>
                            <td style="background: rgba(239, 68, 68, 0.1);"><strong>${MAINTENANCE_MACHINES.M4} ‚Ç¨/h</strong></td>
                            <td><strong>${MAINTENANCE_MACHINES.M5} ‚Ç¨/h</strong></td>
                            <td style="text-align:right;"><strong>${tt('Tag', 'Tag')}: ${(TAG * 100).toFixed(0)}%</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>`;
        
        // Cartes de r√©sum√© avec CGE et r√©sultats
        // Diff√©renciation Manche 2 (RBE) vs Manche 3 (PIG)
        
        let summaryHTML = '';
        
        if (manche === 3) {
            // Manche 3 : Afficher s, q, r globaux et PIG
            const sAvg = mfData.reduce((sum, mf) => sum + mf.s, 0) / mfData.length;
            const qAvg = mfData.reduce((sum, mf) => sum + mf.q, 0) / mfData.length;
            const rAvg = mfData.reduce((sum, mf) => sum + mf.r, 0) / mfData.length;
            
            summaryHTML = `
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.s}">s</span> (R√©activit√©)</div>
                    <div class="summary-card-value">${(h.s * 100).toFixed(0)}%</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.q}">q</span> (Qualit√©)</div>
                    <div class="summary-card-value">${(h.q * 100).toFixed(0)}%</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.r}">r</span> (RSE)</div>
                    <div class="summary-card-value">${(h.r * 100).toFixed(0)}%</div>
                </div>
                <div class="summary-card highlight" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.PIG}" style="color: inherit; border-color: rgba(255,255,255,0.5);">üåø PIG</span></div>
                    <div class="summary-card-value" style="font-size: 1.5em;">${(pig * 100).toFixed(1)}%</div>
                </div>
            </div>
            <div class="summary-cards" style="margin-top: 15px;">
                <div class="summary-card">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.TEG}">TEG</span></div>
                    <div class="summary-card-value">${teg.toFixed(4)}</div>
                </div>
                <div class="summary-card ${rbe >= 0 ? 'positive' : 'negative'}">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.RBE}">RBE</span></div>
                    <div class="summary-card-value ${rbe >= 0 ? 'positive' : 'negative'}">${(rbe / 1000).toFixed(0)}k ‚Ç¨</div>
                </div>
                <div class="summary-card highlight">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.CGE}">CGE</span> Total</div>
                    <div class="summary-card-value">${(cgeTotal / 1000000).toFixed(1)}M ‚Ç¨</div>
                </div>
                <div class="summary-card highlight">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.VAG}">VAG</span> Totale</div>
                    <div class="summary-card-value ${vagTotal >= 0 ? 'positive' : 'negative'}">${(vagTotal / 1000000).toFixed(2)}M ‚Ç¨</div>
                </div>
            </div>`;
        } else {
            // Manche 2 (ou d√©briefing) : Afficher CGE, RBE comme indicateur phare
            summaryHTML = `
            <div class="summary-cards">
                <div class="summary-card">
                    <div class="summary-card-label">ACHAT</div>
                    <div class="summary-card-value">${(cge.achats / 1000).toFixed(0)}k ‚Ç¨</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">VENTE</div>
                    <div class="summary-card-value">${(cge.vente / 1000).toFixed(0)}k ‚Ç¨</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">PRODUCTION</div>
                    <div class="summary-card-value">${(cge.production / 1000).toFixed(0)}k ‚Ç¨</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">LOGISTIQUE</div>
                    <div class="summary-card-value">${(cge.logistique / 1000).toFixed(0)}k ‚Ç¨</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">CONCEPTION</div>
                    <div class="summary-card-value">${(cge.conception / 1000).toFixed(0)}k ‚Ç¨</div>
                </div>
                <div class="summary-card highlight">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.CGE}">CGE</span> Total</div>
                    <div class="summary-card-value">${(cgeTotal / 1000000).toFixed(1)}M ‚Ç¨</div>
                </div>
                <div class="summary-card highlight">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.VAG}">VAG</span> Totale</div>
                    <div class="summary-card-value ${vagTotal >= 0 ? 'positive' : 'negative'}">${(vagTotal / 1000000).toFixed(2)}M ‚Ç¨</div>
                </div>
                <div class="summary-card highlight ${rbe >= 0 ? 'positive' : 'negative'}" style="background: ${rbe >= 0 ? 'var(--gradient-success)' : 'var(--gradient-danger)'};">
                    <div class="summary-card-label"><span class="tooltip-term" data-tooltip="${tooltips.RBE}" style="color: inherit; border-color: rgba(255,255,255,0.5);">üí∞ RBE</span></div>
                    <div class="summary-card-value" style="font-size: 1.5em;">${(rbe / 1000).toFixed(0)}k ‚Ç¨</div>
                </div>
            </div>`;
        }
        
        tableHTML += summaryHTML;
        
        // Titre diff√©rent selon la manche
        let titre = 'üìä Tableau de Bord - ES Marbres & Granits';
        let indicPhare = '';
        if (manche === 2) {
            titre = 'üí∞ Manche 2 : Optimisation RBE';
            indicPhare = `<span class="tooltip-term" data-tooltip="${tooltips.RBE}" style="color: inherit; border: none;">RBE</span>: ${(rbe / 1000).toFixed(0)}k ‚Ç¨`;
        } else if (manche === 3) {
            titre = 'üåø Manche 3 : Performance Int√©gr√©e Globale';
            indicPhare = `<span class="tooltip-term" data-tooltip="${tooltips.PIG}" style="color: inherit; border: none;">PIG</span>: ${(pig * 100).toFixed(1)}%`;
        } else {
            indicPhare = `<span class="tooltip-term" data-tooltip="${tooltips.RBE}" style="color: inherit; border: none;">RBE</span>: ${(rbe / 1000).toFixed(0)}k ‚Ç¨`;
        }
        
        document.getElementById('posteSection').innerHTML = `
            <div class="poste-header">
                <div class="poste-title">${titre}</div>
                <div class="poste-trg" style="background: ${manche === 3 ? 'var(--gradient-success)' : (rbe >= 0 ? 'var(--gradient-success)' : 'var(--gradient-danger)')}">${indicPhare}</div>
            </div>
            ${tableHTML}
        `;
    }
    
    function renderStats() {
        const j = gameState.joueurActuel;
        const manche = gameState.manche;
        const budget = manche >= 2 ? gameState.budgetCommun : gameState.budgets[j];
        let cartes;
        if (manche === 1) {
            cartes = gameState.cartesAchetees[j].length;
        } else if (manche === 2) {
            cartes = gameState.cartesAchetees.commun.length;
        } else {
            cartes = gameState.cartesAchetees.manche3.length;
        }
        
        // Indicateur phare selon la manche
        let indicPhare = '';
        if (manche === 1) {
            indicPhare = `
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-label">TRG Joueur</div>
                    <div class="stat-value">${gameState.indicateurs[j].trg.toFixed(0)}%</div>
                </div>`;
        } else if (manche === 2) {
            const rbe = calculerRBE();
            indicPhare = `
                <div class="stat-card" style="background: ${rbe >= 0 ? 'var(--gradient-success)' : 'var(--gradient-danger)'};">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-label">RBE (Objectif)</div>
                    <div class="stat-value" style="font-size: 1.6em;">${(rbe / 1000).toFixed(0)}k ‚Ç¨</div>
                </div>`;
        } else {
            const pig = gameState.hidden.pig;
            indicPhare = `
                <div class="stat-card" style="background: var(--gradient-success);">
                    <div class="stat-icon">üåø</div>
                    <div class="stat-label">PIG (Objectif)</div>
                    <div class="stat-value" style="font-size: 1.8em;">${(pig * 100).toFixed(1)}%</div>
                </div>`;
        }
        
        // Afficher PIG uniquement en manche 3 ou mode dev
        const showPIG = manche === 3 || devMode.showHidden;
        const pigCard = showPIG ? `
            <div class="stat-card ${gameState.hidden.pig < 1 ? 'warning' : 'good'}">
                <div class="stat-icon">üìä</div>
                <div class="stat-label">PIG Globale</div>
                <div class="stat-value">${gameState.hidden.pig.toFixed(2)}</div>
                <div class="stat-subtext">Performance Int√©gr√©e</div>
            </div>
        ` : '';
        
        // En Manche 1, pas de budget affich√© ici (affich√© sur les cartes)
        // TRG uniquement visible pour le joueur Production (j=2)
        let statsHTML = '';
        
        if (manche >= 2) {
            // Manche 2-3 : afficher budget commun
            statsHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-label">Budget Commun</div>
                    <div class="stat-value">${budget} pts</div>
                    <div class="stat-subtext">${cartes} cartes achet√©es</div>
                </div>
                ${indicPhare}
                <div class="stat-card">
                    <div class="stat-icon">üéÆ</div>
                    <div class="stat-label">Manche</div>
                    <div class="stat-value">${manche}/3</div>
                    <div class="stat-subtext">Collaboration</div>
                </div>
                ${pigCard}
            `;
        } else {
            // Manche 1 : pas de stats row (tout est dans posteSection)
            statsHTML = '';
        }
        
        document.getElementById('statsRow').innerHTML = statsHTML;
    }
    
    function renderProcessInfo() {
        const j = gameState.joueurActuel;
        const config = JOUEURS_CONFIG[j];
        const manche = gameState.manche;
        
        // En Manche 1, afficher des conseils sp√©cifiques par r√¥le
        if (manche === 1) {
            let content = '';
            if (j === 1) {
                document.getElementById('infoTitle').textContent = 'üõí Votre Mission - Approvisionnement';
                content = `
                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(248, 113, 113, 0.15)); border-radius: 12px; border: 1px solid var(--danger);">
                        <p style="margin-bottom: 12px; font-weight: 600; color: var(--danger);">üéØ Objectif : Minimiser le Co√ªt de Revient (CR)</p>
                        <ul style="list-style: none; display: flex; flex-direction: column; gap: 8px; font-size: 0.9em;">
                            <li>üì¶ N√©gociez avec les fournisseurs pour r√©duire les DA</li>
                            <li>üí∞ Surveillez votre Budget disponible</li>
                            <li>üìâ Chaque euro √©conomis√© compte !</li>
                        </ul>
                    </div>
                `;
            } else if (j === 2) {
                document.getElementById('infoTitle').textContent = 'üíº Votre Mission - Commercial';
                content = `
                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.15)); border-radius: 12px; border: 1px solid var(--success);">
                        <p style="margin-bottom: 12px; font-weight: 600; color: var(--success);">üéØ Objectif : Maximiser la Marge</p>
                        <ul style="list-style: none; display: flex; flex-direction: column; gap: 8px; font-size: 0.9em;">
                            <li>üíµ Ajustez le Mix des Ventes pour plus de profit</li>
                            <li>üìä Analysez les marges par produit</li>
                            <li>üéØ Privil√©giez les produits les plus rentables</li>
                        </ul>
                    </div>
                `;
            } else if (j === 3) {
                document.getElementById('infoTitle').textContent = 'üöõ Votre Mission - Logistique';
                content = `
                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15)); border-radius: 12px; border: 1px solid var(--accent-primary);">
                        <p style="margin-bottom: 12px; font-weight: 600; color: var(--accent-primary);">üéØ Objectif : Optimiser Budget/CGE</p>
                        <ul style="list-style: none; display: flex; flex-direction: column; gap: 8px; font-size: 0.9em;">
                            <li>üì¶ Ma√Ætrisez les flux de marchandises</li>
                            <li>üí∞ R√©duisez les Charges d'Exploitation (CGE)</li>
                            <li>‚ö° Optimisez la cha√Æne logistique</li>
                        </ul>
                    </div>
                `;
            } else if (j === 4) {
                document.getElementById('infoTitle').textContent = 'üè≠ Votre Mission - Production';
                content = `
                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.15)); border-radius: 12px; border: 1px solid var(--warning);">
                        <p style="margin-bottom: 12px; font-weight: 600; color: var(--warning);">üéØ Objectif : Maximiser le TRG Moyen</p>
                        <ul style="list-style: none; display: flex; flex-direction: column; gap: 8px; font-size: 0.9em;">
                            <li>‚öôÔ∏è Optimisez l'utilisation des machines</li>
                            <li>‚ö†Ô∏è Attention au goulet d'√©tranglement (M4)</li>
                            <li>üìà Chaque % de TRG compte !</li>
                        </ul>
                    </div>
                `;
            } else {
                document.getElementById('infoTitle').textContent = '‚úÖ Votre Mission - Qualit√©';
                content = `
                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.15)); border-radius: 12px; border: 1px solid var(--success);">
                        <p style="margin-bottom: 12px; font-weight: 600; color: var(--success);">üéØ Objectif : Maximiser la Conformit√© (1-TR)</p>
                        <ul style="list-style: none; display: flex; flex-direction: column; gap: 8px; font-size: 0.9em;">
                            <li>‚úÖ R√©duisez le Taux de Rebut (TR)</li>
                            <li>‚è±Ô∏è Optimisez les Lead Times</li>
                            <li>üîç La qualit√©, c'est la satisfaction client !</li>
                        </ul>
                    </div>
                `;
            }
            document.getElementById('processInfo').innerHTML = content;
            return;
        }
        
        // Manche 2-3 : afficher les processus
        document.getElementById('infoTitle').textContent = j === 1 ? 'Informations Approvisionnement' : 'Mes Processus';
        
        if (j === 1) {
            document.getElementById('processInfo').innerHTML = `
                <div style="padding: 20px; background: rgba(0,0,0,0.2); border-radius: 12px;">
                    <p style="margin-bottom: 15px;">En tant que responsable Approvisionnement, vous g√©rez :</p>
                    <ul style="list-style: none; display: flex; flex-direction: column; gap: 10px;">
                        <li>üì¶ Relations fournisseurs et approvisionnement</li>
                        <li>ü§ù N√©gociations et contrats d'achat</li>
                        <li>üìä Gestion des co√ªts mati√®res premi√®res</li>
                        <li>üöõ Logistique amont et d√©lais fournisseurs</li>
                    </ul>
                </div>
            `;
        } else {
            const postes = config.postes.map(id => gameState.processus.find(p => p.id === id)).filter(p => p);
            document.getElementById('processInfo').innerHTML = postes.map(p => `
                <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px; margin-bottom: 10px;">
                    <div style="font-weight: 700; margin-bottom: 10px; font-size: 1.1em;">${p.emoji} ${p.nom}</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.85em;">
                        <div><span style="opacity: 0.7;">TC:</span> ${p.tc.toFixed(1)}h</div>
                        <div><span style="opacity: 0.7;">WIP:</span> ${Math.round(p.wip)}</div>
                        <div><span style="opacity: 0.7;">‚ö°:</span> ${p.energie.toFixed(1)}</div>
                        <div><span style="opacity: 0.7;">üë§:</span> ${p.op}</div>
                    </div>
                </div>
            `).join('');
        }
    }
    
    function renderMiniRanking() {
        const manche = gameState.manche;
        const j = gameState.joueurActuel;
        const miniRankingContainer = document.querySelector('.ranking-mini');
        
        // Calculer les indicateurs de chaque joueur
        const indicateurs = calculerIndicateursJoueurs();
        
        if (miniRankingContainer) {
            miniRankingContainer.style.display = 'block';
            miniRankingContainer.querySelector('h4').innerHTML = 'üìä Performance de l\'√âquipe';
        }
        
        document.getElementById('miniRanking').innerHTML = indicateurs.map(ind => `
            <div class="ranking-item ${ind.id === gameState.joueurActuel ? 'current' : ''}">
                <div class="ranking-position" style="background: ${ind.color}; font-size: 1.2em;">${ind.emoji}</div>
                <div class="ranking-name">J${ind.id} ‚Äì ${ind.nom}</div>
                <div class="ranking-trg" style="color: ${ind.valueColor};">${ind.valueDisplay}</div>
            </div>
        `).join('');
    }
    
    // Calculer les indicateurs sp√©cifiques √† chaque joueur
    function calculerIndicateursJoueurs() {
        const indicateurs = [];
        
        // J1 - Commercial : Marge Totale
        let margeTotal = 0;
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            margeTotal += (mf.PV - mf.DA) * mf.QV;
        }
        indicateurs.push({
            id: 1,
            nom: JOUEURS_CONFIG[1].nom,
            emoji: JOUEURS_CONFIG[1].emoji,
            indicateur: 'Marge',
            value: margeTotal,
            valueDisplay: '‚Ç¨' + formatNumber(Math.round(margeTotal)),
            valueColor: margeTotal > 0 ? 'var(--success)' : 'var(--danger)',
            color: '#6366f1',
            objectif: 'Maximiser',
            tooltip: 'Marge Brute Totale = Œ£ (PV - DA) √ó QV'
        });
        
        // J2 - Approvisionnement : Co√ªt de Revient Moyen
        let crTotal = 0;
        let qvTotal = 0;
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            crTotal += calculerDDP(mf) * mf.QV;
            qvTotal += mf.QV;
        }
        const crMoyen = qvTotal > 0 ? crTotal / qvTotal : 0;
        indicateurs.push({
            id: 2,
            nom: JOUEURS_CONFIG[2].nom,
            emoji: JOUEURS_CONFIG[2].emoji,
            indicateur: 'CR Moyen',
            value: crMoyen,
            valueDisplay: '‚Ç¨' + crMoyen.toFixed(0),
            valueColor: crMoyen < 500 ? 'var(--success)' : crMoyen < 700 ? 'var(--warning)' : 'var(--danger)',
            color: '#f59e0b',
            objectif: 'Minimiser',
            tooltip: 'Co√ªt de Revient Moyen = Œ£ DDP √ó QV / Œ£ QV'
        });
        
        // J3 - Logistique : CGE Total
        const cgeTotal = calculerCGETotal();
        indicateurs.push({
            id: 3,
            nom: JOUEURS_CONFIG[3].nom,
            emoji: JOUEURS_CONFIG[3].emoji,
            indicateur: 'CGE',
            value: cgeTotal,
            valueDisplay: '‚Ç¨' + formatNumber(Math.round(cgeTotal)),
            valueColor: cgeTotal < 50000 ? 'var(--success)' : cgeTotal < 70000 ? 'var(--warning)' : 'var(--danger)',
            color: '#10b981',
            objectif: 'Minimiser',
            tooltip: 'Charges G√©n√©rales d\'Exploitation totales'
        });
        
        // J4 - Production : TRG Moyen
        const trg = gameState.indicateurs[4]?.trg || 0;
        indicateurs.push({
            id: 4,
            nom: JOUEURS_CONFIG[4].nom,
            emoji: JOUEURS_CONFIG[4].emoji,
            indicateur: 'TRG',
            value: trg,
            valueDisplay: trg.toFixed(0) + '%',
            valueColor: trg >= 85 ? 'var(--success)' : trg >= 70 ? 'var(--warning)' : 'var(--danger)',
            color: '#ef4444',
            objectif: 'Maximiser',
            tooltip: 'Taux de Rendement Global = DO √ó TP √ó TQ'
        });
        
        // J5 - Qualit√© : Conformit√© (1 - TR moyen)
        let trTotal = 0;
        let nbMf = 0;
        for (const mfId in gameState.microFlux) {
            trTotal += gameState.microFlux[mfId].Tr;
            nbMf++;
        }
        const trMoyen = nbMf > 0 ? trTotal / nbMf : 0;
        const conformite = (1 - trMoyen) * 100;
        indicateurs.push({
            id: 5,
            nom: JOUEURS_CONFIG[5].nom,
            emoji: JOUEURS_CONFIG[5].emoji,
            indicateur: 'Conformit√©',
            value: conformite,
            valueDisplay: conformite.toFixed(1) + '%',
            valueColor: conformite >= 95 ? 'var(--success)' : conformite >= 90 ? 'var(--warning)' : 'var(--danger)',
            color: '#8b5cf6',
            objectif: 'Maximiser',
            tooltip: 'Conformit√© = 1 - TR moyen'
        });
        
        return indicateurs;
    }
    
    function renderCartes() {
        const manche = gameState.manche;
        const j = gameState.joueurActuel;
        let cartes, cartesAchetees, budget;
        
        if (manche === 1) {
            cartes = CARTES_MANCHE1[j];
            cartesAchetees = gameState.cartesAchetees[j];
            budget = gameState.budgetManche1; // Budget PARTAG√â
            const budgetDepense = 300 - budget; // Total d√©pens√© par l'√©quipe
            document.getElementById('cardsTitle').textContent = `Cartes de J${j} ‚Äì ${JOUEURS_CONFIG[j].nom}`;
            document.getElementById('budgetDisplay').innerHTML = `<span style="color: var(--accent-secondary);">üí∞ Budget commun: ${budget} pts</span> | <span style="color: var(--warning);">D√©pens√©: ${budgetDepense} pts</span>`;
        } else if (manche === 2) {
            // Manche 2 = Am√©lioration √©conomique (RBE)
            cartes = CARTES_MANCHE2;
            cartesAchetees = gameState.cartesAchetees.commun;
            budget = gameState.budgetCommun;
            document.getElementById('cardsTitle').textContent = 'üí∞ Cartes √âconomiques - Objectif RBE';
            document.getElementById('budgetDisplay').textContent = `${budget} pts`;
            document.getElementById('budgetDisplay').style.color = 'var(--yellow)';
        } else {
            // Manche 3 = Am√©lioration SQR (PIG)
            cartes = CARTES_MANCHE3;
            cartesAchetees = gameState.cartesAchetees.manche3;
            budget = gameState.budgetCommun;
            document.getElementById('cardsTitle').textContent = 'üåø Cartes Performance - Objectif PIG';
            document.getElementById('budgetDisplay').textContent = `${budget} pts`;
            document.getElementById('budgetDisplay').style.color = 'var(--yellow)';
        }
        
        document.getElementById('collabNotice').style.display = manche >= 2 ? 'block' : 'none';
        
        // Sales section visible dans toutes les manches
        const salesSection = document.getElementById('salesSection');
        salesSection.style.display = 'block';
        renderSalesSection();
        
        if (manche >= 2) {
            document.getElementById('budgetCommun').textContent = `${budget} pts`;
        }
        
        // Pour Manche 2 et 3 : affichage en boutiques pleine largeur par secteur
        if (manche >= 2) {
            const secteurs = {
                'Commercial': { emoji: 'üíº', nom: 'Commercial', color: '#6366f1' },
                'Approvisionnement': { emoji: 'üì¶', nom: 'Approvisionnement', color: '#f59e0b' },
                'Logistique': { emoji: 'üöö', nom: 'Logistique', color: '#10b981' },
                'Production': { emoji: '‚öôÔ∏è', nom: 'Production', color: '#ef4444' },
                'Qualit√©': { emoji: '‚úÖ', nom: 'Qualit√©', color: '#8b5cf6' }
            };
            
            // Grouper les cartes par secteur
            const cartesParSecteur = {};
            for (const secteur of Object.keys(secteurs)) {
                cartesParSecteur[secteur] = cartes.filter(c => c.secteur === secteur).map(c => ({
                    ...c,
                    purchased: cartesAchetees.includes(c.id),
                    canAfford: budget >= c.cout
                }));
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 20px;">';
            
            for (const [secteur, config] of Object.entries(secteurs)) {
                const cartesSecte = cartesParSecteur[secteur] || [];
                if (cartesSecte.length === 0) continue;
                
                const disponibles = cartesSecte.filter(c => !c.purchased && c.canAfford).length;
                const jouees = cartesSecte.filter(c => c.purchased).length;
                
                html += `
                    <div class="shop-sector" style="background: var(--bg-elevated); border-radius: 16px; padding: 16px; border-left: 4px solid ${config.color};">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid ${config.color}30;">
                            <span style="font-size: 2em;">${config.emoji}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: ${config.color}; font-size: 1.2em;">${config.nom}</div>
                                <div style="font-size: 0.85em; color: var(--text-muted);">${disponibles} disponibles ¬∑ ${jouees} jou√©es ¬∑ ${cartesSecte.length} total</div>
                            </div>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                `;
                
                cartesSecte.forEach(c => {
                    const opacity = c.purchased ? '0.5' : (!c.canAfford ? '0.7' : '1');
                    const buyText = c.purchased ? '‚úì Jou√©e' : (c.canAfford ? 'üé¥ Acheter' : 'üí∏ Insuffisant');
                    
                    // V0.6.32: Calculer score et risque
                    const impacts = typeof analyzeCardImpacts === 'function' ? analyzeCardImpacts(c) : { score: 50 };
                    const risk = typeof evaluateCardRisk === 'function' ? evaluateCardRisk(c) : { riskLevel: 'low-risk' };
                    
                    // Aide visible seulement si activ√©e ou Manche 2+
                    const showHelp = devMode.showCardHelp || gameState.manche >= 2;
                    
                    let scoreBarClass = 'poor';
                    if (impacts.score >= 70) scoreBarClass = 'excellent';
                    else if (impacts.score >= 55) scoreBarClass = 'good';
                    else if (impacts.score >= 40) scoreBarClass = 'medium';
                    
                    // Badge de risque (seulement si aide activ√©e)
                    let riskBadge = '';
                    if (!c.purchased && c.canAfford && showHelp) {
                        if (risk.riskLevel === 'high-risk') {
                            riskBadge = `<span style="font-size: 0.7em; padding: 2px 6px; border-radius: 4px; background: rgba(239, 68, 68, 0.2); color: var(--danger); margin-left: 6px;">‚ö†Ô∏è</span>`;
                        }
                    }
                    
                    html += `
                        <div class="shop-card action-card" style="flex: 1 1 280px; max-width: 340px; background: var(--bg-card); border-radius: 12px; padding: 14px; opacity: ${opacity}; border: 1px solid ${config.color}30; transition: all 0.2s; position: relative;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="font-weight: 700; font-size: 0.95em; color: var(--text-primary); flex: 1;">${c.emoji} ${c.nom}${riskBadge}</div>
                                <span style="background: ${config.color}; color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.8em; font-weight: 700;">${c.cout} pts</span>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.5;">${c.description}</div>
                            ${c.effetVisible ? `<div style="font-size: 0.8em; color: var(--success); margin-bottom: 10px; padding: 6px 10px; background: rgba(34, 197, 94, 0.1); border-radius: 6px;">‚ú® ${c.effetVisible}</div>` : ''}
                            
                            <!-- V0.6.32: Score de d√©cision (seulement si aide activ√©e) -->
                            ${!c.purchased && showHelp ? `
                            <div class="decision-score" style="margin-bottom: 10px;">
                                <span class="decision-score-label">Score</span>
                                <div class="decision-score-bar">
                                    <div class="decision-score-fill ${scoreBarClass}" style="width: ${impacts.score}%"></div>
                                </div>
                                <span class="decision-score-value" style="color: ${impacts.score >= 60 ? 'var(--success)' : impacts.score >= 40 ? 'var(--warning)' : 'var(--danger)'}">
                                    ${impacts.score}
                                </span>
                            </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 8px;">
                                ${!c.purchased && c.canAfford ? `
                                <button onclick="simulateCardPurchase('${c.id}')" class="btn-simulate" style="padding: 8px 12px; font-size: 0.8em;">
                                    üîç
                                </button>
                                ` : ''}
                                <button onclick="acheterCarte('${c.id}')" ${c.purchased || !c.canAfford ? 'disabled' : ''}
                                    style="flex: 1; padding: 10px; border-radius: 8px; font-size: 0.85em; font-weight: 600;
                                    background: ${c.purchased ? 'var(--bg-elevated)' : (c.canAfford ? config.color : 'var(--bg-elevated)')};
                                    color: ${c.purchased || !c.canAfford ? 'var(--text-muted)' : 'white'};
                                    border: 1px solid ${c.purchased || !c.canAfford ? 'var(--border-default)' : config.color};
                                    cursor: ${c.purchased || !c.canAfford ? 'not-allowed' : 'pointer'};">
                                    ${buyText}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            document.getElementById('cardsGrid').innerHTML = html;
            return;
        }
        
        // Manche 1 : affichage classique avec fonctionnalit√©s V0.6.32
        // Bloquer les cartes pour J1 si le mix n'est pas valid√©
        if (manche === 1 && j === 1 && !gameState.mixValideJ1 && !gameState.phaseDebriefing) {
            document.getElementById('cardsGrid').innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; background: rgba(99, 102, 241, 0.1); border: 2px dashed var(--accent-primary); border-radius: 16px;">
                    <div style="font-size: 3em; margin-bottom: 16px;">üéØ</div>
                    <div style="font-size: 1.2em; font-weight: 700; color: var(--accent-primary); margin-bottom: 12px;">Validez d'abord le Mix de Ventes</div>
                    <div style="color: var(--text-muted); max-width: 400px; margin: 0 auto;">
                        Ajustez les quantit√©s √† vendre pour chaque produit dans la section ci-dessus, puis cliquez sur "Valider le Mix de Ventes" pour d√©bloquer les cartes.
                    </div>
                </div>
            `;
            return;
        }
        
        // V0.6.32: Appliquer filtres et tri
        let cartesFiltr√©es = cartes.map(c => {
            const purchased = cartesAchetees.includes(c.id);
            const canAfford = budget >= c.cout;
            return { ...c, purchased, canAfford };
        });
        
        // Appliquer les filtres UX
        if (typeof filterCards === 'function') {
            cartesFiltr√©es = filterCards(cartesFiltr√©es);
        }
        
        // Trier les cartes : disponibles en haut, fonds insuffisants au milieu, utilis√©es en bas
        const cartesTriees = cartesFiltr√©es.sort((a, b) => {
            // Ordre: disponibles (0), insuffisants (1), utilis√©es (2)
            const orderA = a.purchased ? 2 : (a.canAfford ? 0 : 1);
            const orderB = b.purchased ? 2 : (b.canAfford ? 0 : 1);
            if (orderA !== orderB) return orderA - orderB;
            
            // Si m√™me cat√©gorie et tri par score activ√©
            if (uxState && uxState.cardSort === 'score-desc') {
                const scoreA = typeof analyzeCardImpacts === 'function' ? analyzeCardImpacts(a).score : 0;
                const scoreB = typeof analyzeCardImpacts === 'function' ? analyzeCardImpacts(b).score : 0;
                return scoreB - scoreA;
            }
            return 0;
        });
        
        // V0.6.32: Identifier les meilleures cartes pour les badges
        const recommendedCards = typeof getRecommendedCards === 'function' ? 
            getRecommendedCards(cartesTriees.filter(c => !c.purchased && c.canAfford), 2) : [];
        const recommendedIds = recommendedCards.map(r => r.carte.id);
        
        // Compter les cartes par cat√©gorie
        const nbDisponibles = cartesTriees.filter(c => !c.purchased && c.canAfford).length;
        const nbInsuffisantes = cartesTriees.filter(c => !c.purchased && !c.canAfford).length;
        const nbUtilisees = cartesTriees.filter(c => c.purchased).length;
        
        let html = '';
        let currentSection = '';
        
        cartesTriees.forEach((c, index) => {
            // Ajouter les s√©parateurs de section
            let section = c.purchased ? 'utilisees' : (c.canAfford ? 'disponibles' : 'insuffisantes');
            
            if (section !== currentSection) {
                currentSection = section;
                if (section === 'disponibles' && nbDisponibles > 0) {
                    html += `<div class="cards-section-title" style="grid-column: 1 / -1; color: var(--success); font-weight: 600; margin-top: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(34, 197, 94, 0.3);">‚úÖ Cartes disponibles (${nbDisponibles})</div>`;
                } else if (section === 'insuffisantes' && nbInsuffisantes > 0) {
                    html += `<div class="cards-section-title" style="grid-column: 1 / -1; color: var(--warning); font-weight: 600; margin-top: 16px; padding-bottom: 8px; border-bottom: 1px solid rgba(245, 158, 11, 0.3);">üí∏ Fonds insuffisants (${nbInsuffisantes})</div>`;
                } else if (section === 'utilisees' && nbUtilisees > 0) {
                    html += `<div class="cards-section-title" style="grid-column: 1 / -1; color: var(--text-muted); font-weight: 600; margin-top: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border-default);">‚úì Cartes jou√©es (${nbUtilisees})</div>`;
                }
            }
            
            // V0.6.32: Calculer le risque et le score de la carte
            const risk = typeof evaluateCardRisk === 'function' ? evaluateCardRisk(c) : { riskLevel: 'low-risk' };
            const impacts = typeof analyzeCardImpacts === 'function' ? analyzeCardImpacts(c) : { score: 50 };
            const isRecommended = recommendedIds.includes(c.id);
            const isSelectedForCompare = uxState && uxState.selectedForComparison && uxState.selectedForComparison.includes(c.id);
            
            // Badge de risque ou recommandation (seulement si aide activ√©e dans devMode ou Manche 2+)
            let riskBadgeHTML = '';
            const showHelp = devMode.showCardHelp || gameState.manche >= 2;
            if (!c.purchased && c.canAfford && showHelp) {
                if (isRecommended) {
                    riskBadgeHTML = `<div class="card-risk-badge best-choice">‚≠ê Recommand√©e</div>`;
                } else if (risk.riskLevel === 'high-risk') {
                    riskBadgeHTML = `<div class="card-risk-badge high-risk">‚ö†Ô∏è Risqu√©</div>`;
                } else if (risk.riskLevel === 'medium-risk') {
                    riskBadgeHTML = `<div class="card-risk-badge medium-risk">‚ö° Mod√©r√©</div>`;
                }
            }
            
            // Score de d√©cision
            let scoreBarClass = 'poor';
            if (impacts.score >= 70) scoreBarClass = 'excellent';
            else if (impacts.score >= 55) scoreBarClass = 'good';
            else if (impacts.score >= 40) scoreBarClass = 'medium';
            
            const priceDisplay = `<div class="card-price" style="background: var(--accent-primary); color: white; padding: 4px 10px; border-radius: 8px; font-weight: 700;">${c.cout} pts</div>`;
            const buyText = c.purchased ? '‚úì Jou√©e' : 
                            (c.canAfford ? 'üé¥ Acheter cette carte' : 'üí∏ Budget insuffisant');
            
            // V0.6.32: Ajouter class pour s√©lection de comparaison
            const compareClass = isSelectedForCompare ? 'selected-for-compare' : '';
            const compareHandler = uxState && uxState.comparisonMode && !c.purchased ? 
                `onclick="toggleCardComparison('${c.id}')" style="cursor: pointer;"` : '';
            
            html += `
                <div class="card action-card ${c.purchased ? 'purchased' : ''} ${compareClass}" 
                    ${compareHandler}
                    style="${!c.canAfford && !c.purchased ? 'opacity: 0.7;' : ''} position: relative;">
                    ${riskBadgeHTML}
                    <div class="card-header">
                        <div class="card-title"><span class="card-emoji">${c.emoji}</span>${c.nom}</div>
                        ${priceDisplay}
                    </div>
                    <div class="card-description">${c.description}</div>
                    ${c.effetVisible ? `<div class="card-effect" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.15)); border: 1px solid var(--success); padding: 8px 12px; border-radius: 8px; margin-top: 8px;">
                        <span style="color: var(--success); font-weight: 600;">‚ú® Effet :</span> ${c.effetVisible}
                    </div>` : ''}
                    
                    <!-- V0.6.32: Score de d√©cision (seulement si aide activ√©e) -->
                    ${!c.purchased && showHelp ? `
                    <div class="decision-score">
                        <span class="decision-score-label">Score</span>
                        <div class="decision-score-bar">
                            <div class="decision-score-fill ${scoreBarClass}" style="width: ${impacts.score}%"></div>
                        </div>
                        <span class="decision-score-value" style="color: ${impacts.score >= 60 ? 'var(--success)' : impacts.score >= 40 ? 'var(--warning)' : 'var(--danger)'}">
                            ${impacts.score}
                        </span>
                    </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        ${!c.purchased && c.canAfford ? `
                        <button class="btn-simulate" onclick="event.stopPropagation(); simulateCardPurchase('${c.id}')">
                            üîç Simuler
                        </button>
                        ` : ''}
                        <button class="btn-buy" onclick="event.stopPropagation(); acheterCarte('${c.id}')" ${c.purchased || !c.canAfford ? 'disabled' : ''} style="flex: 1;">
                            ${buyText}
                        </button>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('cardsGrid').innerHTML = html;
    }
    
    function renderReadySection() {
        const j = gameState.joueurActuel;
        const manche = gameState.manche;
        const readySection = document.querySelector('.ready-section');
        
        // En Manche 1 : afficher le budget commun partag√© et bouton Passer
        if (manche === 1 && !gameState.phaseDebriefing) {
            if (readySection) {
                const budgetRestant = gameState.budgetManche1;
                const budgetTotal = 300;
                const depensesJoueur = gameState.budgets[j];
                
                // V√©rifier si le joueur peut acheter au moins une carte
                const cartes = CARTES_MANCHE1[j] || [];
                const cartesAchetees = gameState.cartesAchetees[j] || [];
                const peutAcheter = cartes.some(c => !cartesAchetees.includes(c.id) && budgetRestant >= c.cout);
                
                // Compter combien de joueurs ont pass√© ce tour
                const joueursAyantPasse = gameState.joueursAyantPasse || {};
                const nbPasses = Object.values(joueursAyantPasse).filter(p => p).length;
                
                readySection.innerHTML = `
                    <div style="text-align: center; padding: 16px; background: var(--bg-elevated); border-radius: 12px;">
                        <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 8px;">üí∞ Budget Commun de l'√âquipe</div>
                        <div style="display: flex; align-items: center; gap: 12px; justify-content: center;">
                            <div style="flex: 1; max-width: 300px; height: 8px; background: var(--bg-card); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${(budgetRestant / budgetTotal) * 100}%; background: linear-gradient(90deg, var(--accent-secondary), var(--success)); transition: width 0.3s;"></div>
                            </div>
                            <span style="font-weight: 600; color: var(--accent-secondary);">${budgetRestant}/${budgetTotal} pts</span>
                        </div>
                        <div style="font-size: 0.8em; color: var(--text-muted); margin-top: 8px;">
                            Vous avez d√©pens√© ${depensesJoueur} pts
                        </div>
                        <div style="margin-top: 16px;">
                            <button onclick="passerTour()" class="btn-modal" style="background: ${peutAcheter ? 'var(--bg-card)' : 'var(--warning)'}; color: ${peutAcheter ? 'var(--text-secondary)' : '#000'}; border: 1px solid ${peutAcheter ? 'var(--border-default)' : 'var(--warning)'};">
                                ‚è≠Ô∏è Passer mon tour ${!peutAcheter ? '(budget insuffisant)' : ''}
                            </button>
                        </div>
                        ${nbPasses > 0 ? `<div style="font-size: 0.75em; color: var(--text-muted); margin-top: 8px;">${nbPasses} joueur(s) ont pass√© ce tour</div>` : ''}
                    </div>
                `;
            }
            return;
        }
        
        // Cacher la section "pr√™t" pendant la phase de d√©briefing
        if (gameState.phaseDebriefing) {
            if (readySection) {
                readySection.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 2em; margin-bottom: 12px;">üìã</div>
                        <h3 style="color: var(--warning); margin-bottom: 8px;">Phase de D√©briefing en cours</h3>
                        <p style="color: var(--text-secondary);">Consultez l'onglet <strong>üìú Historique</strong> pour analyser les erreurs et confirmer votre compr√©hension.</p>
                        <div style="margin-top: 16px; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                            ${Object.entries(gameState.joueursCompris).map(([id, compris]) => `
                                <span style="padding: 6px 12px; border-radius: 8px; font-size: 0.85em; font-weight: 600;
                                    background: ${compris ? 'rgba(34, 197, 94, 0.2)' : 'var(--bg-elevated)'};
                                    border: 1px solid ${compris ? 'var(--success)' : 'var(--border-default)'};
                                    color: ${compris ? 'var(--success)' : 'var(--text-secondary)'};">
                                    J${id} ${compris ? '‚úì' : '‚óã'}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            return;
        }
        
        // Section de validation pour Manche 2 et 3 (mode collaboratif)
        if (manche === 2 || manche === 3) {
            const readyState = manche === 2 ? gameState.joueursReadyM2 : gameState.joueursReadyM3;
            const allReady = Object.values(readyState).every(r => r);
            const readyCount = Object.values(readyState).filter(r => r).length;
            const mancheLabel = manche === 2 ? 'Manche 2 - Optimisation RBE' : 'Manche 3 - Optimisation PIG';
            const nextAction = manche === 2 ? 'Passer √† la Manche 3' : 'Terminer la simulation';
            
            if (readySection) {
                readySection.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: var(--bg-elevated); border-radius: 12px;">
                        <div style="font-size: 1.4em; margin-bottom: 12px;">${manche === 2 ? 'ü§ù' : 'üåø'}</div>
                        <h3 style="color: var(--accent-primary); margin-bottom: 8px;">${mancheLabel}</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9em;">
                            Mode collaboratif - Chaque joueur doit valider quand il est pr√™t √† passer √† la suite
                        </p>
                        
                        <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                            ${Object.entries(readyState).map(([id, ready]) => `
                                <button onclick="toggleReadyManche(${id})" 
                                    style="padding: 12px 20px; border-radius: 10px; font-size: 0.95em; font-weight: 600;
                                    cursor: pointer; transition: all 0.2s;
                                    background: ${ready ? 'linear-gradient(135deg, var(--success), #059669)' : 'var(--bg-card)'};
                                    border: 2px solid ${ready ? 'var(--success)' : 'var(--border-default)'};
                                    color: ${ready ? 'white' : 'var(--text-secondary)'};">
                                    ${JOUEURS_CONFIG[id].emoji} J${id} ${ready ? '‚úì OK' : '‚óã'}
                                </button>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 12px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                            <span style="color: var(--text-muted);">Progression :</span>
                            <span style="font-weight: 700; color: ${allReady ? 'var(--success)' : 'var(--accent-primary)'};">
                                ${readyCount}/5 joueurs pr√™ts
                            </span>
                        </div>
                        
                        ${allReady ? `
                            <button onclick="${manche === 2 ? 'passerManche3FromValidation()' : 'terminerSimulation()'}" 
                                style="margin-top: 16px; padding: 14px 32px; font-size: 1.1em; font-weight: 700;
                                background: linear-gradient(135deg, var(--success), #059669);
                                border: none; border-radius: 12px; color: white; cursor: pointer;
                                animation: pulse-success 2s infinite;">
                                üöÄ ${nextAction}
                            </button>
                        ` : ''}
                    </div>
                `;
            }
            return;
        }
        
        // Restaurer la structure normale si on n'est pas en d√©briefing ou manche 2/3
        if (readySection) {
            // V√©rifier si la structure normale existe, sinon la recr√©er
            if (!document.getElementById('readyStatus')) {
                readySection.innerHTML = `
                    <div class="ready-status" id="readyStatus"></div>
                    <button class="btn-ready" id="btnReady" onclick="toggleReady()">
                        ‚úì Pr√™t pour la manche suivante
                    </button>
                `;
            }
        }
        
        const readyStatus = document.getElementById('readyStatus');
        if (readyStatus) {
            readyStatus.innerHTML = Object.entries(gameState.joueursReady).map(([id, ready]) => `
                <div class="player-ready ${ready ? 'ready' : ''} ${parseInt(id) === j ? 'current' : ''}">
                    J${id} ${ready ? '‚úì' : '‚óã'}
                </div>
            `).join('');
        }
        
        const btn = document.getElementById('btnReady');
        if (btn) {
            const isReady = gameState.joueursReady[j];
            
            // Texte diff√©rent selon la manche
            if (manche === 3) {
                btn.textContent = isReady ? '‚Ü© Annuler' : 'üèÅ Terminer la simulation';
                btn.style.background = isReady ? '' : 'linear-gradient(135deg, #f59e0b, #f97316)';
            } else {
                btn.textContent = isReady ? '‚Ü© Annuler' : '‚úì Pr√™t pour la manche suivante';
                btn.style.background = '';
            }
            btn.className = `btn-ready ${isReady ? 'is-ready' : ''}`;
        }
    }
    
    function renderHiddenPanel() {
        const panel = document.getElementById('hiddenPanel');
        const manche = gameState.manche;
        
        // En manche 1, cacher le panel (pas de VAG/BFR/RBE visible)
        if (manche === 1 && !devMode.showHidden) {
            panel.style.display = 'none';
            return;
        }
        
        // En manche 2, cacher le panel (on ne r√©v√®le pas encore s, q, r, PIG)
        if (manche === 2 && !devMode.showHidden) {
            panel.style.display = 'none';
            return;
        }
        
        if (!gameState.hiddenRevealed && !devMode.showHidden) {
            panel.style.display = 'none';
            return;
        }
        panel.style.display = 'block';
        const h = gameState.hidden;
        
        // Ajouter un indicateur mode dev
        const devBadge = devMode.showHidden && manche !== 3 ? '<span style="background: var(--purple); padding: 3px 8px; border-radius: 5px; font-size: 0.7em; margin-left: 10px;">MODE DEV</span>' : '';
        
        document.getElementById('hiddenPanel').querySelector('h3').innerHTML = `‚ö†Ô∏è INDICATEURS R√âV√âL√âS - Performance R√©elle de l'Entreprise ${devBadge}`;
        
        const vagActuel = calculerVAGTotal();
        const cgeActuel = calculerCGETotal();
        const rbeActuel = calculerRBE();
        
        // En manche 3 ou mode dev : afficher s, q, r, PIG
        // Sinon (d√©briefing) : afficher seulement VAG, CGE, RBE
        if (manche === 3 || devMode.showHidden) {
            document.getElementById('hiddenGrid').innerHTML = `
                <div class="hidden-item"><div class="hidden-label">üöÄ Vitesse (s)</div><div class="hidden-value ${getHiddenClass(h.s)}">${(h.s*100).toFixed(0)}%</div></div>
                <div class="hidden-item"><div class="hidden-label">üåç Environnement (r)</div><div class="hidden-value ${getHiddenClass(h.r)}">${(h.r*100).toFixed(0)}%</div></div>
                <div class="hidden-item"><div class="hidden-label">üòä Satisfaction (q)</div><div class="hidden-value ${getHiddenClass(h.q)}">${(h.q*100).toFixed(0)}%</div></div>
                <div class="hidden-item"><div class="hidden-label">üìà VAG</div><div class="hidden-value" style="color: var(--success);">‚Ç¨${formatNumber(Math.round(vagActuel))}</div></div>
                <div class="hidden-item"><div class="hidden-label">üí∏ CGE</div><div class="hidden-value" style="color: var(--warning);">‚Ç¨${formatNumber(Math.round(cgeActuel))}</div></div>
                <div class="hidden-item"><div class="hidden-label">üí∞ RBE</div><div class="hidden-value" style="color: ${rbeActuel >= 0 ? 'var(--success)' : 'var(--danger)'};">‚Ç¨${formatNumber(Math.round(rbeActuel))}</div></div>
                <div class="hidden-item" style="grid-column: span 2; background: rgba(124, 58, 237, 0.2);">
                    <div class="hidden-label">üéØ PIG = s √ó q √ó r √ó TEG</div>
                    <div class="hidden-value" style="color: ${h.pig >= 1 ? 'var(--success)' : 'var(--danger)'};">${h.pig.toFixed(2)}</div>
                </div>
            `;
        } else {
            // D√©briefing manche 1 : seulement indicateurs √©conomiques
            document.getElementById('hiddenGrid').innerHTML = `
                <div class="hidden-item"><div class="hidden-label">üìà VAG Totale</div><div class="hidden-value" style="color: var(--success);">‚Ç¨${formatNumber(Math.round(vagActuel))}</div></div>
                <div class="hidden-item"><div class="hidden-label">üí∏ CGE Total</div><div class="hidden-value" style="color: var(--warning);">‚Ç¨${formatNumber(Math.round(cgeActuel))}</div></div>
                <div class="hidden-item"><div class="hidden-label">üí∞ RBE</div><div class="hidden-value" style="color: ${rbeActuel >= 0 ? 'var(--success)' : 'var(--danger)'};">‚Ç¨${formatNumber(Math.round(rbeActuel))}</div></div>
            `;
        }
    }
    
    function renderVSM() {
        const content = document.getElementById('vsmContent');
        
        // VSM verrouill√©e uniquement en manche 1 (sauf d√©briefing ou mode dev)
        if (gameState.manche === 1 && !gameState.phaseDebriefing && !devMode.unlockVSM) {
            content.innerHTML = `
                <div class="vsm-locked">
                    <div class="vsm-locked-icon">üîí</div>
                    <h2>VSM Verrouill√©e</h2>
                    <p>La cartographie de la cha√Æne de valeur sera disponible √† partir de la Manche 2.</p>
                    <p style="margin-top: 20px; color: var(--yellow);">Terminez la Manche 1 pour d√©couvrir les impacts r√©els de vos d√©cisions.</p>
                </div>
            `;
            return;
        }
        
        // Calculer les charges machines
        calculerChargesMachines();
        
        let totalVA = 0, totalNVA = 0, totalWIP = 0;
        const proc = gameState.processus;
        
        const vsmHTML = proc.map((p, idx) => {
            const va = p.tc * 0.3;
            const nva = p.tc * 0.7;
            totalVA += va;
            totalNVA += nva;
            totalWIP += p.wip;
            
            return `
                <div class="vsm-box">
                    <div class="vsm-icon">${p.emoji}</div>
                    <div class="vsm-name">${p.nom}</div>
                    <div class="vsm-metrics">
                        <div class="vsm-metric"><span>TC</span><span>${p.tc.toFixed(1)}h</span></div>
                        <div class="vsm-metric"><span style="color:var(--green)">VA</span><span style="color:var(--green)">${va.toFixed(1)}h</span></div>
                        <div class="vsm-metric"><span style="color:var(--red)">NVA</span><span style="color:var(--red)">${nva.toFixed(1)}h</span></div>
                        <div class="vsm-metric"><span>WIP</span><span>${Math.round(p.wip)}</span></div>
                    </div>
                </div>
                ${idx < proc.length - 1 ? '<div class="vsm-arrow">‚ûú</div>' : ''}
            `;
        }).join('');
        
        const lt = totalVA + totalNVA;
        const taux = (totalVA / lt * 100).toFixed(1);
        
        // G√©n√©rer HTML des machines avec indicateur de goulet
        const gouletInfo = identifierGoulet();
        const machinesHTML = Object.entries(gameState.machines).map(([mId, m]) => {
            const chargePercent = m.capacite > 0 ? (m.charge / m.capacite * 100) : 0;
            const isGoulet = mId === gouletInfo.goulet && chargePercent >= 80;
            const barClass = chargePercent >= 95 ? 'high' : chargePercent >= 70 ? 'medium' : 'low';
            
            return `
                <div class="vsm-constraint ${isGoulet ? 'bottleneck' : ''}">
                    <div class="vsm-constraint-header">
                        <span class="vsm-constraint-label">${m.emoji} ${m.nom}</span>
                        <span class="vsm-constraint-value" style="color: ${isGoulet ? 'var(--danger)' : 'var(--text-primary)'}">${m.charge.toFixed(0)}h / ${m.capacite}h (${chargePercent.toFixed(0)}%)</span>
                    </div>
                    <div class="vsm-constraint-bar">
                        <div class="vsm-constraint-bar-fill ${barClass}" style="width: ${Math.min(100, chargePercent)}%"></div>
                    </div>
                    ${isGoulet ? '<div style="color: var(--danger); font-size: 0.8em; margin-top: 6px; font-weight: 700;">üî¥ GOULET D\'√âTRANGLEMENT - Contrainte principale</div>' : ''}
                </div>
            `;
        }).join('');
        
        // G√©n√©rer HTML des micro-flux
        const microfluxHTML = Object.entries(gameState.microFlux).map(([mfId, mf]) => {
            const capaciteMax = calculerCapaciteVenteMax(mfId);
            
            return `
                <div class="vsm-microflux-card">
                    <div class="vsm-microflux-header">
                        <div class="vsm-microflux-name"><span>${mf.emoji}</span> ${mf.nom}</div>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700; color: var(--success);">QV: ${mf.QV}</span>
                    </div>
                    <div class="vsm-microflux-metrics">
                        <div class="vsm-microflux-metric">
                            <div class="vsm-microflux-metric-label">Lead Time</div>
                            <div class="vsm-microflux-metric-value">${mf.LT}j</div>
                        </div>
                        <div class="vsm-microflux-metric">
                            <div class="vsm-microflux-metric-label">TR (Taux Rebut)</div>
                            <div class="vsm-microflux-metric-value">${(mf.Tr * 100).toFixed(1)}%</div>
                        </div>
                        <div class="vsm-microflux-metric">
                            <div class="vsm-microflux-metric-label">VAG Unitaire</div>
                            <div class="vsm-microflux-metric-value">${Math.round(calculerVAG(mf))}‚Ç¨</div>
                        </div>
                        <div class="vsm-microflux-metric">
                            <div class="vsm-microflux-metric-label">Vente Max</div>
                            <div class="vsm-microflux-metric-value">${capaciteMax}</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.75em; color: var(--text-muted);">
                        Temps/unit√©: M1=${mf.tM1}h | M2=${mf.tM2}h | M3=${mf.tM3}h
                    </div>
                </div>
            `;
        }).join('');
        
        content.innerHTML = `
            <div class="section-header">
                <div class="section-title"><div class="title-icon">üó∫Ô∏è</div><span>Value Stream Mapping</span></div>
            </div>
            <div class="vsm-container"><div class="vsm-flow">${vsmHTML}</div></div>
            <div class="vsm-summary">
                <div class="vsm-summary-card"><div class="vsm-summary-label">Lead Time Total</div><div class="vsm-summary-value">${lt.toFixed(1)}h</div></div>
                <div class="vsm-summary-card"><div class="vsm-summary-label">Temps VA</div><div class="vsm-summary-value good">${totalVA.toFixed(1)}h</div></div>
                <div class="vsm-summary-card"><div class="vsm-summary-label">Temps NVA</div><div class="vsm-summary-value bad">${totalNVA.toFixed(1)}h</div></div>
                <div class="vsm-summary-card"><div class="vsm-summary-label">Taux VA</div><div class="vsm-summary-value ${parseFloat(taux) > 20 ? 'good' : 'bad'}">${taux}%</div></div>
                <div class="vsm-summary-card"><div class="vsm-summary-label">WIP Total</div><div class="vsm-summary-value">${Math.round(totalWIP)}</div></div>
            </div>
            
            <!-- Section Machines (Contraintes) -->
            <div class="vsm-microflux-section">
                <h3>‚öôÔ∏è Charge des Machines (Contraintes de Capacit√©)</h3>
                <div class="vsm-constraints">${machinesHTML}</div>
            </div>
            
            <!-- Section Micro-flux -->
            <div class="vsm-microflux-section">
                <h3>üì¶ Micro-flux (Produits)</h3>
                <div class="vsm-microflux-grid">${microfluxHTML}</div>
            </div>
        `;
    }
    
    function renderFullRanking() {
        const indicateurs = calculerIndicateursJoueurs();
        
        // Valeurs initiales des indicateurs locaux (stock√©es au d√©marrage)
        const valeursInitiales = gameState.indicateursInitiaux || {
            1: { value: 127500, label: 'Marge' },      // Marge initiale
            2: { value: 450, label: 'CR Moyen' },      // CR moyen initial
            3: { value: 45600, label: 'CGE' },         // CGE initial
            4: { value: 65, label: 'TRG' },            // TRG initial (%)
            5: { value: 92, label: 'Conformit√©' }      // Conformit√© initiale (%)
        };
        
        // Sauvegarder les valeurs initiales si pas encore fait
        if (!gameState.indicateursInitiaux) {
            gameState.indicateursInitiaux = {};
            indicateurs.forEach(ind => {
                gameState.indicateursInitiaux[ind.id] = { value: ind.value, label: ind.indicateur };
            });
        }
        
        // Calculer les progressions
        const progressions = indicateurs.map(ind => {
            const initial = valeursInitiales[ind.id]?.value || ind.value;
            
            // Calcul de la variation brute: (valeur actuelle - valeur initiale) / valeur initiale
            let variationBrute = initial !== 0 ? ((ind.value - initial) / initial) * 100 : 0;
            
            // Pour les indicateurs √† minimiser, multiplier par -1 pour avoir la performance r√©elle
            // Ex: CR passe de 450 √† 400 ‚Üí variation = -11% ‚Üí performance = +11% (bon!)
            let progression = ind.objectif === 'Minimiser' ? -variationBrute : variationBrute;
            
            return {
                ...ind,
                progression,
                isGood: progression >= 0
            };
        });
        
        document.getElementById('fullRanking').innerHTML = `
            <h3 style="text-align: center; color: var(--accent-tertiary); margin-bottom: 20px;">üèÜ Progression des Indicateurs Locaux</h3>
            
            <div style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center;">
                ${progressions.map(ind => `
                    <div style="flex: 0 0 calc(33.333% - 16px); min-width: 250px; max-width: 320px; background: var(--bg-card); border: 2px solid ${ind.color}40; border-radius: 16px; padding: 16px; box-sizing: border-box;">
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                            <div style="font-size: 2.2em;">${ind.emoji}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 1em;">J${ind.id} ‚Äì ${ind.nom}</div>
                                <div style="color: var(--text-muted); font-size: 0.8em;">${gameState.cartesAchetees[ind.id]?.length || 0} cartes jou√©es</div>
                            </div>
                        </div>
                        
                        <div style="background: ${ind.color}20; border-radius: 10px; padding: 12px; text-align: center; margin-bottom: 10px;">
                            <div style="color: ${ind.color}; font-size: 0.8em; font-weight: 600; margin-bottom: 2px;">
                                ${ind.indicateur}
                            </div>
                            <div style="font-size: 1.4em; font-weight: 700; color: ${ind.valueColor};">
                                ${ind.valueDisplay}
                            </div>
                        </div>
                        
                        <!-- Progression -->
                        <div style="background: ${ind.isGood ? 'rgba(34, 197, 94, 0.15)' : 'rgba(239, 68, 68, 0.15)'}; border: 1px solid ${ind.isGood ? 'var(--success)' : 'var(--danger)'}; border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 0.75em; color: var(--text-muted); margin-bottom: 2px;">Progression</div>
                            <div style="font-size: 1.8em; font-weight: 800; color: ${ind.isGood ? 'var(--success)' : 'var(--danger)'};">
                                ${ind.isGood ? '+' : ''}${ind.progression.toFixed(1)}%
                            </div>
                            <div style="font-size: 0.7em; color: var(--text-muted); margin-top: 2px;">
                                Objectif : ${ind.objectif}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
            
            <!-- R√©sum√© compact -->
            <div style="margin-top: 20px; background: var(--bg-elevated); border-radius: 12px; padding: 16px;">
                <h4 style="color: var(--accent-tertiary); margin-bottom: 12px; font-size: 0.95em;">üìä R√©sum√© des Progressions</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    ${progressions.map(ind => `
                        <div style="flex: 1 1 100px; max-width: 140px; text-align: center; padding: 10px; background: var(--bg-card); border-radius: 8px; border-left: 3px solid ${ind.isGood ? 'var(--success)' : 'var(--danger)'};">
                            <div style="font-size: 1.3em; margin-bottom: 2px;">${ind.emoji}</div>
                            <div style="font-size: 1.2em; font-weight: 700; color: ${ind.isGood ? 'var(--success)' : 'var(--danger)'};">
                                ${ind.isGood ? '+' : ''}${ind.progression.toFixed(1)}%
                            </div>
                            <div style="font-size: 0.7em; color: var(--text-muted);">${ind.indicateur}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // ==================== HISTORIQUE ====================
    
    function renderHistorique() {
        const filterManche = document.getElementById('filterManche')?.value || 'all';
        const filterJoueur = document.getElementById('filterJoueur')?.value || 'all';
        const filterImpact = document.getElementById('filterImpact')?.value || 'all';
        
        // Filtrer l'historique
        let filtered = gameState.historique.filter(entry => {
            if (filterManche !== 'all' && entry.manche !== parseInt(filterManche)) return false;
            if (filterJoueur !== 'all' && String(entry.joueur) !== filterJoueur) return false;
            if (filterImpact === 'negative' && (!entry.impacts?.cache || !hasNegativeImpact(entry.impacts.cache))) return false;
            if (filterImpact === 'positive' && entry.manche !== 3) return false;
            return true;
        });
        
        // Rendre la section d√©briefing si en phase d√©briefing
        renderDebriefingSection();
        
        // Rendre les statistiques
        renderHistoryStats(filtered);
        
        // Rendre la timeline
        renderHistoryTimeline(filtered);
        
        // Rendre le r√©sum√© des impacts
        renderImpactSummary(filtered);
    }
    
    function renderDebriefingSection() {
        const section = document.getElementById('debriefingSection');
        if (!section) return;
        
        if (gameState.phaseDebriefing) {
            section.style.display = 'block';
            
            const tousCompris = Object.values(gameState.joueursCompris).every(c => c);
            
            // Rendre les boutons de chaque joueur
            document.getElementById('debriefingPlayers').innerHTML = `
                <div style="display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin: 20px 0;">
                    ${[1,2,3,4,5].map(id => {
                        const compris = gameState.joueursCompris[id];
                        const config = JOUEURS_CONFIG[id];
                        return `
                            <button onclick="toggleComprisJoueur(${id})" class="btn-joueur-compris ${compris ? 'compris' : ''}" 
                                    style="padding: 12px 20px; border-radius: 12px; border: 2px solid ${compris ? 'var(--success)' : 'var(--border-default)'}; 
                                           background: ${compris ? 'rgba(34, 197, 94, 0.2)' : 'var(--bg-elevated)'}; 
                                           color: ${compris ? 'var(--success)' : 'var(--text-primary)'}; cursor: pointer;
                                           transition: all 0.2s; font-weight: 600;">
                                <span style="font-size: 1.5em; display: block; margin-bottom: 4px;">${config.emoji}</span>
                                J${id} ${compris ? '‚úì' : ''}
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Rendre le bouton d'action
            document.getElementById('debriefingAction').innerHTML = tousCompris ? `
                <div style="text-align: center; margin-top: 20px;">
                    <p style="color: var(--success); font-weight: 600; margin-bottom: 12px;">‚úÖ Tous les joueurs ont compris !</p>
                    <button onclick="passerManche2()" class="btn-modal" style="background: linear-gradient(135deg, var(--success), #10b981);">
                        üöÄ Passer √† la Manche 2 - Mode Collaboratif
                    </button>
                </div>
            ` : `
                <p style="text-align: center; color: var(--text-muted); margin-top: 16px;">
                    ${Object.values(gameState.joueursCompris).filter(c => c).length}/5 joueurs ont confirm√©
                </p>
            `;
        } else {
            section.style.display = 'none';
        }
    }
    
    function toggleComprisJoueur(joueur) {
        gameState.joueursCompris[joueur] = !gameState.joueursCompris[joueur];
        render();
    }
    
    function passerManche2() {
        finirDebriefingEtPasserManche2();
    }
    
    function hasNegativeImpact(cache) {
        if (!cache) return false;
        for (const [key, value] of Object.entries(cache)) {
            if (['s', 'r', 'q', 'vag'].includes(key) && value < 0) return true;
            if (key === 'cge' && value > 0) return true;
        }
        return false;
    }
    
    function renderHistoryStats(filtered) {
        const totalCost = filtered.reduce((sum, e) => sum + e.carte.cout, 0);
        const manche1Count = filtered.filter(e => e.manche === 1).length;
        const manche2Count = filtered.filter(e => e.manche === 2).length;
        const negativeCount = filtered.filter(e => hasNegativeImpact(e.impacts?.cache)).length;
        
        document.getElementById('historyStats').innerHTML = `
            <div class="history-stat-card">
                <div class="history-stat-icon">üÉè</div>
                <div class="history-stat-label">Total Cartes</div>
                <div class="history-stat-value">${filtered.length}</div>
            </div>
            <div class="history-stat-card">
                <div class="history-stat-icon">üí∞</div>
                <div class="history-stat-label">D√©penses Totales</div>
                <div class="history-stat-value">${totalCost} pts</div>
            </div>
            <div class="history-stat-card ${negativeCount > 0 ? 'negative' : ''}">
                <div class="history-stat-icon">‚ö†Ô∏è</div>
                <div class="history-stat-label">Impacts N√©gatifs</div>
                <div class="history-stat-value">${negativeCount}</div>
            </div>
            <div class="history-stat-card ${manche2Count > 0 ? 'positive' : ''}">
                <div class="history-stat-icon">üå±</div>
                <div class="history-stat-label">Lean/Green (M2)</div>
                <div class="history-stat-value">${manche2Count}</div>
            </div>
        `;
    }
    
    function renderHistoryTimeline(filtered) {
        if (filtered.length === 0) {
            document.getElementById('historyTimeline').innerHTML = `
                <div class="history-empty">
                    <div class="history-empty-icon">üì≠</div>
                    <h3>Aucune d√©cision enregistr√©e</h3>
                    <p>Les achats de cartes appara√Ætront ici.</p>
                </div>
            `;
            return;
        }
        
        // Trier par timestamp d√©croissant (plus r√©cent en premier)
        const sorted = [...filtered].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        const manche = gameState.manche;
        const enManche1SansDebriefing = manche === 1 && !gameState.phaseDebriefing;
        const apresRevelation = gameState.phaseDebriefing || manche >= 2 || gameState.hiddenRevealed;
        
        document.getElementById('historyTimeline').innerHTML = sorted.map(entry => {
            const joueurInfo = entry.joueur === 'commun' 
                ? { nom: 'Budget Commun', emoji: 'ü§ù' }
                : JOUEURS_CONFIG[entry.joueur];
            
            const time = new Date(entry.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            // Construire les effets √† afficher
            let effectsHTML = '';
            let explanationHTML = '';
            
            if (enManche1SansDebriefing) {
                // En Manche 1 (avant d√©briefing) : montrer les effets GLOBAUX
                if (entry.carte.effetGlobal) {
                    effectsHTML += `<span class="history-effect hidden" style="background: rgba(245, 158, 11, 0.15); border-color: var(--warning);">‚ö†Ô∏è ${entry.carte.effetGlobal}</span>`;
                }
                effectsHTML += `<span class="history-effect" style="background: rgba(99, 102, 241, 0.1); border-color: var(--accent-primary); font-size: 0.75em; color: var(--text-muted);">‚ÑπÔ∏è Impact local masqu√© jusqu'au d√©briefing</span>`;
            } else {
                // Apr√®s d√©briefing ou Manche 2+ : montrer TOUT
                // Effet visible (local)
                if (entry.carte.effetVisible) {
                    effectsHTML += `<span class="history-effect visible">üìà ${entry.carte.effetVisible}</span>`;
                }
                
                // Effet global (cach√©)
                if (entry.carte.effetGlobal && entry.manche === 1) {
                    effectsHTML += `<span class="history-effect hidden" style="background: rgba(239, 68, 68, 0.15); border-color: var(--danger);">‚ö†Ô∏è ${entry.carte.effetGlobal}</span>`;
                }
                
                // Explication p√©dagogique (uniquement pour les cartes Manche 1)
                if (entry.manche === 1 && EXPLICATIONS_CARTES[entry.carte.id]) {
                    explanationHTML = `
                        <div style="margin-top: 8px; padding: 8px 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid var(--purple);">
                            <span style="font-size: 0.8em; color: var(--purple);">üí° <strong>Pourquoi c'est probl√©matique :</strong></span>
                            <span style="font-size: 0.8em; color: var(--text-secondary);"> ${EXPLICATIONS_CARTES[entry.carte.id]}</span>
                        </div>
                    `;
                }
                
                if (entry.carte.type === 'revelation') {
                    effectsHTML += `<span class="history-effect visible">üîç R√©v√©lation</span>`;
                }
                
                // Pour manche 2+, afficher les impacts positifs
                if (entry.manche >= 2 && entry.carte.effetVisible) {
                    effectsHTML += `<span class="history-effect positive">‚ú® Am√©lioration Lean</span>`;
                }
            }
            
            return `
                <div class="history-entry manche-${entry.manche}">
                    <div class="history-entry-meta">
                        <div class="history-manche-badge">M${entry.manche}</div>
                        <div class="history-player-badge">${joueurInfo.emoji} J${entry.joueur === 'commun' ? 'ü§ù' : entry.joueur}</div>
                        <div class="history-time">${time}</div>
                    </div>
                    <div class="history-entry-content">
                        <div class="history-card-name">
                            <span class="history-card-emoji">${entry.carte.emoji}</span>
                            ${entry.carte.nom}
                        </div>
                        <div class="history-card-desc">${entry.carte.description}</div>
                        <div class="history-effects">${effectsHTML}</div>
                        ${explanationHTML}
                    </div>
                    <div class="history-entry-cost">
                        <div class="history-cost-value">${entry.carte.cout} pts</div>
                        <div class="history-cost-label">Reste: ${entry.budgetRestant} pts</div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function formatCacheImpacts(cache) {
        const effects = [];
        for (const [key, value] of Object.entries(cache)) {
            if (value < 0) {
                const label = { s: 'Vitesse', r: 'Env.', q: 'Satisf.' }[key] || key;
                const formatted = ['s', 'r', 'q'].includes(key) 
                    ? `${(value * 100).toFixed(0)}%` 
                    : `${value > 0 ? '+' : ''}${value}`;
                effects.push(`${label} ${formatted}`);
            }
        }
        return effects.join(', ');
    }
    
    function formatPositiveImpacts(cache) {
        const effects = [];
        for (const [key, value] of Object.entries(cache)) {
            if (value > 0) {
                const label = { s: 'Vitesse', r: 'Env.', q: 'Satisf.' }[key] || key;
                const formatted = ['s', 'r', 'q'].includes(key) 
                    ? `+${(value * 100).toFixed(0)}%` 
                    : `${value > 0 ? '+' : ''}${value}`;
                effects.push(`${label} ${formatted}`);
            }
        }
        return effects.join(', ');
    }
    
    function renderImpactSummary(filtered) {
        // Calculer les impacts cumul√©s
        const totals = { s: 0, r: 0, q: 0, vag: 0 };
        
        filtered.forEach(entry => {
            if (entry.impacts?.cache) {
                for (const [key, value] of Object.entries(entry.impacts.cache)) {
                    if (totals[key] !== undefined) {
                        totals[key] += value;
                    }
                }
            }
        });
        
        const hasData = Object.values(totals).some(v => v !== 0);
        
        if (!hasData) {
            document.getElementById('impactSummary').innerHTML = '';
            return;
        }
        
        document.getElementById('impactSummary').innerHTML = `
            <h4>üìä Impact Cumul√© des D√©cisions</h4>
            <div class="impact-grid">
                <div class="impact-item">
                    <div class="impact-item-label">üöÄ Vitesse (s)</div>
                    <div class="impact-item-value ${totals.s < 0 ? 'negative' : 'positive'}">${totals.s >= 0 ? '+' : ''}${(totals.s * 100).toFixed(0)}%</div>
                </div>
                <div class="impact-item">
                    <div class="impact-item-label">üåç Environnement (r)</div>
                    <div class="impact-item-value ${totals.r < 0 ? 'negative' : 'positive'}">${totals.r >= 0 ? '+' : ''}${(totals.r * 100).toFixed(0)}%</div>
                </div>
                <div class="impact-item">
                    <div class="impact-item-label">üòä Satisfaction (q)</div>
                    <div class="impact-item-value ${totals.q < 0 ? 'negative' : 'positive'}">${totals.q >= 0 ? '+' : ''}${(totals.q * 100).toFixed(0)}%</div>
                </div>
                <div class="impact-item">
                    <div class="impact-item-label">üìà VAG</div>
                    <div class="impact-item-value ${totals.vag < 0 ? 'negative' : 'positive'}">${totals.vag >= 0 ? '+' : ''}${totals.vag.toFixed(0)}%</div>
                </div>
                <div class="impact-item">
                    <div class="impact-item-label">üí∏ CGE</div>
                    <div class="impact-item-value ${totals.cge > 0 ? 'negative' : 'positive'}">${totals.cge >= 0 ? '+' : ''}${totals.cge.toFixed(0)}</div>
                </div>
            </div>
        `;
    }
    
    function exportHistory() {
        if (gameState.historique.length === 0) {
            showToast('Aucune donn√©e √† exporter', 'warning');
            return;
        }
        
        // Cr√©er le CSV
        const headers = ['Timestamp', 'Manche', 'Joueur', 'Carte', 'Co√ªt', 'Description', 'Effet Visible', 'Impact s', 'Impact r', 'Impact q', 'Impact VAG', 'Impact CGE'];
        const rows = gameState.historique.map(entry => {
            const joueurNom = entry.joueur === 'commun' ? 'Commun' : `J${entry.joueur} - ${JOUEURS_CONFIG[entry.joueur].nom}`;
            const cache = entry.impacts?.cache || {};
            return [
                entry.timestamp,
                entry.manche,
                joueurNom,
                entry.carte.nom,
                entry.carte.cout,
                `"${entry.carte.description}"`,
                `"${entry.carte.effetVisible || ''}"`,
                cache.s ? (cache.s * 100).toFixed(0) + '%' : '',
                cache.r ? (cache.r * 100).toFixed(0) + '%' : '',
                cache.q ? (cache.q * 100).toFixed(0) + '%' : '',
                cache.vag || '',
                cache.cge || ''
            ].join(',');
        });
        
        const csv = [headers.join(','), ...rows].join('\n');
        
        // T√©l√©charger
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `tableau_tactique_historique_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('Historique export√© !', 'success');
    }
    
    // Repositionner les tooltips pour √©viter les d√©bordements
    function setupTooltipPositioning() {
        document.addEventListener('mouseover', function(e) {
            if (e.target.classList.contains('tooltip-term')) {
                const tooltip = e.target;
                const rect = tooltip.getBoundingClientRect();
                
                // Calculer la position optimale du tooltip
                const tooltipWidth = 280;
                const tooltipHeight = 80;
                const margin = 10;
                
                let left, top;
                
                // Position horizontale
                if (rect.left + tooltipWidth/2 > window.innerWidth - margin) {
                    // Trop √† droite, aligner √† droite
                    left = Math.max(margin, window.innerWidth - tooltipWidth - margin);
                } else if (rect.left - tooltipWidth/2 < margin) {
                    // Trop √† gauche, aligner √† gauche
                    left = margin;
                } else {
                    // Centrer
                    left = rect.left + rect.width/2 - tooltipWidth/2;
                }
                
                // Position verticale
                if (rect.top < tooltipHeight + margin + 20) {
                    // Pas assez de place en haut, afficher en bas
                    top = rect.bottom + 8;
                } else {
                    // Afficher en haut
                    top = rect.top - tooltipHeight - 8;
                }
                
                // Appliquer les positions via style inline sur ::after via CSS variables
                tooltip.style.setProperty('--tooltip-left', left + 'px');
                tooltip.style.setProperty('--tooltip-top', top + 'px');
            }
        });
    }
    setupTooltipPositioning();
    
    // Support tactile pour les tooltips (tablettes/mobiles)
    let tooltipTimeout = null;
    let activeTooltip = null;
    
    function showTooltipOnTouch(tooltip) {
        // Fermer le tooltip pr√©c√©dent
        if (activeTooltip && activeTooltip !== tooltip) {
            activeTooltip.classList.remove('tooltip-active');
        }
        
        // Annuler le timeout pr√©c√©dent
        if (tooltipTimeout) {
            clearTimeout(tooltipTimeout);
        }
        
        // Calculer la position (m√™me logique que pour le hover)
        const rect = tooltip.getBoundingClientRect();
        const tooltipWidth = 280;
        const tooltipHeight = 80;
        const margin = 10;
        
        let left, top;
        
        if (rect.left + tooltipWidth/2 > window.innerWidth - margin) {
            left = Math.max(margin, window.innerWidth - tooltipWidth - margin);
        } else if (rect.left - tooltipWidth/2 < margin) {
            left = margin;
        } else {
            left = rect.left + rect.width/2 - tooltipWidth/2;
        }
        
        if (rect.top < tooltipHeight + margin + 20) {
            top = rect.bottom + 8;
        } else {
            top = rect.top - tooltipHeight - 8;
        }
        
        tooltip.style.setProperty('--tooltip-left', left + 'px');
        tooltip.style.setProperty('--tooltip-top', top + 'px');
        
        // Afficher le tooltip
        tooltip.classList.add('tooltip-active');
        activeTooltip = tooltip;
        
        // Masquer apr√®s 2.5 secondes
        tooltipTimeout = setTimeout(() => {
            tooltip.classList.remove('tooltip-active');
            activeTooltip = null;
        }, 2500);
    }
    
    // Gestionnaire de clic pour les √©crans tactiles
    document.addEventListener('click', function(e) {
        const tooltip = e.target.closest('.tooltip-term');
        
        if (tooltip) {
            e.preventDefault();
            e.stopPropagation();
            showTooltipOnTouch(tooltip);
        } else {
            // Clic ailleurs = fermer le tooltip actif
            if (activeTooltip) {
                activeTooltip.classList.remove('tooltip-active');
                activeTooltip = null;
                if (tooltipTimeout) {
                    clearTimeout(tooltipTimeout);
                    tooltipTimeout = null;
                }
            }
        }
    });
    
    // ==================== V0.6.32 - NOUVELLES FONCTIONNALIT√âS UX ====================
    
    // √âtat des nouvelles fonctionnalit√©s
    const uxState = {
        comparisonMode: false,
        selectedForComparison: [],
        showAssistant: true,
        cardFilter: 'all',
        cardSort: 'default',
        searchQuery: ''
    };
    
    // Toggle mode comparaison
    function toggleComparisonMode() {
        uxState.comparisonMode = !uxState.comparisonMode;
        uxState.selectedForComparison = [];
        document.body.classList.toggle('comparison-mode-active', uxState.comparisonMode);
        updateComparisonPanel();
        showToast(uxState.comparisonMode ? '‚öñÔ∏è Mode comparaison activ√© - S√©lectionnez jusqu\'√† 3 cartes' : 'Mode comparaison d√©sactiv√©', 'info');
        render();
    }
    
    // S√©lectionner une carte pour comparaison
    function toggleCardComparison(carteId) {
        if (!uxState.comparisonMode) return;
        
        const index = uxState.selectedForComparison.indexOf(carteId);
        if (index > -1) {
            uxState.selectedForComparison.splice(index, 1);
        } else if (uxState.selectedForComparison.length < 3) {
            uxState.selectedForComparison.push(carteId);
        } else {
            showToast('Maximum 3 cartes pour la comparaison', 'warning');
            return;
        }
        
        updateComparisonPanel();
        render();
    }
    
    // Mettre √† jour le panneau de comparaison
    function updateComparisonPanel() {
        const panel = document.getElementById('comparisonPanel');
        if (!panel) return;
        
        // Mettre √† jour le compteur
        const countEl = document.getElementById('comparisonCount');
        if (countEl) {
            countEl.textContent = `(${uxState.selectedForComparison.length}/3)`;
        }
        
        if (!uxState.comparisonMode || uxState.selectedForComparison.length === 0) {
            panel.classList.remove('active');
            return;
        }
        
        panel.classList.add('active');
        const manche = gameState.manche;
        const joueur = gameState.joueurActuel;
        
        const cardsHTML = uxState.selectedForComparison.map(carteId => {
            const carte = findCarteById(carteId);
            if (!carte) return '';
            
            const impacts = analyzeCardImpacts(carte);
            const risk = evaluateCardRisk(carte);
            
            // M√©triques diff√©rentes selon la manche
            let metricsHTML = '';
            
            if (manche === 1 && !gameState.phaseDebriefing) {
                // Manche 1: afficher UNIQUEMENT l'indicateur phare du joueur
                const showHelp = devMode.showCardHelp;
                
                // Calculer l'impact sp√©cifique selon le joueur
                if (joueur === 1) {
                    // J1 Commercial: Impact sur la Marge
                    const pvImpact = carte.impacts?.global?.PV ? (carte.impacts.global.PV * 100) : 0;
                    const daImpact = carte.impacts?.global?.DA ? (carte.impacts.global.DA * 100) : 0;
                    const margeImpact = pvImpact - daImpact;
                    
                    metricsHTML = `
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">üíµ Impact Marge</span>
                            <span class="comparison-metric-value" style="color: ${margeImpact >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size: 1.2em;">
                                ${margeImpact >= 0 ? '+' : ''}${margeImpact.toFixed(1)}%
                            </span>
                        </div>
                    `;
                } else if (joueur === 2) {
                    // J2 Approvisionnement: Impact sur le Co√ªt de Revient
                    const daImpact = carte.impacts?.global?.DA ? (carte.impacts.global.DA * 100) : 0;
                    
                    metricsHTML = `
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">üì¶ Impact Co√ªt Revient</span>
                            <span class="comparison-metric-value" style="color: ${daImpact <= 0 ? 'var(--success)' : 'var(--danger)'}; font-size: 1.2em;">
                                ${daImpact > 0 ? '+' : ''}${daImpact.toFixed(1)}%
                            </span>
                        </div>
                    `;
                } else if (joueur === 3) {
                    // J3 Logistique: Impact sur le Lead Time
                    metricsHTML = `
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">üöö Impact Lead Time</span>
                            <span class="comparison-metric-value" style="color: ${impacts.ltImpact <= 0 ? 'var(--success)' : 'var(--danger)'}; font-size: 1.2em;">
                                ${impacts.ltImpact > 0 ? '+' : ''}${impacts.ltImpact}j
                            </span>
                        </div>
                    `;
                } else if (joueur === 4) {
                    // J4 Production: Impact sur la Capacit√©/TRG
                    const capImpact = carte.impacts?.global?.CAP ? (carte.impacts.global.CAP * 100) : 0;
                    const tcImpact = carte.impacts?.global?.TC ? (carte.impacts.global.TC * 100) : 0;
                    
                    metricsHTML = `
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">üè≠ Impact Capacit√©</span>
                            <span class="comparison-metric-value" style="color: ${capImpact >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size: 1.2em;">
                                ${capImpact >= 0 ? '+' : ''}${capImpact.toFixed(0)}%
                            </span>
                        </div>
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">‚è±Ô∏è Temps Cycle</span>
                            <span class="comparison-metric-value" style="color: ${tcImpact <= 0 ? 'var(--success)' : 'var(--danger)'}">
                                ${tcImpact > 0 ? '+' : ''}${tcImpact.toFixed(0)}%
                            </span>
                        </div>
                    `;
                } else if (joueur === 5) {
                    // J5 Qualit√©: Impact sur la Conformit√© (inverse du TR)
                    const trImpact = impacts.qualityImpact; // D√©j√† calcul√©
                    
                    metricsHTML = `
                        <div class="comparison-metric">
                            <span class="comparison-metric-label">‚úÖ Impact Conformit√©</span>
                            <span class="comparison-metric-value" style="color: ${trImpact <= 0 ? 'var(--success)' : 'var(--danger)'}; font-size: 1.2em;">
                                ${trImpact > 0 ? '+' : ''}${trImpact.toFixed(1)}% TR
                            </span>
                        </div>
                    `;
                }
                
                // Ajouter score si aide activ√©e
                if (showHelp) {
                    metricsHTML += `
                        <div class="comparison-metric" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                            <span class="comparison-metric-label">Score</span>
                            <span class="comparison-metric-value" style="color: var(--accent-primary)">
                                ${impacts.score}/100
                            </span>
                        </div>
                    `;
                }
            } else {
                // Manche 2+: on peut montrer VAG
                metricsHTML = `
                    <div class="comparison-metric">
                        <span class="comparison-metric-label">Impact VAG</span>
                        <span class="comparison-metric-value" style="color: ${impacts.vagImpact >= 0 ? 'var(--success)' : 'var(--danger)'}">
                            ${impacts.vagImpact >= 0 ? '+' : ''}${impacts.vagImpact.toFixed(0)}%
                        </span>
                    </div>
                    <div class="comparison-metric">
                        <span class="comparison-metric-label">Impact LT</span>
                        <span class="comparison-metric-value" style="color: ${impacts.ltImpact <= 0 ? 'var(--success)' : 'var(--danger)'}">
                            ${impacts.ltImpact > 0 ? '+' : ''}${impacts.ltImpact}j
                        </span>
                    </div>
                    <div class="comparison-metric">
                        <span class="comparison-metric-label">Impact Qualit√©</span>
                        <span class="comparison-metric-value" style="color: ${impacts.qualityImpact >= 0 ? 'var(--success)' : 'var(--danger)'}">
                            ${impacts.qualityImpact >= 0 ? '+' : ''}${impacts.qualityImpact.toFixed(0)}%
                        </span>
                    </div>
                    <div class="comparison-metric">
                        <span class="comparison-metric-label">Score D√©cision</span>
                        <span class="comparison-metric-value" style="color: var(--accent-primary)">
                            ${impacts.score}/100
                        </span>
                    </div>
                `;
            }
            
            return `
                <div class="comparison-card">
                    <div class="comparison-card-header">
                        <span class="comparison-card-emoji">${carte.emoji}</span>
                        <span class="comparison-card-name">${carte.nom}</span>
                        <span class="comparison-card-cost">${carte.cout} pts</span>
                    </div>
                    <div class="comparison-metrics">
                        ${metricsHTML}
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('comparisonCards').innerHTML = cardsHTML;
    }
    
    // Trouver une carte par son ID
    function findCarteById(carteId) {
        // Chercher dans Manche 1
        for (let joueur = 1; joueur <= 5; joueur++) {
            const cartes = CARTES_MANCHE1[joueur] || [];
            const carte = cartes.find(c => c.id === carteId);
            if (carte) return carte;
        }
        // Chercher dans Manche 2
        const m2 = CARTES_MANCHE2.find(c => c.id === carteId);
        if (m2) return m2;
        // Chercher dans Manche 3
        const m3 = CARTES_MANCHE3.find(c => c.id === carteId);
        if (m3) return m3;
        return null;
    }
    
    // Analyser les impacts d'une carte
    function analyzeCardImpacts(carte) {
        let vagImpact = 0;
        let ltImpact = carte.LT_effect || 0;
        let qualityImpact = 0;
        let cgeImpact = 0;
        
        if (carte.impacts) {
            if (carte.impacts.global) {
                vagImpact += (carte.impacts.global.PV || 0) * 100;
                vagImpact -= (carte.impacts.global.DA || 0) * 100;
                qualityImpact -= (carte.impacts.global.Tr || 0) * 100;
                cgeImpact += (carte.impacts.global.CGE || 0);
                ltImpact += carte.impacts.global.LT || 0;
            }
            if (carte.impacts.hidden || carte.impacts.cache) {
                const h = carte.impacts.hidden || carte.impacts.cache;
                qualityImpact += (h.q || 0) * 100;
            }
        }
        
        // Calculer un score de d√©cision bas√© sur plusieurs facteurs
        let score = 50;
        score += vagImpact * 2;
        score -= ltImpact * 0.5;
        score += qualityImpact;
        score -= cgeImpact * 0.3;
        score -= carte.cout * 0.2;
        score = Math.max(0, Math.min(100, Math.round(score)));
        
        return { vagImpact, ltImpact, qualityImpact, cgeImpact, score };
    }
    
    // √âvaluer le risque d'une carte
    function evaluateCardRisk(carte) {
        const impacts = analyzeCardImpacts(carte);
        let riskLevel = 'low-risk';
        let riskScore = 0;
        
        // Facteurs de risque
        if (impacts.ltImpact > 30) riskScore += 2;
        else if (impacts.ltImpact > 15) riskScore += 1;
        
        if (impacts.qualityImpact < -5) riskScore += 2;
        else if (impacts.qualityImpact < -2) riskScore += 1;
        
        if (carte.cout > 50) riskScore += 1;
        
        if (carte.impacts?.bfr && carte.impacts.bfr > 0.2) riskScore += 2;
        
        // V√©rifier les impacts cach√©s n√©gatifs
        const hidden = carte.impacts?.hidden || carte.impacts?.cache;
        if (hidden) {
            if (hidden.s && hidden.s < -0.05) riskScore += 2;
            if (hidden.q && hidden.q < -0.05) riskScore += 2;
            if (hidden.r && hidden.r < -0.05) riskScore += 1;
        }
        
        if (riskScore >= 4) riskLevel = 'high-risk';
        else if (riskScore >= 2) riskLevel = 'medium-risk';
        
        return { riskLevel, riskScore };
    }
    
    // G√©n√©rer des conseils contextuels
    function generateContextualTips() {
        const tips = [];
        const manche = gameState.manche;
        const joueur = gameState.joueurActuel;
        const budget = manche === 1 ? gameState.budgetManche1 : gameState.budgetCommun;
        
        // Conseil sur le budget
        if (manche === 1 && budget < SEUILS.budgetBas) {
            tips.push({
                type: 'warning',
                icon: 'üí∞',
                title: 'Budget limit√©',
                text: `Il ne reste que ${budget} points. Priorisez les cartes √† fort impact ou passez votre tour.`
            });
        }
        
        // Conseil sur le goulet d'√©tranglement
        calculerChargesMachines();
        const goulet = identifierGoulet();
        if (goulet && goulet.surcharge) {
            tips.push({
                type: 'danger',
                icon: '‚ö†Ô∏è',
                title: `Goulet sur ${goulet.machine}`,
                text: `La charge (${goulet.charge}%) d√©passe la capacit√©. Cherchez des cartes pour r√©duire la charge ou augmenter la capacit√©.`
            });
        }
        
        // Conseils sp√©cifiques par joueur avec orientation KPI (Manche 1)
        if (manche === 1) {
            if (joueur === 1) {
                // J1 COMMERCIAL - KPI: Marge
                const marge = calculerMargeTotal();
                let recettes = 0, couts = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    recettes += mf.PV * mf.QV;
                    couts += mf.DA * mf.QV;
                }
                const tauxMarge = recettes > 0 ? ((marge / recettes) * 100).toFixed(1) : 0;
                
                tips.push({
                    type: tauxMarge >= 40 ? 'success' : tauxMarge >= 25 ? 'info' : 'warning',
                    icon: 'üíµ',
                    title: `üìä Votre KPI : MARGE (${tauxMarge}%)`,
                    text: `Marge actuelle: ‚Ç¨${formatNumber(Math.round(marge))}. Votre objectif est de MAXIMISER la marge brute.`
                });
                
                tips.push({
                    type: 'info',
                    icon: 'üéØ',
                    title: 'Comment am√©liorer votre marge ?',
                    text: `<strong>‚ÜóÔ∏è Augmenter PV</strong> : cartes "prix premium", "image de marque"<br>
                           <strong>‚ÜòÔ∏è R√©duire DA</strong> : cartes "n√©gociation fournisseur", "achats group√©s"<br>
                           <strong>üì¶ Optimiser le mix</strong> : privil√©giez les produits √† forte marge unitaire`
                });
                
                // Analyser les cartes disponibles pour le commercial
                const cartesJ1 = (CARTES_MANCHE1[1] || []).filter(c => !c.purchased && c.cout <= budget);
                const cartesMargeUp = cartesJ1.filter(c => 
                    c.impacts?.global?.PV > 0 || c.impacts?.global?.DA < 0
                );
                if (cartesMargeUp.length > 0) {
                    tips.push({
                        type: 'success',
                        icon: '‚≠ê',
                        title: `${cartesMargeUp.length} carte(s) am√©liorent votre marge`,
                        text: cartesMargeUp.slice(0, 2).map(c => `${c.emoji} ${c.nom}`).join(', ')
                    });
                }
                
            } else if (joueur === 2) {
                // J2 APPROVISIONNEMENT - KPI: Co√ªt de Revient
                let crTotal = 0, qvTotal = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    crTotal += calculerDDP(mf) * mf.QV;
                    qvTotal += mf.QV;
                }
                const crMoyen = qvTotal > 0 ? crTotal / qvTotal : 0;
                
                tips.push({
                    type: crMoyen <= 1800 ? 'success' : crMoyen <= 2200 ? 'info' : 'warning',
                    icon: 'üì¶',
                    title: `üìä Votre KPI : CO√õT DE REVIENT (‚Ç¨${formatNumber(Math.round(crMoyen))})`,
                    text: `Co√ªt de revient moyen par unit√©. Votre objectif est de MINIMISER ce co√ªt.`
                });
                
                tips.push({
                    type: 'info',
                    icon: 'üéØ',
                    title: 'Comment r√©duire le co√ªt de revient ?',
                    text: `<strong>‚ÜòÔ∏è R√©duire DA</strong> : n√©gociation, achats group√©s, nouveaux fournisseurs<br>
                           <strong>‚ÜòÔ∏è R√©duire d√©lais</strong> : cartes "d√©lai fournisseur" r√©duisent le BFR<br>
                           <strong>‚ö†Ô∏è Attention</strong> : √©vitez les cartes qui augmentent le taux de rebut !`
                });
                
                const cartesJ2 = (CARTES_MANCHE1[2] || []).filter(c => !c.purchased && c.cout <= budget);
                const cartesCRDown = cartesJ2.filter(c => 
                    c.impacts?.global?.DA < 0 || c.impacts?.global?.delaiFournisseur < 0
                );
                if (cartesCRDown.length > 0) {
                    tips.push({
                        type: 'success',
                        icon: '‚≠ê',
                        title: `${cartesCRDown.length} carte(s) r√©duisent vos co√ªts`,
                        text: cartesCRDown.slice(0, 2).map(c => `${c.emoji} ${c.nom}`).join(', ')
                    });
                }
                
            } else if (joueur === 3) {
                // J3 LOGISTIQUE - KPI: Lead Time
                const ltMoyen = calculerLTMoyen();
                let bfrTotal = 0;
                for (const mfId in gameState.microFlux) {
                    bfrTotal += calculerBFR(gameState.microFlux[mfId]);
                }
                
                tips.push({
                    type: ltMoyen <= SEUILS.leadTime.bon ? 'success' : ltMoyen <= SEUILS.leadTime.moyen ? 'info' : 'warning',
                    icon: 'üöö',
                    title: `üìä Votre KPI : LEAD TIME (${ltMoyen.toFixed(0)} jours)`,
                    text: `D√©lai moyen de livraison. Votre objectif est de MINIMISER ce d√©lai.`
                });
                
                tips.push({
                    type: 'info',
                    icon: 'üéØ',
                    title: 'Comment r√©duire le Lead Time ?',
                    text: `<strong>‚ÜòÔ∏è R√©duire LT</strong> : cartes "flux tir√©", "kanban", "optimisation stock"<br>
                           <strong>‚ÜòÔ∏è R√©duire BFR</strong> : BFR actuel = ‚Ç¨${formatNumber(Math.round(bfrTotal))}<br>
                           <strong>‚ö†Ô∏è Attention</strong> : le LT impacte directement la satisfaction client !`
                });
                
                const cartesJ3 = (CARTES_MANCHE1[3] || []).filter(c => !c.purchased && c.cout <= budget);
                const cartesLTDown = cartesJ3.filter(c => 
                    c.impacts?.global?.LT < 0 || c.impacts?.microflux?.LT < 0
                );
                if (cartesLTDown.length > 0) {
                    tips.push({
                        type: 'success',
                        icon: '‚≠ê',
                        title: `${cartesLTDown.length} carte(s) r√©duisent le Lead Time`,
                        text: cartesLTDown.slice(0, 2).map(c => `${c.emoji} ${c.nom}`).join(', ')
                    });
                }
                
            } else if (joueur === 4) {
                // J4 PRODUCTION - KPI: TRG
                let trgSum = 0, machineCount = 0;
                for (const [machineId, machine] of Object.entries(gameState.machines)) {
                    const chargePercent = machine.capacite > 0 ? Math.min(100, (machine.charge / machine.capacite * 100)) : 0;
                    trgSum += chargePercent;
                    machineCount++;
                }
                const trgMoyen = machineCount > 0 ? trgSum / machineCount : 0;
                
                tips.push({
                    type: trgMoyen >= SEUILS.trg.bon ? 'success' : trgMoyen >= SEUILS.trg.moyen ? 'info' : 'warning',
                    icon: 'üè≠',
                    title: `üìä Votre KPI : TRG MOYEN (${trgMoyen.toFixed(0)}%)`,
                    text: `Taux de Rendement Global des machines. Objectif : OPTIMISER entre 70-85%.`
                });
                
                tips.push({
                    type: 'info',
                    icon: 'üéØ',
                    title: 'Comment optimiser le TRG ?',
                    text: `<strong>‚ÜóÔ∏è Augmenter capacit√©</strong> : cartes "investissement machine", "maintenance pr√©ventive"<br>
                           <strong>‚ÜòÔ∏è R√©duire temps cycle</strong> : cartes "lean", "SMED", "automatisation"<br>
                           <strong>‚ö†Ô∏è Goulet actuel</strong> : ${goulet.machine} √† ${goulet.charge}%`
                });
                
                const cartesJ4 = (CARTES_MANCHE1[4] || []).filter(c => !c.purchased && c.cout <= budget);
                const cartesTRGUp = cartesJ4.filter(c => 
                    c.impacts?.global?.CAP > 0 || c.impacts?.global?.TC < 0 || c.impacts?.machineCapacite
                );
                if (cartesTRGUp.length > 0) {
                    tips.push({
                        type: 'success',
                        icon: '‚≠ê',
                        title: `${cartesTRGUp.length} carte(s) am√©liorent la production`,
                        text: cartesTRGUp.slice(0, 2).map(c => `${c.emoji} ${c.nom}`).join(', ')
                    });
                }
                
            } else if (joueur === 5) {
                // J5 QUALIT√â - KPI: Conformit√© (1 - TR)
                let trTotal = 0;
                const mfCount = Object.keys(gameState.microFlux).length;
                for (const mfId in gameState.microFlux) {
                    trTotal += gameState.microFlux[mfId].Tr;
                }
                const trMoyen = mfCount > 0 ? (trTotal / mfCount) * 100 : 0;
                const conformite = 100 - trMoyen;
                
                tips.push({
                    type: conformite >= SEUILS.conformite.bon ? 'success' : conformite >= SEUILS.conformite.moyen ? 'info' : 'warning',
                    icon: '‚úÖ',
                    title: `üìä Votre KPI : CONFORMIT√â (${conformite.toFixed(1)}%)`,
                    text: `Taux de conformit√© (100% - rebut). Votre objectif est de MAXIMISER ce taux.`
                });
                
                tips.push({
                    type: 'info',
                    icon: 'üéØ',
                    title: 'Comment am√©liorer la conformit√© ?',
                    text: `<strong>‚ÜòÔ∏è R√©duire TR</strong> : cartes "contr√¥le qualit√©", "formation", "6 sigma"<br>
                           <strong>Taux de rebut actuel</strong> : ${trMoyen.toFixed(1)}%<br>
                           <strong>‚ö†Ô∏è Attention</strong> : certaines cartes "pas ch√®res" augmentent le TR !`
                });
                
                const cartesJ5 = (CARTES_MANCHE1[5] || []).filter(c => !c.purchased && c.cout <= budget);
                const cartesTRDown = cartesJ5.filter(c => 
                    c.impacts?.global?.Tr < 0 || c.impacts?.microflux?.Tr < 0
                );
                if (cartesTRDown.length > 0) {
                    tips.push({
                        type: 'success',
                        icon: '‚≠ê',
                        title: `${cartesTRDown.length} carte(s) am√©liorent la qualit√©`,
                        text: cartesTRDown.slice(0, 2).map(c => `${c.emoji} ${c.nom}`).join(', ')
                    });
                }
            }
        }
        
        // Conseil sur la manche collaborative
        if (manche === 2) {
            const rbe = calculerRBE();
            tips.push({
                type: rbe >= 0 ? 'success' : 'danger',
                icon: 'ü§ù',
                title: `Mode Collaboratif - RBE: ‚Ç¨${formatNumber(Math.round(rbe))}`,
                text: 'Discutez avec l\'√©quipe ! Les d√©cisions affectent tout le monde. Visez √† maximiser le RBE.'
            });
            
            tips.push({
                type: 'info',
                icon: 'üéØ',
                title: 'Strat√©gie d\'√©quipe',
                text: `<strong>RBE = VAG - CGE</strong><br>
                       ‚ÜóÔ∏è Augmenter VAG : volume √ó marge<br>
                       ‚ÜòÔ∏è R√©duire CGE : charges fixes et variables`
            });
        }
        
        if (manche === 3) {
            const pig = gameState.hidden?.pig || calculerPIG();
            tips.push({
                type: pig >= 0.7 ? 'success' : pig >= 0.5 ? 'info' : 'warning',
                icon: 'üåø',
                title: `Excellence & Durabilit√© - PIG: ${(pig * 100).toFixed(0)}%`,
                text: 'Pensez long terme : les cartes vertes am√©liorent l\'image et la performance PIG.'
            });
            
            tips.push({
                type: 'info',
                icon: 'üéØ',
                title: 'Objectifs Manche 3',
                text: `<strong>S (Speed)</strong> : R√©activit√© et d√©lais<br>
                       <strong>Q (Quality)</strong> : Satisfaction client<br>
                       <strong>R (RSE)</strong> : Responsabilit√© environnementale`
            });
        }
        
        return tips;
    }
    
    // Calculer la marge totale
    function calculerMargeTotal() {
        let marge = 0;
        for (const mfId in gameState.microFlux) {
            const mf = gameState.microFlux[mfId];
            marge += (mf.PV - mf.DA) * mf.QV;
        }
        return marge;
    }
    
    // Identifier le goulet d'√©tranglement (version am√©lior√©e compatible)
    function identifierGoulet() {
        let maxCharge = 0;
        let gouletMachine = null;
        
        for (const [machineId, machine] of Object.entries(gameState.machines)) {
            const chargePercent = machine.capacite > 0 ? (machine.charge / machine.capacite * 100) : 0;
            if (chargePercent > maxCharge) {
                maxCharge = chargePercent;
                gouletMachine = machineId;
            }
        }
        
        return {
            // Propri√©t√©s compatibles avec l'ancienne version
            goulet: gouletMachine,
            chargePercent: maxCharge,
            // Nouvelles propri√©t√©s pour v0.6.32
            machine: gouletMachine,
            charge: Math.round(maxCharge),
            surcharge: maxCharge > SEUILS.goulet.critique
        };
    }
    
    // Filtrer les cartes
    function filterCards(cartes) {
        let filtered = [...cartes];
        
        // Filtre par recherche
        if (uxState.searchQuery) {
            const query = uxState.searchQuery.toLowerCase();
            filtered = filtered.filter(c => 
                c.nom.toLowerCase().includes(query) ||
                c.description.toLowerCase().includes(query) ||
                (c.secteur && c.secteur.toLowerCase().includes(query))
            );
        }
        
        // Filtre par type
        if (uxState.cardFilter !== 'all') {
            if (uxState.cardFilter === 'low-cost') {
                filtered = filtered.filter(c => c.cout <= 20);
            } else if (uxState.cardFilter === 'high-impact') {
                filtered = filtered.filter(c => {
                    const impacts = analyzeCardImpacts(c);
                    return impacts.score >= 60;
                });
            } else if (uxState.cardFilter === 'low-risk') {
                filtered = filtered.filter(c => {
                    const risk = evaluateCardRisk(c);
                    return risk.riskLevel === 'low-risk';
                });
            }
        }
        
        // Tri
        if (uxState.cardSort === 'cost-asc') {
            filtered.sort((a, b) => a.cout - b.cout);
        } else if (uxState.cardSort === 'cost-desc') {
            filtered.sort((a, b) => b.cout - a.cout);
        } else if (uxState.cardSort === 'score-desc') {
            filtered.sort((a, b) => {
                const scoreA = analyzeCardImpacts(a).score;
                const scoreB = analyzeCardImpacts(b).score;
                return scoreB - scoreA;
            });
        }
        
        return filtered;
    }
    
    // Mettre √† jour le filtre
    function setCardFilter(filter) {
        uxState.cardFilter = filter;
        render();
    }
    
    // Mettre √† jour le tri
    function setCardSort(sort) {
        uxState.cardSort = sort;
        render();
    }
    
    // Mettre √† jour la recherche
    function setCardSearch(query) {
        uxState.searchQuery = query;
        render();
    }
    
    // Simuler l'achat d'une carte (pr√©visualisation)
    function simulateCardPurchase(carteId) {
        const carte = findCarteById(carteId);
        if (!carte) return;
        
        const modal = document.getElementById('simulationModal');
        if (!modal) return;
        
        const manche = gameState.manche;
        const joueur = gameState.joueurActuel;
        const impacts = analyzeCardImpacts(carte);
        const risk = evaluateCardRisk(carte);
        
        // Aide visible seulement si activ√©e ou Manche 2+
        const showHelp = devMode.showCardHelp || manche >= 2;
        
        let metricsHTML = '';
        
        // En Manche 1: afficher des m√©triques VISIBLES sp√©cifiques au joueur
        if (manche === 1) {
            // M√©triques communes visibles
            const ltBefore = calculerLTMoyen();
            const ltAfter = ltBefore + impacts.ltImpact;
            
            // Calculer TR moyen
            let trTotal = 0;
            let mfCount = Object.keys(gameState.microFlux).length;
            for (const mfId in gameState.microFlux) {
                trTotal += gameState.microFlux[mfId].Tr;
            }
            const trBefore = mfCount > 0 ? (trTotal / mfCount) * 100 : 0;
            const trAfter = Math.max(0, trBefore + impacts.qualityImpact);
            
            // Capacit√© (affect√©e par certaines cartes)
            const capImpact = carte.impacts?.global?.CAP ? (carte.impacts.global.CAP * 100) : 0;
            
            // Budget impact
            const budgetBefore = gameState.budgetManche1;
            const budgetAfter = budgetBefore - carte.cout;
            
            // M√©triques sp√©cifiques selon le joueur
            if (joueur === 1) {
                // J1 Commercial: Marge
                let margeBefore = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    margeBefore += (mf.PV - mf.DA) * mf.QV;
                }
                const pvImpact = carte.impacts?.global?.PV ? (carte.impacts.global.PV * 100) : 0;
                const daImpact = carte.impacts?.global?.DA ? (carte.impacts.global.DA * 100) : 0;
                const margeChange = pvImpact - daImpact;
                const margeAfter = margeBefore * (1 + margeChange / 100);
                
                metricsHTML = `
                    <div class="simulation-metric-row">
                        <span>üíµ Marge Totale</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">‚Ç¨${formatNumber(Math.round(margeBefore))}</span>
                        <span>‚Üí</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">‚Ç¨${formatNumber(Math.round(margeAfter))}</span>
                        <span class="simulation-change ${margeAfter >= margeBefore ? 'positive' : 'negative'}">
                            ${margeChange >= 0 ? '+' : ''}${margeChange.toFixed(1)}%
                        </span>
                    </div>
                `;
            } else if (joueur === 2) {
                // J2 Approvisionnement: Co√ªt de Revient
                let crTotal = 0, qvTotal = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    crTotal += calculerDDP(mf) * mf.QV;
                    qvTotal += mf.QV;
                }
                const crBefore = qvTotal > 0 ? crTotal / qvTotal : 0;
                const daImpact = carte.impacts?.global?.DA ? (carte.impacts.global.DA * 100) : 0;
                const crAfter = crBefore * (1 + daImpact / 100);
                
                metricsHTML = `
                    <div class="simulation-metric-row">
                        <span>üì¶ Co√ªt de Revient Moy.</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">‚Ç¨${formatNumber(Math.round(crBefore))}</span>
                        <span>‚Üí</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">‚Ç¨${formatNumber(Math.round(crAfter))}</span>
                        <span class="simulation-change ${crAfter <= crBefore ? 'positive' : 'negative'}">
                            ${daImpact > 0 ? '+' : ''}${daImpact.toFixed(1)}%
                        </span>
                    </div>
                `;
            } else if (joueur === 4) {
                // J4 Production: TRG/Capacit√©
                let trgSum = 0, machineCount = 0;
                for (const [machineId, machine] of Object.entries(gameState.machines)) {
                    const chargePercent = machine.capacite > 0 ? Math.min(100, (machine.charge / machine.capacite * 100)) : 0;
                    trgSum += chargePercent;
                    machineCount++;
                }
                const trgBefore = machineCount > 0 ? trgSum / machineCount : 0;
                // TRG apr√®s d√©pend de la capacit√© ajout√©e
                const trgAfter = capImpact > 0 ? trgBefore * (100 / (100 + capImpact)) : trgBefore;
                
                metricsHTML = `
                    <div class="simulation-metric-row">
                        <span>üè≠ TRG Moyen</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${trgBefore.toFixed(0)}%</span>
                        <span>‚Üí</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${trgAfter.toFixed(0)}%</span>
                        <span class="simulation-change ${trgAfter <= trgBefore ? 'positive' : 'negative'}">
                            ${capImpact > 0 ? '‚ÜóÔ∏è Cap +' + capImpact.toFixed(0) + '%' : '‚Äî'}
                        </span>
                    </div>
                `;
            } else if (joueur === 5) {
                // J5 Qualit√©: Conformit√© (1-TR)
                const confBefore = 100 - trBefore;
                const confAfter = 100 - trAfter;
                
                metricsHTML = `
                    <div class="simulation-metric-row">
                        <span>‚úÖ Conformit√©</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${confBefore.toFixed(1)}%</span>
                        <span>‚Üí</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${confAfter.toFixed(1)}%</span>
                        <span class="simulation-change ${confAfter >= confBefore ? 'positive' : 'negative'}">
                            ${confAfter >= confBefore ? '+' : ''}${(confAfter - confBefore).toFixed(1)}%
                        </span>
                    </div>
                `;
            } else {
                // J3 Logistique: Budget/D√©lais
                metricsHTML = `
                    <div class="simulation-metric-row">
                        <span>üöö Lead Time Moy.</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${ltBefore.toFixed(0)}j</span>
                        <span>‚Üí</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${ltAfter.toFixed(0)}j</span>
                        <span class="simulation-change ${ltAfter <= ltBefore ? 'positive' : 'negative'}">
                            ${ltAfter > ltBefore ? '+' : ''}${(ltAfter - ltBefore).toFixed(0)}j
                        </span>
                    </div>
                `;
            }
            
            // Ajouter m√©triques communes pour tous (sauf Lead Time pour J2)
            // J2 (Approvisionnement) ne voit pas le Lead Time en Manche 1
            if (joueur !== 2) {
                metricsHTML += `
                    <div class="simulation-metric-row">
                        <span>‚è±Ô∏è Lead Time</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${ltBefore.toFixed(0)}j</span>
                        <span>‚Üí</span>
                        <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${ltAfter.toFixed(0)}j</span>
                        <span class="simulation-change ${ltAfter <= ltBefore ? 'positive' : 'negative'}">
                            ${ltAfter > ltBefore ? '+' : ''}${(ltAfter - ltBefore).toFixed(0)}j
                        </span>
                    </div>
                `;
            }
            metricsHTML += `
                <div class="simulation-metric-row">
                    <span>üéØ Taux de Rebut</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${trBefore.toFixed(1)}%</span>
                    <span>‚Üí</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${trAfter.toFixed(1)}%</span>
                    <span class="simulation-change ${trAfter <= trBefore ? 'positive' : 'negative'}">
                        ${trAfter > trBefore ? '+' : ''}${(trAfter - trBefore).toFixed(1)}%
                    </span>
                </div>
                <div class="simulation-metric-row">
                    <span>üí∞ Budget √âquipe</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${budgetBefore} pts</span>
                    <span>‚Üí</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${budgetAfter} pts</span>
                    <span class="simulation-change negative">
                        -${carte.cout} pts
                    </span>
                </div>
            `;
            
            // Note sur les effets cach√©s
            if (carte.effetGlobal) {
                metricsHTML += `
                    <div style="margin-top: 16px; padding: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 8px; font-size: 0.85em;">
                        <span style="color: var(--warning); font-weight: 600;">‚ö†Ô∏è Attention :</span>
                        <span style="color: var(--text-secondary);"> Cette carte peut avoir des effets cach√©s qui seront r√©v√©l√©s au d√©briefing.</span>
                    </div>
                `;
            }
            
        } else {
            // Manche 2/3: afficher VAG, CGE, RBE (indicateurs r√©v√©l√©s)
            const vagBefore = calculerVAGTotal();
            const cgeBefore = calculerCGETotal();
            const rbeBefore = calculerRBE();
            const ltBefore = calculerLTMoyen();
            
            const vagAfter = vagBefore * (1 + impacts.vagImpact / 100);
            const cgeAfter = cgeBefore + impacts.cgeImpact;
            const ltAfter = ltBefore + impacts.ltImpact;
            const rbeAfter = vagAfter - cgeAfter;
            
            metricsHTML = `
                <div class="simulation-comparison">
                    <div class="simulation-before">
                        <div class="simulation-title">Avant</div>
                        <div class="simulation-metric-row">
                            <span>VAG Total</span>
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">‚Ç¨${formatNumber(Math.round(vagBefore))}</span>
                        </div>
                        <div class="simulation-metric-row">
                            <span>CGE Total</span>
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">‚Ç¨${formatNumber(Math.round(cgeBefore))}</span>
                        </div>
                        <div class="simulation-metric-row">
                            <span>RBE</span>
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700; color: ${rbeBefore >= 0 ? 'var(--success)' : 'var(--danger)'};">‚Ç¨${formatNumber(Math.round(rbeBefore))}</span>
                        </div>
                        <div class="simulation-metric-row">
                            <span>Lead Time</span>
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${ltBefore.toFixed(0)}j</span>
                        </div>
                    </div>
                    
                    <div class="simulation-arrow">‚Üí</div>
                    
                    <div class="simulation-after">
                        <div class="simulation-title">Apr√®s</div>
                        <div class="simulation-metric-row">
                            <span>VAG Total</span>
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">‚Ç¨${formatNumber(Math.round(vagAfter))}</span>
                            <span class="simulation-change ${vagAfter >= vagBefore ? 'positive' : 'negative'}">
                                ${vagAfter >= vagBefore ? '+' : ''}${((vagAfter - vagBefore) / Math.abs(vagBefore) * 100).toFixed(1)}%
                            </span>
                        </div>
                        <div class="simulation-metric-row">
                            <span>CGE Total</span>
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">‚Ç¨${formatNumber(Math.round(cgeAfter))}</span>
                            <span class="simulation-change ${cgeAfter <= cgeBefore ? 'positive' : 'negative'}">
                                ${cgeAfter > cgeBefore ? '+' : ''}${(cgeAfter - cgeBefore).toFixed(0)}
                            </span>
                        </div>
                        <div class="simulation-metric-row">
                            <span>RBE</span>
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700; color: ${rbeAfter >= 0 ? 'var(--success)' : 'var(--danger)'};">‚Ç¨${formatNumber(Math.round(rbeAfter))}</span>
                            <span class="simulation-change ${rbeAfter >= rbeBefore ? 'positive' : 'negative'}">
                                ${rbeAfter >= rbeBefore ? '+' : ''}${formatNumber(Math.round(rbeAfter - rbeBefore))}
                            </span>
                        </div>
                        <div class="simulation-metric-row">
                            <span>Lead Time</span>
                            <span style="font-family: 'JetBrains Mono', monospace; font-weight: 700;">${ltAfter.toFixed(0)}j</span>
                            <span class="simulation-change ${ltAfter <= ltBefore ? 'positive' : 'negative'}">
                                ${ltAfter > ltBefore ? '+' : ''}${(ltAfter - ltBefore).toFixed(0)}j
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('simulationContent').innerHTML = `
            <div style="text-align: center; margin-bottom: 20px;">
                <span style="font-size: 3em;">${carte.emoji}</span>
                <h3 style="color: var(--accent-tertiary); margin: 12px 0 6px;">${carte.nom}</h3>
                <p style="color: var(--text-muted); font-size: 0.9em;">${carte.description}</p>
                <div style="display: inline-flex; gap: 12px; margin-top: 12px;">
                    <span style="background: var(--warning); color: #000; padding: 6px 14px; border-radius: 8px; font-weight: 700;">
                        üí∞ ${carte.cout} pts
                    </span>
                    ${showHelp ? `
                    <span class="card-risk-badge ${risk.riskLevel}" style="position: static;">
                        ${risk.riskLevel === 'high-risk' ? '‚ö†Ô∏è Risqu√©' : risk.riskLevel === 'medium-risk' ? '‚ö° Mod√©r√©' : '‚úÖ S√ªr'}
                    </span>
                    ` : ''}
                </div>
            </div>
            
            <div class="simulation-results">
                <h4 style="color: var(--text-secondary); margin-bottom: 16px; text-align: center;">
                    üìä Impact Estim√© ${manche === 1 ? '(indicateurs visibles)' : ''}
                </h4>
                ${manche === 1 ? `<div style="display: flex; flex-direction: column; gap: 8px;">${metricsHTML}</div>` : metricsHTML}
            </div>
            
            <div style="display: flex; justify-content: center; gap: 16px; margin-top: 20px;">
                <button onclick="closeSimulationModal()" class="btn" style="background: var(--bg-elevated); border: 1px solid var(--border-default); color: var(--text-secondary); padding: 12px 24px; border-radius: 10px; cursor: pointer;">
                    Annuler
                </button>
                <button onclick="closeSimulationModal(); acheterCarte('${carteId}')" class="btn" style="background: var(--gradient-success); border: none; color: #000; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 700;">
                    ‚úì Acheter cette carte
                </button>
            </div>
        `;
        
        modal.classList.add('active');
    }
    
    // Fermer le modal de simulation
    function closeSimulationModal() {
        const modal = document.getElementById('simulationModal');
        if (modal) modal.classList.remove('active');
    }
    
    // Calculer le LT moyen
    function calculerLTMoyen() {
        let ltTotal = 0;
        let count = 0;
        for (const mfId in gameState.microFlux) {
            ltTotal += gameState.microFlux[mfId].LT;
            count++;
        }
        return count > 0 ? ltTotal / count : 0;
    }
    
    // Fermer le panneau de comparaison
    function closeComparisonPanel() {
        uxState.comparisonMode = false;
        uxState.selectedForComparison = [];
        document.body.classList.remove('comparison-mode-active');
        updateComparisonPanel();
        render();
    }
    
    // Recommander les meilleures cartes
    function getRecommendedCards(cartes, limit = 3) {
        const scored = cartes.map(c => ({
            carte: c,
            impacts: analyzeCardImpacts(c),
            risk: evaluateCardRisk(c)
        }));
        
        scored.sort((a, b) => b.impacts.score - a.impacts.score);
        
        return scored.slice(0, limit);
    }
    
    // Rendu am√©lior√© de l'assistant de d√©cision
    function renderDecisionAssistant() {
        const container = document.getElementById('decisionAssistant');
        if (!container || gameState.phaseDebriefing || gameState.phaseDebriefing2) {
            if (container) container.style.display = 'none';
            return;
        }
        
        if (!uxState.showAssistant) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        const tips = generateContextualTips();
        
        document.getElementById('assistantTips').innerHTML = tips.map(tip => `
            <div class="decision-tip ${tip.type}">
                <span class="decision-tip-icon">${tip.icon}</span>
                <div class="decision-tip-content">
                    <div class="decision-tip-title">${tip.title}</div>
                    <div class="decision-tip-text">${tip.text}</div>
                </div>
            </div>
        `).join('');
    }
    
    // Rendu de la barre de stats rapides
    function renderQuickStats() {
        const container = document.getElementById('quickStatsBar');
        if (!container) return;
        
        const manche = gameState.manche;
        const joueur = gameState.joueurActuel;
        const budget = manche === 1 ? gameState.budgetManche1 : gameState.budgetCommun;
        const goulet = identifierGoulet();
        
        let html = `
            <div class="quick-stat">
                <span class="quick-stat-icon">üí∞</span>
                <div>
                    <div class="quick-stat-label">Budget</div>
                    <div class="quick-stat-value ${budget < SEUILS.budgetBas ? 'warning' : 'neutral'}">${budget} pts</div>
                </div>
            </div>
        `;
        
        // En Manche 1: afficher l'indicateur cl√© du joueur actuel
        if (manche === 1 && !gameState.phaseDebriefing) {
            if (joueur === 1) {
                // J1 Commercial: Marge
                let marge = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    marge += (mf.PV - mf.DA) * mf.QV;
                }
                html += `
                    <div class="quick-stat">
                        <span class="quick-stat-icon">üíµ</span>
                        <div>
                            <div class="quick-stat-label">Marge Totale</div>
                            <div class="quick-stat-value ${marge > 0 ? 'positive' : 'negative'}">‚Ç¨${formatNumber(Math.round(marge))}</div>
                        </div>
                    </div>
                `;
            } else if (joueur === 2) {
                // J2 Approvisionnement: Co√ªt de Revient
                let crTotal = 0, qvTotal = 0;
                for (const mfId in gameState.microFlux) {
                    const mf = gameState.microFlux[mfId];
                    crTotal += calculerDDP(mf) * mf.QV;
                    qvTotal += mf.QV;
                }
                const cr = qvTotal > 0 ? crTotal / qvTotal : 0;
                html += `
                    <div class="quick-stat">
                        <span class="quick-stat-icon">üì¶</span>
                        <div>
                            <div class="quick-stat-label">CR Moyen</div>
                            <div class="quick-stat-value ${cr <= 1500 ? 'positive' : cr <= 2000 ? 'warning' : 'negative'}">‚Ç¨${formatNumber(Math.round(cr))}</div>
                        </div>
                    </div>
                `;
            } else if (joueur === 4) {
                // J4 Production: TRG
                let trgSum = 0, machineCount = 0;
                for (const [machineId, machine] of Object.entries(gameState.machines)) {
                    const chargePercent = machine.capacite > 0 ? Math.min(100, (machine.charge / machine.capacite * 100)) : 0;
                    trgSum += chargePercent;
                    machineCount++;
                }
                const trg = machineCount > 0 ? trgSum / machineCount : 0;
                html += `
                    <div class="quick-stat">
                        <span class="quick-stat-icon">‚öôÔ∏è</span>
                        <div>
                            <div class="quick-stat-label">TRG Moyen</div>
                            <div class="quick-stat-value ${getSeuilClass(trg, SEUILS.trg)}">${trg.toFixed(0)}%</div>
                        </div>
                    </div>
                `;
            } else if (joueur === 5) {
                // J5 Qualit√©: Conformit√©
                let trTotal = 0;
                const mfCount = Object.keys(gameState.microFlux).length;
                for (const mfId in gameState.microFlux) {
                    trTotal += gameState.microFlux[mfId].Tr;
                }
                const conformite = mfCount > 0 ? (1 - trTotal / mfCount) * 100 : 0;
                html += `
                    <div class="quick-stat">
                        <span class="quick-stat-icon">‚úÖ</span>
                        <div>
                            <div class="quick-stat-label">Conformit√©</div>
                            <div class="quick-stat-value ${getSeuilClass(conformite, SEUILS.conformite)}">${conformite.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
            } else {
                // J3 Logistique: Lead Time
                const lt = calculerLTMoyen();
                html += `
                    <div class="quick-stat">
                        <span class="quick-stat-icon">üöö</span>
                        <div>
                            <div class="quick-stat-label">Lead Time Moy.</div>
                            <div class="quick-stat-value ${getSeuilClass(lt, SEUILS.leadTime, true)}">${lt.toFixed(0)}j</div>
                        </div>
                    </div>
                `;
            }
            
            // Taux de rebut (visible pour tous)
            let trTotal = 0;
            const mfCount = Object.keys(gameState.microFlux).length;
            for (const mfId in gameState.microFlux) {
                trTotal += gameState.microFlux[mfId].Tr;
            }
            const tr = mfCount > 0 ? (trTotal / mfCount) * 100 : 0;
            html += `
                <div class="quick-stat">
                    <span class="quick-stat-icon">üéØ</span>
                    <div>
                        <div class="quick-stat-label">Rebut Moy.</div>
                        <div class="quick-stat-value ${getSeuilClass(tr, SEUILS.rebut, true)}">${tr.toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }
        
        // En Manche 2+ ou d√©briefing: afficher VAG/CGE/RBE
        if (manche >= 2 || gameState.phaseDebriefing) {
            const vag = calculerVAGTotal();
            const cge = calculerCGETotal();
            const rbe = calculerRBE();
            
            html += `
                <div class="quick-stat">
                    <span class="quick-stat-icon">üìà</span>
                    <div>
                        <div class="quick-stat-label">VAG</div>
                        <div class="quick-stat-value ${vag >= 0 ? 'positive' : 'negative'}">‚Ç¨${formatNumber(Math.round(vag))}</div>
                    </div>
                </div>
                <div class="quick-stat">
                    <span class="quick-stat-icon">üí∏</span>
                    <div>
                        <div class="quick-stat-label">CGE</div>
                        <div class="quick-stat-value neutral">‚Ç¨${formatNumber(Math.round(cge))}</div>
                    </div>
                </div>
                <div class="quick-stat">
                    <span class="quick-stat-icon">üíµ</span>
                    <div>
                        <div class="quick-stat-label">RBE</div>
                        <div class="quick-stat-value ${rbe >= 0 ? 'positive' : 'negative'}">‚Ç¨${formatNumber(Math.round(rbe))}</div>
                    </div>
                </div>
            `;
        }
        
        // N'afficher le goulet que s'il est probl√©matique (>70%)
        if (goulet && goulet.machine && goulet.charge > SEUILS.goulet.avertissement) {
            html += `
                <div class="quick-stat">
                    <span class="quick-stat-icon">üè≠</span>
                    <div>
                        <div class="quick-stat-label">Goulet</div>
                        <div class="quick-stat-value ${goulet.surcharge ? 'negative' : goulet.charge > SEUILS.goulet.alerte ? 'warning' : 'positive'}">
                            ${goulet.machine}: ${goulet.charge}%
                        </div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    // Rendu des filtres de cartes
    function renderCardFilters() {
        const container = document.getElementById('cardFilters');
        if (!container || gameState.phaseDebriefing) {
            if (container) container.style.display = 'none';
            return;
        }
        
        container.style.display = 'flex';
        container.innerHTML = `
            <div class="filter-group">
                <span class="filter-label">Filtrer:</span>
                <button class="filter-btn ${uxState.cardFilter === 'all' ? 'active' : ''}" onclick="setCardFilter('all')">Toutes</button>
                <button class="filter-btn ${uxState.cardFilter === 'low-cost' ? 'active' : ''}" onclick="setCardFilter('low-cost')">üí∞ ‚â§20 pts</button>
                <button class="filter-btn ${uxState.cardFilter === 'high-impact' ? 'active' : ''}" onclick="setCardFilter('high-impact')">‚≠ê Impact+</button>
                <button class="filter-btn ${uxState.cardFilter === 'low-risk' ? 'active' : ''}" onclick="setCardFilter('low-risk')">‚úÖ S√ªres</button>
            </div>
            <div class="filter-group">
                <span class="filter-label">Trier:</span>
                <select class="filter-select" onchange="setCardSort(this.value)">
                    <option value="default" ${uxState.cardSort === 'default' ? 'selected' : ''}>Par d√©faut</option>
                    <option value="cost-asc" ${uxState.cardSort === 'cost-asc' ? 'selected' : ''}>Co√ªt ‚Üë</option>
                    <option value="cost-desc" ${uxState.cardSort === 'cost-desc' ? 'selected' : ''}>Co√ªt ‚Üì</option>
                    <option value="score-desc" ${uxState.cardSort === 'score-desc' ? 'selected' : ''}>Score ‚Üì</option>
                </select>
            </div>
            <div class="filter-group">
                <input type="text" class="filter-search" placeholder="üîç Rechercher..." 
                    value="${uxState.searchQuery}" oninput="setCardSearch(this.value)">
            </div>
            <div class="filter-group" style="margin-left: auto;">
                <button class="filter-btn ${uxState.comparisonMode ? 'active' : ''}" onclick="toggleComparisonMode()">
                    ‚öñÔ∏è Comparer
                </button>
            </div>
        `;
    }
    
    // Override de la fonction render originale pour inclure les nouvelles fonctionnalit√©s
    const originalRender = render;
    render = function() {
        originalRender();
        renderQuickStats();
        renderDecisionAssistant();
        renderCardFilters();
    };
    
    // Init
    calculerChargesMachines();
    render();
    </script>
    
    <!-- Comparison Panel -->
    <div class="comparison-panel" id="comparisonPanel">
        <div class="comparison-header">
            <div class="comparison-title">
                <span>‚öñÔ∏è</span>
                <span>Comparaison des Cartes</span>
                <span id="comparisonCount" style="color: var(--text-muted); font-weight: 400; font-size: 0.9em;"></span>
            </div>
            <button onclick="closeComparisonPanel()" style="background: var(--bg-elevated); border: 1px solid var(--border-default); color: var(--text-secondary); padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                ‚úï Fermer
            </button>
        </div>
        <div class="comparison-cards" id="comparisonCards"></div>
    </div>
    
    <!-- Simulation Modal -->
    <div class="modal-overlay" id="simulationModal">
        <div class="modal-content" style="max-width: 700px;">
            <div id="simulationContent"></div>
        </div>
    </div>
</body>
</html>
